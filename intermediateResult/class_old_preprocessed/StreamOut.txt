licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra stream import java error import java import java net inet address import java util import java util concurr futur import googl common collect iter import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra column famili store import org apach cassandra tabl import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra sstabl descriptor import org apach cassandra sstabl tabl import org apach cassandra sstabl tabl reader import org apach cassandra util util import org apach cassandra util pair class handl stream data node anoth sourc node side alway charg stream session stream initi direct sourc method class demand target stream request file stream group session callback associ instanc mark node full member cluster data stream sourc session send messag stream bit flag header turn part messag includ stream header includ file stream part session file stream combin session list file inconveni inconveni part send file list wait ack start file danc separ connect avoid block ordinari intra node traffic dure stream handler main stream data connect set stream bit incom tcp connect expect ani messag file target node side send stream repli indic success failur file success transfer integr target send addit repli session complet stream request bootstrap subtleti alway creat stream repli list file empti otherwis target stop wait answer public class stream privat static logger logger logger factori logger stream class stream rang target endpoint keyspac public static void transfer rang inet address target tabl tabl collect rang token rang stream callback callback oper type type stream session session stream session creat tabl target callback transfer rang session tabl column famili store rang type flush match column famili keyspac column famili list empti privat static void flush tabl iter column famili store store throw logger info flush memtabl store list futur flush flush array list futur column famili store cfstore store futur flush cfstore forc flush flush null flush add flush util wait futur flush stream rang target endpoint public static void transfer rang stream session session iter column famili store cfses collect rang token rang oper type type assert rang size logger info transfer session host logger debug rang string util join rang tri flush tabl cfses iter tabl reader sstabl collect empti list column famili store store cfses sstabl iter concat sstabl store mark current tabl referenc transfer tabl session sstabl rang type catch throw error level transfer match portion group sstabl singl tabl target endpoint probabl call transfer rang moreov assum refer acquir sstabl public static void transfer tabl stream session session iter tabl reader sstabl collect rang token rang oper type type throw list pend file pend creat pend file sstabl rang type list pend file empti initi transfer otherwis remot hang case request transfer session add file stream pend session call prior send anyth privat static list pend file creat pend file iter tabl reader sstabl collect rang token rang oper type type list pend file pend array list pend file tabl reader sstabl sstabl descriptor desc sstabl descriptor list pair long long section sstabl posit rang rang section empti refer acquir sstabl won stream sstabl releas refer continu pend add pend file sstabl desc tabl section type sstabl estim key rang rang logger info stream context metadata sstabl pend iter size sstabl return pend 