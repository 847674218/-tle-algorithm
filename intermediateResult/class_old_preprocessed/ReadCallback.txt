licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra servic import java import java net inet address import java util list import java util concurr time unit import java util concurr timeout import java util concurr atom atom integ import org apach cassandra config schema import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra read command import org apach cassandra read respons import org apach cassandra tabl import org apach cassandra locat endpoint snitch import org apach cassandra net async callback import org apach cassandra net messag import org apach cassandra net messag servic import org apach cassandra thrift consist level import org apach cassandra thrift unavail import org apach cassandra util util import org apach cassandra util simpl condit import org apach cassandra util wrap runnabl import googl common collect list public class read callback implement async callback protect static final logger logger logger factori logger read callback class protect static final endpoint snitch snitch databas descriptor endpoint snitch protect static final string localdc snitch datacent util broadcast address public final respons resolv resolv protect final simpl condit condit simpl condit privat final long start time protect final int blockfor final list inet address endpoint privat final read command command protect final atom integ receiv atom integ constructor respons count calcul block public read callback respons resolv resolv consist level consist level read command command list inet address endpoint command command blockfor determin block consist level command keyspac resolv resolv start time system current time milli sort consist level endpoint endpoint resolv instanceof row repair resolv endpoint filter endpoint endpoint logger debug enabl logger debug string format blockfor set request blockfor string util join endpoint endpoint alreadi restrict live replica sort snitch prefer hook datacent read callback move local replica front list read repair becaus replica data read otherwis becaus onli blockfor replica digest read protect void sort consist level list inet address endpoint privat list inet address filter endpoint list inet address resolv instanceof row digest resolv assert command instanceof read command command string tabl row digest resolv resolv tabl string column famili read command command column famili meta data cfmd schema instanc tabl meta data tabl column famili doubl chanc util thread local random doubl global repair return cfmd read repair chanc chanc return local repair return local cfmd local read repair chanc list inet address local list array list list inet address list array list inet address add snitch datacent add equal localdc local add add els add add check blockfor localep local size blockfor local add list math min blockfor local size size return local don read repair rang scan return list math min size blockfor public throw timeout digest mismatch long timeout databas descriptor rpc timeout system current time milli start time boolean success tri success condit await timeout time unit catch interrupt throw assert error success string builder string builder messag messag resolv messag append messag append throw timeout oper time receiv onli receiv respons string return blockfor resolv data resolv resolv public void respons messag messag resolv preprocess messag int wait messag receiv increment receiv blockfor resolv data present condit signal mayb resolv repair return true messag count blockfor threshold turn messag respons don version method protect boolean wait messag messag return true return true respons count blockfor threshold protect boolean wait read respons respons return true public void respons read respons result row digest resolv resolv inject pre process result int wait result receiv increment receiv blockfor resolv data present condit signal mayb resolv repair check digest background repair stage receiv repli request protect void mayb resolv repair blockfor endpoint size receiv endpoint size assert resolv data present stage manag stage stage execut async repair runner public int determin block consist level consist level string tabl switch consist level case return case return case return case return tabl open tabl replic strategi replic factor case return tabl open tabl replic strategi replic factor default throw unsupport oper invalid consist level consist level public void assur suffici live node throw unavail endpoint size blockfor logger debug live node satisfi consist level requir string util join endpoint blockfor throw unavail public boolean latenc snitch return true privat class async repair runner extend wrap runnabl protect void run throw throw tri resolv resolv catch digest mismatch logger debug enabl logger debug digest mismatch read command read command read command command final row repair resolv repair resolv row repair resolv read command tabl read command key async callback repair handler async repair callback repair resolv endpoint size inet address endpoint endpoint messag servic instanc send read command endpoint repair handler 