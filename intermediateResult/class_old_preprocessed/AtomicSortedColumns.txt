licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java nio byte buffer import java util import java util concurr atom atom refer import googl common base function import stanford ppl concurr snap tree map import org apach cassandra marshal abstract type import org apach cassandra util alloc thread safe atom sort column implement oper add implemen atom isol sens typic add guarante thread state onli part column ad implement snaptre https github nbronson snaptre copi write clone oper achiev atom guarante remov element sort column iter isol oper actual fulli ignor face concurr don concurr context check snaptre licens public class atom sort column implement sort column privat final atom refer holder ref public static final sort column factori factori factori public sort column creat abstract type compar boolean insert revers return atom sort column compar public sort column sort sort map byte buffer column sort map boolean insert revers return atom sort column sort map public static sort column factori factori return factori privat atom sort column abstract type compar holder compar privat atom sort column sort map byte buffer column column holder column privat atom sort column holder holder ref atom refer holder holder public abstract type compar return abstract type ref map compar public sort column factori factori return factori public sort column clone return atom sort column ref clone public delet info delet info return ref delet info public void delet delet info info delet info max mark delet valu holder current current ref current delet info mark delet info mark delet break ref compar set current current info public void mayb reset delet time int befor holder current current ref stop don chang delet info expir current delet info local delet time befor break ref compar set current current delet info public void retain sort column column holder current modifi current ref modifi current clone modifi retain column ref compar set current modifi public void add column column column alloc alloc holder current modifi current ref modifi current clone modifi add column column alloc ref compar set current modifi public void add sort column alloc alloc function column column transform add size delta alloc transform public long add size delta sort column alloc alloc function column column transform oper atom isol add column copi map cheap snap tree clone atom compar swap everyth ad cours forget updat delet time case ad lot column fail final compar swap expens mitig check haven beaten anoth thread everi column addit bail earli avoid unnecessari work possibl holder current modifi long size delta main loop size delta current ref delet info del info current delet info del info mark delet delet info mark delet del info delet info modifi holder current map clone del info column column sort column size delta modifi add column transform appli column alloc bail earli beaten ref current continu main loop ref compar set current modifi return size delta public boolean replac column column column column column equal column throw illeg argument holder current modifi boolean replac current ref modifi current clone replac modifi map replac column column column ref compar set current modifi return replac public void remov column byte buffer holder current modifi current ref modifi current clone modifi map remov ref compar set current modifi public void clear holder current modifi current ref modifi current clear ref compar set current modifi public column column byte buffer return ref map public sort set byte buffer column return ref map key set public collect column sort column return ref map valu public collect column revers sort column return ref map descend map valu public int size return ref map size public int estim column count return size public boolean empti return ref map empti public iter column iter return sort column iter public iter column revers iter return revers sort column iter public iter column iter byte buffer start return ref map tail map start valu iter public iter column revers iter byte buffer start return ref map descend map tail map start valu iter public boolean insert revers return fals privat static class holder final snap tree map byte buffer column map final delet info delet info holder abstract type compar snap tree map byte buffer column compar delet info holder sort map byte buffer column column snap tree map byte buffer column column delet info holder snap tree map byte buffer column map delet info delet info map map delet info delet info holder clone return map clone holder delet info info return holder map info holder snap tree map byte buffer column map return holder map delet info point clone map clear afterward holder clear return holder snap tree map byte buffer column map compar delet info long add column column column alloc alloc byte buffer column true column column map put absent column column null return column serial size column instanceof super column assert column instanceof super column long previous size column serial size super column column put column super column column alloc return column serial size previous size els calcul reconcil col exist col col column reconcil column column reconcil column alloc map replac column reconcil column return reconcil column serial size column serial size fail replac column due concurr updat concurr remov tri current concurr remov happen onli updat support void retain sort column column iter column iter map valu iter iter column retain column iter column current iter iter null column retain retain retain null compar super byte buffer compar map compar current null retain null int compar compar current retain current instanceof super column assert retain instanceof super column super column current retain super column retain current iter iter null retain retain retain null els iter remov current iter iter null els retain retain retain null current null iter remov current iter iter null 