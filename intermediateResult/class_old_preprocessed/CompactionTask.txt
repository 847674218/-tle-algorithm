licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra compact import java file import java import java util import googl common base predic import googl common collect iter import org slf logger import org slf logger factori import org apach common lang string util import org apach cassandra config databas descriptor import org apach cassandra column famili store import org apach cassandra decor key import org apach cassandra compact compact manag compact executor stat collector import org apach cassandra sstabl import org apach cassandra util closeabl iter import org apach cassandra util util public class compact task extend abstract compact task protect static final logger logger logger factori logger compact task class protect final int befor protect boolean user defin protect oper type compact type protect static long total byte compact public compact task column famili store cfs collect tabl reader sstabl final int befor super cfs sstabl befor befor user defin fals compact type oper type public static synchron long add total byte compact long byte compact return total byte compact byte compact intern test onli rest system submit method proper serial caller charg mark unmark sstabl compact public int execut compact executor stat collector collector throw collect sstabl pass empti null empti compact noth row delet assert sstabl null set tabl reader compact hash set tabl reader sstabl compact interest compact return file compact file locat cfs directori directori tabl cfs expect compact file size compact compact type compact file locat null partial compact accept compact file path null space left compact tri largest compact file locat null compact size logger warn insuffici space compact request file string util join compact note remov file mark compact suboptim sinc caller unmark sstabl compact remov cfs max size file compact compact file locat cfs directori directori tabl cfs expect compact file size compact compact type compact file locat null logger warn insuffici space compact abort compact return databas descriptor snapshot befor compact cfs snapshot flush system current time milli compact cfs column famili saniti check sstabl belong cfs tabl reader sstabl compact assert sstabl descriptor cfname equal cfs column famili compact control control compact control cfs compact befor user defin sstabl flush ad dure compact onli compact remov singl thread compact world valid determin compact sstabl exist start logger info compact compact long start time system current time milli long totalkey written abstract compact strategi strategi cfs compact strategi long estim total key math max databas descriptor index interv tabl reader approxim key count compact long estim tabl math max tabl total byte compact strategi max tabl size long key tabl long math ceil doubl estim total key estim tabl logger debug enabl logger debug expect bloom filter size key tabl abstract compact iter databas descriptor multithread compact parallel compact iter compact type strategi scanner compact control compact iter compact type strategi scanner compact control closeabl iter abstract compact row iter iter iter abstract compact row nni iter filter iter predic null map decor key long cach key hash map decor key long preheat tracker set doesn happen cfs replac entri track entri preheat map descriptor map decor key long cach key map hash map descriptor map decor key long collect tabl reader sstabl array list tabl reader collect tabl writer writer array list tabl writer collector null collector compact tri nni don mark compact final block sinc nondelet data sync close open period dure crash caus data loss cfs mark compact compact compact type return tabl writer writer cfs creat compact writer key tabl compact file locat compact writer add writer nni stop request throw compact interrupt compact info abstract compact row row nni row empti row close continu long posit writer append row totalkey written databas descriptor preheat key cach tabl reader sstabl compact sstabl cach posit row key fals null cach key put row key posit break nni tabl segment threshold reach writer tmp fals becaus queri descriptor tabl reader cach key map put writer descriptor temporari fals cach key nni writer cfs creat compact writer key tabl compact file locat compact writer add writer cach key hash map decor key long long max age max data age compact tabl writer complet writer writer sstabl add complet writer close open reader max age catch tabl writer writer writer writer abort remov alreadi complet tabl tabl reader sstabl sstabl sstabl mark compact sstabl releas refer throw util uncheck final iter close collector null collector finish compact cfs replac compact tabl compact sstabl compact type doesn belong part reader load tracker wire tabl reader sstabl sstabl map entri decor key long entri cach key map sstabl descriptor entri set sstabl cach key entri key entri valu logger info enabl long time system current time milli start time long startsiz tabl total byte compact long endsiz tabl total byte sstabl doubl ratio doubl endsiz doubl startsiz string builder builder string builder builder append tabl reader reader sstabl builder append reader filenam append builder append doubl mbps time doubl endsiz doubl time logger info string format compact origin byte key time dms builder string startsiz endsiz int ratio totalkey written mbps time logger debug string format total byte compact compact task add total byte compact endsiz return compact size protect boolean partial compact accept return user defin extens point strategi limit upper bound sstabl segment size protect boolean tabl segment threshold reach tabl writer writer throw return fals return true propos compact worth proceed level compact overrid promot sstabl level anoth rewrit overlap protect boolean compact interest set tabl reader compact user defin compact size return true logger info string format noth compact forc user defin compact forc compact singl sstabl tombston collect cfs column famili return fals public static long max data age collect tabl reader sstabl long max tabl reader sstabl sstabl sstabl max data age max max sstabl max data age return max public compact task user defin boolean user defin user defin user defin return public compact task set compact type oper type compact type compact type compact type return 