licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra stream import java import java net inet address import java util import java util concurr atom atom integ import java util concurr concurr map import java util concurr concurr hash map import org slf logger import org slf logger factori import org apach cassandra column famili store import org apach cassandra tabl import org apach cassandra dht abstract bound import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra gms gossip import org apach cassandra version serial import org apach cassandra sstabl tabl reader import org apach cassandra net import org apach cassandra servic storag servic import org apach cassandra util util import org apach cassandra util gen task node exchang stream rang tabl handl case local node node stream rang regist callback call complet public class stream repair task implement runnabl privat static final logger logger logger factori logger stream repair task class map task creat node privat static final concurr map stream repair task task concurr hash map stream repair task privat static final stream repair task serial serial stream repair task serial public final privat final inet address owner node task creat src don public final inet address src public final inet address dst privat final string tabl privat final string privat final collect rang token rang privat final stream callback callback privat stream repair task inet address owner inet address src inet address dst string tabl string collect rang token rang stream callback callback owner owner src src dst dst tabl tabl rang rang callback callback public static stream repair task creat inet address inet address string tabl string collect rang token rang runnabl callback inet address local util broadcast address gen type host local anyon node sourc destin howev localhost put sourc avoid inet address src equal local inet address dst equal local stream repair task task stream repair task local src dst tabl rang wrap callback callback local equal src task put task return task return true task task execut local fals public boolean local task return owner equal src public void run src equal util broadcast address initi stream els sourc privat void initi stream column famili store cfstore tabl open tabl column famili store tri logger info string format stream task perform stream repair rang rang size dst acquir refer transfer tabl collect tabl reader sstabl cfstore mark current tabl referenc send rang remot node stream session outsess stream session creat tabl dst callback stream transfer tabl outsess sstabl rang oper type request rang remot node stream request rang dst tabl collect singleton cfstore rang callback oper type catch throw runtim stream repair fail privat void sourc tri logger info string format stream task stream repair rang stream rang size src dst stream repair request send catch throw runtim error stream task src privat static stream callback repli callback final inet address task owner final task return stream callback expect callback receiv send privat final atom integ outstand atom integ public void success outstand decrement wait call return tri stream repair respons repli task owner task catch throw error public void failur wrap callback unregist stream repair task complet privat static stream callback wrap callback final runnabl callback final taskid final boolean local task return stream callback expect callback receiv send privat final atom integ outstand atom integ local task public void success outstand decrement wait call return task remov taskid callback null callback run public void failur public static class stream repair request implement verb handler public void verb messag messag string byte byte messag messag bodi data input stream dis data input stream byte array input stream byte stream repair task task tri task stream repair task serial deseri dis messag version catch throw error assert task src equal util broadcast address assert task owner equal messag logger info string format stream task receiv task stream rang task messag task rang size task dst task run privat static void send stream repair task task throw int version gossip instanc version task src byte array output stream bos byte array output stream data output stream dos data output stream bos stream repair task serial serial task dos version messag msg messag util broadcast address storag servic verb bos byte array version messag servic instanc send msg task src public static class stream repair respons implement verb handler public void verb messag messag string byte byte messag messag bodi data input stream dis data input stream byte array input stream byte taskid tri taskid gen read dis catch throw error error read stream repair respons messag stream repair task task task taskid task null logger error string format receiv stream repair respons unknow tak node restart messag taskid return assert task owner equal util broadcast address logger info string format stream task task succeed task task callback null task callback success privat static void repli inet address remot taskid throw logger info string format stream task task suce respons taskid remot int version gossip instanc version remot byte array output stream bos byte array output stream data output stream dos data output stream bos gen write taskid dos messag msg messag util broadcast address storag servic verb bos byte array version messag servic instanc send msg remot privat static class stream repair task serial implement version serial stream repair task public void serial stream repair task task data output dos int version throw gen write task dos compact endpoint serial helper serial task owner dos compact endpoint serial helper serial task src dos compact endpoint serial helper serial task dst dos dos write task tabl dos write task dos write int task rang size rang token rang task rang abstract bound serial serial rang dos version don serial callback purpos public stream repair task deseri data input dis int version throw gen read dis inet address owner compact endpoint serial helper deseri dis inet address src compact endpoint serial helper deseri dis inet address dst compact endpoint serial helper deseri dis string tabl dis read string dis read int rang count dis read int list rang token rang array list rang token rang count int rang count rang add rang token abstract bound serial deseri dis version token bound return stream repair task owner src dst tabl rang repli callback owner public long serial size stream repair task task int version throw unsupport oper 