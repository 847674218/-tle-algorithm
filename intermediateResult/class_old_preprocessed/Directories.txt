licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java file import java file filter import java error import java import java util import org apach common lang string util import googl common collect immut map import org slf logger import org slf logger factori import org apach cassandra config import org apach cassandra compact level manifest import org apach cassandra util file util import org apach cassandra sstabl import org apach cassandra servic storag servic import org apach cassandra util librari import org apach cassandra util pair encapsul handl path data file directori layout follow path data dir data data addit root data directori specifi path data dir potenti repres multipl locat note case multipl locat manifest level compact onli locat snapshot resp backup alway creat sstabl thare snapshot resp backup insid subdirectori snapshot resp backup snapshot furter insid subdirectori snapshot class abstract detail rest code public class directori privat static logger logger logger factori logger directori class public static final string backup public static final string snapshot public static final char public static final file data file locat static string locat databas descriptor data file locat data file locat file locat length int locat length data file locat file locat privat final string tablenam privat final string cfname privat final file sstabl directori public static directori creat string tablenam string cfname int idx cfname index idx secondari index goe directori base return directori tablenam cfname cfname substr idx els return directori tablenam cfname cfname privat directori string tablenam string cfname string directori tablenam tablenam cfname cfname sstabl directori file data file locat length int data file locat length sstabl directori file data file locat join tablenam directori storag servic instanc client mode tri file dir sstabl directori file util creat directori dir catch throw error public file directori tabl long estim size file path locat maximum avail space estim size request chanc free space onli mmap jvm path null databas descriptor disk access mode config disk access mode mmap databas descriptor index access mode config disk access mode mmap file util cleaner avail logger info forc free disk space upgrad oracl avoid storag servic instanc request retri cing forc unmap compact tabl delet note inspector alreadi onli sun support inspector tabl delet task reschedul fail task tri thread sleep catch interrupt throw assert error path locat maximum avail space estim size return path loop disk disk max free space return disk max free space compact size expect compact file greater max disk space avail return null compact case public file locat maximum avail space long estim size long max free disk file max locat null file dir sstabl directori max free disk dir usabl space max free disk dir usabl space max locat dir load factor entir disk riski max free disk long max free disk logger debug string format expect data file size largest free partit byte free estim size max locat max free disk estim size max free disk return max locat return null public static file snapshot directori descriptor desc string snapshot return creat desc directori snapshot public static file backup directori descriptor desc return creat desc directori public tabl lister sstabl lister return tabl lister public class tabl lister privat boolean skip compact privat boolean skip temporari privat boolean includ backup privat boolean onli backup privat int file privat final map descriptor set compon compon hash map descriptor set compon privat boolean filter privat string snapshot public tabl lister skip compact boolean filter throw illeg state list alreadi call skip compact return public tabl lister skip temporari boolean filter throw illeg state list alreadi call skip temporari return public tabl lister includ backup boolean filter throw illeg state list alreadi call includ backup return public tabl lister onli backup boolean filter throw illeg state list alreadi call onli backup includ backup return public tabl lister snapshot string filter throw illeg state list alreadi call snapshot return public map descriptor set compon list filter return immut map copi compon public list file list file filter list file array list file file map entri descriptor set compon entri compon entri set compon entri valu add file entri key filenam return privat void filter filter return file locat sstabl directori snapshot null file locat join snapshot list file filter continu onli backup locat list file filter includ backup file locat list file filter filter true privat file filter filter note prefix includ cfname separ distinguish cfs secondari index final string sstabl prefix tablenam compon separ cfname compon separ return file filter function alway return fals sinc accept add compon map public boolean accept file file onli interest tabl file belong specif column famili file directori file start sstabl prefix return fals pair descriptor compon pair tabl tri compon filenam file parent file file pair null return fals skip compact file pair left filenam compon exist return fals skip temporari pair left temporari return fals set compon previous compon pair left previous null previous hash set compon compon put pair left previous previous add pair file return fals public file tri level manifest file dir sstabl directori file manifest file file dir cfname level manifest manifest file exist logger debug manifest manifest file return manifest file logger debug level manifest return null public file creat level manifest file manifest file tri level manifest manifest file null manifest file file sstabl directori cfname level manifest return manifest file public void snapshot level manifest string snapshot throw file manifest tri level manifest manifest null file snapshot directori creat manifest parent file snapshot librari creat hard link manifest file snapshot directori manifest public boolean snapshot exist string snapshot file dir sstabl directori file snapshot dir file dir join snapshot snapshot dir exist return true return fals public void clear snapshot string snapshot throw snapshot empti null delet entir snapshot directori string tag snapshot null snapshot file dir sstabl directori file snapshot dir file dir join tag snapshot dir exist logger debug enabl logger debug remov snapshot directori snapshot dir file util delet recurs snapshot dir privat static file creat file base string subdir file dir subdir null subdir length base file base join subdir dir exist dir directori throw error string format invalid directori path path exist directori dir els dir mkdir throw error unabl creat directori dir return dir privat static string join string return string util join file separ check sstabl migrat system directori directori status attempt sstabl migrat note harmless tri migrat useless mayb wast cpu cycl public static boolean sstabl migrat storag servic instanc client mode return fals boolean system keyspac fals file locat data file locat file system dir file locat tabl system keyspac system dir exist system dir directori file status dir file system dir system tabl status dir exist return fals system keyspac brand node return fals check migrat creat long filenam int longest locat tri file loc data file locat longest locat math max longest locat loc canon path length catch throw error check migrat won error halfway long path window check total path length http msdn microsoft librari aspx discuss elsewher filenam meta data ksm schema instanc tabl definit string ksname ksm map entri string meta data entri ksm meta data entri set string cfname entri key max path rough guess estim locat ksname cfname snapshot somenam ksname cfname tmp statist system properti start window longest locat ksname length cfname length throw runtim string format start keyspac column famili charact long doesn respect restrict pleas renam keyspac column famili respect restrict befor updat schema ksname cfname ksm length cfname length throw runtim start keyspac includ data filenam ksm cfname put largest possibl filenam charact return true move sstabl pre layout locat involv move sstabl specif directori renam sstabl includ keyspac filenam note move level manifest snapshot backup public static void migrat tabl logger info upgrad pre version detect migrat sstabl directori layout file locat data file locat locat exist locat directori continu file dir locat list file dir null file dir dir dir directori continu file file dir list file file null file file file migrat file file dir null migrat snapshot dir migrat backup dir privat static void migrat snapshot file dir file snapshot dir file dir snapshot dir exist return file snapshot snapshot dir list file snapshot null file snapshot snapshot snapshot directori continu file file snapshot list file file null file file migrat file dir join snapshot snapshot delet logger info snapsot directori delet migraat empti snapshot snapshot dir delet logger info directori delet migrat empti snapshot dir privat static void migrat backup file dir file backup dir file dir backup dir exist return file file backup dir list file file null file file migrat file dir backup dir delet logger info directori delet migrat empti backup dir privat static void migrat file file file file dir string addit path tri file directori return string file boolean manifest level manifest string cfname manifest manifest substr index compon separ int idx cfname index idx secondari index string dirnam idx cfname substr idx cfname file dest dir creat dir dirnam addit path file dest file file dest dir manifest dir compon separ logger debug string format upgrad move file dest file file util renam confirm file dest file catch throw error privat static string manifest string string ext substr length level manifest length return ext ext tmp ext substr ext length ext hack test don otherwis static void overrid data directori test string loc int data file locat length data file locat file loc hack test don otherwis static void reset data directori test string locat databas descriptor data file locat int locat length data file locat file locat 