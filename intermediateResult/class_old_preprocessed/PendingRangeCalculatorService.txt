licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra servic import googl common collect hash multimap import googl common collect immut set import googl common collect multimap import googl common collect set import org apach cassandra concurr enabl thread pool executor import org apach cassandra concurr thread factori import org apach cassandra config schema import org apach cassandra tabl import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra locat abstract replic strategi import org apach cassandra locat token metadata import org apach cassandra util pair import org slf logger import org slf logger factori import java net inet address import java util hash set import java util map import java util set import java util link hash map import java util concurr public class pend rang calcul servic extend pend rang calcul servic bean public static final pend rang calcul servic instanc pend rang calcul servic privat static logger logger logger factori logger pend rang calcul servic class privat final enabl thread pool executor executor enabl thread pool executor integ time unit link block queue runnabl thread factori pend rang calcul intern public pend rang calcul servic executor set reject execut handler thread pool executor discard polici privat class pend rang task implement runnabl public void run long start system current time milli string tabl schema instanc system tabl calcul pend rang tabl open tabl replic strategi tabl logger debug finish calcul keyspac schema instanc system tabl size system current time milli start public futur updat return executor submit pend rang task public void block finish true executor activ count executor pend task break tri thread sleep catch interrupt throw runtim calcul pend rang accord bootstrap leav node reason doubt write node littl multipl node move calcul biggest rang node clean unneed data afterward write dure movement node leav rang node onli grow node addit rang lose ani current rang result leav therefor remov leav token sake calcul check rang node leav biggest possibl rang regard current leav oper cover subset possibl final rang valu node bootstrap rang node onli smaller complex calcul multipl bootstrap overlap simpli base calcul token ring befor reflect situat leav oper complet bootstrap node ad remov metadata check rang give biggest possibl rang node bootstrap actual final rang smaller doe matter clean data afterward heavi ineffect oper onli onc node chang state cluster manag public static test purpos public static void calcul pend rang abstract replic strategi strategi string tabl token metadata storag servic instanc token metadata multimap rang token inet address pend rang hash multimap creat map token inet address bootstrap token bootstrap token set inet address leav endpoint leav endpoint bootstrap token empti leav endpoint empti move endpoint empti logger debug enabl logger debug bootstrap leav move node empti pend rang tabl set pend rang tabl pend rang return multimap inet address rang token address rang strategi address rang copi metadata reflect situat leav oper finish token metadata left metadata clone left rang affect leav node set rang token affect rang hash set rang token inet address endpoint leav endpoint affect rang add address rang endpoint rang find node respons rang leav node rang token rang affect rang set inet address current endpoint immut set copi strategi calcul natur endpoint rang set inet address endpoint immut set copi strategi calcul natur endpoint rang left metadata pend rang put rang set differ endpoint current endpoint stage pend rang updat accord leav oper continu calcul check bootstrap node bootstrap node simpli add remov left metadata check rang synchron bootstrap token bootstrap token link hash map token inet address bootstrap token map entri token inet address entri bootstrap token entri set inet address endpoint entri valu left metadata updat normal token entri key endpoint rang token rang strategi address rang left metadata endpoint pend rang put rang endpoint left metadata remov endpoint endpoint stage pend rang updat accord leav bootstrap node finish calcul check move node move node bootstrap simpli add remov left metadata check rang pair token inet address move move endpoint inet address endpoint move address move node move left token endpoint left metadata updat normal token move left endpoint rang token rang strategi address rang left metadata endpoint pend rang put rang endpoint left metadata remov endpoint endpoint set pend rang tabl pend rang logger debug enabl logger debug pend rang pend rang empti empti print pend rang 