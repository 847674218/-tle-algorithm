licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra util import java import java nio channel close channel import java secur messag digest import java secur algorithm import org apach cassandra config databas descriptor import org apach cassandra util librari public class sequenti writer extend output stream dirti true buffer ani sync byte protect boolean dirti fals sync fals absolut path file privat final string file path write int path ton byte alloc privat final byte singl byte buffer byte protect byte buffer privat final boolean skip cach privat final int privat final int directori directori sync onli file sync word onli onc file privat boolean directori sync fals protect long current buffer offset protect int valid buffer byte protect final random access file skip cach enabl privat long cach start offset byte sinc cach flush trickl fsync avoid sudden burst dirti buffer flush kernel caus read latenc spike privat boolean trickl fsync privat int trickl fsync byte interv privat int byte sinc trickl fsync public final data output stream stream privat messag digest digest public sequenti writer file file int buffer size boolean skip cach throw random access file file file path file absolut path buffer byte buffer size skip cach skip cach trickl fsync databas descriptor trickl fsync trickl fsync byte interv databas descriptor trickl fsync interv librari getfd directori librari tri open directori file parent stream data output stream public static sequenti writer open file file throw return open file random access reader fals public static sequenti writer open file file boolean skip cach throw return open file random access reader skip cach public static sequenti writer open file file int buffer size boolean skip cach throw return sequenti writer file buffer size skip cach public void write int valu throw singl byte buffer byte valu write singl byte buffer public void write byte buffer throw write buffer buffer length public void write byte data int offset int length throw buffer null throw close channel length int write data offset length offset length dirti true sync true write length byte start posit offset return number byte written caller respons set dirti privat int write byte data int offset int length throw current buffer offset buffer length buffer assert current buffer offset buffer length string format file offset buffer offset path current buffer offset int copi math min length buffer length buffer cursor copi byte extern buffer system arraycopi data offset buffer buffer cursor copi assert current buffer offset buffer length string format file offset buffer offset path current buffer offset valid buffer byte math max valid buffer byte buffer cursor copi current copi return copi synchron file content disk throw java ani error public void sync throw sync intern protect void sync data onli intern throw sync protect void sync intern throw sync flush intern sync data onli intern directori sync librari tri sync directori directori sync true sync fals buffer dirti flush content oper system doe impli fsync current implement reason invalid buffer throw java ani error overrid public void flush throw flush intern protect void flush intern throw dirti flush data trickl fsync byte sinc trickl fsync valid buffer byte byte sinc trickl fsync trickl fsync byte interv sync data onli intern byte sinc trickl fsync skip cach don data reach disk sinc aren call flush continu clear page don offset period updat start offset byte sinc cach flush valid buffer byte byte sinc cach flush random access reader librari tri skip cach cach start offset cach start offset buffer offset byte sinc cach flush rememb wrote don write flush reset buffer dirti fals overrid method overrid flush throw ani error protect void flush data throw write buffer valid buffer byte digest null digest updat buffer valid buffer byte public long file pointer return current return current file pointer disk file note sinc write work buffer data valu increas buffer size everi write writer modifi valu furthermor compress file valu refer compress data writer file pointer refer uncompress file public long disk file pointer throw return file pointer public long length throw return math max math max current length buffer offset valid buffer byte public string path return file path protect void buffer throw flush intern reset buffer protect void reset buffer buffer offset current valid buffer byte privat int buffer cursor return int current buffer offset public file mark mark return buffer file writer mark current public void reset truncat file mark mark throw assert mark instanceof buffer file writer mark long previous current current buffer file writer mark mark pointer previous current valid buffer byte current buffer valid buffer byte valid buffer byte int previous current return synchron current buffer disk becaus don ani data loss sync intern truncat file posit truncat current reset channel posit seek current reset buffer public void truncat long size throw channel truncat size overrid public void close throw buffer null return alreadi close sync intern buffer null skip cach byte sinc cach flush librari tri skip cach close librari tri close directori turn digest comput writer onli call befor ani data written write otherwis illeg state thrown public void set comput digest current throw illeg state tri digest messag digest instanc catch algorithm standard java throw runtim return digest associ file null digest creat onli call onc file fulli creat close call otherwis illeg state thrown public byte digest buffer null throw illeg state return digest null null digest digest class hold mark posit file protect static class buffer file writer mark implement file mark long pointer public buffer file writer mark long pointer pointer pointer 