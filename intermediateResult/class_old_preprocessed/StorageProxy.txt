licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra servic import java data output stream import java import java lang manag manag factori import java net inet address import java nio byte buffer import java util import java util concurr import java util concurr atom atom integ import java util concurr atom atom long import javax manag bean server import javax manag object import googl common base function import googl common collect hash multimap import googl common collect iter import googl common collect map maker import googl common collect multimap import org apach common lang array util import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config databas descriptor import org apach cassandra config schema import org apach cassandra import org apach cassandra dht abstract bound import org apach cassandra dht bound import org apach cassandra dht ring posit import org apach cassandra dht token import org apach cassandra gms failur detector import org apach cassandra gms gossip import org apach cassandra util fast byte array output stream import org apach cassandra locat abstract replic strategi import org apach cassandra locat endpoint snitch import org apach cassandra locat token metadata import org apach cassandra metric client request metric import org apach cassandra net import org apach cassandra thrift import org apach cassandra util public class storag proxi implement storag proxi bean public static final string org apach cassandra type storag proxi privat static final logger logger logger factori logger storag proxi class privat static final boolean true set fals test messagingservic path singl node mbean stuff privat static final latenc tracker read stat latenc tracker privat static final latenc tracker rang stat latenc tracker privat static final latenc tracker write stat latenc tracker public static final string privat static final write perform standard write perform privat static final write perform counter write perform privat static final write perform counter write coordin perform public static final storag proxi instanc storag proxi privat static volatil boolean hint handoff enabl databas descriptor hint handoff enabl privat static volatil int max hint window databas descriptor max hint window privat static volatil int max hint progress util avail processor privat static final atom integ total hint progress atom integ privat static final map inet address atom integ hint progress map maker concurr level comput map function inet address atom integ public atom integ appli inet address inet address return atom integ privat static final atom long total hint atom long privat storag proxi static bean server mbs manag factori platform bean server tri mbs regist bean storag proxi object catch throw runtim standard write perform write perform public void appli mutat mutat collect inet address target write respons handler respons handler string local data center consist level consist level throw timeout assert mutat instanceof row mutat send hint endpoint row mutat mutat target respons handler local data center consist level execut counter write place direct coordin node replica counter mutat verb handler replica othewis write execut stage case verb handler alreadi run stage execut stage otherwis risk deadlock henc differ perform counter write perform write perform public void appli mutat mutat collect inet address target write respons handler respons handler string local data center consist level consist level throw logger debug enabl logger debug insert write local replic mutat string true runnabl runnabl counter write task mutat target respons handler local data center consist level runnabl run counter write coordin perform write perform public void appli mutat mutat collect inet address target write respons handler respons handler string local data center consist level consist level throw logger debug enabl logger debug insert write local replic mutat string true runnabl runnabl counter write task mutat target respons handler local data center consist level stage manag stage stage execut runnabl method mutat appli replica method care possibl replica hint data replica param mutat mutat appli replica param consist level consist level oper public static void mutat list extend mutat mutat consist level consist level throw unavail timeout logger debug mutat consist level mutat consist level final string local data center databas descriptor endpoint snitch datacent util broadcast address long start time system nano time list write respons handler respons handler array list write respons handler mutat size mutat mutat null tri mutat mutat mutat mutat mutat mutat instanceof counter mutat respons handler add mutat counter counter mutat mutat local data center els respons handler add perform write mutat consist level local data center standard write perform null wait write throw timeout necessari write respons handler respons handler respons handler respons handler catch timeout client request metric write timeout logger debug enabl list string mstring array list string mutat size mutat mutat mutat mstring add mutat string true logger debug write timeout string mstring throw catch unavail client request metric write unavail throw catch assert mutat null throw runtim error write key byte buffer util byte hex mutat key final write stat add nano system nano time start time perform write mutat write perform gather list write endpoint appli local mutat write endpoint deletag actual write perform wait respons base consist level param mutat mutat appli param consist level consist level write oper param perform write perform charg appliy mutat list write endpoint standard write perform standard write counter write perform counter write param callback option callback run write success public static write respons handler perform write mutat mutat consist level consist level string local data center write perform perform runnabl callback throw unavail timeout string tabl mutat tabl abstract replic strategi tabl open tabl replic strategi collect inet address write endpoint write endpoint tabl mutat key write respons handler respons handler write respons handler write endpoint consist level callback exit earli fulfil time respons handler assur suffici live node perform appli mutat write endpoint respons handler local data center consist level return respons handler privat static collect inet address write endpoint string tabl byte buffer key storag servic storag servic instanc token storag servic partition token key list inet address natur endpoint natur endpoint tabl return token metadata write endpoint tabl natur endpoint send mutat target write local correspond write hint node avail note hint hint handoff consist level wait hint notifi handler handler respons hint wait hint respons count consist fire hint wait complet fire hint wait complet throw timeout hint written enqueu public static void send hint endpoint final row mutat collect inet address target write respons handler respons handler string local data center consist level consist level throw timeout multimap hold messag address meant specif datacent map string multimap messag inet address messag hash map string multimap messag inet address target size messag produc produc cach messag produc inet address destin target avoid ming due excess hint check live node sinc generat hint overload simpli dead dead idea max hint progress hint flight probabl due small number node caus problem avoid shut write complet healthi node ani node hint progress consid healthi total hint progress max hint progress hint progress destin hint destin throw timeout failur detector instanc aliv destin destin equal util broadcast address insert local respons handler els belong differ server logger debug enabl logger debug insert write key byte buffer util byte hex key destin string databas descriptor endpoint snitch datacent destin multimap messag inet address messag messag messag null messag hash multimap creat messag put messag messag put produc messag gossip instanc version destin destin els hint destin continu schedul local hint schedul local hint destin respons handler consist level send messag local data center messag respons handler public static futur void schedul local hint final row mutat mutat final inet address target final write respons handler respons handler final consist level consist level throw hint doesn sens assert target equal util broadcast address target total hint progress increment final atom integ target hint hint progress target target hint increment runnabl runnabl wrap runnabl public void run throw throw logger debug enabl logger debug ad hint target tri token token storag servic instanc token metadata token target byte buffer tokenbyt storag servic partition token factori byte array token row mutat hint mutat row mutat hint mutat tokenbyt hint mutat appli total hint increment notifi handler onli respons handler null consist level consist level respons handler respons null final total hint progress decrement target hint decrement return futur void stage manag stage stage submit runnabl datacent send messag node relay write replica privat static void send messag string local data center map string multimap messag inet address messag write respons handler handler throw map entri string multimap messag inet address entri messag entri set string data center entri key send messag correspond datacent map entri messag collect inet address messag entri valu map entri set messag messag messag key singl messag object unhint write clean ani previous loop iter messag messag header remov row mutat iter inet address iter messag valu iter inet address target iter direct write local cassadra version data center equal local data center gossip instanc version target messag servic loop loop code clunki avoid creat iter sinc alreadi perfect good messag servic instanc send messag target handler iter target iter messag servic instanc send messag target handler continu add destin messag entri fast byte array output stream bos fast byte array output stream data output stream dos data output stream bos dos write int messag valu size iter inet address destin iter compact endpoint serial helper serial destin dos string messag servic instanc add callback handler messag destin dos write logger debug enabl logger debug ad messag destin messag messag header ad row mutat bos byte array send combin messag header string messag servic instanc send messag target handler logger debug enabl logger debug send messag target privat static void insert local final row mutat final write respons handler respons handler logger debug enabl logger debug insert write local string true runnabl runnabl droppabl runnabl storag servic verb public void run throw throw appli respons handler respons null stage manag stage stage execut runnabl handl counter mutat coordin host counter mutat appli replica call leader mutat befor replic endpoint achiev case coordin host replica proceed appli updat local replic throug appli counter mutat coordin coordin replica counter mutat chosen replica proceed appli counter mutat leader receiv wait acknowledg implement note check fulfil coordin host replica quicker respons becaus write respons handler don easi send error alway gather write latenc coordin node gather point similar case standard write public static write respons handler mutat counter counter mutat string local data center throw unavail timeout inet address endpoint find suitabl endpoint tabl key local data center endpoint equal util broadcast address return appli counter mutat coordin local data center els exit fulfil leader replica string tabl tabl abstract replic strategi tabl open tabl replic strategi collect inet address write endpoint write endpoint tabl key write respons handler write endpoint consist null assur suffici live node actual updat chosen leader replica write respons handler respons handler write respons handler creat endpoint messag messag mutat messag gossip instanc version endpoint logger debug enabl logger debug counter updat key byte buffer util byte hex key endpoint messag servic instanc send messag endpoint respons handler return respons handler find suitabl replica leader counter updat pick random replica local snitch replica aliv local track latenc counter write sens contrarili standard write sinc read involv trust dynam snitch entir solut unclear mix latenc read latenc bit involv privat static inet address find suitabl endpoint string tabl byte buffer key string local data center throw unavail endpoint snitch snitch databas descriptor endpoint snitch list inet address endpoint storag servic instanc live natur endpoint tabl key endpoint empti throw unavail list inet address local endpoint array list inet address inet address endpoint endpoint snitch datacent endpoint equal local data center local endpoint add endpoint local endpoint empti endpoint local pick closest endpoint accord snitch snitch sort proxim util broadcast address endpoint return endpoint els return local endpoint util thread local random int local endpoint size call replica mutat replica becom leader mutat public static write respons handler appli counter mutat leader counter mutat string local data center runnabl callback throw unavail timeout return perform write consist local data center counter write perform callback appli counter mutat leader differ stage execut write appli counter mutat leader assum stage alreadi public static write respons handler appli counter mutat coordin counter mutat string local data center throw unavail timeout return perform write consist local data center counter write coordin perform null privat static runnabl counter write task final mutat mutat final collect inet address target final write respons handler respons handler final string local data center final consist level consist level return droppabl runnabl storag servic verb public void run throw throw assert mutat instanceof counter mutat final counter mutat counter mutat mutat appli mutat appli respons handler respons null send replica ani target remov util broadcast address replic write target empti replic anoth stage becaus involv read replic mutat avoid block stage stage manag stage stage execut droppabl runnabl storag servic verb public void run throw throw timeout send mutat replica send hint endpoint replic mutat target respons handler local data center consist level perform actual read row storag servic fetch specif set column column famili public static list row read list read command command consist level consist level throw unavail timeout invalid request storag servic instanc bootstrap mode client request metric read unavail throw unavail long start time system nano time list row row tri row fetch row command consist level catch unavail client request metric read unavail throw catch timeout client request metric read timeout throw final read stat add nano system nano time start time return row function execut local remot read block result replica locat sort respons time accord snitch send data request closest replica digest request replica read repair enabl closest replica number requir satisfi consist level wait respons replica digest ani match data return data els carri read repair data node privat static list row fetch row list read command initi command consist level consist level throw unavail timeout list row row array list row initi command size list read command command retri collect empti list list read command command command retri empti initi command command retri read callback row read callback read callback command size command retri empti logger debug retri command command retri size send read request int command size read command command command assert command digest queri logger debug command consist level command consist level list inet address endpoint storag servic instanc live natur endpoint command tabl command key databas descriptor endpoint snitch sort proxim util broadcast address endpoint row digest resolv resolv row digest resolv command tabl command key read callback row handler read callback resolv command consist level endpoint handler assur suffici live node assert handler endpoint empti read callback handler data request messag data point node actual data inet address data point handler endpoint data point equal util broadcast address logger debug read data local stage manag stage stage execut local read runnabl command handler els logger debug read data data point messag servic instanc send command data point handler handler endpoint size continu send endpoint digest request read command digest command command copi digest command set digest queri true messag produc produc null inet address digest point handler endpoint list handler endpoint size digest point equal util broadcast address logger debug read digest local stage manag stage stage execut local read runnabl digest command handler els logger debug read digest digest point lazi construct digest messag object sinc necessari local digest read digest read produc null produc cach messag produc digest command messag servic instanc send produc digest point handler read result pass ani digest mismatch list read command repair command null list repair callback repair respons handler null int command size read callback row handler read callback read command command command tri long start time system current time milli row row handler row null command mayb trim row row add row logger debug enabl logger debug read system current time milli start time catch timeout logger debug enabl logger debug read timeout string throw catch digest mismatch logger debug enabl logger debug digest mismatch string row repair resolv resolv row repair resolv command tabl command key repair callback repair handler repair callback resolv handler endpoint repair command null repair command array list read command repair respons handler array list repair callback repair command add command repair respons handler add repair handler messag produc produc cach messag produc command inet address endpoint handler endpoint messag servic instanc send produc endpoint repair handler command retri collect command retri clear read result digest mismatch retri repair respons handler null int repair command size read command command repair command repair callback handler repair respons handler row row tri row handler catch digest mismatch throw assert error full data request node digest wait repair write acknowledg minim impact ani replica write case sync row read multipl time quick success util wait futur handler resolv repair result databas descriptor rpc timeout retri ani potenti short read read command retri command command mayb generat retri command handler row retri command null logger debug issu retri read command command retri collect command retri array list read command command retri add retri command continu row null command mayb trim row row add row command retri empti return row static class local read runnabl extend droppabl runnabl privat final read command command privat final read callback row handler privat final long start system current time milli local read runnabl read command command read callback row handler super storag servic verb command command handler handler protect void run throw throw logger debug enabl logger debug local read runnabl read command tabl tabl tabl open command tabl row command row tabl read respons result read verb handler respons command messag servic instanc add latenc util broadcast address system current time milli start handler respons result static read callback read callback respons resolv resolv read command command consist level consist level list inet address endpoint consist level consist level consist level consist level return datacent read callback resolv consist level command endpoint return read callback resolv consist level command endpoint public static list row rang slice rang slice command command consist level consist level throw unavail timeout logger debug enabl logger debug command consist level command string consist level long start time system nano time list row row scan result tri final slice predic empti predic empti slice predic slice predic command predic command predic int column count row array list row list abstract bound row posit rang restrict rang command rang abstract bound row posit rang rang rang slice command node cmd rang slice command command keyspac command column famili command super column command predic rang command row filter command max result command max column command page list inet address live endpoint storag servic instanc live natur endpoint node cmd keyspac rang databas descriptor endpoint snitch sort proxim util broadcast address live endpoint consist level consist level live endpoint empti live endpoint equal util broadcast address logger debug enabl logger debug local rang slice tri row add rang slice verb handler execut local node cmd row row row column count row live column count catch execut throw runtim caus catch interrupt throw assert error els collect repli resolv accord consist level rang slice respons resolv resolv rang slice respons resolv node cmd keyspac read callback iter row handler read callback resolv node cmd consist level live endpoint handler assur suffici live node resolv set sourc handler endpoint inet address endpoint handler endpoint messag servic instanc send node cmd endpoint handler logger debug enabl logger debug read node cmd endpoint tri row row handler row add row column count row live column count logger debug rang slice read row key util wait futur resolv repair result databas descriptor rpc timeout catch timeout logger debug enabl logger debug rang slice timeout string throw catch digest mismatch throw assert error digest rang slice great otherwis move rang int count node cmd max column column count row size count node cmd max result break page alreadi row reset column filter predic start iter row column row empti command page command predic empti predic final rang stat add nano system nano time start time return trim command row privat static slice predic empti slice predic final slice rang empti slice rang slice rang byte buffer util byte buffer util fals return slice predic set slice rang empti slice rang privat static list row trim rang slice command command list row row max column caller trim result command max column return row els return row size command max result row list command max result row initi request respons session live node check everybodi migrat determin schema chang propag cluster disagr assum ani node fail respond public static map string list string describ schema version final string version schema instanc version string final map inet address version concurr hash map inet address final set inet address live host gossip instanc live member final count latch latch count latch live host size async callback async callback public void respons messag messag record respons remot node logger debug receiv schema check respons messag host address version string string messag messag bodi version put messag version latch count public boolean latenc snitch return fals empti messag act request schema check verb handler inet address endpoint live host messag messag messag util broadcast address storag servic verb array util gossip instanc version endpoint messag servic instanc send messag endpoint tri wait long possibl timeout possibl latch await databas descriptor rpc timeout time unit catch interrupt throw assert error latch shouldn interrupt logger debug version version map version host version map string list string result hash map string list string iter inet address host iter concat gossip instanc live member gossip instanc unreach member inet address host host version version host string string version version null version string list string host result string version host null host array list string result put string version host host add host host address result map readi return client rest debug log result null logger debug host agreement didn respons everybodi string util join result map entri string list string entri result entri set check version disagr log host don agre entri key equal entri key equal version continu string host entri valu logger debug disagre host entri key result size logger debug schema agreement return result comput rang queri sort order node replica destin mani rang restrict scan specif rang els duplic result static extend ring posit list abstract bound restrict rang final abstract bound queri rang special case bound exact minimum token queri rang instanceof bound queri rang left equal queri rang queri rang left minimum storag servic partition logger debug enabl logger debug restrict singl token match queri queri rang return collect singleton list queri rang token metadata token metadata storag servic instanc token metadata list abstract bound rang array list abstract bound divid queri rang piec delimit ring minimum token iter token ring iter token metadata ring iter token metadata sort token queri rang left token true abstract bound remaind queri rang ring iter remaind rang bound token key split token remaind token split provid token remaind key split token upper bound key instanc remaind foo bar node token split remaind foo bar sinc mix token key time rang upper bound key includ key token includ sinc node split valu abstract choic token upper bound token ring iter upper bound upper bound token upper bound queri rang left class remaind left equal upper bound remaind upper bound split break pair abstract bound abstract bound split remaind split upper bound split null continu rang add split left remaind split rang add remaind logger debug enabl logger debug restrict rang queri queri rang rang return rang public long read oper return read stat count public long total read latenc micro return read stat total latenc micro public doubl read latenc micro return read stat latenc micro public long total read latenc histogram micro return read stat total latenc histogram micro public long read latenc histogram micro return read stat latenc histogram micro public long rang oper return rang stat count public long total rang latenc micro return rang stat total latenc micro public doubl rang latenc micro return rang stat latenc micro public long total rang latenc histogram micro return rang stat total latenc histogram micro public long rang latenc histogram micro return rang stat latenc histogram micro public long write oper return write stat count public long total write latenc micro return write stat total latenc micro public doubl write latenc micro return write stat latenc micro public long total write latenc histogram micro return write stat total latenc histogram micro public long write latenc histogram micro return write stat latenc histogram micro public boolean hint handoff enabl return hint handoff enabl public void set hint handoff enabl boolean hint handoff enabl public int max hint window return max hint window public void set max hint window int max hint window public static boolean hint inet address hint handoff enabl return fals boolean hint window expir gossip instanc endpoint downtim max hint window hint window expir logger debug hint gossip instanc endpoint downtim return hint window expir perform truncat operatoin effect delet data column famili cfname param keyspac param cfname throw unavail host ring throw timeout throw public static void truncat block string keyspac string cfname throw unavail timeout logger debug start block truncat oper keyspac keyspac cfname ani host logger info perform truncat host sinc truncat oper aggress typic onli invok admin simplic requir node perform oper throw unavail set inet address endpoint gossip instanc live member int block endpoint size final truncat respons handler respons handler truncat respons handler block send truncat call track respons callback logger debug start send truncat messag host endpoint final truncat truncat truncat keyspac cfname messag produc produc cach messag produc truncat inet address endpoint endpoint messag servic instanc send produc endpoint respons handler wait logger debug truncat messag wait respons block respons handler logger debug truncat gossip ani node current return true gossip node privat static boolean ani host return gossip instanc unreach member empti public interfac write perform public void appli mutat mutat collect inet address target write respons handler respons handler string local data center consist level consist level throw timeout privat static abstract class droppabl runnabl implement runnabl privat final long construct time system current time milli privat final storag servic verb verb public droppabl runnabl storag servic verb verb verb verb public final void run system current time milli construct time databas descriptor rpc timeout messag servic instanc increment drop messag verb return tri run throw catch throw runtim abstract protect void run throw throw public long total hint return total hint public int max hint progress return max hint progress public void set max hint progress int max hint progress public int hint progress return total hint progress public void verifi hint progress hint progress logger warn hint written befor shutdown suppos happen run repair file bug report public long rpc timeout return databas descriptor rpc timeout public void set rpc timeout long timeout milli databas descriptor set rpc timeout timeout milli 