licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra commitlog import java file import java error import java import java util collect import java util collect import java util concurr block queue import java util concurr link block queue import java util concurr time unit import java util concurr concurr link queue import java util concurr atom atom long import googl common collect iter import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra config schema import org apach cassandra column famili store import org apach cassandra tabl import org apach cassandra util file util import org apach cassandra servic storag servic import org apach cassandra util wrap runnabl perform pre alloc commit log segment background thread public method thread safe public class commit log alloc static final logger logger logger factori logger commit log alloc class theoret max millisecond loop run perform janitori task public final static int segment readi privat final block queue commit log segment avail segment link block queue commit log segment alloc run thread privat final block queue runnabl queue link block queue runnabl activ segment unflush data privat final concurr link queue commit log segment activ segment concurr link queue commit log segment track commitlog size multipl segment size promis size adjust actual ad free segment disk evict oldest segment logic effect recycl segment immedi realli happen asynchron alloc thread privat final atom long size atom long segment creation initi disabl becaus typic free segment recycl log replay privat volatil boolean creat reserv segment fals privat final thread alloc thread privat volatil boolean run true public commit log alloc run loop alloc thread runnabl runnabl wrap runnabl public void run throw throw run runnabl queue poll time unit null run els job clear check segment readi effect ensur alway segment avail avail segment empti activ segment empti creat reserv segment logger debug segment reserv creat fresh creat fresh segment alloc thread thread runnabl alloc thread start fetch empti segment file return writabl segment public commit log segment fetch segment commit log segment tri avail segment catch interrupt throw assert error assert activ segment activ segment add cap exceed flush oldest tabl return indic segment longer recycl param segment segment longer public void recycl segment final commit log segment segment activ segment remov segment commit log instanc archiv mayb wait archiv segment archiv command success leav file alon don delet recycl discard segment segment fals return cap exceed discard segment segment true return logger debug recycl segment queue add runnabl public void run commit log segment recycl segment recycl intern add readi segment recycl differ abov becaus work ani file exist commit log segment manag alloc param file segment file longer public void recycl segment final file file check avoid recycl odd size empti segment version unit test cap exceed file length databas descriptor commit log segment size don decreas manag size sinc live segment tri logger debug unopen segment longer delet file file util delet confirm file catch throw error return logger debug recycl file wasn previous live segment add manag size live size add databas descriptor commit log segment size queue add runnabl public void run commit log segment segment commit log segment file path intern add readi segment segment indic segment file delet param segment segment discard privat void discard segment final commit log segment segment final boolean delet file logger debug segment longer activ delet segment delet file archiv script size add databas descriptor commit log segment size queue add runnabl public void run segment discard delet file return space byte segment file public long byte return size param filenam check return true file manag alloc public boolean manag string commit log segment segment iter concat activ segment avail segment segment equal return true return fals creat readi brand segment return newli mint segment privat commit log segment creat fresh segment size add databas descriptor commit log segment size return intern add readi segment commit log segment fresh segment add segment intern track list readi consumpt param segment segment add return newli ad segment privat commit log segment intern add readi segment commit log segment segment assert activ segment segment assert avail segment segment avail segment add segment return segment check specul current size exceed cap return true cap exceed privat boolean cap exceed long current size size logger debug total activ commitlog segment space current size return current size databas descriptor total commitlog space throw flag enabl behavior spare segment avail time public void enabl reserv segment creation creat reserv segment true forc flush dirti repres oldest commitlog segment privat void flush oldest tabl commit log segment oldest segment activ segment peek oldest segment null integ dirti oldest segment dirti string keypac schema instanc dirti left final column famili store cfs tabl open keypac column famili store dirti flush shouldn run commitlog executor sinc acquir tabl switch lock alreadi held thread wait executor context caus deadlock runnabl runnabl runnabl public void run cfs forc flush storag servic option task execut runnabl reset segment test purpos public void reset unsaf logger debug close clear exist commit log segment queue empti thread yield commit log segment segment iter concat activ segment avail segment segment close activ segment clear avail segment clear initi shutdown process alloc thread public void shutdown run fals return alloc thread termin public void await termin throw interrupt alloc thread join return read onli collect activ commit log segment public collect commit log segment activ segment return collect unmodifi collect activ segment 