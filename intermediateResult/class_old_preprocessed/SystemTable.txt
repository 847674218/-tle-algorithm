licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java error import java import java net inet address import java net unknown host import java nio byte buffer import java util import java util concurr execut import org slf logger import org slf logger factori import org apach cassandra config configur import org apach cassandra config databas descriptor import org apach cassandra cql queri processor import org apach cassandra columniter ident queri filter import org apach cassandra filter queri filter import org apach cassandra filter queri path import org apach cassandra marshal ascii type import org apach cassandra marshal byte type import org apach cassandra dht partition import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra servic storag servic import org apach cassandra thrift constant import org apach cassandra util byte buffer util import org apach cassandra util util import org apach cassandra util node public class system tabl privat static logger logger logger factori logger system tabl class public static final string locat info string compat public static final string index info public static final string node info public static final string version layout descript def tabl class header public static final string schema keyspac public static final string schema columnfamili public static final string schema column privat static final byte buffer byte buffer util byte privat static final byte buffer byte buffer util byte ring privat static final byte buffer byte buffer util byte bootstrap privat static final byte buffer byte buffer util byte cooki privat static final byte buffer byte buffer util byte privat static final byte buffer byte buffer util byte token privat static final byte buffer byte buffer util byte generat privat static final byte buffer byte buffer util byte cluster privat static final byte buffer byte buffer util byte current local privat static final byte buffer byte buffer util byte local public enum bootstrap state order boolean compat fals true privat static decor key decor byte buffer key return storag servic partition decor key key public static void finish startup throw def tabl fix schema nano timestamp setup version purg incompat hint privat static void setup version throw row mutat column famili row mutat tabl byte buffer util byte build column famili creat tabl add column column byte buffer util byte version byte buffer util byte util releas version string util timestamp micro add appli row mutat tabl byte buffer util byte cql column famili creat tabl add column column byte buffer util byte version byte buffer util byte queri processor string util timestamp micro add appli row mutat tabl byte buffer util byte thrift column famili creat tabl add column column byte buffer util byte version byte buffer util byte constant util timestamp micro add appli hint becom incompat version cassandra logic associ purg manag privat static void purg incompat hint throw byte buffer upgrad marker byte buffer util byte pre hint purg tabl tabl tabl open tabl queri filter filter queri filter filter decor queri path upgrad marker column famili tabl column famili store column famili filter null logger debug pre hint alreadi purg return marker snapshot remov hint add marker column famili store hint cfs tabl open tabl column famili store hint hand manag hint cfs tabl size logger info possibl format hint truncat tri hint cfs truncat catch throw runtim logger debug mark pre hint purg row mutat row mutat tabl add queri path null upgrad marker byte buffer util byte purg util timestamp micro appli record token anoth node public static synchron void updat token inet address token token equal util broadcast address remov token token return partition storag servic partition column famili column famili creat tabl add column column token factori byte array token byte buffer wrap address util timestamp micro row mutat row mutat tabl add tri appli catch throw error forc block flush remov store token anoth node public static synchron void remov token token token partition storag servic partition row mutat row mutat tabl delet queri path null token factori byte array token util timestamp micro tri appli catch throw error forc block flush method updat system tabl token node public static synchron void updat token token token partition storag servic partition column famili column famili creat tabl add column column system tabl token factori byte array token util timestamp micro row mutat row mutat tabl add tri appli catch throw error forc block flush privat static void forc block flush string cfname tri tabl open tabl column famili store cfname forc block flush catch execut throw runtim catch interrupt throw assert error return map store token address public static hash map token inet address load token hash map token inet address token map hash map token inet address partition storag servic partition tabl tabl tabl open tabl queri filter filter queri filter ident filter decor queri path column famili column famili store remov delet tabl column famili store column famili filter integ null column column sort column tri byte buffer column valu byte addr byte remain byte buffer util array copi posit addr remain token map put token factori byte array column inet address address addr catch unknown host throw error return token map happen tri read system tabl file present read great file great node assum file present read bad throw configur public static void check health throw configur tabl tabl null tri tabl tabl open tabl catch assert error err happen user switch configur configur read system tabl init caus err throw sort set byte buffer col tree set byte buffer byte type instanc col add queri filter filter queri filter filter decor queri path col column famili store cfs tabl column famili store column famili cfs column famili filter null brand node cfs tabl empti throw configur system tabl file couldn load system file node row mutat row mutat tabl column famili creat tabl system tabl add column column byte buffer util byte databas descriptor cluster util timestamp micro add appli return column cluster col column assert cluster col null string save cluster byte buffer util string cluster col valu databas descriptor cluster equal save cluster throw configur save cluster save cluster configur databas descriptor cluster public static token save token tabl tabl tabl open tabl queri filter filter queri filter filter decor queri path column famili tabl column famili store column famili filter return null null storag servic partition token factori byte array column valu public static int increment generat throw tabl tabl tabl open tabl queri filter filter queri filter filter decor queri path column famili tabl column famili store column famili filter int generat null sinc epoch isn foolproof generat foolproof guarante larger address close sane possibl generat int system current time milli els node ignor gossip messag node generat previous final int store generat byte buffer util int column valu final int int system current time milli store generat logger warn store gossip generat greater current system time experi problem store generat generat store generat els generat row mutat row mutat tabl column famili creat tabl system tabl add column column byte buffer util byte generat util timestamp micro add appli forc block flush return generat public static bootstrap state bootstrap state tabl tabl tabl open tabl queri filter filter queri filter filter decor queri path column famili tabl column famili store column famili filter null return bootstrap state column column return bootstrap state valu valu valu posit public static boolean bootstrap complet return bootstrap state bootstrap state public static boolean bootstrap progress return bootstrap state bootstrap state public static void set bootstrap state bootstrap state state column famili column famili creat tabl add column column byte buffer wrap byte byte state ordin util timestamp micro row mutat row mutat tabl add tri appli catch throw runtim public static boolean index built string tabl string index column famili store cfs tabl open tabl column famili store queri filter filter queri filter filter decor byte buffer util byte tabl queri path byte buffer util byte index return column famili store remov delet cfs column famili filter integ null public static void set index built string tabl string index column famili column famili creat tabl add column column byte buffer util byte index byte buffer util util timestamp micro row mutat row mutat tabl byte buffer util byte tabl add tri appli catch throw error forc block flush public static void set index remov string tabl string index row mutat row mutat tabl byte buffer util byte tabl delet queri path null byte buffer util byte index util timestamp micro tri appli catch throw error forc block flush read current local node system tabl null node record public static node current local node byte buffer null tabl tabl tabl open tabl node sinc node timeuuid order older newer queri filter filter queri filter slice filter decor queri path byte buffer util byte buffer util true column famili tabl column famili store column famili filter null column count return node wrap iter els return null write current local node system tabl param node previous local node code node replac null node exist node remov system tabl param node current local node record param microsecond time stamp public static void write current local node node node node node long byte buffer byte buffer wrap util broadcast address address column famili column famili creat tabl add column column node byte row mutat row mutat tabl add tri appli catch throw runtim forc block flush public static list node node record local node id list node node record array list node node record tabl tabl tabl open tabl queri filter filter queri filter ident filter decor queri path column famili tabl column famili store column famili filter node previous null column previous null add node node record previous timestamp ignor column purpos sinc current local node previous node wrap return param column famili respons part schema keyspac column famili column return respons hold level serial schema public static column famili store schema string return tabl open tabl column famili store public static list row serial schema list row schema array list row schema add serial schema schema add serial schema schema add serial schema return schema param schema column famili respons part schema keyspac column famili column return level schema represent row repres individu keyspac column famili public static list row serial schema string schema token min token storag servic partition minimum token return schema schema rang slice null rang row posit min token min key bound min token max key bound integ ident queri filter null public static collect row mutat serial schema map decor key row mutat mutat map hash map decor key row mutat serial schema mutat map serial schema mutat map serial schema mutat map return mutat map valu privat static void serial schema map decor key row mutat mutat map string schema row schema row serial schema schema row mutat mutat mutat map schema row key mutat null mutat map put schema row key row mutat tabl schema row continu mutat add schema row public static map decor key column famili schema string map decor key column famili schema hash map decor key column famili row schema entiti system tabl serial schema schema put schema entiti key schema entiti return schema public static byte buffer schema key string return ascii type instanc string public static row read schema row string decor key key storag servic partition decor key schema key column famili store schema system tabl schema column famili result schema column famili queri filter ident filter key queri path return row key result public static row read schema row string string decor key key storag servic partition decor key schema key column famili store schema system tabl schema column famili result schema column famili key queri path def tabl search composit true def tabl search composit fals fals integ return row key result 