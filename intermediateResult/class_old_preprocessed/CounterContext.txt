licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra context import java nio byte buffer import java secur messag digest import java util array list import java util iter import java util list import org slf logger import org slf logger factori import org apach cassandra constant import org apach cassandra compact compact manag import org apach cassandra marshal marshal import org apach cassandra util alloc import org apach cassandra util byte buffer util import org apach cassandra util heap alloc import org apach cassandra util node implement partit counter context context primarili list tupl node clock count call shard follow shard flag delta special resolut rule merg data structur part header list delta list refer part list shard node logic clock count tupl call bodi exact layout header bodi context list indic bodi list elt byte elt rest header byte bodi layout bodi count count clock clock nodeid nodeid rule merg shard nodeid delta delta sum count logic clock delta delta shard highest logic clock detail descript delta whi merg rule work specif discuss attach public class counter context implement context privat static final int constant short size privat static final int constant short size privat static final int constant long size privat static final int constant long size privat static final int node privat static final logger logger logger factori logger counter context class lazi load singleton privat static class lazi holder privat static final counter context counter context counter context public static counter context instanc return lazi holder counter context creat initi counter context initi valu local node param valu valu initi updat param alloc return empti counter context public byte buffer creat long valu alloc alloc byte buffer context alloc alloc onli elt delta context put short context posit short context put short context posit short write element offset context context posit node local valu return context provid unit test public byte buffer creat node long clock long valu boolean delta byte buffer context byte buffer alloc delta context put short context posit short delta delta context put short context posit short write element offset context context posit delta clock valu return context write tupl node clock count absolut bytebuff wise offset privat static void write element offset byte buffer context int offset node long clock long count context context duplic context posit offset context put byte duplic context put long clock context put long count privat static int header length byte buffer context return math ab context short context posit privat static int compar byte buffer int pos byte buffer int pos return byte buffer util compar array pos pos node determin count relationship context equal set node everi count equal superset node everi count equal greater corollari subset node everi count equal corollari node set equal count greater strategi compar node logic clock version vector param left counter context param counter context return context relationship context public context relationship diff byte buffer left byte buffer context relationship relationship context relationship context state left state context state left header length left context state state context state header length left state remain state remain compar byte int compar left state compar state compar long left clock left state clock long clock state clock long left count left state count long count state count advanc left state move state move process clock comparison left clock clock left count count inconsist shard correspond code merg return case treat differ read repair work return context relationship els continu els left clock clock left clock clock left clock clock left clock clock relationship context relationship relationship context relationship els relationship context relationship continu els relationship context relationship return context relationship els relationship context relationship relationship context relationship els relationship context relationship return context relationship els relationship context relationship continu els compar onli advanc context state move relationship context relationship relationship context relationship els relationship context relationship return context relationship els relationship context relationship continu els compar onli advanc left context left state move relationship context relationship relationship context relationship els relationship context relationship continu els relationship context relationship return context relationship check final length left state remain relationship context relationship return context relationship els relationship context relationship return context relationship els state remain relationship context relationship return context relationship els relationship context relationship return context relationship return relationship return context aggreg count node param left counter context param counter context param alloc alloc merg valu public byte buffer merg byte buffer left byte buffer alloc alloc context state left state context state left header length left context state state context state header length comput size result int merg header length int merg bodi length left state remain state remain int cmp left state compar state cmp merg bodi length left state delta state delta merg header length left state move state move els cmp merg bodi length state delta merg header length state move els cmp merg bodi length left state delta merg header length left state move merg header length left state remain header length state remain header length merg bodi length left state remain bodi length state remain bodi length actual merg byte buffer merg alloc alloc merg header length merg bodi length merg put short merg posit short merg header length context state merg state context state merg merg header length left state reset state reset left state remain state remain int cmp left state compar state cmp left state delta state delta local delta left state delta state delta delta sum long clock left state clock state clock long count left state count state count merg state write element left state node clock count true els onli delta left state delta left state state copi merg state els long left clock left state clock long clock state clock left clock clock delta shard clock differ count howev heal problem determinist select shard log occurr oper someth wrong long left count left state count long count state count left count count compact manag compact manag logger warn invalid counter shard detect differ onli count pick highest heal compact object left state node left clock left count state node clock count left count count left state copi merg state els state copi merg state els left clock clock left clock clock left clock clock left clock clock left state copi merg state els state copi merg state state move left state move els cmp state copi merg state state move els cmp left state copi merg state left state move left state remain left state copi merg state left state move state remain state copi merg state state move return merg human readabl string context param context counter context return human readabl string context public string string byte buffer context context state state context state context header length context string builder string builder append state remain state element idx append append append state node string append append state clock append append state count append state delta append state move append return string return aggreg count node id param context counter context return aggreg count repres code context public long total byte buffer context long total context state easi avoid object creation int offset context posit header length context offset context limit offset long count context long offset node total count return total mark context delet delta afterward mark multipli elt preserv header length elt count order clear delta param context counter context return context mark delet delta public byte buffer mark delta clear byte buffer context int header length header length context header length return context byte buffer mark context duplic short count context short context posit negat elt mark delet chang size count mark put short mark posit short count return mark remov delta context set empti header param context counter context return version code context count delta public byte buffer clear delta byte buffer context int header length header length context header length return context byte buffer clean byte buffer alloc context remain header length clean put short clean posit short byte buffer util array copi context context posit header length clean clean posit context remain header length return clean public void valid context byte buffer context throw marshal int header length header length context header length context remain header length throw marshal invalid size counter context updat messag digest content context note skip header entir sinc header inform local onli digest meant comparison node alway updat digest ctx updat digest clear delta ctx public void updat digest messag digest messag byte buffer context int hlength header length context byte buffer dup context duplic dup posit context posit hlength messag updat dup check provid context count provid node sinc context sort implement binari search howev call ani critic path context fair small doesn matter public boolean node byte buffer context node context state easi avoid object creation int offset context posit header length context offset context limit offset equal node wrap context offset return true return fals comput context appli context yield total local node id nulifi content merg current local node public byte buffer comput shard merger byte buffer context list node node record id long merg befor long system current time milli int hlength header length context node local node local iter node node record record iter id iter node node record curr record record iter record iter null context state state context state context hlength context state state null list node merg array list node long merg total state remain curr record null assert curr record equal local node node state node int node compar curr record curr record record iter record iter null continu state delta state clock alreadi merg shard wait collect node equal local creat problemat context prior throw runtim current node negat clock due restart node dcassandra renew counter true fix state count happen previous bug generat fix logger error string format invalid counter context clock count node fix state count state count node string merg add node merg total state count els howev merg renew isn safe check renew befor merg befor curr record timestamp merg befor merg add node merg total state count curr record record iter record iter null state move continu iter repair invalid shard state remain node node state node state delta state clock node equal local creat problemat context prior throw runtim current node negat clock due restart node dcassandra renew counter true fix state count happen previous bug generat fix logger error string format invalid counter context clock count node fix state clock state count node string merg add node merg total state count state move merg empti return null context state merger context state alloc merg size merg size state reset int int remov total boolean local written fals state remain node node state node node compar local merger write element local merg total true local written true els merg size node compar merg long count state count remov total count merger write element node state clock count true state move local written merger write element local merg total true saniti check assert merg total remov total return merger context remov shard cancel comput shard merger sinc time older befor compact strip context unecessari inform shrink public byte buffer remov shard byte buffer context int befor int hlength header length context context state state context state context hlength int remov shard int remov delta state remain long clock state clock clock count clock previous creat situat delta shard throw sinc comput shard merger correct situat delta shard crappier situat becaus sinc respons shard simpli ignor shard state count state delta throw illeg state counter shard negat clock count context string context els logger debug ignor remov delta corrupt shard context string context state move continu int clock befor remov shard state delta remov delta state move remov shard return context int remov header size remov delta int remov bodi size remov shard int size context remain remov header size remov bodi size int hlength hlength remov header size byte buffer clean context heap alloc instanc alloc size clean context put short clean context posit short hlength context state clean context state clean context hlength state reset state remain long clock state clock clock state count int clock befor state copi clean state move return clean context helper class work context work iter context abstract list tupl nodeid clock count context state encapsul context posit tupl creat context iter note intrins privat class intend method counter context onli howev public becaus conveni creat handcraft context unit test public static class context state public final byte buffer context public final int header length privat int header offset offset context posit privat int bodi offset offset context posit privat boolean current delta public context state byte buffer context int header length context header length header length fals updat delta public context state byte buffer context context header length context privat context state byte buffer context int header length int header offset int bodi offset boolean current delta context context header length header length header offset header offset bodi offset bodi offset current delta current delta public boolean delta return current delta privat void updat delta current delta header offset header length context short context posit header offset short element idx public boolean remain return bodi offset context remain public int remain header length return header length header offset public int remain bodi length return context remain bodi offset public void move bodi offset current delta header offset updat delta advanc posit public void copi context state byte buffer util array copi context context posit bodi offset context context posit bodi offset current delta context put short context posit header offset short element idx current delta current delta move public int compar context state return compar context context posit bodi offset context context posit bodi offset public void reset header offset bodi offset header length updat delta public node node return node wrap context context posit bodi offset public long clock return context long context posit bodi offset node public long count return context long context posit bodi offset node advanc posit public void write element node long clock long count boolean delta write element offset context context posit bodi offset clock count delta context put short context posit header offset short element idx current delta delta move public void write element node long clock long count write element clock count fals public int element idx return bodi offset header length public context state duplic return context state context header length header offset bodi offset current delta alloc context big code element count element code delta count delta return initi context state correspond public static context state alloc int element count int delta count return alloc element count delta count heap alloc instanc public static context state alloc int element count int delta count alloc alloc assert delta count element count int hlength delta count byte buffer context alloc alloc hlength element count context put short context posit short delta count return context state context hlength 