licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra servic import java data input stream import java data output stream import java error import java import java net inet address import java nio byte buffer import java util import java util concurr callabl import java util concurr execut import java util concurr futur import java util array list import java util collect import java util import java util concurr time unit import java lang manag manag factori import java lang manag runtim bean import org slf logger import org slf logger factori import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config meta data import org apach cassandra config configur import org apach cassandra config meta data import org apach cassandra config schema import org apach cassandra import org apach cassandra filter queri filter import org apach cassandra filter queri path import org apach cassandra gms import org apach cassandra util fast byte array input stream import org apach cassandra util fast byte array output stream import org apach cassandra net async callback import org apach cassandra net messag import org apach cassandra net messag servic import org apach cassandra util byte buffer util import org apach cassandra util util import org apach cassandra util gen import org apach cassandra util wrap runnabl import org apach common lang array util public class migrat manag implement endpoint state chang subscrib privat static final logger logger logger factori logger migrat manag class tri mani time send migrat request node befor give privat static final int privat static final byte buffer byte buffer util byte migrat privat static final runtim bean runtim bean manag factori runtim bean public static final int public void join inet address endpoint endpoint state state public void chang inet address endpoint applic state state version valu valu state applic state endpoint equal util broadcast address return mayb schedul schema pull string valu valu endpoint public void aliv inet address endpoint endpoint state state version valu valu state applic state applic state valu null mayb schedul schema pull string valu valu endpoint public void dead inet address endpoint endpoint state state public void restart inet address endpoint endpoint state state public void remov inet address endpoint version differ node send request local migrat list endpoint expect receiv list migrat appli local privat static void mayb schedul schema pull final version final inet address endpoint request migrat node version younger gossip instanc version endpoint messag servic return don request migrat node version gossip instanc version endpoint messag servic return schema instanc version equal version return schema empti version equal schema instanc version runtim bean uptim bootstrap start submit migrat task immedi submit migrat task endpoint els includ delay chanc appli ani chang push simultan runnabl runnabl runnabl public void run grab latest version schema sinc chang sinc initi schedul version valu valu gossip instanc endpoint state endpoint endpoint applic state applic state current version string valu valu schema instanc version equal current version return submit migrat task endpoint storag servic option task schedul runnabl time unit privat static void submit migrat task inet address endpoint ref futur becaus caus distribut deadlock becaus run gossip stage stage manag stage stage submit migrat task endpoint public static boolean readi bootstrap return stage manag stage stage activ count public static void announc keyspac meta data ksm throw configur ksm valid schema instanc tabl definit ksm null throw configur string format add alreadi exist keyspac ksm logger info string format creat keyspac ksm announc ksm schema util timestamp micro public static void announc column famili meta data cfm throw configur cfm valid meta data ksm schema instanc tabl definit cfm ksm null throw configur string format add column famili exist keyspac cfm cfm els ksm meta data key cfm throw configur string format add alreadi exist column famili keyspac cfm cfm logger info string format creat column famili cfm announc cfm schema util timestamp micro public static void announc keyspac updat meta data ksm throw configur ksm valid meta data ksm schema instanc meta data ksm ksm null throw configur string format updat exist keyspac ksm logger info string format updat keyspac ksm ksm ksm announc ksm schema updat ksm util timestamp micro public static void announc column famili updat meta data cfm throw configur cfm valid meta data cfm schema instanc meta data cfm cfm cfm null throw configur string format updat exist column famili keyspac cfm cfm logger info string format updat column famili cfm cfm cfm cfm announc cfm schema updat cfm util timestamp micro public static void announc keyspac drop string throw configur meta data ksm schema instanc meta data ksm null throw configur string format drop exist keyspac logger info string format drop keyspac ksm announc ksm drop schema util timestamp micro public static void announc column famili drop string string throw configur meta data cfm schema instanc meta data cfm null throw configur string format drop exist column famili keyspac logger info string format drop column famili cfm cfm announc cfm drop schema util timestamp micro activ announc version activ host rpc param schema schema mutat appli privat static void announc row mutat schema util wait futur announc collect singleton list schema privat static void push schema mutat inet address endpoint collect row mutat schema tri messag msg migrat messag schema gossip instanc version endpoint messag servic instanc send msg endpoint catch throw error return futur local applic schema privat static futur announc final collect row mutat schema futur stage manag stage stage submit wrap runnabl protect void run throw throw configur def tabl merg schema schema inet address endpoint gossip instanc live member endpoint equal util broadcast address continu delt localhost alreadi don send migrat node version older gossip instanc version endpoint messag servic continu push schema mutat endpoint schema return announc version passiv gossip notifi node arriv cluster param version schema version announc public static void passiv announc version gossip instanc add local applic state applic state storag servic instanc valu factori schema version logger debug gossip schema version version serial row mutat raw byte migrat messag transform definit updat respons verb handler param schema row mutat send remot node param version version messag return serial migrat schema mutat throw fail serial privat static messag migrat messag collect row mutat schema int version throw return messag util broadcast address storag servic verb serial schema schema version version serial row mutat raw byte param schema row mutat serial param version version messag servic serial return serial mutat throw fail serial public static byte serial schema collect row mutat schema int version throw fast byte array output stream bout fast byte array output stream data output stream dout data output stream bout dout write int schema size row mutat mutat schema row mutat serial serial mutat dout version dout close return bout byte array deseri migrat messag consid data compat start version param data data messag coordin hold schema mutat appli param version version messag return collect row mutat appli node aka schema throw messag incompat version data corrupt public static collect row mutat deseri migrat messag byte data int version throw collect row mutat schema array list row mutat data input stream data input stream fast byte array input stream data int count read int int count schema add row mutat serial deseri version return schema clear local store schema inform reset schema initi state call user rid schema disagr throw schema tabl truncat fail public static void reset local schema throw logger info start local schema reset tri logger debug enabl logger debug truncat schema tabl truncat schema tabl util wait futur array list futur system tabl schema system tabl truncat system tabl schema system tabl truncat system tabl schema system tabl truncat logger debug enabl logger debug clear local schema keyspac definit schema instanc clear set inet address live endpoint gossip instanc live member live endpoint remov util broadcast address forc migrat node check node version request migrat becaus migrat format node version incompat older version due broken timestamp version prior inet address node live endpoint gossip instanc version node messag servic logger debug enabl logger debug request schema node util wait futur stage manag stage stage submit migrat task node break logger info local schema reset complet catch interrupt throw runtim catch execut throw runtim onli case node style migrat schema newli updat return identifi version appli migrat deprec public static migrat decor key dkey storag servic partition decor key tabl def tabl open tabl column famili store store def column famili store def tabl queri filter filter queri filter filter dkey queri path def tabl column famili store column famili filter null column size return null els return gen column valu static class migrat task extend wrap runnabl privat final inet address endpoint migrat task inet address endpoint endpoint endpoint public void run throw throw messag messag messag util broadcast address storag servic verb array util gossip instanc version endpoint failur detector instanc aliv endpoint logger error send migrat request node endpoint return async callback async callback public void respons messag messag tri def tabl merg remot schema messag messag bodi messag version catch logger error merg remot schema catch configur logger error configur merg remot schema public boolean latenc snitch return fals messag servic instanc send messag endpoint 