licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra compact import java nio byte buffer import java import java util import org apach cassandra config databas descriptor import org apach cassandra import org apach cassandra sstabl import org apach cassandra util file util import org apach cassandra util random access reader import org apach cassandra util byte buffer util import org apach cassandra util util import org apach cassandra util interv tree import org apach cassandra util output handler public class scrubber implement closeabl public final column famili store cfs public final tabl reader sstabl public final file destin privat final compact control control privat final boolean commut privat final int expect bloom filter size privat final random access reader data file privat final random access reader index file privat final scrub info scrub info privat long row read privat tabl writer writer privat tabl reader sstabl privat tabl reader order sstabl privat int good row privat int bad row privat int empti row privat final output handler output handler privat static final compar abstract compact row acr compar compar abstract compact row public int compar abstract compact row abstract compact row return key compar key privat final set abstract compact row order row tree set abstract compact row acr compar public scrubber column famili store cfs tabl reader sstabl throw cfs sstabl output handler log output fals public scrubber column famili store cfs tabl reader sstabl output handler output handler boolean offlin throw cfs cfs sstabl sstabl output handler output handler calcul expect compact files destin cfs directori directori tabl sstabl disk length destin null throw disk full list tabl reader scrub collect singleton list sstabl run scrub offlin purg tombston sstabl data tombston delet control offlin scrub control cfs compact control cfs collect singleton list sstabl compact manag default befor cfs true commut cfs metadata default valid commut expect bloom filter size math max databas descriptor index interv int tabl reader approxim key count scrub loop row deseri check damag loop index time posit index recov row header key data size corrupt posit index file row data file data file sstabl open data reader true index file random access reader open file sstabl descriptor filenam compon true scrub info scrub info data file sstabl public void scrub throw output handler output scrub sstabl tri byte buffer index key byte buffer util read short length index file throw variabl don side effect assert long row posit index index file read long assert row posit index row posit index error creat writer leav empti temp file writer compact manag mayb creat writer cfs destin expect bloom filter size null collect singleton list sstabl abstract compact row prev row null data file scrub info stop request throw compact interrupt scrub info compact info long row start data file file pointer output handler debug read row row start decor key key null long data size tri key tabl reader decod key sstabl partition sstabl descriptor byte buffer util read short length data file data size sstabl descriptor int row size data file read int data file read long output handler debug string format row byte byte buffer util byte hex key key data size catch throwabl throw fatal check null key byte buffer current index key index key long row posit index tri index key index file null byte buffer util read short length index file row posit index index file data file length index file read long catch throwabl output handler warn error read index file index key null row posit index data file length long data start data file file pointer long data start index current index key null row start current index key remain sstabl descriptor int row size long data size index row posit index data start index assert current index key null index file current index key null output handler debug string format index doublecheck row byte byte buffer util byte hex current index key data size index writer mark tri key null throw error unabl read row key data file data size data file length throw error imposs row size data size tabl ident iter row tabl ident iter sstabl data file key data start data size true abstract compact row compact row control compact row row compact row empti empti row els prev row null acr compar compar prev row compact row order row add compact row output handler warn string format order row detect compact row key prev row key continu writer append compact row prev row compact row good row key key equal current index key data start data start index output handler warn index file differ key row size key data file catch throwabl throw fatal output handler warn fatal error read row stacktrac follow writer reset truncat current index key null key null key key equal current index key data start data start index data size data size index output handler output string format retri row index data byte start data size index data start index key tabl reader decod key sstabl partition sstabl descriptor current index key tri tabl ident iter row tabl ident iter sstabl data file key data start index data size index true abstract compact row compact row control compact row row compact row empti empti row els prev row null acr compar compar prev row compact row order row add compact row output handler warn string format order row detect compact row key prev row key continu writer append compact row prev row compact row good row catch throwabl throw fatal skip row danger counter commut throw error output handler warn retri fail skip row retri stacktrac follow writer reset truncat data file seek row posit index bad row els skip row danger counter commut throw error output handler warn row data start unread skip current index key null data file seek row posit index bad row row read control throttl data file file pointer writer file pointer sstabl writer close open reader sstabl max data age catch writer null writer abort throw util uncheck order row empti tabl writer order writer compact manag mayb creat writer cfs destin expect bloom filter size null collect singleton list sstabl abstract compact row row order row order writer append row order sstabl order writer close open reader sstabl max data age output handler warn string format order row scrub written order sstabl order row size sstabl order sstabl sstabl null bad row output handler warn valid row scrub sstabl mark delet attempt manual recoveri find copi pre scrub snapshot els output handler output scrub sstabl complet empti row row tombston els output handler output scrub sstabl complet good row row sstabl empti row empti tombston row drop bad row output handler warn unabl recov bad row row skip attempt manual recoveri pre scrub snapshot run nodetool repair transfer data healthi replica ani public tabl reader tabl return sstabl public tabl reader order tabl return order sstabl privat void throw fatal throwabl instanceof error instanceof assert error instanceof error throw error public void close file util close quiet data file file util close quiet index file public compact info holder scrub info return scrub info privat static class scrub info extend compact info holder privat final random access reader data file privat final tabl reader sstabl public scrub info random access reader data file tabl reader sstabl data file data file sstabl sstabl public compact info compact info tri return compact info sstabl metadata oper type data file file pointer data file length catch throw runtim privat static class scrub control extend compact control public scrub control column famili store cfs super cfs integ true interv tree tabl reader collect interv empti list fals overrid public boolean purg decor key key return fals 