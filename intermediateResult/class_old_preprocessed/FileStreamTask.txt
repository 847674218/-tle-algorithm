licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra stream import java import java net inet address import java net socket import java nio byte buffer import org apach cassandra config databas descriptor import org apach cassandra gms gossip import org apach cassandra compress compress random access reader import org apach cassandra util random access reader import org apach cassandra util file util import org apach cassandra net header import org apach cassandra net messag import org apach cassandra net messag servic import org apach cassandra servic storag servic import org apach cassandra util byte buffer util import org apach cassandra util pair import org apach cassandra util throttl import org apach cassandra util wrap runnabl import ning compress lzf output stream import org slf logger import org slf logger factori public class file stream task extend wrap runnabl privat static logger logger logger factori logger file stream task class public static final int public static final int protect final stream header header protect final inet address communic socket privat socket socket socket output input stream privat output stream output privat output stream compressedoutput privat data input stream input alloc buffer transfer onli onc privat final byte transfer buffer byte outbound global throughput limit privat final throttl throttl privat final stream repli verb handler handler stream repli verb handler public file stream task stream header header inet address header header throttl throttl string throttl throughput function return instantan throughput target byte millisecond public int target throughput databas descriptor stream throughput outbound megabit sec throttl disabl return total throughput int total byte databas descriptor stream throughput outbound megabit sec stream throughput target byte return total byte math max messag servic instanc activ stream outbound public void run throw throw tri connect attempt success connect stream point fail receiv job request stream stream session session stream session header session session null logger info stream session file stream task expect receiv els session file size kind receiv final confirm befor close receiv repli logger info finish stream session catch stream session session stream session header session session null session close fals throw final tri close catch logger debug enabl logger debug error close socket logger debug enabl logger debug stream header file stream file section specifi header throw ani error privat void stream throw byte buffer header buffer messag servic instanc construct stream header header fals gossip instanc version write header compress compat messag output write byte buffer util array header buffer header file null return raw random access file sinc manag buffer random access reader file header file sstabl compress tri skip kernel page cach possibl compress random access reader open header file filenam header file sstabl compress metadata true random access reader open file header file filenam true set data compress stream compressedoutput output stream output messag servic instanc increment activ stream outbound tri stream requir section file pair long long section header file section seek section file seek section left length section stream long length section section left track write progress long byte transfer byte transfer length long write write file length byte transfer byte transfer write store stream progress header file progress write current section send compressedoutput flush logger debug enabl logger debug byte transfer byte transfer header file size receiv repli confirm receiv repli final messag servic instanc decrement activ stream outbound matter happen close file file util close quiet file privat void receiv repli throw messag servic valid magic input read int int msheader input read int assert messag servic bit msheader stream receiv befor stream repli int version messag servic bit msheader input read int read total size string input read header header header serial deseri input version int bodi size input read int byte bodi byte bodi size input read fulli bodi messag messag messag header bodi version assert messag verb storag servic verb repli messag receiv stream socket handler verb messag sequenti read byte file write output stream param reader file reader read param length full length transfer param byte transfer number byte remain transfer return number byte transfer throw ani error protect long write random access reader reader long length long byte transfer throw int transfer int math min length byte transfer reader read fulli transfer buffer transfer compressedoutput write transfer buffer transfer throttl throttl delta transfer return transfer connect destin backoff fail attempt node cluster current storag port throw attempt fail privat void connect attempt throw int attempt true tri socket messag servic instanc connect pool socket socket set timeout databas descriptor stream socket timeout output socket output stream input data input stream socket input stream break catch attempt throw long waitm databas descriptor rpc timeout long math pow attempt logger warn fail attempt attempt connect stream header file retri waitm tri thread sleep waitm catch interrupt wtf throw runtim wtf protect void close throw output null output close public string string return string format file stream task session header session 