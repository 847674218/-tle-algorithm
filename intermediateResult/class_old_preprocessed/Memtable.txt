licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java file import java import java nio byte buffer import java util import java util concurr import java util concurr atom atom long import googl common base function import org slf logger import org slf logger factori import org apach cassandra concurr debugg thread pool executor import org apach cassandra concurr thread factori import org apach cassandra columniter column iter import org apach cassandra columniter simpl abstract column iter import org apach cassandra commitlog replay posit import org apach cassandra filter abstract column iter import org apach cassandra filter queri filter import org apach cassandra filter slice queri filter import org apach cassandra sstabl tabl reader import org apach cassandra sstabl tabl writer import org apach cassandra util util import org apach cassandra util slab alloc import org apach cassandra util wrap runnabl import org cliffc high scale lib block hash set import org github jamm memori meter public class memtabl privat static final logger logger logger factori logger memtabl class size memori serial size privat static final doubl max liveratio byte column bit jvm higher someth probabl broken privat static final doubl limit amount concurr run queu meter becaus count slow minut larg memtabl busi server memtabl aliv flush otherwis approach bound number outstand run meter maximum set executor queue unbound implicit bound number privat static final set column famili store meter progress block hash set column famili store privat static final executor servic meter executor debugg thread pool executor integ time unit link block queue runnabl thread factori memori meter overrid protect void execut runnabl throwabl super execut debugg thread pool executor log execut privat final memori meter meter volatil static memtabl activ measur privat volatil boolean frozen privat final atom long current size atom long privat final atom long current oper atom long index memtabl row posit onli purpos abl select key rang token key bound howev put ensur actual onli store decor key privat final concurr navig map row posit column famili column famili concurr skip list map row posit column famili public final column famili store cfs privat final long creation time privat final slab alloc alloc slab alloc realli onli column alloc memtabl big wast avoid alloc privat final function column column local copi function function column column public column appli column return local copi cfs alloc public memtabl column famili store cfs cfs cfs creation time system current time milli callabl set object provid callabl set object public set object call throw avoid count onc row set object set collect set map ident hash map object boolean set add memtabl cfs metadata return set meter memori meter omit share buffer overhead tracker provid provid public long live size fudg factor base throughput live ratio calcul base observ pre slab behavior account chang introduct slab long estim size long current size cfs live ratio cap estim alloc estim size alloc minimum size return alloc minimum size estim size alloc maximum size return alloc maximum size return estim size public long serial size return current size public long oper return current oper boolean frozen return frozen void freez frozen true onli call column famili store appli public handl lock avoid submit flush memtabl ani unsaf void put decor key key column famili column famili assert frozen foolproof hell assert resolv key column famili public void updat live ratio throw runtim memori meter initi hack openjdk log warn startup script logger warn memori meter uniniti jamm specifi java agent assum live ratio usual cassandra env disabl jamm becaus buggi upgrad sun cfs live ratio return meter progress add cfs logger debug meter alreadi pend activ skip live ratio updat cfs return runnabl runnabl runnabl public void run tri activ measur memtabl long start system current time milli concurr skip list map cycl measur deep track refer object visit reduc memori overhead measur break row time long deep size meter measur column famili int object map entri row posit column famili entri column famili entri set deep size meter measur deep entri key meter measur deep entri valu object entri valu column count doubl ratio doubl deep size current size ratio logger warn set live ratio minimum ratio ratio ratio logger warn set live ratio maximum ratio ratio veri conserv estim sinc penalti guess death higher estim believ immedi averag ratio cfs live ratio cfs live ratio ratio els cfs live ratio cfs live ratio ratio logger info live ratio count calcul column object cfs cfs live ratio ratio system current time milli start object activ measur null final meter progress remov cfs meter executor submit runnabl privat void resolv decor key key column famili column famili previous column famili key previous null atom sort column doesn work super column column famili empti clone shallow super thread safe sort column factori atom sort column factori fals add column avoid wast work beaten put absent previous column famili put absent decor key key token alloc clone key key empti previous null previous empti long size delta previous add size delta alloc local copi function current size add size delta current oper add column count mark delet column count debug public string content string builder builder string builder builder append map entri row posit column famili entri column famili entri set builder append entri key append append entri valu append builder append return builder string privat tabl reader write sort content futur replay posit context throw execut interrupt logger info write long key size row posit key column famili key set don write sensic key assert key instanceof decor key key size decor key key key remain long estim size long key size index entri key size key data file current size data bloom filter row index overhead tabl reader tabl error creat writer leav empti temp file tabl writer writer cfs creat flush writer column famili size estim size context tri clear map free memori sinc memtabl queri pend flush categori map entri row posit column famili entri column famili entri set column famili entri valu mark delet pedant purg column level tombston race write tabl result unexpect behaviour delet disk lost overrid exist column valu onli remov delet column level tombston ensur delet tabl column famili store remov delet column onli integ writer append decor key entri key tabl writer close open reader catch writer abort throw util uncheck logger info string format complet flush byte commitlog posit tabl filenam file tabl filenam length context return tabl public void flush signal final count latch latch executor servic writer final futur replay posit context writer execut wrap runnabl public void run throw throw tabl reader sstabl write sort content context cfs replac flush memtabl sstabl latch count public string string return string format memtabl serial live byte op cfs column famili hash code current size live size current oper param start includ data result includ key memtabl return iter entri data start key public iter map entri decor key column famili entri iter final row posit start final row posit stop return iter map entri decor key column famili privat iter map entri row posit column famili iter stop minimum column famili tail map start entri set iter column famili map start true stop true entri set iter public boolean return iter public map entri decor key column famili map entri row posit column famili entri iter actual store key true decor key assert entri key instanceof decor key return map entri decor key column famili object entri ugli public void remov iter remov public boolean clean return column famili empti obtain iter column memtabl specifi order start column public static column iter slice iter final decor key key final column famili slice queri filter filter assert null final iter column filter iter filter revers filter start remain revers iter revers iter filter start iter filter start return abstract column iter public column famili column famili return public decor key key return key public boolean return filter iter public column return filter iter public static column iter iter final decor key key final column famili final queri filter filter assert null final boolean standard super return simpl abstract column iter privat iter byte buffer iter filter column iter public column famili column famili return public decor key key return key protect column comput iter byte buffer current iter column column column current column null clone supercolumn caller freeli remov delet otherwis mutat return standard column super column column clone return data public column famili column famili decor key key return column famili key void clear unsaf column famili clear public long creation time return creation time 