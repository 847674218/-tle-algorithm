licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra stream import java import java net inet address import java net inet socket address import java net socket import java util collect import org apach cassandra config databas descriptor import org apach cassandra column famili import org apach cassandra column famili store import org apach cassandra decor key import org apach cassandra tabl import org apach cassandra compact compact control import org apach cassandra compact precompact row import org apach cassandra gms gossip import org apach cassandra column serial import org apach cassandra sstabl import org apach cassandra util file util import org apach cassandra net outbound tcp connect import org apach cassandra servic storag servic import org apach cassandra util byte buffer util import org apach cassandra util byte read tracker import org apach cassandra util util import org apach cassandra util pair import ning compress lzf input stream import org slf logger import org slf logger factori public class incom stream reader privat static final logger logger logger factori logger incom stream reader class protect final pend file local file protect final pend file remot file protect final stream session session privat final socket socket public incom stream reader stream header header socket socket throw socket set timeout databas descriptor stream socket timeout socket socket inet address host header broadcast address null header broadcast address inet socket address socket remot socket address address header pend file empti header file null stream session creat alreadi receiv file stream session session host header session stream repli repli stream repli header session stream repli status outbound tcp connect write repli messag gossip instanc version host long string header session data output stream socket output stream throw session header session alreadi close session stream session host header session session set socket socket session add file header pend file set current file stream progress show jmx session set current file header file session set tabl header tabl pend file context local node remot file header file local file remot file null stream context map remot file null public void read throw remot file null logger debug enabl logger debug receiv stream logger debug creat file estim key local file filenam remot file estim key assert remot file estim key tabl reader reader null logger debug estim key remot file estim key data input stream dis data input stream input stream socket input stream tri reader stream dis local file remot file session finish remot file reader catch retri throw session close finish privat tabl reader stream data input input pend file local file pend file remot file throw column famili store cfs tabl open local file desc ksname column famili store local file desc cfname decor key key tabl writer writer tabl writer local file filenam remot file estim key compact control control compact control cfs collect tabl reader empti list integ true tri byte read tracker byte read tracker input pair long long section local file section long length section section left long byte read byte read length reset key tabl reader decod key storag servic partition local file desc byte buffer util read short length long data size tabl reader read row size local file desc cfs cach row key remot file type oper type data size databas descriptor memori compact limit updat row cach note becaus won echo column flag contrarili append stream doe tabl ident iter iter tabl ident iter cfs metadata key data size column serial flag precompact row row precompact row control collect singleton list iter don expir anyth row shouldn empti assert row empti writer append row row append doe updat max timestamp writer updat max timestamp row max timestamp updat cach column famili row full column famili cfs updat row cach key els writer append stream key cfs metadata data size cfs invalid cach row key byte read byte read remot file progress byte read return writer close open reader catch writer abort instanceof throw els throw util uncheck privat void retri throw sourc node stream file session retri remot file delet orphan file file local file filenam file file util delet confirm file local file filenam 