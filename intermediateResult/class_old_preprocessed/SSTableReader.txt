licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra sstabl import java import java nio byte buffer import java util import java util concurr atom atom integ import java util concurr atom atom boolean import java util concurr import org apach cassandra cach key cach key import org apach cassandra concurr debugg thread pool executor import org apach cassandra config column definit import org apach cassandra config schema import org apach cassandra index key key index import org apach cassandra dht local partition import org apach cassandra compress compress random access reader import org apach cassandra servic cach servic import org slf logger import org slf logger factori import org apach cassandra cach instrument cach import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra import org apach cassandra commitlog replay posit import org apach cassandra filter queri filter import org apach cassandra dht abstract bound import org apach cassandra dht partition import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra compress compress metadata import org apach cassandra util import org apach cassandra servic storag servic import org apach cassandra util tabl reader open tabl start creat tabl writer renam open call open exist tabl file refer column famili store post start public class tabl reader extend tabl privat static final logger logger logger factori logger tabl reader class guesstim size index entri privat static final int databas descriptor index interv max data age timestamp local server time system current time milli repres uppper bound newest piec data store sstabl word sstabl doe item creat max data age field serial disk reli truncat doe advis sstabl flush max data age set time creation sstabl creat compact max data age set max merg tabl age millisecond sinc epoc local host public final long max data age indexfil datafil null befor call load privat segment file ifil privat segment file dfile privat index summari index summari privat filter privat instrument cach key cach key long key cach privat bloom filter tracker bloom filter tracker bloom filter tracker privat final atom integ refer atom integ technic compact necessari sinc unreferenc compact good extra layer protect refer count bug delet data base alon privat final atom boolean compact atom boolean fals privat final atom boolean suspect atom boolean fals privat final tabl delet task delet task privat final tabl metadata sstabl metadata public static long approxim key count iter tabl reader sstabl long count tabl reader sstabl sstabl int index key count sstabl key sampl size count count index key count databas descriptor index interv logger debug enabl logger debug index size bloom filter calc file sstabl filenam count return count public static tabl reader open descriptor descriptor throw meta data metadata descriptor cfname int descriptor cfname index string parent descriptor cfname substr meta data parent schema instanc meta data descriptor ksname parent column definit def parent column definit index descriptor cfname substr metadata meta data index metadata parent def key index index compar els metadata schema instanc meta data descriptor ksname descriptor cfname return open descriptor metadata public static tabl reader open descriptor desc meta data metadata throw partition desc cfname local partition metadata key valid storag servic partition return open desc compon desc metadata public static tabl reader open valid descriptor descriptor set compon compon meta data metadata throw return open descriptor compon collect decor key empti set metadata storag servic partition fals public static tabl reader open descriptor descriptor set compon compon meta data metadata partition partition throw return open descriptor compon collect decor key empti set metadata partition public static tabl reader open descriptor descriptor set compon compon set decor key save key meta data metadata partition partition throw return open descriptor compon save key metadata partition true privat static tabl reader open descriptor descriptor set compon compon set decor key save key meta data metadata partition partition boolean valid throw assert partition null minimum compon anyth assert compon compon data compon sstabl descriptor assert compon compon primari index compon sstabl descriptor long start system current time milli logger info open byte descriptor file descriptor filenam length tabl metadata sstabl metadata compon compon tabl metadata serial deseri descriptor tabl metadata creat default instanc check sstabl creat partition partition null indic older version sstabl stat avail case skip check string partition partition class canon sstabl metadata partition null partition equal sstabl metadata partition throw runtim string format open becaus partition doe match descriptor partition tabl reader sstabl tabl reader descriptor compon metadata partition null null null null system current time milli sstabl metadata version befor encod key utf befor hash filter descriptor string bloom filter sstabl load true save key els sstabl load fals save key sstabl load bloom filter valid sstabl valid logger debug enabl logger debug descriptor system current time milli start logger debug enabl sstabl key cach null logger debug string format key cach key sstabl key cach size sstabl key cach capac return sstabl public static void log open descriptor descriptor instanceof file logger error sstabl compon descriptor skip becaus messag els logger error corrupt sstabl descriptor skip public static collect tabl reader batch open set map entri descriptor set compon entri final set decor key save key final data tracker tracker final meta data metadata final partition partition final collect tabl reader sstabl link block queue tabl reader executor servic executor debugg thread pool executor creat fix pool size tabl batch open util avail processor final map entri descriptor set compon entri entri runnabl runnabl runnabl public void run tabl reader sstabl tri sstabl open entri key entri valu save key metadata partition catch logger error corrupt sstabl entri skip return sstabl add sstabl executor submit runnabl executor shutdown tri executor await termin time unit catch interrupt throw assert error return sstabl open row index reader alreadi state initi tabl writer static tabl reader intern open descriptor desc set compon compon meta data metadata partition partition segment file ifil segment file dfile index summari isummari filter long max data age tabl metadata sstabl metadata throw assert desc null partition null ifil null dfile null isummari null null sstabl metadata null return tabl reader desc compon metadata partition ifil dfile isummari max data age sstabl metadata privat tabl reader descriptor desc set compon compon meta data metadata partition partition segment file ifil segment file dfile index summari index summari filter bloom filter long max data age tabl metadata sstabl metadata throw super desc compon metadata partition sstabl metadata sstabl metadata max data age max data age ifil ifil dfile dfile index summari index summari bloom filter delet task tabl delet task public void set track data tracker tracker key cach cach servic instanc key cach delet task set tracker tracker void load bloom filter throw compon compon bloom filter empti filter return data input stream stream null tri stream data input stream buffer input stream file input stream descriptor filenam compon descriptor bloom filter legaci bloom filter serial deseri stream els bloom filter serial deseri stream final file util close quiet stream load ifil dfile index summari option recreat bloom filter privat void load boolean recreatebloom set decor key key load cach throw boolean cach load key load cach empti cach load key cach null key cach cach servic instanc key cach segment file builder ibuild segment file builder databas descriptor index access mode segment file builder dbuilder compress segment file compress builder segment file builder databas descriptor disk access mode read posit don worri entri span mmap boundari random access reader input random access reader open file descriptor filenam compon true decor key left null null tri long index size input length long histogram count sstabl metadata estim row size count long estim key histogram count sstabl metadata estim row size overflow histogram count tabl estim row index input statist suppos option index summari index summari estim key recreatebloom legaci bloom filter filter estim key true long index posit input file pointer index posit index size break decor key decor key null int len byte buffer util read short length input boolean key left null boolean key index posit constant short size len constant long size index size boolean add entri index summari add entri add entri cach load recreatebloom key key decor key decod key partition descriptor byte buffer util read input len key left decor key key decor key els file util skip byte fulli input len long data posit input read long decor key null recreatebloom add decor key key add entri index summari add entri decor key index posit key cach key alreadi pre load cach load key load cach decor key cach key decor key data posit index summari increment rowid ibuild add potenti boundari index posit dbuilder add potenti boundari data posit index summari complet final file util close quiet input minim key left minim key final state reader ifil ibuild complet descriptor filenam compon dfile dbuilder complet descriptor filenam compon privat void valid compar throw illeg state string format tabl key key posit index file start scan find key index interv key privat long index scan posit row posit key assert index summari key null index summari key size int index collect binari search index summari key key index binari search give index greater key search insert posit int greater index greater return return index summari posit greater els return index summari posit index return compress metadata sstabl throw illeg state sstabl compress public compress metadata compress metadata compress throw illeg state compress return compress segment file dfile metadata test purpos onli public void forc filter failur legaci bloom filter alway match bloom filter public filter bloom filter return public long bloom filter serial size descriptor bloom filter return legaci bloom filter serial serial size legaci bloom filter els return bloom filter serial serial size bloom filter return estim number key tabl public long estim key return index summari key size databas descriptor index interv param rang return estim number key rang tabl public long estim key rang collect rang token rang long sampl key count list pair integ integ sampl index sampl index rang index summari key rang pair integ integ sampl index rang sampl index sampl key count sampl index rang sampl index rang left return math max sampl key count databas descriptor index interv return approxim lth key tabl public collect decor key key sampl return index summari key privat static list pair integ integ sampl index rang list decor key sampl collect rang token rang index determin minim section rang list pair integ integ posit array list pair integ integ sampl empti return posit rang token rang rang normal rang row posit left posit rang left max key bound row posit posit rang max key bound int left collect binari search sampl left posit left left left els left rang start exclus left left left sampl size left sampl continu int rang wrap rang left rang sampl size collect binari search sampl posit rang inclus previous index binari search give sinc index return key alreadi stric greater bound continu left empti rang continu posit add pair integ valu left integ valu return posit public iter decor key key sampl final rang token rang final list decor key sampl index summari key final list pair integ integ index rang sampl index rang sampl collect singleton list rang index rang empti return collect empti list return iter decor key public iter decor key iter return iter decor key privat iter pair integ integ rang iter index rang iter privat pair integ integ current privat int idx public boolean current null idx current rang iter current rang iter idx current left return true return fals return true public decor key row posit sampl idx index onli valid row key onli row posit key posit search purpos assert instanceof decor key return decor key public void remov throw unsupport oper determin minim set section extract tabl cover rang return sort list offset pair cover rang datafil tabl public list pair long long posit rang collect rang token rang index determin minim section rang list pair long long posit array list pair long long rang token rang rang normal rang abstract bound row posit key rang rang row bound long left posit key rang left oper left left file continu long posit key rang oper rang wrap rang left rang file wrap uncompress length left empti rang continu posit add pair long valu left long valu return posit public void cach key decor key key long info meta data cach cach metadata cach key cach null cach meta data cach cach meta data cach key cach capac return avoid perman refer origin key buffer key cach key cach key key cach key descriptor byte buffer util clone key key logger trace ad cach entri cach key info key cach put cach key info public long cach posit decor key key boolean updat stat return cach posit key cach key descriptor key key updat stat privat long cach posit key cach key unifi key boolean updat stat key cach null key cach capac return updat stat key cach unifi key key cach intern unifi key return null posit updat key cach stat posit org apach cassandra row posit org apach cassandra sstabl tabl reader oper boolean public long posit row posit key oper return posit key true param key key appli rhs oper fake key key select token bound onli param oper defin match key nearest key target match oper win param updat cach stat true updat stat cach return posit data file find key key present public long posit row posit key oper boolean updat cach stat check bloom filter oper assert key instanceof decor key onli sens key valid row key present decor key key key return key cach onli sens valid row key oper oper key instanceof decor key decor key decor key decor key key key cach key cach key key cach key descriptor decor key key long cach posit cach posit cach key updat cach stat cach posit null logger trace cach hit cach key cach posit return cach posit sampl index imposs key present long sampl posit index scan posit key sampl posit oper updat cach stat bloom filter tracker add fals posit match posit oper match return posit return appli scan disk index start nearest sampl posit iter file data input segment ifil iter sampl posit segment file data input input segment tri input read key data posit index entri decor key index decor key decod key partition descriptor byte buffer util read short length input long data posit input read long int comparison index decor key compar key int appli comparison comparison assert key instanceof decor key key index key onli true row key decor key decor key decor key key logger trace enabl expens saniti check file data input fdi dfile segment data posit decor key key disk tabl reader decod key partition descriptor byte buffer util read short length fdi key disk equal key throw assert error string format key disk key fdi path fdi close key cach null key cach capac updat cach stat store exact match key cach key decor key data posit oper updat cach stat bloom filter tracker add true posit return data posit oper updat cach stat bloom filter tracker add fals posit return catch mark suspect throw error final file util close quiet input oper updat cach stat bloom filter tracker add fals posit return return length byte data tabl compress file disk size disk length public long uncompress length return dfile length return length byte disk size tabl compress file data length length public long disk length return dfile disk length public boolean acquir refer true int refer return fals refer compar set return true public void releas refer refer decrement compact forc final mmap necessari ifil cleanup dfile cleanup delet task schedul assert refer refer counter refer dfile path mark sstabl compact call function caller ensur tabl reader referenc anywher thread hold refer return true time file mark compact rare data tracker unmark compact call multipl time buggi public boolean mark compact logger debug enabl logger debug mark filenam compact return compact set true public void mark suspect logger debug enabl logger debug mark filenam suspect blacklist suspect set true public boolean mark suspect return suspect param filter filter read column return scanner seek row tabl public tabl scanner scanner queri filter filter return tabl scanner filter direct tabl scanner return scanner seek row tabl public tabl scanner direct scanner return tabl scanner true direct tabl scanner defin rang token param rang rang key cover return scanner seek row tabl public tabl scanner direct scanner rang token rang rang null return direct scanner return tabl bound scanner true rang public file data input file data input decor key decor key long posit posit decor key oper posit return null return dfile segment posit test sstabl data newer age param localhost current milli time work conjunct max data age upper bound creat data sstabl param age age compar max data sstabl measur millisec sinc epoc host return true iff sstabl data newer age paramet public boolean sinc long age return max data age age public static long read row size data input descriptor throw int row size return read int return read long public void creat link string snapshot directori path throw compon compon compon file sourc file file descriptor filenam compon file target link file snapshot directori path sourc file librari creat hard link sourc file target link condit deprec partition convert disk format method public static decor key decod key partition descriptor byte buffer byte encod key return convert disk format byte return decor key byte move someplac reusabl public abstract static class oper public static final oper equal public static final oper greater equal public static final oper greater param comparison result call compar compar desir field rhs return oper match match greater match public abstract int appli int comparison final static class equal extend oper public int appli int comparison return comparison final static class greater equal extend oper public int appli int comparison return comparison comparison final static class greater extend oper public int appli int comparison return comparison public long bloom filter fals posit count return bloom filter tracker fals posit count public long bloom filter fals posit count return bloom filter tracker fals posit count public long bloom filter true posit count return bloom filter tracker true posit count public long bloom filter true posit count return bloom filter tracker true posit count public instrument cach key cach key long key cach return key cach public estim histogram estim row size return sstabl metadata estim row size public estim histogram estim column count return sstabl metadata estim column count public doubl compress ratio return sstabl metadata compress ratio public replay posit replay posit return sstabl metadata replay posit public long max timestamp return sstabl metadata max timestamp public set integ ancestor return sstabl metadata ancestor public random access reader open data reader boolean skip cach throw return compress compress random access reader open filenam compress metadata skip cach random access reader open file filenam skip cach param sstabl return true desir refer acquir otherwis unrefer ani partial acquisit return fals public static boolean acquir refer iter tabl reader sstabl tabl reader fail null tabl reader sstabl sstabl sstabl acquir refer fail sstabl break fail null return true tabl reader sstabl sstabl sstabl fail break sstabl releas refer return fals public static void releas refer iter tabl reader sstabl tabl reader sstabl sstabl tri sstabl releas refer catch logger error fail releas refer sstabl 