licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java import java nio byte buffer import java util import googl common collect iter import googl common collect map import org slf logger import org slf logger factori import org apach cassandra columniter column iter import org apach cassandra columniter tabl column iter import org apach cassandra columniter simpl abstract column iter import org apach cassandra compact size tier compact strategi import org apach cassandra filter queri filter import org apach cassandra filter queri filter import org apach cassandra marshal counter column type import org apach cassandra sstabl tabl import org apach cassandra sstabl tabl reader import org apach cassandra util file util import org apach cassandra util closeabl iter public class collat control privat static logger logger logger factori logger collat control class privat final column famili store cfs privat final boolean mutabl column privat final queri filter filter privat final int befor privat int sstabl iter public collat control column famili store cfs boolean mutabl column queri filter filter int befor cfs cfs mutabl column mutabl column filter filter befor befor public column famili top level column return filter filter instanceof queri filter cfs metadata type column famili type standard filter path super column null cfs metadata default valid counter column type instanc collect time order data collect data collect data order recenc sstabl maxtimestamp data onc data request column newer newest remain maxtimestamp stop privat column famili collect time order data logger debug collect time order data atom sort column doesn work super columi sort column factori factori mutabl column cfs metadata type column famili type super thread safe sort column factori atom sort column factori tree map sort column factori column famili column famili creat cfs metadata factori filter filter revers list column iter iter array list column iter column famili store view fragment view cfs mark referenc filter key tri memtabl memtabl view memtabl column iter iter filter memtabl column iter memtabl iter null iter add iter delet iter column famili iter add column iter avoid chang filter column origin filter reduc filter remov column irrelev tree set byte buffer filter column tree set byte buffer queri filter filter filter column queri filter reduc filter queri filter filter key filter path queri filter filter column add tabl disk collect sort view sstabl tabl max timestamp compar read sort sstabl long row tombston long tabl reader sstabl view sstabl alreadi row tombston timestamp greater updat sstabl sinc rest sstabl older sstabl max timestamp row tombston break long current max sstabl max timestamp reduc filter reduc filter current max queri filter reduc filter filter column empti break column iter iter reduc filter tabl column iter sstabl iter add iter iter column famili null column famili iter column famili mark delet track row level tombston encount row tombston mark delet delet sstabl iter iter add column iter distinguish data row rebuild effici data cach empti don rebuild slower iter empti return null final collat collat boilerpl requir provid closeabl iter final column famili closeabl iter column collat simpl abstract column iter final iter column iter iter protect column comput return iter iter data public column famili column famili return public decor key key return filter key column famili return clone shallow filter collat column return collect singleton list collat befor hoist request data sstabl sstabl iter cfs minimum compact threshold cfs compact disabl cfs compact strategi instanceof size tier compact strategi row mutat row mutat cfs tabl row filter key return clone tri skip commitlog index updat fine sinc fragment exist data tabl open tabl appli fals fals catch log result return logger error error write read result caller respons final remov delet import cach row work correct return return final column iter iter iter file util close quiet iter tabl reader releas refer view sstabl remov column param filter alreadi data param return newer param sstabl timestamp privat void reduc filter queri filter filter column famili return long sstabl timestamp abstract column filter path super column null return super column return column filter path super column don ani inform null sstabl timestamp long return iter byte buffer iter queri filter filter filter column iter iter byte buffer filter column iter column column column filter column column null column timestamp sstabl timestamp iter remov collect data brute forc iter filter question everi memtabl sstabl merg togeth privat column famili collect data logger debug collect data atom sort column doesn work super column sort column factori factori mutabl column cfs metadata type column famili type super thread safe sort column factori atom sort column factori array sort column factori column famili store view fragment view cfs mark referenc filter key list column iter iter array list column iter iter size view memtabl view sstabl size column famili return column famili creat cfs metadata factori filter filter revers tri memtabl memtabl view memtabl column iter iter filter memtabl column iter memtabl iter null return delet iter column famili iter add iter long row tombston long tabl reader sstabl view sstabl alreadi row tombston timestamp greater updat sstabl skip sstabl max timestamp row tombston continu column iter iter filter tabl column iter sstabl iter add iter iter column famili null column famili iter column famili mark delet row tombston mark delet return delet sstabl iter row tombston pass iter obtain sstabl drop ani max timestamp row tombston row tombston long iter column iter iter iter column iter iter iter instanceof tabl column iter tabl column iter iter stabl max timestamp row tombston file util close quiet iter remov distinguish data row rebuild effici data cach empti don rebuild slower iter empti return null filter collat column return iter befor caller respons final remov delet import cach row work correct return return final column iter iter iter file util close quiet iter tabl reader releas refer view sstabl public int sstabl iter return sstabl iter 