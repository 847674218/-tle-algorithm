licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java error import java import java nio byte buffer import java util array list import java util collect import java util collect import java util compar import java util iter import java util list import java util map import java util sort set import java util tree set import java util concurr concurr hash map import java util concurr execut import java util concurr futur import java util concurr lock reentrant read write lock import org apach cassandra config import org apach cassandra commitlog commit log import org apach cassandra filter queri filter import org apach cassandra filter queri path import org apach cassandra sstabl tabl reader import org apach cassandra locat abstract replic strategi import org apach cassandra servic storag servic import org apach cassandra util byte buffer util import org apach cassandra util util import org apach cassandra util node import org slf logger import org slf logger factori import googl common base function import googl common collect iter repres keyspac public class tabl public static final string system privat static final logger logger logger factori logger tabl class access memtabl acquir thread safeti mayb switch memtabl aquir write lock method full explan enabl fair observ decreas throughput leav public static final reentrant read write lock switch lock reentrant read write lock possibl call tabl open run daemon sens ensur proper directori cassandra daemon static storag servic instanc client mode tri databas descriptor creat directori catch throw error tabl public final string column famili store column famili privat final map integ column famili store column famili store concurr hash map integ column famili store privat final object index lock privat volatil abstract replic strategi replic strategi public static tabl open string tabl return open tabl schema instanc true public static tabl open tabl string tabl return open tabl schema instanc fals privat static tabl open string tabl schema schema boolean load tabl tabl tabl instanc schema tabl instanc tabl tabl instanc null instanti tabl put absent import onli onc keyspac synchron check befor synchron tabl class tabl instanc schema tabl instanc tabl tabl instanc null open store tabl tabl instanc tabl tabl load tabl schema store tabl instanc tabl instanc tabl construct cach befor cach row call column famili store cfs tabl instanc column famili store cfs init row cach return tabl instanc public static tabl clear string tabl throw return clear tabl schema instanc public static tabl clear string tabl schema schema throw synchron tabl class tabl schema remov tabl instanc tabl null column famili store cfs column famili store unload cfs return public collect column famili store column famili store return collect unmodifi collect column famili store valu public column famili store column famili store string integ schema instanc null throw illeg argument string format unknown tabl pair return column famili store public column famili store column famili store integ column famili store cfs column famili store cfs null throw illeg argument unknown return cfs cleanup key belong local public void forc cleanup node shot renew renew throw execut interrupt equal throw unsupport oper cleanup system tabl necessari wise sort column famili order tabl size cleanup smaller free space larger list column famili store sort column famili array list column famili store column famili store valu collect sort sort column famili compar column famili store compar size equal sort arbitrari determinist public int compar column famili store column famili store long diff total disk space total disk space diff return diff return return column famili compar column famili cleanup sort order free space larger column famili store cfs sort column famili cfs forc cleanup renew snapshot specif column famili entir set column famili column famili null timestamp param snapshot tag associ snapshot valu null param column famili column famili snapshot null throw column famili doesn exist public void snapshot string snapshot string column famili throw assert snapshot null boolean snap shot fals column famili store store column famili store valu column famili null store column famili equal column famili snap shot true store snapshot snapshot column famili null snap shot throw fail snapshot column famili column famili doe exist param client suppli null return snapshot public static string timestamp snapshot string client suppli string snapshot long string system current time milli client suppli null client suppli equal snapshot snapshot client suppli return snapshot check snapshot alreadi exist param snapshot user suppli snapshot return true snapshot exist public boolean snapshot exist string snapshot assert snapshot null column famili store store column famili store valu store snapshot exist snapshot return true return fals clear snapshot tabl param snapshot user suppli snapshot empti null snapshot clean public void clear snapshot string snapshot throw column famili store store column famili store valu store clear snapshot snapshot return list open tabl reader public list tabl reader tabl list tabl reader list array list tabl reader column famili store size column famili store store column famili store valu list add store tabl return list privat tabl string tabl boolean load tabl tabl meta data ksm schema instanc meta data tabl assert ksm null unknown keyspac tabl tri creat replic strategi ksm catch configur throw runtim index lock object databas descriptor concurr writer int index lock length index lock object meta data cfm array list meta data schema instanc tabl definit tabl meta data valu logger debug initi cfm init cfm cfm load tabl public void creat replic strategi meta data ksm throw configur replic strategi null storag servic instanc token metadata unregist replic strategi replic strategi abstract replic strategi creat replic strategi ksm ksm strategi class storag servic instanc token metadata databas descriptor endpoint snitch ksm strategi option invok compact manang public void drop integ throw assert column famili store key column famili store cfs column famili store remov cfs null return unload cfs disassoci cfs tabl instanc privat void unload column famili store cfs throw tri cfs forc block flush catch execut throw catch interrupt throw cfs invalid add intern structur creat disk file public void init integ string boolean load tabl column famili store key case reset local schema reload metadata column famili store cfs column famili store assert cfs column famili equal tri cfs metadata reload cfs reload catch throw util uncheck els column famili store put column famili store creat column famili store load tabl public row row queri filter filter throw column famili store store column famili store filter column famili column famili column famili store column famili filter array sort column factori return row filter key column famili public void appli row mutat mutat boolean write commit log throw appli mutat write commit log true method add row commit log associ tabl onc happen data associ individu column famili written column famili store memtabl public void appli row mutat mutat boolean write commit log boolean updat index throw logger debug enabl logger debug appli mutat row byte buffer util byte hex mutat key write mutat commitlog memtabl switch lock read lock lock tri write commit log commit log instanc add mutat decor key key storag servic partition decor key mutat key column famili mutat column famili column famili store cfs column famili store cfs null logger error attempt mutat exist column famili continu sort set byte buffer mutat index column null updat index byte buffer column cfs index manag index column column column mark delet mutat index column null mutat index column tree set byte buffer compar mutat index column add column logger debug enabl actual valid print valu becaus overload valu delet timestamp form valu column type byte buffer valu column column null null column column valu null row level delet logger debug string format mutat index column valu compar string column valu null null byte buffer util byte hex valu shard lock insuffici avoid content hot row hint write node key target worth special case index case avoid synchron mutat index column null cfs appli key continu els mutat index column null synchron index lock mutat key raw data appli everi updat ani order read time resolut throw obsolet version avoid read befor write index data creat index entri obsolet write column famili index column read current index column key cfs mutat index column logger debug pre mutat index row index column ignor obsolet mutat mutat index column index column cfs appli key ignor full index memtabl flush master full cfs index manag appli index updat mutat key mutat index column index column final switch lock read lock unlock privat static void ignor obsolet mutat column famili sort set byte buffer mutat index column column famili index column modifi object race write https issu apach org jira brows index column null return iter byte buffer iter mutat index column iter iter byte buffer iter column column column null row delet wouldn mark mutat column null mark delet row mark delet column updat column timestamp row tombston treat didn exist otherwis don care row tombston purpos index updat proceed usual column timestamp mark delet don remov object race commit log write leav harmless column null column column index column column delet irrelev index chang state live delet updat newer tombston doesn matter boolean delet column null column mark delet column null column mark delet obsolet row column timestamp appli older exist data boolean obsolet row tombston column null column null mark delet column timestamp boolean obsolet column column null column timestamp index column mark delet column null column reconcil column column delet obsolet row tombston obsolet column logger debug enabl logger debug skip index updat obsolet mutat compar string iter remov index column remov privat static column famili read current index column decor key key column famili store cfs sort set byte buffer mutat index column queri filter filter queri filter filter key queri path cfs column famili mutat index column return cfs column famili filter public abstract replic strategi replic strategi return replic strategi param key row index param cfs column famili index row param index column column index compar order public static void index row decor key key column famili store cfs sort set byte buffer index column logger debug enabl logger debug index row cfs metadata key valid string key key switch lock read lock lock tri synchron cfs tabl index lock key key column famili read current index column key cfs index column null tri cfs index manag appli index updat key key column null catch throw error final switch lock read lock unlock privat object index lock byte buffer key return index lock math ab key hash code index lock length public list futur flush throw list futur futur array list futur integ column famili store key set futur futur column famili store forc flush futur null futur add futur return futur public static iter tabl function string tabl transform function string tabl public tabl appli string tabl return tabl open tabl return iter transform schema instanc tabl transform overrid public string string return class simpl 