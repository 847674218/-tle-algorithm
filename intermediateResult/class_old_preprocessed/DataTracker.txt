licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java file import java util import java util concurr copi write array list import java util concurr atom atom long import java util concurr atom atom refer import googl common collect import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra compact oper type import org apach cassandra sstabl tabl reader import org apach cassandra notif notif import org apach cassandra notif notif consum import org apach cassandra notif tabl ad notif import org apach cassandra notif tabl list chang notif import org apach cassandra servic storag servic import org apach cassandra util interv tree interv import org apach cassandra util interv tree interv tree import org apach cassandra util wrap runnabl public class data tracker privat static final logger logger logger factori logger data tracker class public collect notif consum subscrib copi write array list notif consum public final column famili store cfstore privat final atom refer view view disk live total size privat final atom long live size atom long privat final atom long total size atom long public data tracker column famili store cfstore cfstore cfstore view atom refer view init public memtabl memtabl return view memtabl public set memtabl memtabl pend flush return view memtabl pend flush public list tabl reader tabl return view sstabl public set tabl reader uncompact tabl return view compact stabl public view view return view switch current memtabl atom add current memtabl memtabl pend flush replac fresh memtabl return previous current memtabl ad pend flush public memtabl switch memtabl atom chang current memtabl memtabl memtabl memtabl cfstore memtabl flush memtabl view current view view current view view flush memtabl current view memtabl view current view switch memtabl memtabl view compar set current view view return flush memtabl renew current memtabl put flush flush memtabl clean case chang becaus frozen public void renew memtabl memtabl memtabl memtabl cfstore view current view view current view view view current view renew memtabl memtabl view compar set current view view public void replac flush memtabl memtabl tabl reader sstabl cfstore valid view current view view current view view view current view replac flush memtabl sstabl replac array list sstabl collect tabl reader empti list view compar set current view view return view current view view current view view view current view replac flush memtabl sstabl view compar set current view view add tabl size array list sstabl notifi ad sstabl increment backup sstabl public void increment backup final tabl reader sstabl databas descriptor increment backup enabl return runnabl runnabl wrap runnabl protect void run throw throw file backup dir directori backup directori sstabl descriptor sstabl creat link backup dir canon path storag servic task execut runnabl return subset activ sstabl mark compact null threshold met file mark compact unmark unmark compact note acquir refer mark sstabl releas unmark compact sinc call mark compact sstabl mark compact bug skip public set tabl reader mark compact collect tabl reader tomark int min int max max min max return null tomark null tomark empti return null view current view view set tabl reader subset null order preserv set copi input set tabl reader remain link hash set tabl reader tomark current view view find subset activ alreadi compact remain remov current view compact remain retain current view sstabl remain size min meet min threshold return null cap newli compact item subset set subset hash set tabl reader iter tabl reader iter remain iter int ad ad max iter ad subset add iter view current view mark compact subset view compar set current view view return subset remov file compact status differ mark compact becaus run compact succeed public void unmark compact collect tabl reader unmark cfstore valid don origin compact suceed fail difficult sstabl refer alreadi releas good approach mark sstabl involv compact compact succeed harmless redund fail ensur sstabl delet restart tabl reader sstabl unmark sstabl mark compact view current view view current view view view current view unmark compact unmark view compar set current view view public void mark compact collect tabl reader sstabl oper type compact type replac sstabl collect tabl reader empti list notifi tabl chang sstabl collect tabl reader empti list compact type public void replac compact tabl collect tabl reader sstabl iter tabl reader replac oper type compact type replac sstabl replac notifi tabl chang sstabl replac compact type public void add initi tabl collect tabl reader sstabl replac collect tabl reader empti list sstabl notif backup necessari public void add tabl collect tabl reader sstabl replac collect tabl reader empti list sstabl tabl reader sstabl sstabl increment backup sstabl notifi ad sstabl remov sstabl busi compact public void unrefer tabl set tabl reader compact view current view view current view view compact current view compact stabl view current view replac compact collect tabl reader empti set view compar set current view view compact empti notifi tabl chang level manifest promot doesn promot return notifi tabl chang compact collect tabl reader empti set oper type post replac compact collect tabl reader empti set initi tracker purg refer void init view set view memtabl cfstore collect memtabl empti set collect tabl reader empti list collect tabl reader empti set interv tree privat void replac collect tabl reader tabl iter tabl reader replac cfstore valid remov tabl size replac replac collect empti list view current view view current view view view current view replac tabl replac view compar set current view view post replac tabl replac privat void post replac collect tabl reader tabl iter tabl reader replac add tabl size replac remov tabl size tabl privat void add tabl size iter tabl reader tabl tabl reader sstabl tabl assert sstabl key sampl null logger debug enabl logger debug string format ad list file track sstabl descriptor cfstore tabl cfstore column famili long size sstabl byte disk live size add size total size add size sstabl set track privat void remov tabl size iter tabl reader tabl tabl reader sstabl tabl logger debug enabl logger debug string format remov list file track sstabl descriptor cfstore tabl cfstore column famili live size add sstabl byte disk boolean compact sstabl mark compact assert compact sstabl alreadi mark compact sstabl releas refer public long live size return live size public long total size return total size public void space reclaim long size total size add size public long estim key long tabl reader sstabl tabl sstabl estim key return public long estim row size histogram long histogram long tabl reader sstabl tabl long row size sstabl estim row size bucket fals int histogram length histogram row size return histogram public long estim column count histogram long histogram long tabl reader sstabl tabl long column size sstabl estim column count bucket fals int histogram length histogram column size return histogram public doubl compress ratio doubl sum int total tabl reader sstabl tabl sstabl compress ratio doubl sum sstabl compress ratio total return total doubl sum total public long min row size long min tabl reader sstabl tabl min sstabl estim row size min min min sstabl estim row size min return min public long max row size long max tabl reader sstabl tabl sstabl estim row size max max max sstabl estim row size max return max public long row size long sum long count tabl reader sstabl tabl sum sstabl estim row size count return count sum count public int column long sum int count tabl reader sstabl tabl sum sstabl estim column count count return count int sum count public long bloom filter fals posit long count tabl reader sstabl tabl count sstabl bloom filter fals posit count return count public long bloom filter fals posit long count tabl reader sstabl tabl count sstabl bloom filter fals posit count return count public doubl bloom filter fals ratio long fals count long true count tabl reader sstabl tabl fals count sstabl bloom filter fals posit count true count sstabl bloom filter true posit count fals count true count return return doubl fals count true count fals count public doubl bloom filter fals ratio long fals count long true count tabl reader sstabl tabl fals count sstabl bloom filter fals posit count true count sstabl bloom filter true posit count fals count true count return return doubl fals count true count fals count public void notifi tabl chang iter tabl reader remov iter tabl reader ad oper type compact type notif consum subscrib subscrib notif notif tabl list chang notif ad remov compact type subscrib handl notif notif public void notifi ad tabl reader ad notif consum subscrib subscrib notif notif tabl ad notif ad subscrib handl notif notif public void subscrib notif consum consum subscrib add consum public void unsubscrib notif consum consum boolean subscrib remov consum assert consum subscrib public static interv tree tabl reader build interv tree iter tabl reader sstabl list interv interv array list interv iter size sstabl tabl reader sstabl sstabl interv add interv tabl reader sstabl sstabl sstabl return interv tree tabl reader interv immut structur hold current memtabl memtabl pend flush sstabl column famili sstabl activ compact subset sstabl static class view public final memtabl memtabl public final set memtabl memtabl pend flush public final set tabl reader compact sort set becaus order maintain sort set explicit compar provid consist equal immut sort set ignor ani object compar equal exist set member obvious drop sstabl max column timestamp happen equal anoth accept list public final list tabl reader sstabl public final interv tree tabl reader interv tree view memtabl memtabl set memtabl pend flush list tabl reader sstabl set tabl reader compact interv tree tabl reader interv tree memtabl memtabl memtabl pend flush pend flush sstabl sstabl compact compact interv tree interv tree public set set view tabl reader compact stabl return set differ immut set copi sstabl compact public view switch memtabl memtabl memtabl set memtabl pend immut set memtabl builder add memtabl pend flush add memtabl build return view memtabl pend sstabl compact interv tree public view renew memtabl memtabl memtabl return view memtabl memtabl pend flush sstabl compact interv tree public view replac flush memtabl flush memtabl tabl reader tabl set memtabl pend immut set copi set differ memtabl pend flush collect singleton flush memtabl list tabl reader tabl tabl tabl interv tree interv tree build interv tree tabl return view memtabl pend collect unmodifi list tabl compact interv tree public view replac collect tabl reader tabl iter tabl reader replac list tabl reader tabl tabl tabl replac interv tree interv tree build interv tree tabl return view memtabl memtabl pend flush collect unmodifi list tabl compact interv tree public view mark compact collect tabl reader tomark set tabl reader compact immut set tabl reader builder add compact add tomark build return view memtabl memtabl pend flush sstabl compact interv tree public view unmark compact collect tabl reader tounmark set tabl reader compact immut set copi set differ compact immut set copi tounmark return view memtabl memtabl pend flush sstabl compact interv tree privat list tabl reader tabl tabl reader tabl perform sensit don obsess select merg return tabl collect tabl reader empti list collect singleton list tabl privat list tabl reader tabl collect tabl reader tabl iter tabl reader replac immut set tabl reader set immut set copi tabl int tabl size sstabl size tabl size iter size replac assert tabl size iter size replac string format incoher size replac tabl size tabl replac list tabl reader tabl array list tabl reader tabl size tabl reader sstabl sstabl set sstabl tabl add sstabl iter add tabl replac assert tabl size tabl size string format expect size replac tabl size tabl size tabl replac return tabl overrid public string string return string format view pend count sstabl compact memtabl pend flush size sstabl compact 