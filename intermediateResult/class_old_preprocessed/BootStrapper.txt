licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra dht import java import java net inet address import java util import java util concurr time unit import java util concurr lock condit import googl common base charset import org apach cassandra config schema import org apach cassandra gms import org apach common lang array util import org slf logger import org slf logger factori import org apach cassandra config configur import org apach cassandra config databas descriptor import org apach cassandra tabl import org apach cassandra locat abstract replic strategi import org apach cassandra locat token metadata import org apach cassandra net async callback import org apach cassandra net verb handler import org apach cassandra net messag import org apach cassandra net messag servic import org apach cassandra servic storag servic import org apach cassandra stream oper type import org apach cassandra util util import org apach cassandra util simpl condit public class boot strapper privat static final logger logger logger factori logger boot strapper class endpoint bootstrap protect final inet address address token node bootstrap protect final token token protect final token metadata token metadata privat static final long default bootstrap timeout public boot strapper inet address address token token token metadata tmd assert address null assert token null address address token token token metadata tmd public void bootstrap throw logger debug enabl logger debug bootstrap process rang streamer streamer rang streamer token metadata address oper type streamer add sourc filter rang streamer failur detector sourc filter failur detector instanc string tabl schema instanc system tabl abstract replic strategi strategi tabl open tabl replic strategi streamer add rang tabl strategi pend address rang token metadata token address streamer fetch storag servic instanc finish bootstrap initialtoken specifi otherwis pick token assum load load node public static token bootstrap token final token metadata metadata final map inet address doubl load throw configur user specifi token databas descriptor initi token null logger debug token manual specifi databas descriptor initi token token token storag servic partition token factori string databas descriptor initi token metadata endpoint token null throw configur bootstrap exist token token decommiss removetoken node return token schema join exist cluster balanc token map entri inet address endpoint state entri gossip instanc endpoint state entri key equal util broadcast address skip ourselv avoid confus test alway load schema continu version valu schema valu entri valu applic state applic state schema valu null schema valu valu equal schema empti version string return balanc token metadata load schema pick random token multipl seed start simultan cluster don token return storag servic partition random token public static token balanc token token metadata metadata map inet address doubl load inet address max endpoint bootstrap sourc metadata load token bootstrap token max endpoint logger info token assum load max endpoint return static inet address bootstrap sourc final token metadata metadata final map inet address doubl load sort number node alreadi bootstrap sourc node rang load list inet address endpoint array list inet address load size inet address endpoint load key set metadata member endpoint continu endpoint add endpoint endpoint empti throw runtim node unabl bootstrap intend start singl node cluster broadcast address listen address list seed otherwis determin whi seed contact knowledg rest cluster usual solv give node seed list collect sort endpoint compar inet address public int compar inet address inet address int metadata pend rang chang int metadata pend rang chang return target prioriti doubl load load doubl load load load load return return load load inet address max endpoint endpoint endpoint size assert max endpoint equal util broadcast address metadata pend rang chang max endpoint throw runtim everi node bootstrap sourc pleas specifi initi token manual wait exist bootstrap oper finish return max endpoint static token bootstrap token inet address max endpoint messag messag messag util broadcast address storag servic verb array util gossip instanc version max endpoint int retri long timeout math max messag servic default callback timeout retri bootstrap token callback btc bootstrap token callback messag servic instanc send messag max endpoint btc timeout token token btc token timeout token null return token retri throw runtim bootstrap fail obtain token max endpoint public static class bootstrap token verb handler implement verb handler public void verb messag messag string storag servic storag servic instanc string token string storag servic partition token factori string bootstrap token messag respons messag intern repli token string byte charset messag version messag servic instanc send repli respons messag privat static class bootstrap token callback implement async callback privat volatil token token privat final condit condit simpl condit public token token long timeout boolean success tri success condit await timeout time unit catch interrupt throw runtim return success token null public void respons messag msg token storag servic partition token factori string string msg messag bodi charset condit signal public boolean latenc snitch return fals 