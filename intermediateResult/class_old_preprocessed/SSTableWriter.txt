licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra sstabl import java import java nio byte buffer import java util import java util regex pattern import googl common collect set import org apach cassandra config schema import org slf logger import org slf logger factori import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra import org apach cassandra compact import org apach cassandra dht partition import org apach cassandra column serial import org apach cassandra compress compress sequenti writer import org apach cassandra util import org apach cassandra servic storag servic import org apach cassandra util public class tabl writer extend tabl privat static logger logger logger factori logger tabl writer class privat index writer iwrit privat segment file builder dbuilder privat final sequenti writer data file privat decor key written key privat file mark data mark privat tabl metadata collector sstabl metadata collector public tabl writer string filenam long key count throw filenam key count schema instanc meta data descriptor filenam filenam storag servic partition tabl metadata creat collector privat static set compon compon meta data metadata set compon compon hash set compon array list compon compon compon compon metadata compress paramet sstabl compressor null compon add compon els feel safer actual add compon mayb write digest compon unmodifi construct compon add compon return compon public tabl writer string filenam long key count meta data metadata partition partition tabl metadata collector sstabl metadata collector throw super descriptor filenam filenam compon metadata metadata partition iwrit index writer key count compress dbuilder segment file compress builder data file compress sequenti writer open filenam descriptor filenam compon databas descriptor popul cach flush metadata compress paramet sstabl metadata collector els dbuilder segment file builder databas descriptor disk access mode data file sequenti writer open file filenam databas descriptor popul cach flush data file set comput digest sstabl metadata collector sstabl metadata collector public void mark data mark data file mark iwrit mark public void reset truncat tri data file reset truncat data mark iwrit reset truncat catch throw error perform saniti check param decor key return posit data file befor ani data written privat long befor append decor key decor key throw assert decor key null key null empti key index column valu written key null written key compar decor key throw runtim written key written key current key decor key write filenam return written key null data file file pointer privat void append decor key decor key long data posit throw written key decor key written key null written key logger trace enabl logger trace wrote decor key data posit iwrit append decor key data posit dbuilder add potenti boundari data posit public long append abstract compact row row throw long current posit befor append row key byte buffer util write short length row key key data file stream long data start data file file pointer long data size row write data file stream assert data size data file file pointer data start incorrect row data size data size written data file path correct data file file pointer data start max timestamp alway collect precis row max timestamp return long avoid deseri echo row reason whi collect call column famili store creat compact writer howev sstabl timestamp updat timestamp case echo row sinc compact control deseri true sstabl metadata collector updat max timestamp row max timestamp sstabl metadata collector add row size data file file pointer current posit sstabl metadata collector add column count row column count append row key current posit return current posit public void append decor key decor key column famili throw long start posit befor append decor key byte buffer util write short length decor key key data file stream serial index bloom filter memori structur column index row header header column index serial write row size data file stream write long header serial size serial size tabl write row header data int column count column famili serial serial index header data file stream append decor key start posit track max column timestamp sstabl metadata collector updat max timestamp max timestamp sstabl metadata collector add row size data file file pointer start posit sstabl metadata collector add column count column count public void append decor key decor key byte buffer valu throw long current posit befor append decor key byte buffer util write short length decor key key data file stream assert valu remain data file stream write long valu remain byte buffer util write valu data file stream append decor key current posit public long append stream decor key key meta data metadata long data size data input throw long current posit befor append key byte buffer util write short length key key data file stream long data start data file file pointer write row size data file stream write long data size write int size read int data file stream write int size int size data file stream write byte read byte write index int index size read int data file stream write int index size int index size data file stream write byte read byte data data file stream write int read int data file stream write long read long column size int column count read int data file stream write int column count deseri column obtain max timestamp immedi serial long max timestamp long column famili column famili creat metadata array sort column factori int column count deseri column becaus written data size base data size receiv reseri exact data column column column serial deseri column serial flag integ column instanceof counter column column counter column column mark delta clear els column instanceof super column super column super column column column column column column instanceof counter column column mark counter column column mark delta clear replac column mark max timestamp math max max timestamp column max timestamp column serial serial column data file stream assert data size data file file pointer data start incorrect row data size data size written data file path correct data file file pointer data start sstabl metadata collector updat max timestamp max timestamp sstabl metadata collector add row size data file file pointer current posit sstabl metadata collector add column count column count append key current posit return current posit public void updat max timestamp long timestamp sstabl metadata collector updat max timestamp timestamp failur attempt close index writer data file befor delet temp compon sstabl public void abort assert descriptor temporari file util close quiet iwrit file util close quiet data file tri set compon compon tabl compon descriptor compon empti tabl delet descriptor compon catch logger error string format fail delet temp compon descriptor public tabl reader close open reader throw return close open reader system current time milli public tabl reader close open reader long max data age throw index filter iwrit close main data close truncat necessari data file close write sstabl statist tabl metadata sstabl metadata sstabl metadata collector final metadata partition class canon write metadata descriptor sstabl metadata mayb write digest remov tmp marker compon final descriptor newdesc renam descriptor compon final memori state reader segment file ifil iwrit builder complet newdesc filenam tabl segment file dfile dbuilder complet newdesc filenam tabl tabl reader sstabl tabl reader intern open newdesc compon metadata partition ifil dfile iwrit summari iwrit max data age sstabl metadata sstabl minim key sstabl minim key iwrit null dbuilder null return sstabl privat void mayb write digest throw byte digest data file digest digest null return sequenti writer sequenti writer open file descriptor filenam tabl true writ output compat sha sum descriptor newdesc descriptor temporari fals string tmp newdesc filenam tabl split pattern quot file separ string data file tmp tmp length write string format hex byte hex digest data file byte close privat static void write metadata descriptor desc tabl metadata sstabl metadata throw sequenti writer sequenti writer open file desc filenam tabl true tabl metadata serial serial sstabl metadata stream close static descriptor renam descriptor tmpdesc set compon compon descriptor newdesc tmpdesc temporari fals renam tmpdesc newdesc compon return newdesc public static void renam descriptor tmpdesc descriptor newdesc set compon compon tri data becaus data present sstabl complet renam befor crash compon compon set differ compon collect singleton compon util renam confirm tmpdesc filenam compon newdesc filenam compon util renam confirm tmpdesc filenam compon newdesc filenam compon catch throw error public long file pointer return data file file pointer public long disk file pointer throw return data file disk file pointer encapsul write index filter tabl state object valid close class index writer implement closeabl privat final sequenti writer index file public final segment file builder builder public final index summari summari public final bloom filter privat file mark mark index writer long key count throw index file sequenti writer open file descriptor filenam tabl databas descriptor popul cach flush builder segment file builder databas descriptor index access mode summari index summari key count doubl chanc metadata bloom filter chanc chanc null chanc paranoia bug thrift avro def danc befor break logger error bloom filter chanc isn suppos happen chanc null chanc null bloom filter filter key count bloom filter filter key count chanc public void append decor key key long data posit throw add key key long index posit index file file pointer byte buffer util write short length key key index file stream index file stream write long data posit logger trace enabl logger trace wrote index key index posit summari mayb add entri key index posit builder add potenti boundari index posit close index bloomfilt public state writer valid consumpt public void close throw bloom filter file output stream fos file output stream descriptor filenam tabl data output stream stream data output stream fos bloom filter serial serial stream stream flush fos sync stream close index long posit index file file pointer index file close call forc file util truncat index file path posit final memori index state summari complet public void mark mark index file mark public void reset truncat throw set bloom filter addit extra key harmless reset dbuilder call afterappend assum work won tri reset index file reset truncat mark overrid public string string return index writer descriptor 