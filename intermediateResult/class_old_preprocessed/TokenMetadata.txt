licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra locat import java net inet address import java util import java util concurr concurr hash map import java util concurr concurr map import java util concurr copi write array list import java util concurr lock read write lock import java util concurr lock reentrant read write lock import googl common collect import org apach cassandra util pair import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra servic storag servic public class token metadata privat static logger logger logger factori logger token metadata class maintain token endpoint map everi node cluster privat map token inet address token endpoint map prior map rang inet address pend rang ad node began bootstrap remov finish inadequ multipl chang simultan exampl suppos ring node replic factor node bootstrap pend rang suppos node bootstrap time pend rang node assign pend rang unabl repres map happen obvious ani node boot simultan node chang chang pend rang multimap rang inet address map string multimap rang inet address becaus replic strategi option key space ad bootstrap token leav endpoint collect rebuild pend rang complet inform addit chang mid oper final note record token join node bootstrap token detect reject addit multipl node token befor becom part ring privat map token inet address bootstrap token map synchron map hash map token inet address creat don record token sinc part token endpoint map leav privat set inet address leav endpoint hash set inet address cach calcul token endpoint map bootstrap token leav endpoint privat concurr map string multimap rang token inet address pend rang concurr hash map string multimap rang token inet address node migrat token ring privat set pair token inet address move endpoint hash set pair token inet address lock manipul token map privat final read write lock lock reentrant read write lock true privat array list token sort token list subscrib notifi token endpoint map chang privat final copi write array list abstract replic strategi subscrib copi write array list abstract replic strategi public token metadata null public token metadata map token inet address token endpoint map token endpoint map null token endpoint map hash map creat token endpoint map token endpoint map sort token sort token privat array list token sort token array list token token array list token token endpoint map key set collect sort token return token return number node bootstrap sourc primari rang public int pend rang chang inet address sourc int rang token sourc rang primari rang token sourc synchron bootstrap token token token bootstrap token key set sourc rang token return updat token map singl token endpoint pair normal state public void updat normal token token token inet address endpoint updat normal token collect singleton pair creat token endpoint updat token map set token endpoint pair normal state prefer whenev multipl pair updat updat singl multipl expens param token pair public void updat normal token set pair token inet address token pair token pair empti return lock write lock lock tri boolean sort token fals pair token inet address token endpoint pair token pair token token token endpoint pair left inet address endpoint token endpoint pair assert token null assert endpoint null bootstrap token invers remov endpoint token endpoint map invers remov endpoint inet address prev token endpoint map put token endpoint endpoint equal prev prev null logger warn token token chang ownership prev endpoint sort token true leav endpoint remov endpoint remov move endpoint remov endpoint move sort token sort token sort token final lock write lock unlock public void add bootstrap token token token inet address endpoint assert token null assert endpoint null lock write lock lock tri inet address endpoint endpoint bootstrap token token endpoint null endpoint equal endpoint throw runtim bootstrap token collis endpoint endpoint token token endpoint token endpoint map token endpoint null endpoint equal endpoint throw runtim bootstrap token collis endpoint endpoint token token bootstrap token invers remov endpoint bootstrap token put token endpoint final lock write lock unlock public void remov bootstrap token token token assert token null lock write lock lock tri bootstrap token remov token final lock write lock unlock public void add leav endpoint inet address endpoint assert endpoint null lock write lock lock tri leav endpoint add endpoint final lock write lock unlock add move endpoint param token token node move param endpoint address move node public void add move endpoint token token inet address endpoint assert endpoint null lock write lock lock tri move endpoint add pair token inet address token endpoint final lock write lock unlock public void remov endpoint inet address endpoint assert endpoint null lock write lock lock tri bootstrap token invers remov endpoint token endpoint map invers remov endpoint leav endpoint remov endpoint sort token sort token invalid cach final lock write lock unlock remov pair token address move endpoint param endpoint address move node public void remov move inet address endpoint assert endpoint null lock write lock lock tri pair token inet address pair move endpoint pair equal endpoint move endpoint remov pair break invalid cach final lock write lock unlock public token token inet address endpoint assert endpoint null assert member endpoint don return null lock read lock lock tri return token endpoint map invers endpoint final lock read lock unlock public boolean member inet address endpoint assert endpoint null lock read lock lock tri return token endpoint map invers key endpoint final lock read lock unlock public boolean leav inet address endpoint assert endpoint null lock read lock lock tri return leav endpoint endpoint final lock read lock unlock public boolean move inet address endpoint assert endpoint null lock read lock lock tri pair token inet address pair move endpoint pair equal endpoint return true return fals final lock read lock unlock creat copi token metadata onli token endpoint map pend rang bootstrap token leav endpoint includ copi public token metadata clone onli token map lock read lock lock tri return token metadata hash map creat token endpoint map final lock read lock unlock creat copi token metadata token endpoint map reflect situat current leav oper finish return token metadata public token metadata clone left lock read lock lock tri token metadata left metadata clone onli token map inet address endpoint leav endpoint left metadata remov endpoint endpoint return left metadata final lock read lock unlock creat copi token metadata token endpoint map reflect situat current leav move oper finish return token metadata public token metadata clone settl lock read lock lock tri token metadata metadata clone onli token map inet address endpoint leav endpoint metadata remov endpoint endpoint pair token inet address pair move endpoint metadata updat normal token pair left pair return metadata final lock read lock unlock public inet address endpoint token token lock read lock lock tri return token endpoint map token final lock read lock unlock public rang token primari rang token return rang token predecessor public array list token sort token lock read lock lock tri return sort token final lock read lock unlock privat multimap rang token inet address pend rang string tabl multimap rang token inet address map pend rang tabl map null map hash multimap creat multimap rang token inet address prior map pend rang put absent tabl map prior map null map prior map return map mutabl map return caller modifi public map rang token collect inet address pend rang string tabl return pend rang tabl map public list rang token pend rang string tabl inet address endpoint list rang token rang array list rang token map entri rang token inet address entri pend rang tabl entri entri valu equal endpoint rang add entri key return rang public void set pend rang string tabl multimap rang token inet address rang map pend rang put tabl rang map public token predecessor token token list token sort token int index collect binari search token token assert index token string util join token endpoint map key set return token index token token size token index public token successor token token list token sort token int index collect binari search token token assert index token string util join token endpoint map key set return token index token size token token index caller modifi bootstrap token public map token inet address bootstrap token return bootstrap token caller modifi leav endpoint public set inet address leav endpoint return leav endpoint endpoint migrat token return set address move endpoint public set pair token inet address move endpoint return move endpoint public static int token index final array list ring token start boolean insert min assert ring size insert minimum token index includ isn member ring int collect binari search ring start ring size insert min return public static token token final array list token ring token start return ring token index ring start fals iter token ring start token node start doe token ring param includ min true minimum token return ring owner public static iter token ring iter final array list token ring token start boolean includ min ring empti return includ min iter singleton iter storag servic partition minimum token iter token empti iter final boolean insert min includ min ring minimum true fals final int start index token index ring start insert min return abstract iter token int start index protect token comput return data tri return minimum index return storag servic partition minimum token return ring token index return ring final ring size insert min start index iter test public void clear unsaf bootstrap token clear token endpoint map clear leav endpoint clear pend rang clear invalid cach public string string string builder string builder lock read lock lock tri set inet address ep token endpoint map invers key set ep empti append normal token append system properti line separ inet address ep append append append token endpoint map invers append system properti line separ synchron bootstrap token bootstrap token empti append bootstrap token append system properti line separ map entri token inet address entri bootstrap token entri set append entri valu entri key append system properti line separ leav endpoint empti append leav endpoint append system properti line separ inet address leav endpoint append append system properti line separ pend rang empti append pend rang append system properti line separ append print pend rang final lock read lock unlock return string public string print pend rang string builder string builder map entri string multimap rang token inet address entri pend rang entri set map entri rang token inet address rmap entri valu entri append rmap valu rmap key append system properti line separ return string public void invalid cach abstract replic strategi subscrib subscrib subscrib invalid cach token endpoint valu public void regist abstract replic strategi subscrib subscrib add subscrib public void unregist abstract replic strategi subscrib subscrib remov subscrib write endpoint differ read endpoint becaus read endpoint onli care natur node token write endpoint account node bootstrap ring write data stay date dure bootstrap process method return node replic factor possibl return collect pass effici onli replic strategi care method higher level user onli hint public collect inet address write endpoint token token string tabl collect inet address natur endpoint map rang token collect inet address rang pend rang tabl rang empti return natur endpoint set inet address endpoint hash set inet address natur endpoint map entri rang token collect inet address entri rang entri set entri key token endpoint add entri valu return endpoint return token endpoint map consid read oper cluster public map token inet address token endpoint map read lock read lock lock tri map token inet address map hash map token inet address token endpoint map size map put token endpoint map return map final lock read lock unlock return stabl copi won modifi token endpoint map normal bootstrap node cluster public map token inet address normal bootstrap token endpoint map lock read lock lock tri map token inet address map hash map token inet address token endpoint map size bootstrap token size map put token endpoint map synchron bootstrap token map put bootstrap token return map final lock read lock unlock 