licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra net import java error import java import java lang manag manag factori import java net import java nio byte buffer import java nio channel asynchron close import java nio channel server socket channel import java util import java util concurr concurr map import java util concurr executor servic import java util concurr time unit import java util concurr atom atom integ import java util concurr atom atom long import javax manag bean server import javax manag object import googl common base function import googl common collect list import org slf logger import org slf logger factori import org apach cassandra concurr debugg thread pool executor import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config configur import org apach cassandra config databas descriptor import org apach cassandra config encrypt option import org apach cassandra row mutat import org apach cassandra gms gossip import org apach cassandra util data output buffer import org apach cassandra locat latenc subscrib import org apach cassandra net serial type import org apach cassandra net sink sink manag import org apach cassandra secur factori import org apach cassandra servic storag proxi import org apach cassandra servic storag servic import org apach cassandra stream file stream task import org apach cassandra stream stream header import org apach cassandra util import org cliffc high scale lib block hash map public final class messag servic implement messag servic bean public static final string org apach cassandra net type messag servic bit version don wast version public static final int public static final int public static final int public static final int public static final int public static final int public static final int version static serial type serial type serial type prefac everi messag number recipi valid sender sane static final int record result map messag privat final expir map string callback info callback lookup tabl regist messag handler base verb privat final map storag servic verb verb handler verb handler executor destin inet address stream background stream place limit ourselv stream time throttl reason arbitrarili stream unlimit amount file onc becaus singl destin hundr file pend caus seek storm transfer exact file destin host put veri natur rate limit addit map expect behavior mani case creat stream executor core size time consum thread overhead degener case stream everyon ring time ring chang thread node instanc node total fine privat final concurr map inet address debugg thread pool executor stream executor block hash map inet address debugg thread pool executor privat final atom integ activ stream outbound atom integ privat final block hash map inet address outbound tcp connect pool connect manag block hash map inet address outbound tcp connect pool privat static final logger logger logger factori logger messag servic class privat static final int privat list socket thread socket thread list array list privat final simpl condit listen gate verb drop request queu longer correspond client request someth trigger don drop intern messag bootstrap repair notif public static final enum set storag servic verb enum set storag servic verb storag servic verb storag servic verb storag servic verb storag servic verb storag servic verb total drop messag count server lifetim privat final map storag servic verb atom integ drop messag enum map storag servic verb atom integ storag servic verb class drop count request api high concurr isn necessari privat final map storag servic verb integ drop collect synchron map enum map storag servic verb integ storag servic verb class privat final map storag servic verb integ drop intern enum map storag servic verb integ storag servic verb class privat long total timeout privat long total timeout privat final map string atom long timeout host hash map string atom long privat final map string atom long timeout host hash map string atom long privat final list latenc subscrib subscrib array list latenc subscrib privat static final long databas descriptor rpc timeout privat static class handl public static final messag servic instanc messag servic public static messag servic instanc return handl instanc privat messag servic storag servic verb verb drop messag put verb atom integ drop put verb drop intern put verb listen gate simpl condit verb handler enum map storag servic verb verb handler storag servic verb class runnabl log drop runnabl public void run log drop messag storag servic schedul task schedul fix delay log drop time unit function pair string callback info timeout report function pair string callback info object public object appli pair string callback info pair callback info expir callback info pair mayb add latenc expir callback info callback expir callback info target doubl databas descriptor rpc timeout total timeout string expir callback info target host address atom long timeout host null atom long timeout host put increment onli creat atom long instanc write access hashmap happen singl thread timeout host null timeout host put atom long expir callback info hint assert expir callback info messag null tri row mutat row mutat byte expir callback info messag messag bodi expir callback info messag version return storag proxi schedul local hint expir callback info target null null catch logger error unabl deseri mutat writ hint expir callback info target return null callback expir map string callback info timeout report bean server mbs manag factori platform bean server tri mbs regist bean object catch throw runtim track latenc inform dynam snitch param callback associ messag messag type interest param address host repli messag param latenc public void mayb add latenc messag callback inet address address doubl latenc latenc snitch add latenc address latenc public void add latenc inet address address doubl latenc latenc subscrib subscrib subscrib subscrib receiv time address latenc call gossip notic node respond public void convict inet address logger debug reset pool connect pool reset listen specifi port param local inet address port listen public void listen inet address local throw configur callback reset hack test stop restart server socket server socket local socket thread socket thread local start socket thread add listen gate signal privat list server socket server socket inet address local throw configur final list server socket array list server socket databas descriptor encrypt option internod encrypt encrypt option internod encrypt add factori server socket databas descriptor encrypt option local databas descriptor storag port set reus address happen factori logger info start encrypt messag servic port databas descriptor storag port server socket channel server channel server socket channel open server socket socket server channel socket socket set reus address true inet socket address address inet socket address local databas descriptor storag port tri socket bind address catch bind messag throw configur address anoth process chang listen address storag port cassandra yaml valu conflict servic els messag assign request address throw configur unabl bind address address set listen address cassandra yaml interfac bind privat address els throw logger info start messag servic port databas descriptor storag port add socket return public void wait listen tri listen gate await catch interrupt logger debug await interrupt public void destroy connect pool inet address outbound tcp connect pool connect manag null return null guard simpli test ack con null ack con close socket true cmd con null cmd con close socket true connect manag remov timeout host remov host address timeout host remov host address public outbound tcp connect pool connect pool inet address outbound tcp connect pool connect manag null connect manag put absent outbound tcp connect pool connect manag return public outbound tcp connect connect inet address messag msg return connect pool connect msg regist verb correspond verb handler messag servic param verb param verb handler handler specifi verb public void regist verb handler storag servic verb verb verb handler verb handler assert verb handler key verb verb handler put verb verb handler method return verb handler associ regist verb handler regist null return param type verb handler sought return refer verb handler handler specifi verb public verb handler verb handler storag servic verb type return verb handler type public string add callback messag callback messag messag inet address return add callback messag public string add callback messag callback messag messag inet address long timeout string messag callback info previous enabl mutat messag store messag track potenti hint databas descriptor hint handoff enabl messag verb storag servic verb previous callback put messag callback info messag timeout els previous callback put messag callback info timeout assert previous null return messag privat static atom integ gen atom integ integ avoid unnecessari int string int convers privat static string return integ string gen increment send messag messag inet address messag callback long timeout public string send messag messag inet address messag callback return send messag send messag endpoint method specifi callback invok actual respons hold messag onli mutat messag determin trigger hint storag proxi param messag messag param endpoint messag param callback interfac pass respons suggest timeout occur invok send suggest timeout occur invok send param timeout timeout expir return refer messag match result public string send messag messag inet address messag callback long timeout string add callback messag timeout send messag return public void send messag messag inet address send messag public void send repli messag messag string inet address send messag send messag endpoint similar send messag inet address async callback param produc pro param endpo messag param callback process respons return refer messag match result public string send messag produc produc inet address async callback tri return send produc messag gossip instanc version catch happen dure messag creation throw error send messag endpoint method adher fire forget style messag param messag messag param endpoint messag public void send messag messag string inet address logger trace enabl logger trace util broadcast address send messag verb local deliveri messag equal receiv messag return messag sink test hook messag process messag sink manag process client messag messag process messag null return pool connect realli connect queue outbound tcp connect connect connect process messag write connect enqueu process messag public async result send messag messag inet address async result iar async result send messag iar return iar stream file sourc destin high optim hold ani content file memori param header header file stream metadata param endpoint stream file public void stream stream header header inet address debugg thread pool executor executor stream executor executor null core pool size import document stream executor executor debugg thread pool executor creat maximum pool size stream time unit debugg thread pool executor stream executor put absent executor null executor shutdown executor executor execut file stream task header public void increment activ stream outbound activ stream outbound increment public void decrement activ stream outbound activ stream outbound decrement count activ outbound stream task public int activ stream outbound return activ stream outbound public void regist latenc subscrib subcrib subscrib add subcrib public void clear callback unsaf callback reset public void wait stream throw interrupt doe prevent stream drain sinc stream onli start respons explicit oper action bootstrap move repair feel featur debugg thread pool executor stream executor valu shutdown debugg thread pool executor stream executor valu await termin time unit logger error stream complet skip wait callback don ani creat sinc requir write hint public void shutdown logger info wait messag servic quiesc schedul hint mutat stage erron shut mutat stage assert stage manag stage stage shutdown import part callback shutdown block attempt humor test tri stop restart tri socket thread socket thread close catch throw error public void receiv messag messag string logger trace enabl logger trace util broadcast address receiv messag verb messag messag sink manag process server messag messag messag null return runnabl runnabl messag deliveri task messag executor servic stage stage manag stage messag messag type assert stage null stage messag type messag verb stage execut runnabl public callback info remov regist callback string messag return callback remov messag public long regist callback age string messag return callback age messag public static void valid magic int magic throw magic throw invalid protocol header public static int bit int int int return public byte buffer construct stream header stream header stream header boolean compress int version set protocol header byte long repres integ bit indic serial type bit indic compress turn turn default bit indic stream mode turn default follow bit reserv futur bit indic version number remain bit current int header set serial bit header serial type ordin set compress bit compress header set stream bit header set version bit header version finish protocol header setup ad stream header session pendingfil info stream session pend file size pend file bool file pend file pend file byte byte tri data output buffer buffer data output buffer stream header serial serial stream header buffer version byte buffer data catch throw runtim assert byte length byte buffer buffer byte buffer alloc byte length buffer put int buffer put int header buffer put int byte length buffer put byte buffer flip return buffer public void increment drop messag storag servic verb verb assert verb verb verb legal drop drop messag verb increment privat void log drop messag boolean log tpstat fals map entri storag servic verb atom integ entri drop messag entri set atom integ drop entri valu storag servic verb verb entri key int drop drop intern verb log tpstat true logger info messag drop object verb drop intern put verb drop log tpstat status logger log privat static class socket thread extend thread privat final server socket server socket thread server socket server string super server server public void run true tri socket socket server accept authent socket incom tcp connect socket start els socket close catch asynchron close happen anoth thread call close logger info messag servic shut server thread break catch throw runtim void close throw server close privat boolean authent socket socket return databas descriptor internod authent authent socket inet address socket port public map string integ command pend task map string integ pend task hash map string integ map entri inet address outbound tcp connect pool entri connect manag entri set pend task put entri key host address entri valu cmd con pend messag return pend task public map string long command complet task map string long complet task hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set complet task put entri key host address entri valu cmd con complet messsag return complet task public map string long command drop task map string long drop task hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set drop task put entri key host address entri valu cmd con drop messag return drop task public map string integ respons pend task map string integ pend task hash map string integ map entri inet address outbound tcp connect pool entri connect manag entri set pend task put entri key host address entri valu ack con pend messag return pend task public map string long respons complet task map string long complet task hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set complet task put entri key host address entri valu ack con complet messsag return complet task public static long default callback timeout return public map string integ drop messag map string integ map hash map string integ map entri storag servic verb atom integ entri drop messag entri set map put entri key string entri valu return map public map string integ drop messag map string integ map hash map string integ map entri storag servic verb atom integ entri drop messag entri set storag servic verb verb entri key integ drop entri valu integ drop drop drop verb map put verb string drop drop put verb drop return map public long total timeout return total timeout public long total timout long total timeout total timeout total timeout total timeout return public map string long timeout host map string long result hash map string long map entri string atom long entri timeout host entri set result put entri key entri valu return result public map string long timeout host map string long result hash map string long map entri string atom long entri timeout host entri set string entri key atom long entri valu long timeout timeout host result put timeout set timeout return result 