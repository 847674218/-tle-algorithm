licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra net import java data input import java data output import java error import java import java lang manag manag factori import java net import java nio byte buffer import java nio channel asynchron close import java nio channel server socket channel import java util import java util concurr concurr map import java util concurr executor servic import java util concurr time unit import java util concurr atom atom integ import javax manag bean server import javax manag object import googl common base function import googl common collect list import org slf logger import org slf logger factori import org apach cassandra concurr debugg thread pool executor import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config databas descriptor import org apach cassandra config encrypt option server encrypt option import org apach cassandra import org apach cassandra dht boot strapper import org apach cassandra configur import org apach cassandra gms gossip digest ack import org apach cassandra gms gossip digest ack import org apach cassandra gms gossip digest syn import org apach cassandra version serial import org apach cassandra util data output buffer import org apach cassandra locat latenc subscrib import org apach cassandra metric connect metric import org apach cassandra metric drop messag metric import org apach cassandra net sink sink manag import org apach cassandra secur factori import org apach cassandra servic import org apach cassandra stream import org apach cassandra stream compress compress file stream task import org apach cassandra trace trace import org apach cassandra util import org cliffc high scale lib block hash map public final class messag servic implement messag servic bean public static final string org apach cassandra net type messag servic bit version don wast version public static final int public static final int public static final int public static final int public static final int current version prefac everi messag number recipi valid sender sane static final int verb handler identifi public enum verb deprec client initi read write deprec deprec deprec deprec deprec respons intern call similar snapshot dummi verb drop messag pad compat previous version valid verb futur rememb add verb sinc serial ordin public static final verb verb valu public static final enum map messag servic verb stage verb stage enum map messag servic verb stage messag servic verb class put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage actual handl file stream task stream executor put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage put verb stage messag receiv incom tcp connect verb kind messag time determin deseri messag payload verb repli someth told tradit fine sinc verb handler knew type payload expect handl deseri avoid extra copi intermediari byte wire callback info object public static final enum map verb version serial verb serial enum map verb version serial verb class put verb callback determin serial instanc put verb callback determin serial instanc put verb row mutat serial put verb row mutat serial put verb read command serial put verb stream repli serial put verb stream request serial put verb rang slice command serial put verb boot strapper string serial instanc put verb anti entropi servic tree request serial put verb anti entropi servic valid serial put verb stream repair task serial put verb serial serial put verb gossip digest ack serial put verb gossip digest ack serial put verb gossip digest syn serial put verb migrat manag migrat serial instanc put verb truncat serial put verb index scan command serial put verb null put verb counter mutat serial map kind serial wire callback base outbound verb public static final enum map verb version serial callback deseri enum map verb version serial verb class put verb write respons serial put verb write respons serial put verb write respons serial put verb rang slice repli serial put verb read respons serial put verb truncat respons serial put verb null put verb migrat manag migrat serial instanc put verb serial serial put verb boot strapper string serial instanc put verb null record result map messag privat final expir map string callback info callback placehold class deseri callback implement special case code inbound tcp connect becaus pass messag version serial static class callback determin serial implement version serial object public static final callback determin serial instanc callback determin serial public object deseri data input int version throw throw unsupport oper public void serial object data output int version throw throw unsupport oper public long serial size object int version throw unsupport oper lookup tabl regist messag handler base verb privat final map verb verb handler verb handler executor destin inet address stream background stream place limit ourselv stream time throttl reason arbitrarili stream unlimit amount file onc becaus singl destin hundr file pend caus seek storm transfer exact file destin host put veri natur rate limit addit map expect behavior mani case creat stream executor core size time consum thread overhead degener case stream everyon ring time ring chang thread node instanc node total fine privat final concurr map inet address debugg thread pool executor stream executor block hash map inet address debugg thread pool executor privat final block hash map inet address outbound tcp connect pool connect manag block hash map inet address outbound tcp connect pool privat static final logger logger logger factori logger messag servic class privat static final int privat final list socket thread socket thread list array list privat final simpl condit listen gate verb drop request queu longer request timeout correspond client request someth trigger don drop intern messag bootstrap repair notif public static final enum set verb enum set verb verb verb verb verb verb verb total drop messag count server lifetim privat final map verb drop messag metric drop messag enum map verb drop messag metric verb class drop count request api high concurr isn necessari privat final map verb integ drop intern enum map verb integ verb class privat final list latenc subscrib subscrib array list latenc subscrib protocol version node cluster privat final concurr map inet address integ version block hash map inet address integ privat static class handl public static final messag servic instanc messag servic public static messag servic instanc return handl instanc privat messag servic verb verb drop messag put verb drop messag metric verb drop intern put verb listen gate simpl condit verb handler enum map verb verb handler verb class runnabl log drop runnabl public void run log drop messag storag servic schedul task schedul fix delay log drop time unit function pair string expir map cacheabl object callback info timeout report function pair string expir map cacheabl object callback info object public object appli pair string expir map cacheabl object callback info pair callback info expir callback info pair valu mayb add latenc expir callback info callback expir callback info target pair timeout connect metric total timeout mark connect pool expir callback info target increment timeout expir callback info hint assert expir callback info messag null row mutat row mutat expir callback info messag payload return storag proxi submit hint expir callback info target null null return null callback expir map string callback info databas descriptor min rpc timeout timeout report bean server mbs manag factori platform bean server tri mbs regist bean object catch throw runtim track latenc inform dynam snitch param callback associ messag messag type interest param address host repli messag param latenc public void mayb add latenc messag callback inet address address long latenc latenc snitch add latenc address latenc public void add latenc inet address address long latenc latenc subscrib subscrib subscrib subscrib receiv time address latenc call gossip notic node respond public void convict inet address logger debug reset pool connect pool reset listen specifi port param local inet address port listen public void listen inet address local throw configur callback reset hack test stop restart server socket server socket local socket thread socket thread local start socket thread add listen gate signal privat list server socket server socket inet address local throw configur final list server socket array list server socket databas descriptor server encrypt option internod encrypt server encrypt option internod encrypt tri add factori server socket databas descriptor server encrypt option local databas descriptor storag port catch throw configur unabl creat ssl socket set reus address happen factori logger info start encrypt messag servic port databas descriptor storag port server socket channel server channel null tri server channel server socket channel open catch throw runtim server socket socket server channel socket tri socket set reus address true catch socket throw configur insuffici permiss set reus address inet socket address address inet socket address local databas descriptor storag port tri socket bind address catch bind messag throw configur address anoth process chang listen address storag port cassandra yaml valu conflict servic els messag assign request address throw configur unabl bind address address set listen address cassandra yaml interfac bind privat address els throw runtim catch throw runtim logger info start messag servic port databas descriptor storag port add socket return public void wait listen tri listen gate await catch interrupt logger debug await interrupt public void destroy connect pool inet address outbound tcp connect pool connect manag null return close connect manag remov public outbound tcp connect pool connect pool inet address outbound tcp connect pool connect manag null connect manag put absent outbound tcp connect pool connect manag return public outbound tcp connect connect inet address messag msg return connect pool connect msg regist verb correspond verb handler messag servic param verb param verb handler handler specifi verb public void regist verb handler verb verb verb handler verb handler assert verb handler key verb verb handler put verb verb handler method return verb handler associ regist verb handler regist null return param type verb handler sought return refer verb handler handler specifi verb public verb handler verb handler verb type return verb handler type public string add callback messag callback messag messag inet address long timeout string messag callback info previous enabl mutat messag store messag track potenti hint databas descriptor hint handoff enabl messag verb verb previous callback put messag callback info messag callback deseri messag verb timeout els previous callback put messag callback info callback deseri messag verb timeout assert previous null return messag privat static final atom integ gen atom integ integ avoid unnecessari int string int convers privat static string return integ string gen increment send messag messag inet address messag callback long timeout public string send messag messag inet address messag callback return send messag messag timeout send messag endpoint method specifi callback invok actual respons hold messag onli mutat messag determin trigger hint storag proxi param messag messag param endpoint messag param callback interfac pass respons suggest timeout occur invok send suggest timeout occur invok send param timeout timeout expir return refer messag match result public string send messag messag inet address messag callback long timeout string add callback messag timeout instanceof abstract write respons handler predictor instanc start write oper els instanceof read callback predictor instanc start read oper send messag return public void send messag messag inet address send messag public void send repli messag messag string inet address send messag send messag endpoint method adher fire forget style messag param messag messag param endpoint messag public void send messag messag string inet address logger trace enabl logger trace util broadcast address send messag verb equal util broadcast address logger trace messag messag servic messag messag sink test hook messag process messag sink manag process outbound messag messag process messag null return pool connect realli connect queue outbound tcp connect connect connect process messag write connect enqueu process messag public async result send messag messag inet address async result iar async result send messag iar return iar stream file sourc destin high optim hold ani content file memori param header header file stream metadata param endpoint stream file public void stream stream header header inet address debugg thread pool executor executor stream executor executor null core pool size import document stream executor executor debugg thread pool executor creat maximum pool size stream time unit debugg thread pool executor stream executor put absent executor null executor shutdown executor executor execut header file null header file compress info null file stream task header compress file stream task header public void regist latenc subscrib subcrib subscrib add subcrib public void clear callback unsaf callback reset public void wait stream throw interrupt doe prevent stream drain sinc stream onli start respons explicit oper action bootstrap move repair feel featur debugg thread pool executor stream executor valu shutdown debugg thread pool executor stream executor valu await termin time unit logger error stream complet skip wait callback don ani creat sinc requir write hint public void shutdown logger info wait messag servic quiesc schedul hint mutat stage erron shut mutat stage assert stage manag stage stage shutdown import part callback shutdown block attempt humor test tri stop restart tri socket thread socket thread close catch throw error public void receiv messag messag string long timestamp trace instanc initi messag messag trace trace messag receiv messag messag sink manag process inbound messag messag messag null return runnabl runnabl messag deliveri task messag timestamp executor servic stage stage manag stage messag messag type assert stage null stage messag type messag verb messag verb verb predictor instanc log enabl messag callback messag servic instanc regist callback callback instanceof abstract write respons handler predictor instanc log write respons timestamp els instanceof read callback predictor instanc log read respons timestamp stage execut runnabl public void set callback test string messag callback info callback callback put messag callback public callback info regist callback string messag return callback messag public callback info remov regist callback string messag return callback remov messag public long regist callback age string messag return callback age messag public static void valid magic int magic throw magic throw invalid protocol header public static int bit int pack int start int count return pack start count count public byte buffer construct stream header stream header stream header boolean compress int version int header set compress bit compress header set stream bit header set version bit header version ad stream header session pendingfil info stream session pend file size pend file bool file pend file pend file byte byte tri data output buffer buffer data output buffer stream header serial serial stream header buffer version byte buffer data catch throw runtim assert byte length byte buffer buffer byte buffer alloc byte length buffer put int buffer put int header buffer put int byte length buffer put byte buffer flip return buffer return version associ address param version version public int set version inet address address int version logger debug set version version address integ version put address version return null version public void reset version inet address endpoint logger debug reset version endpoint version remov endpoint public integ version inet address address integ version address null don version assum current incorrect logger trace assum current protocol version address return messag servic current version els return public int version string address throw unknown host return version inet address address public boolean version inet address endpoint return version endpoint null public void increment drop messag verb verb assert verb verb verb legal drop drop messag verb drop mark privat void log drop messag boolean log tpstat fals map entri verb drop messag metric entri drop messag entri set int drop int entri valu drop count verb verb entri key int drop drop intern verb log tpstat true logger info messag drop object verb drop intern put verb drop log tpstat status logger log privat static class socket thread extend thread privat final server socket server socket thread server socket server string super server server public void run true tri socket socket server accept incom tcp connect socket start catch asynchron close happen anoth thread call close logger info messag servic shut server thread break catch throw runtim void close throw server close public map string integ command pend task map string integ pend task hash map string integ map entri inet address outbound tcp connect pool entri connect manag entri set pend task put entri key host address entri valu cmd con pend messag return pend task public int command pend task inet address address outbound tcp connect pool connect connect manag address return connect null connect cmd con pend messag public map string long command complet task map string long complet task hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set complet task put entri key host address entri valu cmd con complet messsag return complet task public map string long command drop task map string long drop task hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set drop task put entri key host address entri valu cmd con drop messag return drop task public map string integ respons pend task map string integ pend task hash map string integ map entri inet address outbound tcp connect pool entri connect manag entri set pend task put entri key host address entri valu ack con pend messag return pend task public map string long respons complet task map string long complet task hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set complet task put entri key host address entri valu ack con complet messsag return complet task public map string integ drop messag map string integ map hash map string integ map entri verb drop messag metric entri drop messag entri set map put entri key string int entri valu drop count return map public map string integ drop messag map string integ map hash map string integ map entri verb drop messag metric entri drop messag entri set map put entri key string entri valu drop return map public long total timeout return connect metric total timeout count public long total timout return connect metric total timeout public map string long timeout host map string long result hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set string entri key host address long entri valu timeout result put return result public map string long timeout host map string long result hash map string long map entri inet address outbound tcp connect pool entri connect manag entri set string entri key host address long entri valu timeout result put return result 