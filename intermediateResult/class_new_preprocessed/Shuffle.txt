packag org apach cassandra tool licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens import java closeabl import java import java net unknown host import java nio byte buffer import java util array list import java util array import java util collect import java util collect import java util date import java util hash map import java util hash set import java util iter import java util list import java util map import java util random import java util set import javax manag import javax manag bean server connect import javax manag malform object import javax manag object import org apach cassandra cql jdbc jdbc date import org apach cassandra dht partition import org apach cassandra dht token import org apach cassandra locat endpoint snitch info bean import org apach cassandra servic storag servic bean import org apach cassandra thrift cassandra import org apach cassandra thrift compress import org apach cassandra thrift consist level import org apach cassandra thrift cql result import org apach cassandra thrift cql row import org apach cassandra thrift invalid request import org apach cassandra thrift time import org apach cassandra thrift token rang import org apach cassandra thrift unavail import org apach cassandra util byte buffer util import org apach common cli command line import org apach common cli argument import org apach thrift import org apach thrift protocol binari protocol import org apach thrift transport fast frame transport import org apach thrift transport socket import org apach thrift transport transport import org apach thrift transport transport import googl common collect hash multimap import googl common collect multimap public class shuffl extend abstract jmx client privat static final string obj org apach cassandra type storag servic privat static final string snitch obj org apach cassandra type endpoint snitch info privat storag servic bean proxi null privat random rand random system current time milli privat final string thrift host privat final int thrift port privat final boolean thrift frame static add cmd option thrift host true thrift hostnam address default host add cmd option thrift port true thrift port number default add cmd option thrift frame fals enabl frame transport thrift default fals add cmd option enabl true immedi enabl shuffl creat onli add cmd option onli true appli onli creat onli public shuffl string host int port throw host port host fals null null public shuffl string host int port string thrift host int thrift port boolean thrift frame string usernam string password throw super host port usernam password thrift host thrift host thrift port thrift port thrift frame thrift frame setup storag servic proxi proxi proxi jmx conn mbean server conn public storag servic bean proxi bean server connect mbean conn storag servic bean proxi null tri object object obj proxi bean proxi mbean conn storag servic bean class catch malform object throw runtim return proxi public endpoint snitch info bean snitch proxi bean server connect mbean conn endpoint snitch info bean proxi null tri object object snitch obj proxi bean proxi mbean conn endpoint snitch info bean class catch malform object throw runtim return proxi multimap endpoint token return random map param endpoint map current map endpoint token return map endpoint token public multimap string string calcul reloc multimap string string endpoint map multimap string string reloc hash multimap creat set string endpoint hash set string endpoint map key set map string integ endpoint num token hash map string integ endpoint size map string iter string iter map hash map string iter string endpoint size creat map endpoint token iter endpoint number token string endpoint endpoint tri endpoint num token put endpoint proxi token endpoint size catch unknown host throw runtim iter map put endpoint endpoint map endpoint iter int ep complet endpoint size set string endpoint complet hash set string outer true endpoint remov endpoint complet string endpoint endpoint boolean choic fals iter map endpoint endpoint complet add endpoint continu string token iter map endpoint list string set array list string endpoint set remov endpoint collect shuffl set rand string choic set reloc choic size endpoint num token choic reloc put choic token choic true break choic reloc put endpoint token exhaust token iter endpoint complet size ep complet break outer return reloc enabl reloc param endpoint sequenc hostnam string public void enabl reloc string endpoint enabl reloc array list endpoint enabl reloc param endpoint collect hostnam string public void enabl reloc collect string endpoint string endpoint endpoint tri connect conn connect endpoint port proxi conn mbean server conn enabl schedul rang xfer conn close catch writeln fail enabl shuffl endpoint disabl reloc param endpoint sequenc hostnam string public void disabl reloc string endpoint disabl reloc array list endpoint disabl reloc param endpoint collect hostnam string public void disabl reloc collect string endpoint string endpoint endpoint tri connect conn connect endpoint port proxi conn mbean server conn disabl schedul rang xfer conn close catch writeln fail enabl shuffl endpoint return list live node return string endpoint throw shuffl error public collect string live node throw shuffl error tri connect conn connect host port return proxi conn mbean server conn live node catch throw shuffl error error retriev list node interfac creat distribut random token endpoint map throw shuffl error handl public void shuffl boolean enabl string onli throw shuffl error cassandra client seed client null map string string token map null partition partition null multimap string string endpoint map hash multimap creat endpoint snitch info bean snitch proxi snitch proxi jmx conn mbean server conn tri seed client thrift client thrift host thrift port thrift frame token map seed client describ token map map entri string string entri token map entri set string endpoint entri valu token entri key tri onli null onli equal snitch proxi datacent endpoint endpoint map put endpoint token els endpoint map put endpoint token catch unknown host writeln warn unknown endpoint snitch endpoint catch invalid request ire throw runtim ire catch throw shuffl error string format thrift request fail thrift host thrift port messag partition partition thrift host thrift port thrift frame multimap string string reloc calcul reloc endpoint map writeln token writeln store reloc remot node string endpoint reloc key set string tok reloc endpoint writeln tok token map tok endpoint string cql queri creat shuffl batch insert reloc endpoint partition execut cql queri endpoint thrift port thrift frame cql queri enabl enabl reloc reloc key set print list pend token reloc node throw shuffl error public void throw shuffl error map string list cql row queu reloc list reloc partition partition partition thrift host thrift port thrift frame boolean onc fals string host queu reloc key set cql row row queu reloc host assert row column size onc writeln token endpoint request writeln onc true byte buffer token byte byte buffer wrap row column valu byte buffer request byte buffer wrap row column valu date time jdbc date instanc compos request token token partition token factori byte array token byte writeln token string host time string list pend token reloc node return throw shuffl error privat map string list cql row list reloc throw shuffl error string cql queri token byte request system rang xfer map string list cql row result hash map string list cql row string host live node cql result result execut cql queri host thrift port thrift frame cql queri result put host result row return result clear pend token reloc node throw shuffl error public void clear throw shuffl error map string list cql row queu reloc list reloc string host queu reloc key set cql row row queu reloc host assert row column size byte buffer token byte byte buffer wrap row column valu string queri string format system rang xfer token byte byte buffer util byte hex token byte execut cql queri host thrift port thrift frame queri enabl shuffl node cluster throw shuffl error public void enabl throw shuffl error enabl reloc live node disabl shuffl node cluster throw shuffl error public void disabl throw shuffl error disabl reloc live node setup return thrift connect param host hostnam address connect param port port number connect param frame wrap frame transport true return cassandra client instanc throw shuffl error public static cassandra client thrift client string host int port boolean frame throw shuffl error tri return cassandra client host port frame catch transport throw shuffl error string format unabl connect host port messag execut queri param host hostnam address connect param port port number connect param frame wrap frame transport true param cql queri queri string return thrift cql result instanc throw shuffl error public static cql result execut cql queri string host int port boolean frame string cql queri throw shuffl error cassandra client client null tri client thrift client host port frame return client execut cql queri byte buffer wrap cql queri byte compress catch unavail throw shuffl error string format unabl write shuffl entri reason unavail host catch time throw shuffl error string format unabl write shuffl entri reason time host catch throw runtim final client null client close return partition instanc remot host param host hostnam address connect param port port number connect param frame wrap frame transport true return partition instanc throw shuffl error public static partition partition string host int port boolean frame throw shuffl error string partition null tri partition thrift client host port frame describ partition catch throw shuffl error string format thrift request fail host port messag catch invalid request throw runtim error call describ partition defi explan tri class partition class class partition return partition partition class instanc catch class throw shuffl error unabl locat class partition partition catch throw runtim creat return batch insert statement set token reloc param token token reloc param partition instanc partition return queri string public static string creat shuffl batch insert collect string token partition partition string builder queri string builder queri append append string token str token token token partition token factori string token str string hex token byte buffer util byte hex partition token factori byte array token queri append system rang xfer token byte request append append hex token append append queri append append return queri string print usag inform privat static void print shuffl string builder string builder append command append string format append creat initi shuffl oper append string format append list pend reloc append string format append clear clear pend reloc append string format append abl enabl shuffl append string format append dis abl disabl shuffl append string format print shuffl option command string execut param arg argument pass command line throw face meet palm public static void main string arg throw command line cmd null tri cmd process argument arg catch argument system err println messag system exit command argument cmd arg list size system err println command argument print shuffl system exit string command string cmd arg list string host cmd option valu host null cmd option valu host string port cmd option valu port null cmd option valu port integ string string thrift host cmd option valu thrift host null cmd option valu thrift host host string thrift port cmd option valu thrift port null cmd option valu thrift port string onli cmd option valu onli boolean thrift frame cmd option thrift frame true fals boolean enabl cmd option enabl true fals int port num thrift port num pars port number port null tri port num integ pars int port catch number format ferr system err printf valid port number port system exit els port num pars thrift port number thrift port null tri thrift port num integ pars int thrift port catch number format ferr system err printf valid port number thrift port system exit els thrift port num shuffl shuffler shuffl host port num thrift host thrift port num thrift frame null null tri command equal creat shuffler shuffl enabl onli els command equal shuffler els command start shuffler enabl els command start dis shuffler disabl els command equal clear shuffler clear els system err println unknown subcommand command print shuffl system exit catch shuffl error err shuffler writeln err system exit final shuffler close system exit cassandra client closeabl class cassandra client implement closeabl transport transport cassandra client client cassandra client string host int port boolean frame throw transport socket socket socket host port transport frame socket fast frame transport socket transport open client cassandra client binari protocol transport tri client set cql version catch throw runtim cql result execut cql queri byte buffer cql queri compress compress throw return client execut cql queri cql queri compress consist level string describ partition throw invalid request return client describ partition list token rang describ ring string keyspac throw invalid request return client describ ring keyspac map string string describ token map throw invalid request return client describ token map public void close transport close suppress warn serial class shuffl error extend shuffl error string msg super msg 