licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java file import java nio byte buffer import java util import java util concurr import java util concurr atom atom long import googl common base function import googl common base throwabl import org apach cassandra concurr enabl thread pool executor import org apach cassandra concurr stage manag import org apach cassandra config databas descriptor import org apach cassandra index secondari index manag import org apach cassandra util disk awar runnabl import org cliffc high scale lib block hash set import org github jamm memori meter import org slf logger import org slf logger factori import org apach cassandra concurr debugg thread pool executor import org apach cassandra concurr thread factori import org apach cassandra columniter disk atom iter import org apach cassandra columniter simpl abstract column iter import org apach cassandra commitlog replay posit import org apach cassandra filter abstract column iter import org apach cassandra filter queri filter import org apach cassandra filter slice queri filter import org apach cassandra marshal abstract type import org apach cassandra sstabl tabl metadata import org apach cassandra sstabl tabl reader import org apach cassandra sstabl tabl writer import org apach cassandra util slab alloc public class memtabl privat static final logger logger logger factori logger memtabl class switch memtabl put memtabl sort content writer executor write complet turn writer tabl reader add tabl avail read switch memtabl doe put memtabl memtabl pend flush stay flush complet ad tabl reader tabl add entri commit log updat wait flush complet call memtabl flush multipl flush happen simultan multicor system call correct order necessari replay case restart sinc commit log assum call data context persist tabl privat static final executor servic flush writer enabl thread pool executor databas descriptor flush writer stage manag time unit link block queue runnabl databas descriptor flush queue size thread factori flush writer intern size memori serial size privat static final doubl max liveratio byte column bit jvm higher someth probabl broken privat static final doubl limit amount concurr run queu meter becaus count slow minut larg memtabl busi server memtabl aliv flush otherwis approach bound number outstand run meter maximum set executor queue unbound implicit bound number privat static final set column famili store meter progress block hash set column famili store privat static final executor servic meter executor debugg thread pool executor integ time unit link block queue runnabl thread factori memori meter overrid protect void execut runnabl throwabl super execut debugg thread pool executor log execut privat final memori meter meter volatil static memtabl activ measur privat final atom long current size atom long privat final atom long current oper atom long index memtabl row posit onli purpos abl select key rang token key bound howev put ensur actual onli store decor key privat final concurr navig map row posit column famili column famili concurr skip list map row posit column famili public final column famili store cfs privat final long creation time privat final slab alloc alloc slab alloc realli onli column alloc memtabl big wast avoid alloc privat final function column column local copi function function column column public column appli column return local copi cfs alloc record compar creation memtabl onli user updat compar memtabl creat compar public final abstract type initi compar public memtabl column famili store cfs cfs cfs creation time system current time milli initi compar cfs metadata compar callabl set object provid callabl set object public set object call throw avoid count onc row set object set collect set map ident hash map object boolean set add memtabl cfs metadata return set meter memori meter omit share buffer overhead tracker provid provid public long live size return long current size cfs live ratio public long serial size return current size public long oper return current oper onli call column famili store appli public handl lock avoid submit flush memtabl ani unsaf void put decor key key column famili column famili secondari index manag updat index resolv key column famili index public void updat live ratio throw runtim memori meter initi hack openjdk log warn startup script logger warn memori meter uniniti jamm specifi java agent assum live ratio usual cassandra env disabl jamm becaus buggi upgrad sun cfs live ratio return meter progress add cfs logger debug meter alreadi pend activ skip live ratio updat cfs return runnabl runnabl runnabl public void run tri activ measur memtabl long start system current time milli concurr skip list map cycl measur deep track refer object visit reduc memori overhead measur break row time long deep size meter measur column famili int object map entri row posit column famili entri column famili entri set deep size meter measur deep entri key meter measur deep entri valu object entri valu column count doubl ratio doubl deep size current size ratio logger warn set live ratio minimum ratio ratio ratio logger warn set live ratio maximum ratio ratio veri conserv estim sinc penalti guess death higher estim believ immedi averag ratio cfs live ratio cfs live ratio ratio els cfs live ratio cfs live ratio ratio logger info live ratio count calcul column object cfs cfs live ratio ratio system current time milli start object activ measur null final meter progress remov cfs meter executor submit runnabl privat void resolv decor key key column famili secondari index manag updat index column famili previous column famili key previous null atom sort column doesn work super column column famili empti clone shallow super thread safe sort column factori atom sort column factori fals add column avoid wast work beaten put absent previous column famili put absent decor key key token alloc clone key key empti previous null previous empti long size delta previous add size delta alloc local copi function index current size add size delta current oper add column count mark delet column count debug public string content string builder builder string builder builder append map entri row posit column famili entri column famili entri set builder append entri key append append entri valu append builder append return builder string public void flush signal final count latch latch final futur replay posit context flush writer execut flush runnabl latch context public string string return string format memtabl serial live byte op cfs column famili hash code current size live size current oper param start includ data result includ key memtabl return iter entri data start key public iter map entri decor key column famili entri iter final row posit start final row posit stop return iter map entri decor key column famili privat iter map entri row posit column famili iter stop minimum column famili tail map start entri set iter column famili map start true stop true entri set iter public boolean return iter public map entri decor key column famili map entri row posit column famili entri iter actual store key true decor key assert entri key instanceof decor key return map entri decor key column famili object entri ugli public void remov iter remov public boolean clean return column famili empti obtain iter column memtabl specifi order start column public static disk atom iter slice iter final decor key key final column famili slice queri filter filter assert null final iter column filter iter filter revers revers iter filter slice iter filter slice return abstract column iter public column famili column famili return public decor key key return key public boolean return filter iter public disk atom return filter iter public static disk atom iter iter final decor key key final column famili final queri filter filter assert null final boolean standard super return simpl abstract column iter privat iter byte buffer iter filter column iter public column famili column famili return public decor key key return key protect disk atom comput iter byte buffer current iter column column column current column null clone supercolumn caller freeli remov delet otherwis mutat return standard column super column column clone return data public column famili column famili decor key key return column famili key void clear unsaf column famili clear public long creation time return creation time class flush runnabl extend disk awar runnabl privat final count latch latch privat final futur replay posit context privat final long estim size flush runnabl count latch latch futur replay posit context latch latch context context long key size row posit key column famili key set don write sensic key assert key instanceof decor key key size decor key key key remain estim size long key size index entri key size key data file current size data bloom filter row index overhead public long expect write size return estim size protect void run file data directori throw assert data directori null flush task bound ani disk tabl reader sstabl write sort content context data directori cfs replac flush memtabl sstabl latch count privat tabl reader write sort content futur replay posit context file data directori throw execut interrupt logger info write memtabl string tabl reader tabl error creat writer leav empti temp file tabl writer writer creat flush writer cfs temp tabl path cfs directori locat disk data directori tri clear map free memori sinc memtabl queri pend flush categori map entri row posit column famili entri column famili entri set column famili entri valu mark delet everi node reason write batchlog data sstabl turn incur cost compact sinc write delet cancel data strict local don preserv tombston repair data row row level tombston write effect expens skip cfs column famili equal system tabl cfs tabl equal tabl empti continu pedant purg column level tombston race write tabl result unexpect behaviour delet disk lost overrid exist column valu onli remov delet column level tombston ensur delet tabl column famili store remov delet column onli integ writer append decor key entri key writer file pointer tabl writer close open reader logger info string format complet flush byte commitlog posit tabl filenam file tabl filenam length context els writer abort tabl null logger info complet flush noth retain commitlog posit context return tabl catch throwabl writer abort throw throwabl propag public tabl writer creat flush writer string filenam throw execut interrupt tabl metadata collector sstabl metadata collector tabl metadata creat collector replay posit context return tabl writer filenam column famili size cfs metadata cfs partition sstabl metadata collector 