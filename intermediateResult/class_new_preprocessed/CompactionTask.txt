licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra compact import java file import java import java util import javax print attribut integ syntax import googl common base predic import googl common base throwabl import googl common collect iter import googl common collect iter import googl common primit long import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra column famili store import org apach cassandra decor key import org apach cassandra row index entri import org apach cassandra compact compact manag compact executor stat collector import org apach cassandra sstabl import org apach cassandra util closeabl iter public class compact task extend abstract compact task protect static final logger logger logger factori logger compact task class protect final int befor protect static long total byte compact privat set tabl reader compact privat compact executor stat collector collector public compact task column famili store cfs collect tabl reader sstabl final int befor super cfs sstabl befor befor compact hash set tabl reader sstabl public static synchron long add total byte compact long byte compact return total byte compact byte compact intern test onli rest system submit method proper serial caller charg mark unmark sstabl compact public int execut compact executor stat collector collector collector collector run return compact size public long expect write size return cfs expect compact file size compact compact type public boolean reduc scope limit space partial compact accept compact size tri largest logger warn insuffici space compact request file string util join compact note remov file mark compact suboptim sinc caller unmark sstabl return compact remov cfs max size file compact els return fals intern test onli rest system submit method proper serial caller charg mark unmark sstabl compact protect void run file data directori throw collect sstabl pass empti null empti compact noth row delet assert sstabl null data directori null databas descriptor snapshot befor compact cfs snapshot flush system current time milli compact cfs column famili saniti check sstabl belong cfs tabl reader sstabl compact assert sstabl descriptor cfname equal cfs column famili compact control control compact control cfs compact befor sstabl flush ad dure compact onli compact remov singl thread compact world valid determin compact sstabl exist start logger info compact compact long start time system current time milli long totalkey written abstract compact strategi strategi cfs compact strategi long estim total key math max databas descriptor index interv tabl reader approxim key count compact long estim tabl math max tabl total byte compact strategi max tabl size long key tabl long math ceil doubl estim total key estim tabl logger debug enabl logger debug expect bloom filter size key tabl abstract compact iter databas descriptor multithread compact parallel compact iter compact type strategi scanner compact control compact iter compact type strategi scanner compact control closeabl iter abstract compact row iter iter map decor key row index entri cach key hash map decor key row index entri preheat tracker set doesn happen cfs replac entri track entri preheat map descriptor map decor key row index entri cach key map hash map descriptor map decor key row index entri collect tabl reader sstabl array list tabl reader collect tabl writer writer array list tabl writer collector null collector compact tri iter don mark compact final block sinc nondelet data sync close open period dure crash caus data loss cfs mark compact compact compact type return tabl writer writer cfs creat compact writer key tabl cfs directori locat disk data directori compact writer add writer iter stop request throw compact interrupt compact info abstract compact row row iter row empti control invalid cach row row key row close continu row cach call remov delet read time coher queri return row push cach obsolet tombston persist indefinit control remov delet cach row key row index entri index entri writer append row totalkey written databas descriptor preheat key cach tabl reader sstabl compact sstabl cach posit row key fals null cach key put row key index entri break tabl segment threshold reach writer tmp fals becaus queri descriptor tabl reader cach key map put writer descriptor temporari fals cach key writer cfs creat compact writer key tabl cfs directori locat disk data directori compact writer add writer cach key hash map decor key row index entri writer file pointer cach key map put writer descriptor temporari fals cach key els writer abort writer remov writer long max age max data age compact tabl writer complet writer writer sstabl add complet writer close open reader max age catch throwabl tabl writer writer writer writer abort remov alreadi complet tabl tabl reader sstabl sstabl sstabl mark compact sstabl releas refer throw throwabl propag final control close tri iter close catch throw runtim collector null collector finish compact cfs replac compact tabl compact sstabl compact type doesn belong part reader load tracker wire tabl reader sstabl sstabl map entri decor key row index entri entri cach key map sstabl descriptor entri set sstabl cach key entri key entri valu log bunch statist result long time system current time milli start time long startsiz tabl total byte compact long endsiz tabl total byte sstabl doubl ratio doubl endsiz doubl startsiz string builder builder string builder tabl reader reader sstabl builder append reader descriptor base filenam append doubl mbps time doubl endsiz doubl time long total sourc row string merg summari long count merg row count int count length int row long count count total sourc row row count merg summari string format row count logger info string format compact sstabl byte origin dms total row uniqu row merg count compact size builder string startsiz endsiz int ratio time mbps total sourc row totalkey written merg summari logger debug string format total byte compact compact task add total byte compact endsiz protect boolean partial compact accept return user defin extens point strategi limit upper bound sstabl segment size protect boolean tabl segment threshold reach tabl writer writer return fals public static long max data age collect tabl reader sstabl long max tabl reader sstabl sstabl sstabl max data age max max sstabl max data age return max 