licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra locat import java net inet address import java nio byte buffer import java util import java util concurr concurr hash map import java util concurr concurr map import java util concurr copi write array list import java util concurr lock read write lock import java util concurr lock reentrant read write lock import googl common collect import org apach cassandra util multi val map import org apach cassandra util pair import org apach cassandra util sort multi val map import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra gms failur detector import org apach cassandra servic storag servic public class token metadata privat static final logger logger logger factori logger token metadata class maintain token endpoint map everi node cluster privat final multi val map token inet address token endpoint map maintain endpoint host map everi node cluster privat final map inet address endpoint host map prior map rang inet address pend rang ad node began bootstrap remov finish inadequ multipl chang simultan exampl suppos ring node replic factor node bootstrap pend rang suppos node bootstrap time pend rang node assign pend rang unabl repres map happen obvious ani node boot simultan node chang chang pend rang multimap rang inet address map string multimap rang inet address becaus replic strategi option key space ad bootstrap token leav endpoint collect rebuild pend rang complet inform addit chang mid oper final note record token join node bootstrap token detect reject addit multipl node token befor becom part ring privat final multi val map token inet address bootstrap token multi val map token inet address don record token sinc part token endpoint map leav privat final set inet address leav endpoint hash set inet address cach calcul token endpoint map bootstrap token leav endpoint privat final concurr map string multimap rang token inet address pend rang concurr hash map string multimap rang token inet address node migrat token ring privat final set pair token inet address move endpoint hash set pair token inet address token migrat endpoint privat final map token inet address reloc token hash map token inet address lock manipul token map privat final read write lock lock reentrant read write lock true privat volatil array list token sort token privat final topolog topolog list subscrib notifi token endpoint map chang privat final copi write array list abstract replic strategi subscrib copi write array list abstract replic strategi privat static final compar inet address inetaddress cmp compar inet address public int compar inet address inet address return byte buffer wrap address compar byte buffer wrap address public token metadata sort multi val map token inet address creat null inetaddress cmp hash map inet address creat topolog privat token metadata multi val map token inet address token endpoint map map inet address endpoint map topolog topolog token endpoint map token endpoint map topolog topolog endpoint host map endpoint map sort token sort token privat array list token sort token return array list token token endpoint map key set return number node bootstrap sourc primari rang public int pend rang chang inet address sourc int collect rang token sourc rang primari rang token sourc lock read lock lock tri token token bootstrap token key set rang token rang sourc rang rang token final lock read lock unlock return updat token map singl token endpoint pair normal state public void updat normal token token token inet address endpoint updat normal token collect singleton token endpoint public void updat normal token collect token token inet address endpoint multimap inet address token endpoint token hash multimap creat token token token endpoint token put endpoint token updat normal token endpoint token updat token map set token endpoint pair normal state prefer whenev multipl pair updat updat singl multipl expens param endpoint token public void updat normal token multimap inet address token endpoint token endpoint token empti return lock write lock lock tri boolean sort token fals inet address endpoint endpoint token key set collect token token endpoint token endpoint assert token null token empti bootstrap token remov valu endpoint token endpoint map remov valu endpoint topolog add endpoint endpoint leav endpoint remov endpoint remov move endpoint remov endpoint move token token token inet address prev token endpoint map put token endpoint endpoint equal prev prev null logger warn token token chang ownership prev endpoint sort token true sort token sort token sort token final lock write lock unlock store point host map uniqu chang fact param host param endpoint public void updat host host inet address endpoint assert host null assert endpoint null inet address store endpoint host map invers host store null store equal endpoint failur detector instanc aliv store throw runtim string format host collis activ endpoint store endpoint host store endpoint host map endpoint store null store equal host logger warn chang host object endpoint store host endpoint host map forc put endpoint host return uniqu host point public host inet address endpoint return endpoint host map endpoint return point uniqu host public inet address endpoint host host return endpoint host map invers host return copi endpoint map read onli oper public map inet address endpoint host map read map inet address read map hash map inet address read map put endpoint host map return read map deprec public void add bootstrap token token token inet address endpoint add bootstrap token collect singleton token endpoint public void add bootstrap token collect token token inet address endpoint assert token null token empti assert endpoint null lock write lock lock tri inet address endpoint token token token endpoint bootstrap token token endpoint null endpoint equal endpoint throw runtim bootstrap token collis endpoint endpoint token token endpoint token endpoint map token endpoint null endpoint equal endpoint throw runtim bootstrap token collis endpoint endpoint token token bootstrap token remov valu endpoint token token token bootstrap token put token endpoint final lock write lock unlock public void remov bootstrap token collect token token assert token null token empti lock write lock lock tri token token token bootstrap token remov token final lock write lock unlock public void add leav endpoint inet address endpoint assert endpoint null lock write lock lock tri leav endpoint add endpoint final lock write lock unlock add move endpoint param token token node move param endpoint address move node public void add move endpoint token token inet address endpoint assert endpoint null lock write lock lock tri move endpoint add pair creat token endpoint final lock write lock unlock add reloc rang token move respect endpoint anoth param token token move param endpoint destin move public void add reloc token collect token token inet address endpoint assert endpoint null assert token null token size lock write lock lock tri token token token inet address prev reloc token put token endpoint prev null prev equal endpoint logger warn reloc overwrit previous object token endpoint prev final lock write lock unlock public void remov endpoint inet address endpoint assert endpoint null lock write lock lock tri bootstrap token remov valu endpoint token endpoint map remov valu endpoint topolog remov endpoint endpoint leav endpoint remov endpoint endpoint host map remov endpoint sort token sort token invalid cach final lock write lock unlock remov pair token address move endpoint param endpoint address move node public void remov move inet address endpoint assert endpoint null lock write lock lock tri pair token inet address pair move endpoint pair equal endpoint move endpoint remov pair break invalid cach final lock write lock unlock remov pair token address reloc rang param endpoint public void remov reloc token token inet address endpoint assert endpoint null assert token null lock write lock lock tri inet address previous reloc token remov token previous null logger debug remov reloc previous remov token els previous equal endpoint logger warn remov reloc token mismatch endpoint object token endpoint previous final lock write lock unlock public collect token token inet address endpoint assert endpoint null assert member endpoint don return null lock read lock lock tri return array list token token endpoint map invers endpoint final lock read lock unlock deprec public token token inet address endpoint return token endpoint iter public boolean member inet address endpoint assert endpoint null lock read lock lock tri return token endpoint map invers key endpoint final lock read lock unlock public boolean leav inet address endpoint assert endpoint null lock read lock lock tri return leav endpoint endpoint final lock read lock unlock public boolean move inet address endpoint assert endpoint null lock read lock lock tri pair token inet address pair move endpoint pair equal endpoint return true return fals final lock read lock unlock public boolean reloc token token assert token null lock read lock lock tri return reloc token key token final lock read lock unlock creat copi token metadata onli token endpoint map pend rang bootstrap token leav endpoint includ copi public token metadata clone onli token map lock read lock lock tri return token metadata sort multi val map token inet address creat token endpoint map null inetaddress cmp hash map creat endpoint host map topolog topolog final lock read lock unlock creat copi token metadata token endpoint map reflect situat current leav oper finish return token metadata public token metadata clone left lock read lock lock tri token metadata left metadata clone onli token map inet address endpoint leav endpoint left metadata remov endpoint endpoint return left metadata final lock read lock unlock creat copi token metadata token endpoint map reflect situat current leav move reloc oper finish return token metadata public token metadata clone settl lock read lock lock tri token metadata metadata clone onli token map inet address endpoint leav endpoint metadata remov endpoint endpoint pair token inet address pair move endpoint metadata updat normal token pair left pair map entri token inet address reloc reloc token entri set metadata updat normal token reloc key reloc valu return metadata final lock read lock unlock public inet address endpoint token token lock read lock lock tri return token endpoint map token final lock read lock unlock public collect rang token primari rang collect token token collect rang token rang array list rang token token size token token rang add rang token predecessor return rang deprec public rang token primari rang token return primari rang array list iter public array list token sort token return sort token privat multimap rang token inet address pend rang string tabl multimap rang token inet address map pend rang tabl map null map hash multimap creat multimap rang token inet address prior map pend rang put absent tabl map prior map null map prior map return map mutabl map return caller modifi public map rang token collect inet address pend rang string tabl return pend rang tabl map public list rang token pend rang string tabl inet address endpoint list rang token rang array list rang token map entri rang token inet address entri pend rang tabl entri entri valu equal endpoint rang add entri key return rang public void set pend rang string tabl multimap rang token inet address rang map pend rang put tabl rang map public token predecessor token token list token sort token int index collect binari search token token assert index token string util join token endpoint map key set return token index token token size token index public token successor token token list token sort token int index collect binari search token token assert index token string util join token endpoint map key set return token index token size token token index return copi bootstrap token map public multi val map token inet address bootstrap token lock read lock lock tri return multi val map token inet address bootstrap token final lock read lock unlock public set inet address endpoint return endpoint host map key set caller modifi leav endpoint public set inet address leav endpoint return leav endpoint endpoint migrat token return set address move endpoint public set pair token inet address move endpoint return move endpoint rang migrat endpoint return set token address pair reloc rang public map token inet address reloc rang return reloc token public static int token index final array list ring token start boolean insert min assert ring size insert minimum token index includ isn member ring int collect binari search ring start ring size insert min return public static token token final array list token ring token start return ring token index ring start fals iter token ring start token node start doe token ring param includ min true minimum token return ring owner public static iter token ring iter final array list token ring token start boolean includ min ring empti return includ min iter singleton iter storag servic partition minimum token iter token empti iter final boolean insert min includ min ring minimum final int start index token index ring start insert min return abstract iter token int start index protect token comput return data tri return minimum index return storag servic partition minimum token return ring token index return ring final ring size insert min start index iter test public void clear unsaf bootstrap token clear token endpoint map clear topolog clear leav endpoint clear pend rang clear endpoint host map clear invalid cach public string string string builder string builder lock read lock lock tri set inet address ep token endpoint map invers key set ep empti append normal token append system properti line separ inet address ep append append append token endpoint map invers append system properti line separ bootstrap token empti append bootstrap token append system properti line separ map entri token inet address entri bootstrap token entri set append entri valu append append entri key append system properti line separ leav endpoint empti append leav endpoint append system properti line separ inet address leav endpoint append append system properti line separ pend rang empti append pend rang append system properti line separ append print pend rang final lock read lock unlock return string public string print pend rang string builder string builder map entri string multimap rang token inet address entri pend rang entri set map entri rang token inet address rmap entri valu entri append rmap valu append append rmap key append system properti line separ return string public string print reloc rang string builder string builder map entri token inet address entri reloc token entri set append string format entri key entri valu return string public void invalid cach abstract replic strategi subscrib subscrib subscrib invalid cach token endpoint valu public void regist abstract replic strategi subscrib subscrib add subscrib public void unregist abstract replic strategi subscrib subscrib remov subscrib public collect inet address pend endpoint token token string tabl map rang token collect inet address rang pend rang tabl rang empti return collect empti list set inet address endpoint hash set inet address map entri rang token collect inet address entri rang entri set entri key token endpoint add entri valu return endpoint deprec retain benefit test public collect inet address write endpoint token token string tabl collect inet address natur endpoint array list inet address endpoint array list inet address iter add endpoint iter concat natur endpoint pend endpoint token tabl return endpoint return endpoint token multimap represent token endpoint map copi public multimap inet address token endpoint token map read lock read lock lock tri multimap inet address token clone hash multimap creat map entri token inet address entri token endpoint map entri set clone put entri valu entri key return clone final lock read lock unlock return stabl copi won modifi token endpoint map normal bootstrap node cluster public map token inet address normal bootstrap token endpoint map lock read lock lock tri map token inet address map hash map token inet address token endpoint map size bootstrap token size map put token endpoint map map put bootstrap token return map final lock read lock unlock return topolog map node rack onli copi token metadata avoid concurr modif topolog method subsequ caller public topolog topolog assert storag servic instanc token metadata return topolog track assign rack endpoint datacent normal endpoint token metadata faster calcul endpoint network topolog strategi public static class topolog multi map endpoint privat final multimap string inet address endpoint map multi map rack endpoint rack privat final map string multimap string inet address rack revers lookup map endpoint current rack assign privat final map inet address pair string string current locat protect topolog endpoint hash multimap creat rack hash map string multimap string inet address current locat hash map inet address pair string string protect void clear endpoint clear rack clear current locat clear construct deep copi protect topolog topolog endpoint hash multimap creat endpoint rack hash map string multimap string inet address string rack key set rack put hash multimap creat rack current locat hash map inet address pair string string current locat store current rack assign protect void add endpoint inet address endpoint snitch snitch databas descriptor endpoint snitch string snitch datacent string rack snitch rack pair string string current current locat current null current left equal current equal rack return rack current left remov current endpoint remov current left endpoint put rack key rack put hash multimap string inet address creat rack put rack current locat put pair creat rack remov current rack assign protect void remov endpoint inet address current locat key return pair string string current current locat remov endpoint remov current left rack current left remov current return multi map endpoint public multimap string inet address datacent endpoint return endpoint return map multi map rack endpoint rack public map string multimap string inet address datacent rack return rack 