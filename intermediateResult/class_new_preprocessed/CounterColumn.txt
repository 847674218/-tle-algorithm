licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java import java nio byte buffer import java net inet address import java secur messag digest import java util set import googl common collect immut set import googl common collect set import org slf logger import org slf logger factori import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra context counter context import org apach cassandra context context context relationship import org apach cassandra marshal abstract type import org apach cassandra marshal marshal import org apach cassandra overload import org apach cassandra request execut import org apach cassandra column serial import org apach cassandra util data output buffer import org apach cassandra util alloc import org apach cassandra servic abstract write respons handler import org apach cassandra servic storag proxi import org apach cassandra util column repres partit counter public class counter column extend column privat static final logger logger logger factori logger counter column class protect static final counter context context manag counter context instanc privat final long timestamp delet public counter column byte buffer long valu long timestamp context manag creat valu heap alloc instanc timestamp public counter column byte buffer long valu long timestamp long timestamp delet context manag creat valu heap alloc instanc timestamp timestamp delet public counter column byte buffer byte buffer valu long timestamp valu timestamp long public counter column byte buffer byte buffer valu long timestamp long timestamp delet super valu timestamp timestamp delet timestamp delet public static counter column creat byte buffer byte buffer valu long timestamp long timestamp delet column serial flag flag elt negat clean delta short count valu short valu posit flag column serial flag flag column serial flag count valu counter context instanc clear delta valu return counter column valu timestamp timestamp delet public long timestamp delet return timestamp delet public long total return context manag total valu overrid public int data size counter column add column byte timestamp delet return super data size type size sizeof timestamp delet overrid public int serial size type size type size return super serial size type size type size sizeof timestamp delet overrid public column diff column column assert column instanceof counter column column instanceof delet column wrong class type column class timestamp column timestamp return column note point column tombston inde column result merg node result merg counter column tombston return tombston tombston timestamp greater counter column assert column instanceof delet column wrong class type column class timestamp delet counter column column timestamp delet return column context relationship rel context manag diff column valu valu context relationship rel context relationship rel return column return null special case digest creation counter column becaus don includ inform shard context delta sinc inform differ node node overrid public void updat digest messag digest digest digest updat duplic don delta account digest context manag updat digest digest valu data output buffer buffer data output buffer tri buffer write long timestamp buffer write byte serial flag buffer write long timestamp delet catch throw runtim digest updat buffer data buffer length overrid public column reconcil column column alloc alloc assert column instanceof counter column column instanceof delet column wrong class type column class column mark delet live tombston track tombston timestamp column timestamp live tombston return column live delet tombston timestamp delet column timestamp return live delet tombston return counter column valu timestamp column timestamp live live delet timestamp counter column column timestamp delet return column live delet live timestamp delet column timestamp return live live merg clock updat valu return counter column context manag merg valu column valu alloc math max timestamp column timestamp math max timestamp delet counter column column timestamp delet overrid public boolean equal object super equal return fals counter column return super equal timestamp delet counter column timestamp delet overrid public int hash code int result super hash code result result int timestamp delet timestamp delet return result overrid public column local copi column famili store cfs return counter column cfs intern copi heap alloc instanc byte buffer util clone valu timestamp timestamp delet overrid public column local copi column famili store cfs alloc alloc return counter column cfs intern copi alloc alloc clone valu timestamp timestamp delet overrid public string string abstract type compar string builder string builder append compar string append append mark delet append append context manag string valu append append timestamp append append timestamp delet return string overrid public int serial flag return column serial overrid public void valid field meta data metadata throw marshal valid metadata valu valid column counter column type valid long intern represent counter context manag valid context valu check counter counter column context public boolean counter counter return context manag counter valu privat counter column comput shard merger int merg befor byte buffer context manag comput shard merger valu counter local counter id merg befor null return null els return counter column timestamp timestamp delet privat counter column remov shard int befor byte buffer context manag remov shard valu befor valu return els return counter column timestamp timestamp delet public static void merg remov shard decor key key column famili int befor int merg befor merg remov shard key befor merg befor true phase remov shard phase merg shard valu current shard nulifi send counter context shard nulifi replica phase onc shard nulifi longer grace replica awar merg simpli remov shard context valu method doe phase note send replica flag onli facilit test true real code method abov prefer public static void merg remov shard decor key key column famili int befor int merg befor boolean send replica column famili remot merger null super column instanceof counter column continu counter column counter column counter column shard merger comput shard merger merg befor counter column merg shard merger null merg counter column reconcil shard merger remot merger null remot merger clone shallow remot merger add column merg counter column clean merg remov shard befor clean replac clean els column col super column super column col column column column column instanceof counter column continu counter column counter column column counter column shard merger comput shard merger merg befor counter column merg shard merger null merg counter column reconcil shard merger remot merger null remot merger clone shallow remot merger add column merg counter column clean merg remov shard befor clean column replac column clean remot merger null send replica tri send replica key remot merger catch logger error error send shard merger mutat remot endpoint public column mark delta clear return counter column context manag mark delta clear valu timestamp timestamp delet privat static void send replica decor key key column famili throw request execut row mutat row mutat metadata key key add final inet address local util broadcast address string local data center databas descriptor endpoint snitch datacent local storag proxi perform write consist level local data center storag proxi write perform public void appli mutat mutat iter inet address target abstract write respons handler respons handler string local data center consist level consist level throw overload onli send remot replica local set inet address remot set differ immut set copi target immut set local fake local respons good lad won wait respons handler respons handler respons null storag proxi send hint endpoint row mutat mutat remot respons handler local data center consist level null write type don wait answer 