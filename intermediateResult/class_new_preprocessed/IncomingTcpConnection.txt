licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra net import java import java net inet address import java net socket import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra gms gossip import org apach cassandra util fast byte array input stream import org apach cassandra stream incom stream reader import org apach cassandra stream stream header import org xerial snappi snappi input stream public class incom tcp connect extend thread privat static final logger logger logger factori logger incom tcp connect class privat final socket socket public inet address public incom tcp connect socket socket assert socket null socket socket connect stream messag entir lifetim becaus stream bypass input stream implement send file buffer determin type connect overrid public void run tri determin connect type decid buffer data input stream data input stream socket input stream messag servic valid magic read int int header read int boolean stream messag servic bit header int version messag servic bit header logger debug connect version version socket inet address stream handl stream version els version messag servic handl legaci version version els handl modern version version header catch logger trace eof read socket close connect reset throw catch logger debug read socket close final close privat void handl modern version int version int header throw data output stream data output stream socket output stream write int messag servic current version flush data input stream data input stream socket input stream int max version read int compact endpoint serial helper deseri boolean compress messag servic bit header compress logger debug upgrad incom connect compress data input stream snappi input stream socket input stream els data input stream buffer input stream socket input stream logger debug max version max version version messag servic current version save endpoint gossip reconnect gossip instanc add save endpoint logger info receiv messag newer protocol version ignor version return messag servic instanc set version math min messag servic current version max version logger debug set version math min messag servic current version max version outbound side reconnect necessari upgrad version true messag servic valid magic read int receiv messag version privat void handl legaci version int version throw data input stream data input stream buffer input stream socket input stream receiv messag version whi logger debug version version version messag servic current version save endpoint gossip reconnect gossip instanc add save endpoint logger info receiv messag newer protocol version ignor return int version messag servic instanc set version version logger debug set version version version version logger debug break outbound connect forc version upgrad messag servic instanc connect pool reset newer version version true messag servic valid magic read int int header read int legaci protocol send header messag assert messag servic bit header stream connect chang stream version messag servic bit header logger trace version version receiv messag version privat void handl stream data input stream input int version throw version messag servic current version int size input read int byte header byte byte size input read fulli header byte stream stream header serial deseri data input stream fast byte array input stream header byte version input els stream connect session fix version anyth wrong version stream connect drop logger error receiv stream protocol version version termin connect version messag servic current version privat inet address receiv messag data input stream input int version throw version messag servic input read int size entir messag placehold string input read long timestamp system current time milli version messag servic read int cross node enabl int partial input read int databas descriptor cross node timeout timestamp timestamp partial messag messag messag read input version messag null callback expir noth return null version messag servic current version messag servic instanc receiv messag timestamp els logger debug receiv connect newer protocol version ignor messag version return messag privat void close reset version sinc set start incom socket null messag servic instanc reset version tri socket close catch logger debug enabl logger debug error close socket privat void stream stream header stream header data input stream input throw incom stream reader stream header socket read 