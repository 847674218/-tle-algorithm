licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra servic import java import java net inet address import java util collect import java util list import java util concurr time unit import java util concurr atom atom integ import org apach cassandra config schema import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra read command import org apach cassandra tabl import org apach cassandra read timeout import org apach cassandra unavail import org apach cassandra net async callback import org apach cassandra net messag import org apach cassandra net messag import org apach cassandra net messag servic import org apach cassandra consist level import org apach cassandra util util import org apach cassandra util simpl condit import org apach cassandra util wrap runnabl public class read callback messag resolv implement async callback messag protect static final logger logger logger factori logger read callback class public final respons resolv messag resolv resolv privat final simpl condit condit simpl condit privat final long start time privat final int blockfor final list inet address endpoint privat final read command command privat final consist level consist level privat final atom integ receiv atom integ privat final tabl tabl push consist level constructor respons count calcul block public read callback respons resolv messag resolv resolv consist level consist level read command command list inet address filter endpoint resolv consist level consist level block tabl open command keyspac command tabl open command keyspac filter endpoint logger trace enabl logger trace string format blockfor set request blockfor string util join endpoint privat read callback respons resolv messag resolv resolv consist level consist level int blockfor read command command tabl tabl list inet address endpoint command command tabl tabl blockfor blockfor consist level consist level resolv resolv start time system current time milli endpoint endpoint public read callback messag resolv resolv respons resolv messag resolv resolv return read callback resolv consist level blockfor command tabl endpoint public resolv throw read timeout digest mismatch long timeout command timeout system current time milli start time boolean success tri success condit await timeout time unit catch interrupt throw assert error success throw read timeout consist level receiv blockfor resolv data present return blockfor resolv data resolv resolv public void respons messag messag messag resolv preprocess messag int wait messag receiv increment receiv blockfor resolv data present condit signal mayb resolv repair return true messag count blockfor threshold privat boolean wait messag messag return consist level consist level databas descriptor local data center equal databas descriptor endpoint snitch datacent messag true public void respons messag result messag messag messag messag creat util broadcast address result collect string byte empti map messag servic verb messag servic current version respons messag check digest background repair stage receiv repli request protect void mayb resolv repair blockfor endpoint size receiv endpoint size assert resolv data present stage manag stage stage execut async repair runner public void assur suffici live node throw unavail consist level assur suffici live node tabl endpoint public boolean latenc snitch return true privat class async repair runner extend wrap runnabl protect void run throw throw resolv row digest resolv full data read mismatch otherwis resolv send repair direct case digest mismatch tri resolv resolv catch digest mismatch assert resolv instanceof row digest resolv logger debug enabl logger debug digest mismatch read command read command read command command final row data resolv repair resolv row data resolv read command tabl read command key read command filter async callback repair handler async repair callback repair resolv endpoint size messag read command messag read command command creat messag inet address endpoint endpoint messag servic instanc send messag endpoint repair handler 