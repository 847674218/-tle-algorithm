licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra sstabl import java file import java import java util map import java util tree map import java util concurr block queue import java util concurr synchron queue import googl common base throwabl import org apach cassandra config meta data import org apach cassandra column famili import org apach cassandra column famili type import org apach cassandra decor key import org apach cassandra tree map sort column import org apach cassandra marshal abstract type import org apach cassandra dht partition import org apach cassandra compress compress paramet import org apach cassandra net messag servic tabl writer doesn assum row sort order writer buffer row memori write sort order avoid load entir data set memori amount row buffer configur time threshold met tabl creat buffer reset abstract tabl simpl writer public class tabl simpl unsort writer extend abstract tabl simpl writer privat static final buffer buffer privat buffer buffer buffer privat final long buffer size privat long current size privat final block queue buffer write queue synchron queue buffer privat final disk writer disk writer disk writer creat buffer writer param directori directori write sstabl param partition partition param keyspac keyspac param column famili column famili param compar column famili compar param compar column famili compar null super column famili param buffer size data size befor sstabl written buffer reset correspond rough written data size size creat sstabl actual size memori higher depend size column add heap buffer size probabl reason choic experi valu public tabl simpl unsort writer file directori partition partition string keyspac string column famili abstract type compar abstract type compar int buffer size compress paramet compress paramet super directori meta data keyspac column famili compar null column famili type standard column famili type super compar compar compress paramet compress paramet partition buffer size buffer size disk writer start public tabl simpl unsort writer file directori partition partition string keyspac string column famili abstract type compar abstract type compar int buffer size directori partition keyspac column famili compar compar buffer size compress paramet null protect void write row decor key key column famili column famili throw current size key key remain column famili serial serial size column famili messag servic current version current size buffer size sync protect column famili column famili column famili previous buffer current key alreadi exist memori continu ad previous null previous column famili creat metadata tree map sort column factori buffer put current key previous els reus count alreadi becaus easier add full size write row call find delta remov size call current size current key key remain column famili serial serial size previous messag servic current version return previous public void close throw sync tri write queue put disk writer join catch interrupt throw runtim check writer privat void sync throw buffer empti return check writer tri write queue put buffer catch interrupt throw runtim buffer buffer current size privat void check writer throw slight lame report writer good disk writer null disk writer instanceof throw disk writer els throw throwabl propag disk writer typedef privat static class buffer extend tree map decor key column famili privat class disk writer extend thread volatil throwabl null public void run tabl writer writer null tri true buffer write queue return writer writer map entri decor key column famili entri entri set writer append entri key entri valu writer close open reader catch throwabl writer null writer abort 