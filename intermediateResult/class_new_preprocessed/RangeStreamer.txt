licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra dht import java net inet address import java util import java util concurr concurr hash map import java util concurr count latch import googl common collect array list multimap import googl common collect hash multimap import googl common collect multimap import org apach cassandra stream stream callback import org apach cassandra util util import org apach common lang string util import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra tabl import org apach cassandra gms failur detector import org apach cassandra gms failur detector import org apach cassandra locat abstract replic strategi import org apach cassandra locat endpoint snitch import org apach cassandra locat token metadata import org apach cassandra stream oper type import org apach cassandra stream stream assist stream rang node public class rang streamer privat static final logger logger logger factori logger rang streamer class privat final token metadata metadata privat final inet address address privat final oper type type privat final multimap string map entri inet address collect rang token fetch hash multimap creat privat final set sourc filter sourc filter hash set sourc filter protect test protect count latch latch privat set rang token complet collect set map concurr hash map rang token boolean filter appli sourc stream construct fetch map public static interfac sourc filter public boolean includ inet address endpoint sourc filter exclud ani endpoint aliv accord failur detector public static class failur detector sourc filter implement sourc filter privat final failur detector public failur detector sourc filter failur detector public boolean includ inet address endpoint return aliv endpoint sourc filter exclud ani endpoint specif data center public static class singl datacent filter implement sourc filter privat final string sourc privat final endpoint snitch snitch public singl datacent filter endpoint snitch snitch string sourc sourc sourc snitch snitch public boolean includ inet address endpoint return snitch datacent endpoint equal sourc public rang streamer token metadata metadata inet address address oper type type metadata metadata address address type type public void add sourc filter sourc filter filter sourc filter add filter public void add rang string tabl collect rang token rang multimap rang token inet address rang tabl rang sourc tabl rang logger debug enabl map entri rang token inet address entri rang tabl entri logger debug string format rang exist type entri key entri valu map entri inet address collect rang token entri rang fetch map rang tabl sourc filter map entri set logger debug enabl rang entri valu logger debug string format rang sourc tabl type entri key tabl fetch put tabl entri map rang respect sourc candid stream rang rang list sourc sort proxim relat dest address privat multimap rang token inet address rang sourc string tabl collect rang token desir rang abstract replic strategi strat tabl open tabl replic strategi multimap rang token inet address rang address strat rang address metadata clone onli token map multimap rang token inet address rang sourc array list multimap creat rang token desir rang desir rang rang token rang rang address key set rang desir rang list inet address prefer databas descriptor endpoint snitch sort list proxim address rang address rang rang sourc put desir rang prefer break rang sourc key set desir rang throw illeg state sourc desir rang return rang sourc param rang sourc rang fetch key potenti sourc valu param sourc filter possibl empti collect sourc filter appli addit ani filter alway exclud ourselv return privat static multimap inet address rang token rang fetch map multimap rang token inet address rang sourc collect sourc filter sourc filter multimap inet address rang token rang fetch map map hash multimap creat rang token rang rang sourc key set boolean sourc fals outer inet address address rang sourc rang address equal util broadcast address localhost sourc don add map avoid stream local sourc true continu sourc filter filter sourc filter filter includ address continu outer rang fetch map map put address rang sourc true break ensur onli stream node rang sourc throw illeg state unabl find suffici sourc stream rang rang return rang fetch map map public static multimap inet address rang token work map multimap rang token inet address rang sourc target return rang fetch map rang sourc target collect sourc filter singleton failur detector sourc filter failur detector instanc test purpos multimap string map entri inet address collect rang token fetch return fetch public void fetch latch count latch fetch entri size map entri string map entri inet address collect rang token entri fetch entri final string tabl entri key final inet address sourc entri valu key final collect rang token rang entri valu valu send messag respect folk stream data stream callback callback stream callback public void success complet add rang latch count logger debug enabl logger debug string format remov sourc remain sourc tabl type latch count public void failur latch count logger warn stream sourc fail logger debug enabl logger debug type ing sourc rang string util join rang stream request rang sourc tabl rang callback type tri latch await map entri string map entri inet address collect rang token entri fetch entri complet entri valu valu throw runtim string format unabl fetch rang keyspac ani host entri valu valu entri key catch interrupt throw assert error 