licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra util import java import java nio map byte buffer import java nio channel file channel import java util array list import java util array import java util list import org slf logger import org slf logger factori import org apach cassandra read error public class mmap segment file extend segment file privat static final logger logger logger factori logger mmap segment file class perfect world final test smaller size stay sane public static long integ sort array segment offset map byte buffer segment mmap complet disabl segment long mmap valu offset null indic fall random access file privat final segment segment public mmap segment file string path long length segment segment super path length segment segment return segment entri posit privat segment floor long posit assert posit posit length posit length segment seg segment posit null int idx array binari search segment seg assert idx bad posit posit segment array string segment idx entri insert point idx idx return segment idx return segment posit close public file data input segment long posit segment segment floor posit segment null segment mmap return map file data input segment path segment left int posit segment left mmap open braf cover segment braf unbound segment cover rest file row random access reader file random access reader open file path file seek posit return file public void cleanup file util cleaner avail return tri forc unmap segment undocu unsaf sun fail sun wait final map work thread tri access ani segment hell unleash earth tri segment segment segment segment null continu file util clean segment logger debug segment unmap success catch suppos happen logger error error unmap segment overrid default behaviour creat segment maximum size static class builder extend segment file builder plan segment boundari privat list long boundari offset open segment segment privat long current start current length open segment merg multipl larg mmap segment singl buffer segment privat long current size public builder super boundari array list long boundari add public void add potenti boundari long boundari boundari current start boundari fit current segment expand current size boundari current start return close current segment tri room boundari current size current start current size boundari add current start current size boundari current start couldn room boundari segment current size current start boundari boundari add current start current size public segment file complet string path long length file path length add sentinel valu length length boundari boundari size boundari add length creat segment return mmap segment file path length creat segment path privat segment creat segment string path int segcount boundari size segment segment segment segcount random access file raf tri raf random access file path catch file throw runtim tri int segcount long start boundari long size boundari start map byte buffer segment size raf channel map file channel map mode start size null segment segment start segment catch throw read error path final file util close quiet raf return segment overrid public void serial bound data output dos throw super serial bound dos dos write int boundari size long posit boundari dos write long posit overrid public void deseri bound data input dis throw super deseri bound dis list long temp array list long int size dis read int int size temp add dis read long boundari temp 