licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra compact import java file import java import java lang manag manag factori import java util import java util concurr import java util concurr lock lock import java util concurr lock reentrant read write lock import javax manag bean server import javax manag object import googl common base predic import googl common base throwabl import googl common collect concurr hash multiset import googl common collect iter import googl common collect multiset import googl common primit long import org slf logger import org slf logger factori import org apach cassandra cach auto save cach import org apach cassandra cach row cach key import org apach cassandra concurr debugg thread pool executor import org apach cassandra concurr thread factori import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra config schema import org apach cassandra import org apach cassandra commitlog replay posit import org apach cassandra compact compact info holder import org apach cassandra index secondari index import org apach cassandra index secondari index builder import org apach cassandra dht bound import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra sstabl import org apach cassandra util file util import org apach cassandra metric compact metric import org apach cassandra util random access reader import org apach cassandra servic anti entropi servic import org apach cassandra servic cach servic import org apach cassandra servic storag servic import org apach cassandra util closeabl iter import org apach cassandra util counter import org apach cassandra util pair import org apach cassandra util wrap runnabl singleton manag privat executor ongo compact readwrit lock control compact proceed extern consum complet stop compact acquir write lock compact lock schedul compact accomplish swap sstabl compact set data tracker schedul attempt ignor current compact sstabl public class compact manag implement compact manag bean public static final string org apach cassandra type compact manag privat static final logger logger logger factori logger compact manag class public static final compact manag instanc public static final int integ public static final int integ thread local current thread compact manag counter context figur log warn invalid counter shard public static final thread local boolean compact manag thread local boolean overrid protect boolean initi valu return fals compact lock purpos special compact acquir writelock readlock compact activ quiesc grab sstabl someth schema migrat run concurr compact current onli chang compact strategi mayb reload compact strategi big hammer onli care quiesc privat final reentrant read write lock compact lock reentrant read write lock static instanc compact manag bean server mbs manag factori platform bean server tri mbs regist bean instanc object catch throw runtim privat final compact executor executor compact executor privat final compact executor valid executor valid executor privat final compact metric metric compact metric executor valid executor privat final multiset column famili store compact concurr hash multiset creat return lock acquisit compact run public lock compact lock return compact lock write lock call whenev compact columnfamili call reason sinc compact singl thread call unnecessari ope bucket phase public list futur submit background final column famili store cfs int count compact count cfs count executor activ count executor maximum pool size logger debug background compact run remain skip object cfs tabl cfs column famili count return collect empti list logger debug schedul background task check object cfs tabl cfs column famili cfs compact strategi class simpl list futur futur array list futur room compact fill executor executor activ count futur size executor maximum pool size futur add executor submit background compact task cfs compact add cfs return futur actual sstabl compact determin run sstabl creat task submiss execut execut date inform class background compact task implement runnabl privat final column famili store cfs background compact task column famili store cfs cfs cfs public void run compact lock read lock lock tri logger debug check cfs tabl cfs column famili log lock delay ani cfs valid logger debug abort compact drop return abstract compact strategi strategi cfs compact strategi abstract compact task task strategi background task default befor cfs task null logger debug task avail return tri task execut metric final task unmark tabl final compact remov cfs compact lock read lock unlock submit background cfs privat static interfac tabl oper public void perform column famili store store collect tabl reader sstabl throw privat void perform tabl oper final column famili store cfs final tabl oper oper throw interrupt execut callabl object runnabl callabl object public object call throw compact lock write lock lock tri collect tabl reader sstabl true sstabl cfs data tracker uncompact tabl sstabl empti return cfs data tracker mark compact sstabl break tri downgrad lock acquisit compact lock read lock lock compact lock write lock unlock tri oper perform cfs sstabl final compact lock read lock unlock final cfs data tracker unmark compact sstabl return final probabl alreadi downgrad compact lock write lock held current thread compact lock write lock unlock executor submit runnabl public void perform scrub column famili store store throw interrupt execut perform tabl oper store tabl oper public void perform column famili store store collect tabl reader sstabl throw scrub store sstabl public void perform tabl rewrit column famili store store throw interrupt execut perform tabl oper store tabl oper public void perform column famili store cfs collect tabl reader sstabl assert cfs index final tabl reader sstabl sstabl tabl mark caller import task creat onli sstabl level compact level manifest replac compact task task compact task cfs collect singleton list sstabl task set user defin true task set compact type oper type task execut metric public void perform cleanup column famili store store final counter shot renew renew throw interrupt execut perform tabl oper store tabl oper public void perform column famili store store collect tabl reader sstabl throw sort column famili order tabl size cleanup smaller free space larger list tabl reader sort tabl array list tabl reader sstabl collect sort sort tabl compar tabl reader public int compar tabl reader tabl reader return long compar disk length disk length cleanup compact store sort tabl renew public void perform maxim final column famili store store throw interrupt execut submit maxim store default befor store public futur submit maxim final column famili store store final int befor runnabl runnabl wrap runnabl protect void run throw throw acquir write lock long schedul sstabl compact lock write lock lock tri abstract compact task task store compact strategi maxim task befor task null return tri downgrad lock acquisit compact lock read lock lock compact lock write lock unlock tri task execut metric final compact lock read lock unlock final task unmark tabl final probabl alreadi downgrad compact lock write lock held current thread compact lock write lock unlock return executor submit runnabl public void forc user defin compact string ksname string data file schema instanc tabl ksname throw illeg argument unknown keyspac ksname string filenam data file split collect descriptor descriptor array list descriptor filenam length string cfname null string filenam filenam extract keyspac columnfamili filenam descriptor desc descriptor filenam filenam trim desc ksname equal ksname throw illeg argument keyspac ksname doe match file filenam cfname null cfname desc cfname els cfname equal desc cfname throw illeg argument provid sstabl column famili file directori file ksname file separ cfname pair descriptor string descriptor filenam directori filenam trim equal compon throw illeg argument filenam doe data file descriptor add left column famili store cfs tabl open ksname column famili store cfname submit user defin cfs descriptor default befor cfs public futur submit user defin final column famili store cfs final collect descriptor data file final int befor runnabl runnabl wrap runnabl protect void run throw throw compact lock read lock lock tri sstabl compact executor don tri compact someth alreadi compact earlier collect tabl reader sstabl array list tabl reader data file size descriptor desc data file ineffici perform sensit path tabl reader sstabl lookup tabl cfs desc sstabl null logger info compact activ sstabl desc els sstabl add sstabl tri sstabl empti logger info file compact user defin compact attempt schedul set els cfs data tracker mark compact sstabl success perform compact tri abstract compact strategi strategi cfs compact strategi abstract compact task task strategi user defin task sstabl befor task execut metric final cfs data tracker unmark compact sstabl els logger info tabl user defin compact alreadi compact final tabl reader releas refer sstabl final compact lock read lock unlock return executor submit runnabl acquir refer sstabl effic ani critic path privat tabl reader lookup tabl final column famili store cfs descriptor descriptor tabl reader null tabl reader sstabl cfs mark current tabl referenc equal chang won work becaus sstabl descriptor directori absolut path construct descriptor absolut path haven ani satisfi data file locat tabl return path multipl volum henc sstabl descriptor string descriptor string sstabl els sstabl releas refer return doe mutat data schedul public futur object submit valid final column famili store store final anti entropi servic valid valid callabl object callabl callabl object public object call throw compact lock read lock lock tri valid compact store valid return final compact lock read lock unlock return valid executor submit callabl test public void disabl auto compact string ksname schema instanc system tabl column famili store cfs tabl open ksname column famili store cfs disabl auto compact deseri everyth serial newest version attempt recov bogus row key size data index skip row garbag column result earli byte buffer bug throw privat void scrub column famili store cfs collect tabl reader sstabl throw assert cfs index final tabl reader sstabl sstabl scrub cfs sstabl privat void scrub column famili store cfs tabl reader sstabl throw scrubber scrubber scrubber cfs sstabl compact info holder scrub info scrubber scrub info metric compact scrub info tri scrubber scrub final scrubber close metric finish compact scrub info scrubber order tabl null cfs add tabl scrubber order tabl scrubber tabl null cfs mark compact collect singleton list sstabl oper type els cfs replac compact tabl collect singleton list sstabl collect singleton list scrubber tabl oper type function goe file remov key node respons onli key node respons throw privat void cleanup compact column famili store cfs collect tabl reader sstabl counter shot renew renew throw assert cfs index tabl tabl cfs tabl collect rang token rang storag servic instanc local rang tabl rang empti logger info cleanup run befor node join ring return boolean commut cfs metadata default valid commut boolean index cfs index manag index empti tabl reader sstabl sstabl index bound token sstabl token sstabl token intersect rang cfs replac compact tabl array list sstabl collect tabl reader empti list oper type continu compact control control compact control cfs collect singleton list sstabl default befor cfs long start time system current time milli long totalkey written int expect bloom filter size math max databas descriptor index interv int tabl reader approxim key count array list sstabl logger debug enabl logger debug expect bloom filter size expect bloom filter size tabl writer writer null tabl reader sstabl null logger info clean sstabl calcul expect compact files long expect rang file size cfs expect compact file size array list sstabl oper type file compact file locat cfs directori directori tabl expect rang file size compact file locat null throw disk full tabl scanner scanner sstabl direct scanner long row read list column index column row null cleanup info cleanup info sstabl scanner metric compact tri scanner stop request throw compact interrupt compact info tabl ident iter row tabl ident iter scanner rang rang row key token rang abstract compact row compact row control compact row row compact row empti continu writer mayb creat writer cfs compact file locat expect bloom filter size writer collect singleton list sstabl writer append compact row totalkey written els cfs invalid cach row row key index commut index column row null index column row clear row disk atom column row column instanceof counter column renew mayb renew counter column column column instanceof column cfs index manag index column column index column row null index column row array list column index column row add column column index column row null index column row empti acquir memtabl lock becaus secondari index delet caus race tabl switch lock read lock lock tri cfs index manag delet index row key index column row final tabl switch lock read lock unlock row read control throttl scanner current posit writer null sstabl writer close open reader sstabl max data age catch throwabl writer null writer abort throw throwabl propag final control close scanner close metric finish compact list tabl reader result array list tabl reader sstabl null result add sstabl string format clean origin byte key time dms long time system current time milli start time long startsiz sstabl disk length long endsiz sstabl disk length doubl ratio doubl endsiz doubl startsiz logger info string format format writer filenam startsiz endsiz int ratio totalkey written time flush ensur don lose tombston restart sinc commitlog cfs index manag flush index block cfs replac compact tabl array list sstabl result oper type public static tabl writer mayb creat writer column famili store cfs file compact file locat int expect bloom filter size tabl writer writer collect tabl reader sstabl writer null file util creat directori compact file locat writer cfs creat compact writer expect bloom filter size compact file locat sstabl return writer perform readon compact sstabl order valid complet row write merg result privat void valid compact column famili store cfs anti entropi servic valid valid throw isn meant race proof becaus won caus bug drop mid valid attempt valid drope effort avoid useless work scenario valid submit befor drop compact start prior drop sstabl aliv sinc valid compact run concurr compact otherwis scan cfs valid return collect tabl reader sstabl int befor cfs snapshot exist valid request sessionid snapshot creat session read sstabl cfs snapshot tabl reader valid request sessionid comput gcbefor base current time wouldn veri good becaus replica execut differ time purpos repair snaphsot creation time snapshot give rought time replica rought case good snapshot case befor int cfs snapshot creation time valid request sessionid cfs metadata grace els flush everyon valid data similar possibl tri storag servic instanc forc tabl flush cfs tabl cfs column famili catch execut throw catch interrupt throw assert error don mark valid sstabl compact data tracker mark referenc won clean compact dure valid sstabl cfs mark current tabl referenc befor default befor cfs compact iter valid compact iter cfs sstabl valid request rang befor closeabl iter abstract compact row iter iter metric compact tri valid iter valid prepar cfs iter stop request throw compact interrupt compact info abstract compact row row iter row empti row close els valid add row valid complet final tabl reader releas refer sstabl iter close cfs tabl snapshot exist valid request sessionid cfs tabl clear snapshot valid request sessionid metric finish compact schedul becaus perform disjoint work sstabl compact public futur submit index build final secondari index builder builder runnabl runnabl runnabl public void run compact lock read lock lock tri metric compact builder tri builder build final metric finish compact builder final compact lock read lock unlock don submit executor compact lock held current thread return simpl futur immedi immedi execut happen dure migrat lock compact thread reiniti column famili store normal circumst spawn index job compact manag block compact lock write lock current thread return simpl futur runnabl els return executor submit runnabl public futur submit cach write final auto save cach writer writer runnabl runnabl runnabl public void run auto save cach flush progress add writer cach type logger debug cach flush alreadi progress skip writer compact info return tri metric compact writer tri writer save cach final metric finish compact writer final auto save cach flush progress remov writer cach type return executor submit runnabl public futur submit truncat final column famili store main final long truncat runnabl runnabl runnabl public void run compact lock write lock lock tri replay posit replay main discard tabl truncat secondari index index main index manag index index truncat truncat system tabl save truncat posit main replay row cach key key cach servic instanc row cach key set key main metadata cach servic instanc row cach remov key final compact lock write lock unlock return executor submit runnabl static int default befor column famili store cfs ndari index expir column purg tombston delet befor add ani grace howev sinc ndari index local node return cfs index int system current time milli int system current time milli cfs metadata grace privat static class valid compact iter extend compact iter public valid compact iter column famili store cfs collect tabl reader sstabl rang token rang int befor super oper type cfs compact strategi scanner sstabl rang valid compact control cfs befor control valid compact alway purg note call cfs overlap tabl provid sstabl becaus sstabl guarante activ sstabl sinc run repair snapshot privat static class valid compact control extend compact control public valid compact control column famili store cfs int befor super cfs befor overrid public boolean purg decor key key long del timestamp main reason alway purg includ gcabl tombston repair digest depend schedul compact differ node perfect becaus gcbefor current dependend current time valid compact start bad normal repair broken repair snapshot solut agre gcbefor node note valid compact includ sstabl don problem purg tombston shadow column anoth sstabl doubli concern sinc valid compact read onli return true public int activ compact return compact metric compact size privat static class compact executor extend thread pool executor protect compact executor int min thread int max thread string block queue runnabl queue super min thread max thread time unit queue thread factori thread core thread time true privat compact executor int thread count string thread count thread count link block queue runnabl public compact executor math max databas descriptor concurr compactor compact executor protect void befor execut thread runnabl set thread factori redund compact manag set true super befor execut modifi debugg thread pool executor compact interrupt log overrid public void execut runnabl throwabl super execut null debugg thread pool executor extract throwabl null instanceof compact interrupt logger info messag logger debug full interrupt stack trace els debugg thread pool executor handl log privat static class valid executor extend compact executor public valid executor super integ valid executor synchron queue runnabl public interfac compact executor stat collector void compact compact info holder void finish compact compact info holder public list map string string compact list holder compact holder compact metric compact list map string string array list map string string compact holder size compact info holder compact holder add compact info map return public list string compact summari list holder compact holder compact metric compact list string array list string compact holder size compact info holder compact holder add compact info string return public long total byte compact return metric byte compact count public long total compact complet return metric total compact complet count public int pend task return metric pend task valu public long complet task return metric complet task valu privat static class simpl futur implement futur privat runnabl runnabl privat simpl futur runnabl runnabl public boolean cancel boolean interrupt run throw illeg state call simpl futur cancel public boolean cancel return fals public boolean return runnabl null public object throw interrupt execut runnabl run runnabl null return runnabl public object long timeout time unit unit throw interrupt execut timeout throw illeg state call simpl futur long time unit privat static class cleanup info extend compact info holder privat final tabl reader sstabl privat final tabl scanner scanner public cleanup info tabl reader sstabl tabl scanner scanner sstabl sstabl scanner scanner public compact info compact info tri return compact info sstabl metadata oper type scanner current posit scanner length byte catch throw runtim public void stop compact string type oper type oper oper type valu type holder holder compact metric compact holder compact info task type oper holder stop public int core compactor thread return executor core pool size public void set core compactor thread int number executor set core pool size number public int maximum compactor thread return executor maximum pool size public void set maximum compactor thread int number executor set maximum pool size number public int core valid thread return valid executor core pool size public void set core valid thread int number valid executor set core pool size number public int maximum valid thread return valid executor maximum pool size public void set maximum valid thread int number valid executor set maximum pool size number tri stop compact column famili note method doe wait indefinit compact finish maximum wait time sec param column famili column famili tri stop compact public void stop compact collect meta data column famili assert column famili null holder compact holder compact metric compact compact info info compact holder compact info column famili info meta data compact holder stop signal compact stop 