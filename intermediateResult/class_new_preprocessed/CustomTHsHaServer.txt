licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra thrift import java import java net inet socket address import java nio channel select key import java nio channel selector import java nio channel spi selector provid import java util hash set import java util iter import java util set import java util concurr executor servic import java util concurr reject execut import java util concurr synchron queue import java util concurr time unit import org apach cassandra util util import org slf logger import org slf logger factori import org apach cassandra concurr enabl thread pool executor import org apach cassandra concurr thread factori import org apach cassandra config databas descriptor import org apach thrift server nonblock server import org apach thrift server server import org apach thrift transport nonblock server transport import org apach thrift transport nonblock socket import org apach thrift transport nonblock transport import org apach thrift transport transport interim solut commit idea avoid stick throughput spread multipl thread number selector thread number avail public class custom server extend nonblock server privat static final logger logger factori logger custom server class privat final set selector thread thread hash set selector thread privat volatil boolean stop true privat final executor servic invok argument block server appli addit executor pool respons creat intern thread process data thread select usual equal number cpu public custom server arg arg executor servic invok int thread count super arg invok invok creat network thread int thread count thread add selector thread selector thread inherit doc overrid public void serv start listen return start thread return set serv true join selector invok shutdown set serv fals stop listen save remot socket thead local futur client state protect class invoc implement runnabl privat final frame buffer frame buffer privat final selector thread thread public invoc final frame buffer frame buffer selector thread thread frame buffer frame buffer thread thread public void run nonblock socket socket nonblock socket frame buffer tran thrift session manag instanc set current socket socket socket channel socket remot socket address frame buffer invok selector thread chang select type thread request select interest chang frame buffer protect boolean start thread stop fals start thread selector thread thread thread thread start return true overrid protect void join selector tri wait stuff selector thread thread thread thread join catch interrupt error interrupt join thread stop serv shut everyth overrid public void stop stop listen stop true selector thread thread thread thread wakeup selector join selector thread perform expens oper protect class selector thread extend thread privat final selector selector privat final nonblock server transport server transport privat final set frame buffer select interest chang hash set frame buffer public selector thread string super tri selector selector provid provid open selector server transport nonblock server transport server transport server transport regist selector selector catch throw runtim couldnt open selector public void run tri stop select catch throwabl error uncaught final tri selector close catch ignor privat void select throw interrupt wait key selector select iter select key key iter selector select key iter key iter select key key key iter key iter remov tri key valid invalid cleanup cleanup selectionkey key continu key accept handl accept key readabl handl read key els key writabl handl write key els debug unexpect state key interest op catch ignor cleanup selectionkey key process chang insert complet process interest chang privat void handl accept select key client key null nonblock transport client null tri accept connect client nonblock transport server transport accept client key client regist selector selector select key add key map frame buffer frame buffer frame buffer client client key client key attach frame buffer catch transport ignor handl thread server transport accept return null noth accept return catch tte someth wrong accept warn tri accept tte tte print stack trace client key null cleanup selectionkey client key client null client close privat void handl read select key key frame buffer buffer frame buffer key attach buffer read cleanup selectionkey key return buffer frame fulli read request invok buffer cleanup selectionkey key privat void handl write select key key frame buffer buffer frame buffer key attach buffer write cleanup selectionkey key public void request select interest chang frame buffer frame buffer synchron select interest chang select interest chang add frame buffer wake selector current block selector wakeup privat void process interest chang synchron select interest chang frame buffer select interest chang chang select interest select interest chang clear privat void cleanup selectionkey select key key frame buffer buffer frame buffer key attach buffer null buffer close cancel select key key cancel public void wakeup selector selector wakeup protect boolean request invok frame buffer frame buffer selector thread thread tri runnabl invoc invoc frame buffer thread invok execut invoc return true catch reject execut warn executor servic reject execut return fals overrid protect void request select interest chang frame buffer dont chang interest selector thread becaus method synchron rest selector thread public static class factori implement server factori public server build server arg arg databas descriptor client encrypt option enabl throw runtim client support block socket hsha pleas remov client ssl configur final inet socket address addr arg addr nonblock server transport server transport tri server transport custom nonblock server socket addr arg aliv arg send buffer size arg recv buffer size catch transport throw runtim string format unabl creat thrift socket addr address addr port selector servic invoc multi thread executor servic executor servic executor servic enabl thread pool executor databas descriptor rpc min thread databas descriptor rpc max thread time unit synchron queue runnabl thread factori thread nonblock server arg server arg nonblock server arg server transport input transport factori arg transport factori output transport factori arg transport factori input protocol factori arg protocol factori output protocol factori arg protocol factori processor arg processor check avail processor system equal thread return custom server server arg executor servic util avail processor 