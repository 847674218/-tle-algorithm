licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra gms import java lang manag manag factori import java net inet address import java net unknown host import java util import java util map entri import java util concurr import javax manag bean server import javax manag object import googl common annot visibl test import org slf logger import org slf logger factori import org apach cassandra concurr debugg schedul thread pool executor import org apach cassandra config databas descriptor import org apach cassandra dht token import org apach cassandra net messag import org apach cassandra net messag servic import org apach cassandra servic storag servic import org apach cassandra util util modul respons gossip inform local endpoint abstract maintain list live dead endpoint period everi modul choos random node initi gossip gossip involv messag instanc node initi gossip node start send node gossip digest syn messag node receipt messag send node gossip digest ack messag receipt messag node send node gossip digest ack messag complet gossip modul hear abov mention messag updat failur detector live inform hear gossip shutdown messag modul instant mark remot node failur detector public class gossip implement failur detect event listen gossip bean privat static final string org apach cassandra net type gossip privat static final debugg schedul thread pool executor executor debugg schedul thread pool executor gossip task static final applic state applic state valu static final list string array list version valu version valu version valu version valu privat schedul futur schedul gossip task public final static int interv milli public final static int storag servic privat static final logger logger logger factori logger gossip class public static final gossip instanc gossip public static final long veri long time day privat long fat client timeout privat final random random random privat final compar inet address inetcompar compar inet address public int compar inet address addr inet address addr return addr host address compar addr host address subscrib interest endpoint state chang privat final list endpoint state chang subscrib subscrib copi write array list endpoint state chang subscrib live member set privat final set inet address live endpoint concurr skip list set inet address inetcompar unreach member set privat final map inet address long unreach endpoint concurr hash map inet address long initi seed join cluster privat final set inet address seed concurr skip list set inet address inetcompar map key endpoint valu state associ endpoint final concurr map inet address endpoint state endpoint state map concurr hash map inet address endpoint state map key endpoint valu timestamp endpoint remov gossip ignor ani gossip regard endpoint time remov prevent node fals reincarn dure time remov gossip propag node privat final map inet address long remov endpoint concurr hash map inet address long privat final map inet address long expir time endpoint map concurr hash map inet address long privat class gossip task implement runnabl public void run tri wait messag servic start listen messag servic instanc wait listen updat local heartbeat counter endpoint state map util broadcast address heart beat state updat heart beat logger trace enabl logger trace heartbeat endpoint state map util broadcast address heart beat state heart beat version final list gossip digest digest array list gossip digest gossip instanc random gossip digest digest digest size gossip digest syn digest syn messag gossip digest syn databas descriptor cluster databas descriptor partition digest messag gossip digest syn messag messag gossip digest syn messag servic verb digest syn messag gossip digest syn serial gossip random live member boolean gossip seed gossip live member messag gossip unreach member probabl check gossip unreach member messag gossip seed abov node seed prevent partit group node onli gossip subset seed straightforward check check seed verifi live unreach avoid comput reason live node seed case seed onlin introduc themselv member ring definit seed node list case eventu someon gossip gossip random seed gossip seed check exposit gossip seed live endpoint size seed size gossip seed messag logger trace enabl logger trace perform status check status check catch logger error gossip error privat gossip ensur remov endpoint leeway prevent gossip fat client timeout long regist failur detector receiv failur detector event failur detector instanc regist failur detect event listen regist instanc tri bean server mbs manag factori platform bean server mbs regist bean object catch throw runtim regist interest state chang param subscrib modul implement endpoint state chang subscrib public void regist endpoint state chang subscrib subscrib subscrib add subscrib unregist interest state chang param subscrib modul implement endpoint state chang subscrib public void unregist endpoint state chang subscrib subscrib subscrib remov subscrib public set inet address live member set inet address live mbrs hash set inet address live endpoint live mbrs util broadcast address live mbrs add util broadcast address return live mbrs public set inet address unreach member return unreach endpoint key set public long endpoint downtim inet address long downtim unreach endpoint downtim null return system current time milli downtim els return method part failur detect event listen interfac invok failur detector convict point param endpoint point convict public void convict inet address endpoint doubl phi endpoint state state endpoint state map endpoint state aliv dead state state mark dead endpoint state return greatest heartbeat applic state param state return int max endpoint state version endpoint state state int max version state heart beat state heart beat version version valu valu state applic state map valu max version math max max version valu version return max version remov endpoint gossip complet param endpoint endpoint remov current membership privat void evict membership inet address endpoint unreach endpoint remov endpoint endpoint state map remov endpoint expir time endpoint map remov endpoint quarantin endpoint endpoint logger debug enabl logger debug evict endpoint gossip remov endpoint gossip retain endpoint state public void remov endpoint inet address endpoint subscrib anyth subscrib depend gossip state won confus endpoint state chang subscrib subscrib subscrib subscrib remov endpoint live endpoint remov endpoint unreach endpoint remov endpoint remov endpoint state quarantin expir failur detector instanc remov endpoint messag servic instanc reset version endpoint quarantin endpoint endpoint messag servic instanc destroy connect pool endpoint logger debug enabl logger debug remov endpoint endpoint quarantin endpoint param endpoint privat void quarantin endpoint inet address endpoint remov endpoint put endpoint system current time milli remov endpoint evict immedi avoid gossip node onli call token address param endpoint endpoint replac public void replac endpoint inet address endpoint remov endpoint endpoint evict membership endpoint gossip digest built base random loop collect live endpoint param digest list gossip digest privat void random gossip digest list gossip digest digest endpoint state state int generat int max version local epstat part endpoint state map list inet address endpoint array list inet address endpoint state map key set collect shuffl endpoint random inet address endpoint endpoint state endpoint state map endpoint state null generat state heart beat state generat max version max endpoint state version state digest add gossip digest endpoint generat max version logger trace enabl string builder string builder gossip digest digest digest append digest append logger trace gossip digest string method remov exist endpoint cluster spoof state call coordin removetoken invok param endpoint endpoint remov param host host remov param local host host replic coordin public void advertis remov inet address endpoint host local host endpoint state state endpoint state map endpoint rememb node generat int generat state heart beat state generat logger info remov host host logger info sleep storag servic ensur endpoint doe chang tri thread sleep storag servic catch interrupt throw assert error chang state endpoint state map endpoint state heart beat state generat generat throw runtim endpoint endpoint generat chang tri remov updat node generat mimic chang logger info advertis remov endpoint state updat timestamp don evict state heart beat state forc newer generat unsaf state add applic state applic state storag servic instanc valu factori remov nonloc host state add applic state applic state storag servic instanc valu factori remov coordin local host endpoint state map put endpoint state handl switch endpoint state onli call advertis remov param endpoint param host public void advertis token remov inet address endpoint host endpoint state state endpoint state map endpoint state updat timestamp don evict state heart beat state forc newer generat unsaf state add applic state applic state storag servic instanc valu factori remov nonloc host comput expir time logger info complet remov endpoint endpoint state map put endpoint state ensur gossip occur befor return tri thread sleep interv milli catch interrupt throw assert error call method tri extrem hard obliter ani endpoint ring doe onli call human param address throw unknown host public void unsaf assassin endpoint string address throw unknown host inet address endpoint inet address address endpoint state state endpoint state map endpoint collect token token null logger warn assassin gossip endpoint state null state endpoint state heart beat state int system current time milli els tri token storag servic instanc token metadata token endpoint catch assert error int generat state heart beat state generat logger info sleep storag servic ensur endpoint doe chang tri thread sleep storag servic catch interrupt throw assert error chang state endpoint state map endpoint state heart beat state generat generat throw runtim endpoint endpoint generat chang tri remov state updat timestamp don evict state heart beat state forc newer generat unsaf token null token array list storag servic instanc bootstrap token pass collect dollar gtfo state add applic state applic state storag servic instanc valu factori left token comput expir time handl major state chang endpoint state tri thread sleep interv milli catch interrupt throw assert error logger warn finish kill endpoint public boolean endpoint inet address endpoint return endpoint state map key endpoint public int current generat number inet address endpoint return endpoint state map endpoint heart beat state generat return true chosen target seed fals otherwis param messag param set set endpoint random endpoint chosen return true chosen endpoint seed privat boolean send gossip messag gossip digest syn messag set inet address set int size set size size return fals generat random number size list inet address live endpoint array list inet address set int index size random int size inet address live endpoint index logger trace enabl logger trace send gossip digest syn messag servic instanc send messag return seed send gossip messag live member return true recipi seed privat boolean gossip live member messag gossip digest syn messag int size live endpoint size size return fals return send gossip messag live endpoint send gossip messag unreach member privat void gossip unreach member messag gossip digest syn messag doubl live endpoint count live endpoint size doubl unreach endpoint count unreach endpoint size unreach endpoint count base probabl doubl prob unreach endpoint count live endpoint count doubl rand dbl random doubl rand dbl prob send gossip messag unreach endpoint key set gossip seed facilit partit heal privat void gossip seed messag gossip digest syn prod int size seed size size size seed util broadcast address return live endpoint size send gossip prod seed els gossip seed probabl doubl probabl seed size doubl live endpoint size unreach endpoint size doubl rand dbl random doubl rand dbl probabl send gossip prod seed privat void status check long system current time milli set inet address ep endpoint state map key set inet address endpoint ep endpoint equal util broadcast address continu failur detector instanc interpret endpoint endpoint state state endpoint state map endpoint state null long durat state updat timestamp check fat client fat client remov automat gossip fat client timeout remov dead state dead state state state aliv storag servic instanc token metadata member endpoint remov endpoint key endpoint durat fat client timeout logger info fat client endpoint silent fat client timeout remov gossip remov endpoint endpoint put remov endpoint respect quarantin delay evict membership endpoint rid state immedi check dead state remov long expir time expir time endpoint endpoint state aliv expir time storag servic instanc token metadata member endpoint logger debug enabl logger debug time expir endpoint endpoint expir time evict membership endpoint remov endpoint empti entri inet address long entri remov endpoint entri set entri valu logger debug enabl logger debug elaps entri key gossip quarantin remov endpoint remov entri key protect long expir time endpoint inet address endpoint default expir time veri long time long store time expir time endpoint map endpoint return store time null comput expir time store time public endpoint state endpoint state endpoint inet address return endpoint state map public set entri inet address endpoint state endpoint state return endpoint state map entri set public boolean host inet address endpoint messag servic instanc version endpoint messag servic instanc version endpoint messag servic return true els endpoint state endpoint endpoint applic state applic state null integ pars int endpoint state endpoint endpoint applic state applic state valu messag servic return true return fals public boolean vnode inet address endpoint return host endpoint endpoint state endpoint endpoint applic state applic state null public host inet address endpoint host endpoint throw runtim host endpoint doe style token return string endpoint state endpoint endpoint applic state applic state valu endpoint state state version bigger inet address endpoint int version endpoint state state endpoint state map endpoint endpoint state reqd endpoint state null state null tri includ heart beat state onli greater version pass happen heart beat version mayb lesser version pass applic state version greater version pass case send heart beat throw receiv redund int local version state heart beat state heart beat version local version version reqd endpoint state endpoint state state heart beat state logger trace enabl logger trace local heartbeat version local version greater version endpoint accumul applic state version greater version variabl entri applic state version valu entri state applic state map entri set version valu valu entri valu valu version version reqd endpoint state null reqd endpoint state endpoint state state heart beat state final applic state key entri key logger trace enabl logger trace ad state key valu valu reqd endpoint state add applic state key valu return reqd endpoint state determin endpoint start earlier public int compar endpoint startup inet address addr inet address addr endpoint state endpoint state endpoint addr endpoint state endpoint state endpoint addr assert null null return heart beat state generat heart beat state generat void notifi failur detector map inet address endpoint state remot state map entri inet address endpoint state entri remot state map entri set notifi failur detector entri key entri valu void notifi failur detector inet address endpoint endpoint state remot endpoint state endpoint state local endpoint state endpoint state map endpoint local endpoint state exist report onli version workout local endpoint state null failur detector failur detector instanc int local generat local endpoint state heart beat state generat int remot generat remot endpoint state heart beat state generat remot generat local generat local endpoint state updat timestamp node dead generat chang indic reboot possibl takeov clean interv relearn local endpoint state aliv logger debug clear interv time due generat chang endpoint clear endpoint report endpoint return remot generat local generat int local version max endpoint state version local endpoint state int remot version remot endpoint state heart beat state heart beat version remot version local version local endpoint state updat timestamp version chang report report endpoint privat void mark aliv inet address addr endpoint state local state logger trace enabl logger trace mark aliv addr local state mark aliv local state updat timestamp prevent status check race evict veri long time live endpoint add addr unreach endpoint remov addr expir time endpoint map remov addr logger debug remov expir time endpoint addr logger info inet address addr endpoint state chang subscrib subscrib subscrib subscrib aliv addr local state logger trace enabl logger trace notifi subscrib privat void mark dead inet address addr endpoint state local state logger trace enabl logger trace mark dead addr local state mark dead live endpoint remov addr unreach endpoint put addr system current time milli logger info inet address dead addr endpoint state chang subscrib subscrib subscrib subscrib dead addr local state logger trace enabl logger trace notifi subscrib method call whenev big chang state generat chang node param endpoint param state endpoint state endpoint privat void handl major state chang inet address endpoint state state dead state state endpoint state map null logger info node restart els logger info node part cluster logger trace enabl logger trace ad endpoint state endpoint state map put state node restart subscrib whatev action necessari endpoint state chang subscrib subscrib subscrib subscrib restart state dead state state mark aliv state els logger debug mark aliv due dead state mark dead state endpoint state chang subscrib subscrib subscrib subscrib join state privat boolean dead state endpoint state state state applic state applic state null return fals string valu state applic state applic state valu string piec valu split version valu assert piec length string state piec string deadstat state equal deadstat return true return fals void appli state local map inet address endpoint state state map entri inet address endpoint state entri state map entri set inet address entri key equal util broadcast address continu remov endpoint key logger trace enabl logger trace ignor gossip becaus quarantin continu endpoint state local state ptr endpoint state map endpoint state remot state entri valu state doe exist add doe add remot generat greater generat tie attempt break heartbeat version local state ptr null int local generat local state ptr heart beat state generat int remot generat remot state heart beat state generat logger trace enabl logger trace local generat local generat remot generat remot generat remot generat local generat logger trace enabl logger trace updat heartbeat state generat remot generat local generat major state chang handl updat insert remot state direct handl major state chang remot state els remot generat local generat generat chang appli state find maximum state int local max version max endpoint state version local state ptr int remot max version max endpoint state version remot state remot max version local max version appli state notifi sinc major chang appli state local state ptr remot state els logger trace enabl logger trace ignor remot version remot max version local max version local state ptr aliv dead state local state ptr cours dead mark aliv local state ptr els logger trace enabl logger trace ignor remot generat remot generat local generat els node report case time aliv failur detector instanc report handl major state chang remot state privat void appli state inet address addr endpoint state local state endpoint state remot state don assert sinc node restart version int version local state heart beat state heart beat version local state set heart beat state remot state heart beat state logger trace enabl logger trace updat heartbeat state version local state heart beat state heart beat version version addr loop appli anoth notifi state updat present current notif receiv entri applic state version valu remot entri remot state applic state map entri set applic state remot key remot entri key version valu remot valu remot entri valu assert remot state heart beat state generat local state heart beat state generat local state add applic state remot key remot valu entri applic state version valu remot entri remot state applic state map entri set notif addr remot entri key remot entri valu notifi applic state chang privat void notif inet address addr applic state state version valu valu endpoint state chang subscrib subscrib subscrib subscrib chang addr state valu request state endpoint digest privat void request gossip digest digest list gossip digest delta gossip digest list int remot generat sinc data endpoint local request everth delta gossip digest list add gossip digest digest endpoint remot generat logger trace enabl logger trace request digest endpoint send data version greater max remot version privat void send gossip digest digest map inet address endpoint state delta state map int max remot version endpoint state local state ptr state version bigger digest endpoint max remot version local state ptr null delta state map put digest endpoint local state ptr method figur state gossip gossipe doesn delta digest delta state built void examin gossip list gossip digest digest list list gossip digest delta gossip digest list map inet address endpoint state delta state map gossip digest digest digest list int remot generat digest generat int max remot version digest max version state associ point digest endpoint state state ptr endpoint state map digest endpoint fire gossip digest ack messag data associ endpoint local follow path logic absolut noth endpoint request data endpoint state ptr null int local generat state ptr heart beat state generat max version key state associ endpoint int max local version max endpoint state version state ptr remot generat local generat max remot version max local version continu remot generat local generat request everyth gossip request digest delta gossip digest list remot generat els remot generat local generat send data generat localgener version send digest delta state map els remot generat local generat max remot version greater request remot endpoint send data endpoint version greater max version number local endpoint max remot version lesser send data local endpoint version greater max remot version max remot version max local version delta gossip digest list add gossip digest digest endpoint remot generat max local version els max remot version max local version send data generat localgener version max remot version send digest delta state map max remot version els sinc data endpoint local request everyth request digest delta gossip digest list remot generat public void start int generat number start generat number hash map applic state version valu start gossip generat number preload map applic state befor start public void start int generat nbr map applic state version valu preload local state seed config initi set inet address seed host databas descriptor seed inet address seed seed host seed equal util broadcast address continu seed add seed initi heartbeat state local endpoint mayb initi local state generat nbr endpoint state local state endpoint state map util broadcast address map entri applic state version valu entri preload local state entri set local state add applic state entri key entri valu notifi snitch gossip start databas descriptor endpoint snitch gossip start logger trace enabl logger trace gossip start generat local state heart beat state generat schedul gossip task executor schedul fix delay gossip task gossip interv milli gossip interv milli time unit initi local state gossip start befor public void mayb initi local state int generat nbr heart beat state state heart beat state generat nbr endpoint state local state endpoint state state local state mark aliv endpoint state map put absent util broadcast address local state add endpoint knew previous state unknown public void add save endpoint inet address equal util broadcast address logger debug attempt add save endpoint return endpoint state state endpoint state heart beat state state mark dead endpoint state map put state unreach endpoint put system current time milli logger trace enabl logger trace ad save endpoint state heart beat state generat public void add local applic state applic state state version valu valu endpoint state state endpoint state map util broadcast address assert state null state add applic state state valu notif util broadcast address state valu public void stop schedul gossip task cancel fals logger info announc shutdown tri thread sleep interv milli catch interrupt throw runtim messag messag messag messag servic verb inet address live endpoint messag servic instanc send messag public boolean enabl return schedul gossip task null schedul gossip task cancel visibl test public void initi node unsaf inet address addr uuid int generat nbr heart beat state state heart beat state generat nbr endpoint state state endpoint state state state mark aliv endpoint state state endpoint state map put absent addr state endpoint state local state state null state state alway add version state local state add applic state applic state storag servic instanc valu factori network version local state add applic state applic state storag servic instanc valu factori host uuid visibl test public void inject applic state inet address endpoint applic state state version valu valu endpoint state local state endpoint state map endpoint local state add applic state state valu public long endpoint downtim string address throw unknown host return endpoint downtim inet address address public int current generat number string address throw unknown host return current generat number inet address address public void add expir time endpoint inet address endpoint long expir time logger debug enabl logger debug ad expir time endpoint endpoint expir time expir time endpoint map put endpoint expir time public static long comput expir time return system current time milli gossip veri long time 