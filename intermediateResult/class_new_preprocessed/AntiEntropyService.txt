licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra servic import java import java net inet address import java secur messag digest import java util import java util concurr import java util concurr atom atom boolean import java util concurr lock condit import googl common base object import googl common collect set import org slf logger import org slf logger factori import org apach cassandra concurr configur thread pool executor import org apach cassandra concurr thread factori import org apach cassandra concurr stage import org apach cassandra concurr stage manag import org apach cassandra config databas descriptor import org apach cassandra import org apach cassandra compact abstract compact row import org apach cassandra compact compact manag import org apach cassandra dht abstract bound import org apach cassandra dht random partition import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra gms import org apach cassandra version serial import org apach cassandra locat token metadata import org apach cassandra net import org apach cassandra stream stream repair task import org apach cassandra util anti entropi servic encapsul valid hash individu column famili exchang merkl tree remot node tree request respons convers trigger repair disagre rang everi tree convers initi valid tree generat local remot tree rendezv rendezv endpoint tree onc tree rendezv differenc execut servic trigger repair disagre rang tree comparison repair trigger occur singl thread stage step enact repair follow major compact trigger nodeprob nodeprob send tree request messag neighbor target node node receiv tree request perform readon compact immedi valid column famili compact process valid column famili call valid prepar sampl column famili determin key distribut call valid add order everi row column famili call valid complet indic row ad call complet indic valid merkl tree creat column famili valid tree return request node tree respons node receiv tree respons pass tree rendezv check tree rendezv compar tree local cach compar ani tree receiv neighbor tree remot immedi compar local tree cach otherwis remot tree store local tree generat differenc object enqueu comparison differenc execut stage compar tree perform repair stream api public class anti entropi servic privat static final logger logger logger factori logger anti entropi servic class singleton enforc public static final anti entropi servic instanc anti entropi servic privat static final thread pool executor executor static executor configur thread pool executor time unit link block queue runnabl thread factori anti entropi session intern public static enum status map activ session privat final concurr map string repair session session protect constructor anti entropi servic instanc protect anti entropi servic session concurr hash map string repair session request repair tabl column famili block repair complet return futur asynchron call null repair public repair futur submit repair session rang token rang string tablenam boolean sequenti boolean local string cfname repair session session repair session rang tablenam sequenti local cfname session endpoint empti return null repair futur futur task session futur executor execut futur task return futur task public void termin session repair session session session valu session forc shutdown test onli creat session correspond fake request add session avoid test repair futur submit artifici repair session tree request req string tablenam string cfname repair futur futur task repair session req tablenam cfname futur executor execut futur task return futur task return neighbor share provid rang param tabl tabl repair param repair token repair param local onli node local datacent return neighbor share provid rang static set inet address neighbor string tabl rang token repair boolean local storag servic storag servic instanc map rang token list inet address replica set rang address map tabl rang token rang super set null rang token rang local rang tabl rang repair rang super set rang break els rang intersect repair throw illeg argument request rang intersect local rang fulli lead imprecis repair rang super set null replica set key repair return collect empti set set inet address neighbor hash set inet address replica set rang super set neighbor remov util broadcast address local token metadata topolog topolog token metadata clone onli token map topolog set inet address local endpoint set hash set topolog datacent endpoint databas descriptor local data center return set intersect neighbor local endpoint return neighbor regist tree request compar appropri tree stage becom avail privat void rendezv tree request request merkl tree tree repair session session session request sessionid session null logger warn merkl tree respons unknown repair session node restart sinc session start session interrupt unknown reason request sessionid return repair session repair job job session job peek job null assert session termin return logger info string format repair receiv merkl tree session request request endpoint job add tree request tree logger debug tree receiv session request job submit differenc job complet switch line note onli thread session job poll repair session repair job job session job peek job null repair session differenc considern inform session session differenc signal els job send tree request respond node request valid tree param valid local generat valid param local localhost parameter test void respond valid valid inet address local messag servic messag servic instanc tri valid request endpoint equal util broadcast address logger info string format repair send complet merkl tree valid request sessionid valid request endpoint valid request send valid creat messag valid request endpoint catch logger error string format repair error send complet merkl tree valid request sessionid valid request endpoint valid request strategi handl build valid merkl tree column famili lifecycl prepar initi tree sampl add time add hash tree complet enqueu ani oper block wait valid tree public static class valid implement runnabl public final tree request request public final merkl tree tree null row min token consum privat transient long valid privat transient merkl tree tree rang rang privat transient merkl tree tree rang iter rang privat transient decor key key public final static merkl tree row hash merkl tree row hash null byte public static valid serial serial valid serial public valid tree request request request memori usag maxsiz tunabl global share cluster merkl tree databas descriptor partition request rang merkl tree int math pow valid tree request request merkl tree tree request request tree tree reestablish rang becaus don serial bad reason merkl tree detail tree full rang request rang valid rang null rang null public void prepar column famili store cfs tree partition instanceof random partition beat tree distribut tree init els list decor key key array list decor key decor key sampl cfs key sampl request rang assert request rang sampl token token sampl token rang request rang key add sampl key empti tree distribut tree init els int numkey key size random random random sampl column famili random key index true decor key key random int numkey tree split token break logger debug prepar servic tree size tree size request rang tree invalid call order everi row present hash row add tree built possibl case token greater rang haven generat rang token equal rang left rang valid token rang rang progress invalid rang exist becaus onli valid complet empti tree moment bother deal case case result error addit special case minimum token becaus sort possibl rang param row row public void add abstract compact row row assert request rang row key token row key token request rang assert key null key compar row key row row key receiv order wrt key key row key rang null rang rang generat rang long case true rang row key token add empti hash move rang rang add hash rang rang case true mix hash row rang add hash row hash row privat merkl tree row hash row hash abstract compact row row valid merkl tree intern lot output bit messag digest digest util messag digest row updat digest return merkl tree row hash row key token digest digest regist newli creat tree rendezv stage public void complet complet tree stage manag stage stage execut logger debug valid valid row servic tree request void complet tree assert rang null valid prepar rang null rang add hash rang rang rang rang add hash call valid lifecycl respond valid tree run stage public void run respond request trigger valid anti entropi servic instanc respond util broadcast address public messag valid creat messag return messag valid messag servic verb valid serial public static class valid serial implement version serial valid public void serial valid valid data output dos int version throw tree request serial serial valid request dos version merkl tree serial serial valid tree dos version public valid deseri data input dis int version throw final tree request request tree request serial deseri dis version tri return valid request merkl tree serial deseri dis version catch throw runtim public long serial size valid valid int version return tree request serial serial size valid request version merkl tree serial serial size valid tree version handler request remot node generat valid tree payload pair repres columnfamili valid public static class tree request verb handler implement verb handler tree request trigger valid compact return tree complet public void verb messag tree request messag string tree request remotereq messag payload tree request request tree request remotereq sessionid messag remotereq rang remotereq trigger read onli compact column famili store store tabl open request left column famili store request valid valid valid request logger debug queue valid compact request compact manag instanc submit valid store valid handler respons remot node valid tree payload complet valid object remot endpoint public static class tree respons verb handler implement verb handler valid public void verb messag valid messag string deseri remot tree regist valid respons messag payload tree request request tree request respons request sessionid messag respons request rang respons request anti entropi servic instanc rendezv request respons tree tupl tabl public static class pair extend pair string string public pair string tabl string super tabl assert tabl null null tupl tabl address rang repres locat outstand tree request public static class tree request public static final tree request serial serial tree request serial public final string sessionid public final inet address endpoint public final rang token rang public final pair public tree request string sessionid inet address endpoint rang token rang pair sessionid sessionid endpoint endpoint rang rang overrid public final int hash code return object hash code sessionid endpoint rang overrid public final boolean equal object instanceof tree request return fals tree request tree request handl null proper return object equal sessionid sessionid object equal endpoint endpoint object equal object equal rang rang overrid public string string return tree request sessionid endpoint rang public messag tree request creat messag return messag tree request messag servic verb tree request serial public static class tree request serial implement version serial tree request public void serial tree request request data output dos int version throw dos write request sessionid compact endpoint serial helper serial request endpoint dos dos write request left dos write request abstract bound serial serial request rang dos version public tree request deseri data input dis int version throw string sess dis read inet address endpoint compact endpoint serial helper deseri dis pair cfpair pair dis read dis read rang token rang rang rang token abstract bound serial deseri dis version return tree request sess endpoint rang cfpair public long serial size tree request request int version return type size sizeof request sessionid compact endpoint serial helper serial size request endpoint type size sizeof request left type size sizeof request abstract bound serial serial size request rang version trigger repair neighbor tabl cfs rang typic lifecycl start join execut client thread static class repair session extend wrap runnabl implement endpoint state chang subscrib failur detect event listen privat final string session privat final boolean sequenti privat final string tablenam privat final string cfname privat final rang token rang privat volatil privat final atom boolean fail atom boolean fals privat final set inet address endpoint final queue repair job job concurr link queue repair job final map string repair job activ job concurr hash map string repair job privat final simpl condit complet simpl condit public final condit differenc simpl condit privat volatil boolean termin fals public repair session tree request req string tablenam string cfname req sessionid req rang tablenam fals fals cfname anti entropi servic instanc session put public repair session rang token rang string tablenam boolean sequenti boolean local string cfname gen time string rang tablenam sequenti local cfname privat repair session string rang token rang string tablenam boolean sequenti boolean local string cfname session sequenti sequenti tablenam tablenam cfname cfname assert cfname length repair column famili pointless doesn rang rang endpoint anti entropi servic neighbor tablenam rang local public string return session public rang token rang return rang repair futur futur return repair futur privat string repair node string builder string builder append util broadcast address inet address endpoint append append return string don care return valu care throw public void run throw throw logger info string format repair session sync rang repair node rang tablenam array string cfname endpoint empti differenc signal logger info string format repair neighbor repair rang session complet rang return check node live inet address endpoint endpoint failur detector instanc aliv endpoint differenc signal logger info string format repair proceed repair becaus neighbor dead session fail endpoint return messag servic instanc version endpoint messag servic sequenti logger info string format repair repair snapshot node pre endpoint return anti entropi servic instanc session put gossip instanc regist failur detector instanc regist failur detect event listen tri creat queue repair job column famili string cfname cfname repair job job repair job cfname job offer job activ job put cfname job job peek send tree request block whatev thread start session request return thread die session complet background complet await null logger info string format repair session complet success els logger error string format repair session complet follow error throw catch interrupt throw runtim interrupt wait repair final mark session termin termin failur detector instanc unregist failur detect event listen gossip instanc unregist anti entropi servic instanc session remov return wheather session termin public boolean termin return termin public void termin termin true repair job job job job termin job clear activ job clear clear repair job termin session public void forc shutdown differenc signal complet signal void complet differenc differenc logger debug string format repair repair complet differenc endpoint differenc endpoint differenc cfname repair job job activ job differenc cfname job null assert termin return job complet synchron differenc activ job remov differenc cfname string remain activ job size string format remain column famili sync session activ job size logger info string format repair fulli sync differenc cfname remain activ job empti complet signal void fail node inet address remot string error msg string format endpoint die remot error msg node fail stop everyth activ background forc shutdown public void join inet address endpoint endpoint state state public void chang inet address endpoint applic state state version valu valu public void aliv inet address endpoint endpoint state state public void dead inet address endpoint endpoint state state public void remov inet address endpoint convict endpoint doubl public void restart inet address endpoint endpoint state state convict endpoint doubl public void convict inet address endpoint doubl phi endpoint endpoint return higher confid failur detect usual becaus fail repair wrong high cost phi databas descriptor phi convict threshold return unlik possibl arriv multipl time avoid print error messag fail compar set fals true return fail node endpoint class repair job privat final string cfname send tree request track endpoint remain hear privat final request coordin tree request tree request tree respons track privat final list tree respons tree array list tree respons endpoint size onc respons receiv tree compar differenc task submit job differenc complet privat final request coordin differenc differenc privat final condit request simpl condit privat count latch snapshot latch null public repair job string cfname cfname cfname tree request request coordin tree request sequenti public void send tree request messag servic instanc send creat messag endpoint differenc request coordin differenc sequenti public void send differenc stage manag stage stage execut send merkl tree request everi involv neighbor public void send tree request send request node list inet address endpoint array list inet address endpoint endpoint add util broadcast address sequenti snapshot endpoint inet address endpoint endpoint tree request add tree request endpoint rang pair tablenam cfname logger info string format repair request merkl tree cfname endpoint tree request start request signal public void snapshot collect inet address endpoint tri snapshot latch count latch endpoint size async callback callback async callback public boolean latenc snitch return fals public void respons messag msg repair job snapshot latch count inet address endpoint endpoint messag servic instanc send snapshot command tablenam cfname session fals creat messag endpoint callback snapshot latch await snapshot latch null catch interrupt throw runtim add receiv tree return number remain tree receiv job complet caller assum exact add tree call result remain endpoint public synchron int add tree tree request request merkl tree tree wait request perform tri request await catch interrupt throw assert error interrupt wait request assert request equal cfname tree add tree respons request endpoint tree return tree request complet request submit differenc run tree receiv befor call public void submit differenc differ tree anoth int tree size tree respons tree int tree size tree respons tree differenc differenc differenc cfname logger debug queue comparison differenc differenc add differenc differenc start tree clear return true param differenc remain synchron boolean complet synchron differenc differenc return differenc complet differenc public void termin snapshot latch null snapshot latch count snapshot latch count run node initi request compar tree launch repair disagre rang class differenc implement runnabl public final string cfname public final tree respons public final tree respons public final list rang token differ array list rang token differenc string cfname tree respons tree respons cfname cfname compar tree trigger repair ani rang mismatch public void run restor partition case serial tree partition null tree partition storag servic partition tree partition null tree partition storag servic partition compar tree collect differ differ add merkl tree differ tree tree choos repair method base signific differ string format string format repair endpoint endpoint endpoint cfname differ empti logger info string format format consist complet return differ perform stream repair logger info string format format differ size rang sync perform stream repair start send receiv list differ remot endpoint creat callback call band onc stream complet void perform stream repair runnabl callback runnabl public void run complet differenc stream repair task task stream repair task creat endpoint endpoint tablenam cfname differ callback pre node don handl stream task don bother task local task messag servic instanc version task dst messag servic task run public string string return differenc endpoint endpoint rang static class tree respons public final inet address endpoint public final merkl tree tree tree respons inet address endpoint merkl tree tree endpoint endpoint tree tree public static class repair futur extend futur task public final repair session session repair futur repair session session super session null session session public static abstract class request coordin privat final order order protect request coordin boolean sequenti order sequenti sequenti order parallel order public abstract void send request public void add request order add request public void start order start return mani request remain public int complet request return order complet request privat static abstract class order protect final request coordin coordin order request coordin coordin coordin coordin public abstract void add request public abstract void start public abstract int complet request privat static class sequenti order extend order privat final queue request link list sequenti order request coordin coordin super coordin public void add request request add request public void start request empti return coordin send request peek public int complet request assert request equal request peek request poll int remain request size remain coordin send request peek return remain privat static class parallel order extend order privat final set request hash set parallel order request coordin coordin super coordin public void add request request add request public void start request request coordin send request public int complet request request remov request return request size 