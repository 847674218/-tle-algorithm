licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra net import java buffer output stream import java data input stream import java data output stream import java import java net inet address import java net socket import java nio byte buffer import java util import java util concurr block queue import java util concurr link block queue import java util concurr atom atom long import org slf logger import org slf logger factori import org apach cassandra trace trace state import org apach cassandra trace trace import org apach cassandra util util import org apach cassandra util gen import org xerial snappi snappi output stream import org apach cassandra config config import org apach cassandra config databas descriptor public class outbound tcp connect extend thread privat static final logger logger logger factori logger outbound tcp connect class privat static final messag messag messag servic verb privat volatil boolean stop fals privat static final int retri send thread read activ queue queue empti swap backlog privat volatil block queue queu messag backlog link block queue queu messag privat volatil block queue queu messag activ link block queue queu messag privat final outbound tcp connect pool pool refer privat data output stream privat socket socket privat volatil long complet privat final atom long drop atom long privat int target version public outbound tcp connect outbound tcp connect pool pool super pool point pool refer pool privat static boolean local inet address target host string remot databas descriptor endpoint snitch datacent target host string local databas descriptor endpoint snitch datacent databas descriptor rpc address return remot equal local public void enqueu messag messag string expir messag tri backlog put queu messag messag system current time milli catch interrupt throw assert error void close socket boolean destroy thread activ clear backlog clear stop destroy thread exit loop stop thread enqueu null void soft close socket enqueu null public int target version return target version public void run true queu messag activ poll null exhaust activ queue switch backlog onc someth process tri backlog catch interrupt throw assert error block queue queu messag tmp backlog backlog activ activ tmp messag messag disconnect stop break continu timestamp system current time milli timeout drop increment els socket null connect write connect els clear queue els gossip messag activ clear public int pend messag return activ size backlog size public long complet messsag return complet public long drop messag return drop privat boolean compress connect assum version return databas descriptor internod compress config internod compress databas descriptor internod compress config internod compress local pool refer point privat void write connect queu messag tri byte session byte messag paramet trace session byte null session gen byte buffer wrap session byte trace state state trace instanc session state trace send messag pool refer point trace instanc stop local state write messag timestamp target version complet activ peek null flush catch program error silenc instanceof logger error error write pool refer point els logger debug enabl logger debug error write pool refer point disconnect public static void write messag messag string long timestamp data output stream int version throw write int messag servic version messag servic write header version fals includ total messag size int doesn expect write int write version messag servic int cast cut high order timestamp assum remain recipi reconstruct write int int timestamp messag serial version privat static void write header data output stream int version boolean compress enabl throw bit unus serial type alway binari bit compress bit stream mode bit unus bit version bit unus int header compress enabl header header version write int header privat void disconnect socket null tri socket close catch logger trace enabl logger trace close connect pool refer point null socket null privat boolean connect logger debug enabl logger debug attempt connect pool refer point target version messag servic instanc version pool refer point long start system current time milli system current time milli start databas descriptor rpc timeout tri socket pool refer socket socket set aliv true local pool refer point socket set tcp delay true els socket set tcp delay databas descriptor inter tcp delay data output stream buffer output stream socket output stream target version messag servic write int messag servic write header target version compress connect flush data input stream data input stream socket input stream int max target version read int target version max target version logger debug target max version reconnect version max target version messag servic instanc set version pool refer point max target version disconnect return fals target version max target version target version messag servic current version logger trace detect higher max version reconnect queu messag max target version target version messag servic instanc set version pool refer point math min messag servic current version max target version soft close socket write int messag servic current version compact endpoint serial helper serial util broadcast address compress connect flush logger trace upgrad output stream compress data output stream snappi output stream buffer output stream socket output stream return true catch socket null logger trace enabl logger trace unabl connect pool refer point tri thread sleep catch interrupt throw assert error return fals privat void expir messag true queu messag backlog peek null timestamp system current time milli messag timeout break queu messag backlog poll send thread switch queue add entri backlog activ queue posit relat entri contend client head backlog lock null activ add break drop increment privat static class queu messag final messag messag final string final long timestamp queu messag messag messag string long timestamp messag messag timestamp timestamp 