licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra commitlog import java file import java import java random access file import java nio map byte buffer import java nio channel file channel import java util collect import java util compar import java util hash map import java util import java util concurr atom atom integ import java util zip checksum import org slf logger import org slf logger factori import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra config schema import org apach cassandra column famili import org apach cassandra row mutat import org apach cassandra write error import org apach cassandra util file util import org apach cassandra net messag servic import org apach cassandra util pure java crc singl commit log file disk manag creation file write row mutat disk track mutat posit ani dirti cover segment file segment file initi alloc fix size grow accomid larger valu necessari public class commit log segment privat static final logger logger logger factori logger commit log segment class privat final static long base system current time milli privat final static atom integ atom integ commit log entri overhead byte int length long head checksum long tail checksum static final int cach dirti segment avoid lookup replay posit decid delet segment privat final hash map integ write hash map integ public final long privat final file log file privat final random access file log file accessor privat boolean sync fals privat final map byte buffer buffer privat boolean close public final commit log descriptor descriptor return newli mint segment file public static commit log segment fresh segment return commit log segment null public static long return base increment construct segment file param file path null recycl exist file renam truncat commit log commit log segment string file path descriptor commit log descriptor log file file databas descriptor commit log locat descriptor file boolean creat true tri file path null file file file file path file exist logger debug discard commit log segment file path file renam log file throw renam file path fail creat fals open initi segment file log file accessor random access file log file creat logger debug creat commit log segment log file path map segment extend truncat standard segment size log file accessor set length databas descriptor commit log segment size buffer log file accessor channel map file channel map mode databas descriptor commit log segment size buffer put int commit log buffer posit sync true catch throw write error log file complet discard segment file delet potenti block oper public void discard boolean delet file shouldn close file write potenti earlier elig recyl close delet file file util delet confirm log file recycl process unneed segment file reus return commit log segment repres newli reusabl segment public commit log segment recycl write segment marker veri file close buffer posit buffer put int commit log buffer posit tri sync catch write error logger error error flush throw close return commit log segment path return true room write param mutat segment public boolean capac row mutat mutat long total size row mutat serial serial size mutat messag servic current version return total size buffer remain mark column famili modifi dirti posit privat void mark dirti row mutat row mutat replay posit rep pos column famili column famili row mutat column famili check null cfm case write goe defin befor segment creat meta data cfm schema instanc meta data column famili cfm null logger error attempt write commit log entri unrecogn column famili column famili els mark dirti cfm rep pos posit append row mutat commit log requr capac alreadi check param row mutat mutat append commit log return posit append mutat public replay posit write row mutat row mutat throw assert close replay posit rep pos context mark dirti row mutat rep pos checksum checksum pure java crc byte serial row row mutat serial buffer messag servic current version checksum updat serial row length buffer put int serial row length buffer put long checksum valu buffer put serial row checksum updat serial row serial row length buffer put long checksum valu buffer remain write segment marker rewind posit start buffer put int commit log buffer posit buffer posit commit log sync true return rep pos forc disk flush segment file public void sync sync tri buffer forc catch map byte buffer forc doe declar actual throw throw write error path sync fals return current replay posit log segment public replay posit context return replay posit buffer posit return file path segment public string path return log file path return file segment public string return log file close segment file public void close close return tri file util clean buffer log file accessor close close true catch throw write error path record dirti posit param column famili dirti param posit posit write written privat void mark dirti integ posit write put posit mark column famili specifi clean log segment context argument file onli mark clean newer write place param column famili clean param context option clean offset public void mark clean replay posit context integ written write written null context written context posit write remov return collect dirti segment file public collect dirti return write key set return true segment unus safe recycl delet public boolean unus return write empti check replay posit segment file param context replay posit check return true replay posit segment file public boolean replay posit context return context segment debug fast public string dirti string string builder string builder write key set meta data schema instanc meta data append null delet append append append return string overrid public string string return commit log segment path public int posit return buffer posit public static class commit log segment file compar implement compar file public int compar file file commit log descriptor desc commit log descriptor file commit log descriptor desc commit log descriptor file return int desc desc 