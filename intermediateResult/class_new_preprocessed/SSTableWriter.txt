licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra sstabl import java import java nio channel close channel import java util import java util regex pattern import googl common collect set import org slf logger import org slf logger factori import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra config schema import org apach cassandra import org apach cassandra compact import org apach cassandra dht partition import org apach cassandra write error import org apach cassandra column serial import org apach cassandra compress compress sequenti writer import org apach cassandra util import org apach cassandra servic storag servic import org apach cassandra util public class tabl writer extend tabl privat static final logger logger logger factori logger tabl writer class privat index writer iwrit privat segment file builder dbuilder privat final sequenti writer data file privat decor key written key privat file mark data mark privat final tabl metadata collector sstabl metadata collector public tabl writer string filenam long key count filenam key count schema instanc meta data descriptor filenam filenam storag servic partition tabl metadata creat collector privat static set compon compon meta data metadata set compon compon hash set compon array list compon compon compon compon compon metadata bloom filter chanc compon add compon metadata compress paramet sstabl compressor null compon add compon els feel safer actual add compon mayb write digest compon unmodifi construct compon add compon return compon public tabl writer string filenam long key count meta data metadata partition partition tabl metadata collector sstabl metadata collector super descriptor filenam filenam compon metadata metadata partition iwrit index writer key count compress dbuilder segment file compress builder data file compress sequenti writer open filenam descriptor filenam compon databas descriptor popul cach flush metadata compress paramet sstabl metadata collector els dbuilder segment file builder databas descriptor disk access mode data file sequenti writer open file filenam databas descriptor popul cach flush data file set comput digest sstabl metadata collector sstabl metadata collector public void mark data mark data file mark iwrit mark public void reset truncat data file reset truncat data mark iwrit reset truncat perform saniti check param decor key return posit data file befor ani data written privat long befor append decor key decor key assert decor key null key null empti key index column valu written key null written key compar decor key throw runtim written key written key current key decor key write filenam return written key null data file file pointer privat row index entri append decor key decor key long data posit delet info del info column index index written key decor key written key null written key logger trace enabl logger trace wrote decor key data posit row index entri entri row index entri creat data posit del info index iwrit append decor key entri dbuilder add potenti boundari data posit return entri public row index entri append abstract compact row row long current posit befor append row key tri byte buffer util write short length row key key data file stream long data start data file file pointer long data size row write data file stream assert data size data file file pointer data start incorrect row data size data size written data file path correct data file file pointer data start catch throw write error data file path sstabl metadata collector updat data file file pointer current posit row column stat return append row key current posit row delet info row index public void append decor key decor key column famili long start posit befor append decor key tri byte buffer util write short length decor key key data file stream sinc column index insert rang tombston marker comput size data tricki data output buffer buffer data output buffer build column index write column column index builder builder column index builder decor key key column count buffer column index index builder build type size type size type size long del size delet time serial serial size delet info top level delet type size data file stream write long buffer length del size type size sizeof write delet info column count delet info serial serial tabl delet info data file stream data file stream write int builder written atom count data file stream write buffer data buffer length append decor key start posit delet info index catch throw write error data file path sstabl metadata collector updat data file file pointer start posit column stat throw read data input fail throw write error write data file fail public long append stream decor key key meta data metadata long data size data input throw long current posit befor append key long data start tri byte buffer util write short length key key data file stream data start data file file pointer write row size data file stream write long data size catch throw write error data file path delet info delet info delet info serial deseri tabl descriptor version int column count read int tri delet info serial serial tabl delet info data file stream data file stream write int column count catch throw write error data file path deseri column obtain max timestamp immedi serial long min timestamp long long max timestamp long stream histogram tombston stream histogram column famili column famili creat metadata array sort column factori delet delet info column index builder column index column index builder key key column count data file stream disk atom serial atom serial disk serial int column count deseri column becaus written data size base data size receiv reseri exact data disk atom atom atom serial deseri tabl column serial flag integ descriptor version atom instanceof counter column atom counter column atom mark delta clear els atom instanceof super column super column super column atom column column column column instanceof counter column column mark counter column column mark delta clear replac column mark int delet time atom local delet time delet time integ tombston updat delet time min timestamp math min min timestamp atom min timestamp max timestamp math max max timestamp atom max timestamp tri column index add atom write atom disk catch throw write error data file path assert data size data file file pointer data start incorrect row data size data size written data file path correct data file file pointer data start sstabl metadata collector updat min timestamp min timestamp sstabl metadata collector updat max timestamp max timestamp sstabl metadata collector add row size data file file pointer current posit sstabl metadata collector add column count column count sstabl metadata collector merg tombston histogram tombston append key current posit delet info column index build return current posit failur attempt close index writer data file befor delet temp compon sstabl public void abort assert descriptor temporari file util close quiet iwrit file util close quiet data file set compon compon tabl compon descriptor tri compon empti tabl delet descriptor compon catch write error logger error string format fail delet temp compon descriptor throw public tabl reader close open reader return close open reader system current time milli public tabl reader close open reader long max data age index filter iwrit close main data close truncat necessari data file close write sstabl statist tabl metadata sstabl metadata sstabl metadata collector final metadata partition class canon write metadata descriptor sstabl metadata mayb write digest save tabl compon tabl append descriptor compon remov tmp marker compon final descriptor newdesc renam descriptor compon final memori state reader segment file ifil iwrit builder complet newdesc filenam tabl segment file dfile dbuilder complet newdesc filenam tabl tabl reader sstabl tabl reader intern open newdesc compon metadata partition ifil dfile iwrit summari iwrit max data age sstabl metadata sstabl minim key sstabl minim key tri save summari disk tabl reader save summari sstabl iwrit builder dbuilder iwrit null dbuilder null return sstabl privat void mayb write digest byte digest data file digest digest null return sequenti writer sequenti writer open file descriptor filenam tabl true writ output compat sha sum descriptor newdesc descriptor temporari fals string tmp newdesc filenam tabl split pattern quot file separ string data file tmp tmp length tri write string format hex byte hex digest data file byte catch close channel throw assert error happen close privat static void write metadata descriptor desc tabl metadata sstabl metadata sequenti writer sequenti writer open file desc filenam tabl true tri tabl metadata serial serial sstabl metadata stream catch throw write error path close static descriptor renam descriptor tmpdesc set compon compon descriptor newdesc tmpdesc temporari fals renam tmpdesc newdesc compon return newdesc public static void renam descriptor tmpdesc descriptor newdesc set compon compon compon compon set differ compon set hash set compon compon file util renam confirm tmpdesc filenam compon newdesc filenam compon data becaus data present sstabl complet renam befor crash file util renam confirm tmpdesc filenam compon newdesc filenam compon renam confirm becaus summari avail load tabl close open reader file util renam confirm tmpdesc filenam compon newdesc filenam compon public long file pointer return data file file pointer public long disk file pointer return data file disk file pointer encapsul write index filter tabl state object valid close class index writer implement closeabl privat final sequenti writer index file public final segment file builder builder public final index summari summari public final filter privat file mark mark index writer long key count index file sequenti writer open file descriptor filenam tabl databas descriptor popul cach flush builder segment file builder databas descriptor index access mode summari index summari key count filter factori filter key count metadata bloom filter chanc true public void append decor key key row index entri index entri add key key long index posit index file file pointer tri byte buffer util write short length key key index file stream row index entri serial serial index entri index file stream catch throw write error index file path logger trace enabl logger trace wrote index entri index entri index posit summari mayb add entri key index posit builder add potenti boundari index posit close index bloomfilt public state writer valid consumpt public void close compon compon string path descriptor filenam tabl tri bloom filter file output stream fos file output stream path data output stream stream data output stream fos filter factori serial stream descriptor version filter type stream flush fos sync stream close catch throw write error path index long posit index file file pointer index file close call forc file util truncat index file path posit final memori index state summari complet public void mark mark index file mark public void reset truncat set bloom filter addit extra key harmless reset dbuilder call afterappend assum work won tri reset index file reset truncat mark overrid public string string return index writer descriptor 