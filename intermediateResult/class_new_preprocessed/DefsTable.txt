licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java import java nio byte buffer import java util import java util concurr execut import java util concurr futur import org slf logger import org slf logger factori import googl common collect iter import googl common collect map differ import googl common collect map import org apach avro binari decod import org apach avro decod factori import org apach avro specif specif datum reader import org apach avro specif specif record import org apach cassandra config import org apach cassandra compact compact manag import org apach cassandra filter queri filter import org apach cassandra filter queri path import org apach cassandra marshal ascii type import org apach cassandra marshal type import org apach cassandra migrat avro def import org apach cassandra configur import org apach cassandra servic storag servic import org apach cassandra servic migrat manag import org apach cassandra util byte buffer util import org apach cassandra util util store keyspac column famili attribut schema load distribut easi replac mechan local migrat serial store system migrat schema distribut layout key ascii type ascii json serial valu key key keyspac layout key ascii type composit ascii ascii json serial valu key key keyspac compon column column famili compon column famili attribut layout key ascii type composit ascii ascii ascii json serial valu key key keyspac column composit support level nest repres follow structur column famili column column attribut valu exampl schema schema keyspac row key column durabl write valu true timestamp column valu timestamp column replic factor valu timestamp column strategi class valu org apach cassandra locat network topolog strategi timestamp column strategi option valu datacent timestamp schema columnfamili row key column bloom filter chanc valu timestamp column cach valu timestamp column column type valu standard timestamp column comment valu column famili timestamp column default valid class valu org apach cassandra marshal byte type timestamp column grace valu timestamp column valu timestamp column key alia valu timestamp part output omit schema column row key column index valu null timestamp column index option valu null timestamp column index type valu null timestamp column valu vsb timestamp column valid class valu org apach cassandra marshal ascii type timestamp public class def tabl privat final static logger logger logger factori logger def tabl class unbuff decod privat final static decod factori decod factori configur direct decod true column schema store serial keyspac definit invalid keyspac public static final byte buffer byte buffer util byte avro schema public static final string migrat public static final string schema save keyspac definit system schema columnfamili public static synchron void save collect meta data keyspac long timestamp system current time milli meta data meta data keyspac meta data schema timestamp appli load keyspac definit system keyspac system return collect keyspac definit public static collect meta data load tabl list row serial schema system tabl serial schema system tabl list meta data keyspac array list meta data serial schema size row row serial schema schema invalid schema row row schema ignor schema row row continu keyspac add meta data schema row serial column famili row key return keyspac public static void fix schema nano timestamp fix schema nano timestamp system tabl fix schema nano timestamp system tabl fix schema nano timestamp system tabl privat static void fix schema nano timestamp string column famili column famili store cfs tabl open tabl column famili store column famili boolean cleanup fals date date list row row system tabl serial schema column famili row check loop row row row schema invalid schema row row continu column column row column date column date date column timestamp column date date micro date column timestamp assum micro calendar calendar calendar instanc calendar set time micro micro befor calendar calendar micro cleanup true break row check loop els milli fix micro cleanup true break row check loop cleanup return logger info fix timestamp schema column famili column famili tri cfs truncat catch execut throw runtim catch interrupt throw assert error long micro timestamp time row row row schema invalid schema row row continu row mutat mutat row mutat tabl row key key column column row column column live mutat add queri path column famili null column column valu micro timestamp mutat appli flush immedi becaus read schema befor replay commitlog tri cfs forc block flush catch execut throw runtim flush fix schema timestamp catch interrupt throw assert error public static byte buffer search composit string boolean start assert null byte buffer byte type instanc decompos int length byte remain byte byte byte length byte byte length byte byte length byte buffer util array copi byte byte length byte byte length byte start return byte buffer wrap byte privat static row serial column famili decor key key column famili store cfs store system tabl schema system tabl return row key cfs store column famili queri filter ident filter key queri path system tabl load version keyspac definit storag data sourc note definit method load schema handl tabl param version version latest migrat return collect keyspac definit throw fail read fail deseri avro schema public static synchron collect meta data load storag version throw decor key vkey storag servic partition decor key byte version tabl def tabl open tabl column famili store store def column famili store column famili store column famili queri filter ident filter vkey queri path column avroschema column collect meta data keyspac collect empti list avroschema null byte buffer valu avroschema valu org apach avro schema schema org apach avro schema pars byte buffer util string valu deseri keyspac schema collect column column sort column keyspac array list meta data column size column column column column equal continu def deseri avro schema column valu def keyspac add avro avro store deseri keyspac place save keyspac logger info truncat deprec system column famili migrat schema drop column famili tabl drop column famili tabl return keyspac merg remot schema form row mutat local mutat metadata object involv oper add drop param mutat schema chang appli throw configur metadata attribut invalid valu throw data corrupt dure transport fail appli oper public static synchron void merg schema collect row mutat mutat throw configur current state schema map decor key column famili keyspac system tabl schema system tabl map decor key column famili column famili system tabl schema system tabl row mutat mutat mutat mutat appli storag servic instanc client mode flush schema schema instanc updat version announc data appli map decor key column famili keyspac system tabl schema system tabl map decor key column famili column famili system tabl schema system tabl set string keyspac drop merg keyspac keyspac keyspac merg column famili column famili column famili safe drop keyspac onli nest column famili delet string keyspac drop keyspac drop drop keyspac keyspac drop privat static set string merg keyspac map decor key column famili map decor key column famili updat calcul differ state note entri onli left alway empti map differ decor key column famili diff map differ updat step check ani keyspac ad map entri decor key column famili entri diff entri onli entri set column famili attr entri valu don care nest column famili becaus process separ attr empti add keyspac meta data schema row entri key entri valu collect meta data empti list step check ani keyspac creat context creat previous delet exist level schema empti key map decor key map differ valu differ column famili modifi entri diff entri differ loop modifi entri skip process key time store left process item iter remov alreadi met key list decor key left process array list decor key modifi entri size map entri decor key map differ valu differ column famili entri modifi entri entri set column famili prev valu entri valu left valu column famili valu entri valu valu prev valu empti add keyspac meta data schema row entri key valu collect meta data empti list continu left process add entri key left process size return collect empti set final step updat modifi keyspac save keyspac drop set string keyspac drop hash set string decor key key left process map differ valu differ column famili valu diff modifi entri key column famili state valu diff valu state empti keyspac drop add ascii type instanc string key key els updat keyspac meta data schema row key state collect meta data empti list return keyspac drop privat static void merg column famili map decor key column famili map decor key column famili updat throw configur calcul differ state note entri onli left alway empti map differ decor key column famili diff map differ updat check ani keyspac column famili ad map entri decor key column famili entri diff entri onli entri set column famili attr entri valu attr empti map string meta data def meta data deseri column famili row entri key attr meta data def def valu add column famili def deal modifi column famili rememb keyspac nest column famili put singl row map decor key map differ valu differ column famili modifi entri diff entri differ decor key keyspac modifi entri key set map differ valu differ column famili valu diff modifi entri keyspac column famili prev valu valu diff left valu state befor extern modif column famili valu valu diff valu updat state row row row keyspac valu prev valu empti keyspac delet creat meta data cfm meta data deseri column famili row valu add column famili cfm els valu empti keyspac delet meta data cfm meta data deseri column famili row keyspac prev valu valu drop column famili cfm cfm els modif nest column famili perform nest diff determin realli chang string ascii type instanc string keyspac key map string meta data def hash map string meta data meta data cfm schema instanc meta data meta data valu def put cfm cfm map string meta data def meta data deseri column famili row map differ string meta data def diff map differ def def meta data def def diff entri onli valu add column famili def meta data def def diff entri onli left valu drop column famili def def map differ valu differ meta data def def diff entri differ valu updat column famili def valu privat static void add keyspac meta data ksm assert schema instanc meta data ksm null schema instanc load ksm storag servic instanc client mode tabl open ksm migrat manag instanc notifi creat keyspac ksm privat static void add column famili meta data cfm assert schema instanc meta data cfm cfm null meta data ksm schema instanc tabl definit cfm ksm meta data clone ksm iter concat ksm meta data valu collect singleton cfm schema instanc load cfm init definit sinc call init manual tabl open cfm schema instanc set tabl definit ksm storag servic instanc client mode tabl open ksm init cfm cfm true migrat manag instanc notifi creat column famili cfm privat static void updat keyspac meta data state meta data ksm schema instanc meta data state assert ksm null meta data ksm meta data clone ksm reload attribut ksm meta data valu schema instanc set tabl definit ksm tri storag servic instanc client mode tabl open state creat replic strategi ksm migrat manag instanc notifi updat keyspac ksm catch configur late throw configur catch previous throw runtim privat static void updat column famili meta data state meta data cfm schema instanc meta data state state assert cfm null cfm reload storag servic instanc client mode tabl tabl tabl open cfm tabl column famili store cfm reload migrat manag instanc notifi updat column famili cfm privat static void drop keyspac string throw meta data ksm schema instanc tabl definit string snapshot tabl timestamp snapshot compact manag instanc stop compact ksm meta data valu remov cfs tabl instanc meta data cfm ksm meta data valu column famili store cfs tabl open ksm column famili store cfm schema instanc purg cfm storag servic instanc client mode databas descriptor auto snapshot cfs snapshot snapshot tabl open ksm drop cfm remov tabl static instanc tabl clear ksm schema instanc clear tabl definit ksm storag servic instanc client mode migrat manag instanc notifi drop keyspac ksm privat static void drop column famili string string throw meta data ksm schema instanc tabl definit assert ksm null column famili store cfs tabl open column famili store assert cfs null reiniti tabl meta data cfm ksm meta data schema instanc purg cfm schema instanc set tabl definit keyspac definit ksm cfm compact manag instanc stop compact array list cfm storag servic instanc client mode databas descriptor auto snapshot cfs snapshot tabl timestamp snapshot cfs column famili tabl open ksm drop cfm migrat manag instanc notifi drop column famili cfm privat static meta data keyspac definit meta data ksm meta data exclud clone ksm includ def list meta data cfs array list meta data ksm meta data valu cfs remov exclud assert cfs size ksm meta data size return meta data clone ksm cfs privat static void flush schema flush schema system tabl flush schema system tabl flush schema system tabl privat static void flush schema string util wait futur system tabl schema forc flush privat static byte buffer byte version return byte buffer util byte version string deseri singl object base schema param writer writer schema param byte array deseri param empti object deseri null return serial avro object throw deseri fail public static extend specif record deseri avro org apach avro schema writer byte buffer byte throw binari decod dec creat binari decod byte buffer util array byte null specif datum reader reader specif datum reader writer reader set expect schema return reader read dec 