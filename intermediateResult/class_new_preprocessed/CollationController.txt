licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java nio byte buffer import java util import googl common collect iter import org slf logger import org slf logger factori import org apach cassandra columniter disk atom iter import org apach cassandra columniter simpl abstract column iter import org apach cassandra compact size tier compact strategi import org apach cassandra filter queri filter import org apach cassandra filter queri filter import org apach cassandra marshal counter column type import org apach cassandra sstabl tabl import org apach cassandra sstabl tabl reader import org apach cassandra util file util import org apach cassandra trace trace import org apach cassandra util closeabl iter import org apach cassandra util heap alloc public class collat control privat static final logger logger logger factori logger collat control class privat final column famili store cfs privat final queri filter filter privat final sort column factori factori privat final int befor privat int sstabl iter public collat control column famili store cfs boolean mutabl column queri filter filter int befor cfs cfs filter filter befor befor atom sort column doesn work super column factori mutabl column cfs metadata type column famili type super thread safe sort column factori atom sort column factori array sort column factori public column famili top level column return filter filter instanceof queri filter cfs metadata type column famili type standard filter path super column null cfs metadata default valid counter column type instanc collect time order data collect data collect data order recenc sstabl maxtimestamp data onc data request column newer newest remain maxtimestamp stop privat column famili collect time order data logger trace collect time order data column famili column famili creat cfs metadata factori filter filter revers list disk atom iter iter array list disk atom iter trace trace acquir sstabl refer column famili store view fragment view cfs mark referenc filter key temporari object memtabl sstabl sourc accomod factori requir add atom happen sort order add merg final collect sort set column merg uniform sort exist column famili temp column famili creat cfs metadata array sort column factori filter filter revers tri trace trace merg memtabl content memtabl memtabl view memtabl disk atom iter iter filter memtabl column iter memtabl iter null iter add iter temp delet iter column famili iter temp add atom iter add temp heap alloc instanc temp clear avoid chang filter column origin filter reduc filter remov column irrelev queri filter filter queri filter filter filter tree set byte buffer filter column tree set byte buffer filter column queri filter reduc filter queri filter filter key filter path filter updat column filter column add tabl disk collect sort view sstabl tabl max timestamp compar read sort sstabl long row tombston long tabl reader sstabl view sstabl alreadi row tombston timestamp greater updat sstabl sinc rest sstabl older sstabl max timestamp row tombston break long current max sstabl max timestamp reduc filter reduc filter current max queri filter reduc filter filter column empti break disk atom iter iter reduc filter tabl column iter sstabl iter add iter iter column famili null column famili iter column famili mark delet track row level tombston encount row tombston delet info top level delet mark delet temp delet sstabl iter trace trace merg data sstabl sstabl descriptor generat iter temp add atom iter add temp heap alloc instanc temp clear distinguish data row rebuild effici data cach empti don rebuild slower iter empti return null final collat collat boilerpl requir provid closeabl iter final column famili closeabl iter disk atom collat simpl abstract column iter final iter column iter iter protect disk atom comput return iter iter data public column famili column famili return public decor key key return filter key column famili return clone shallow trace trace collat result filter collat disk atom return collect singleton list collat befor hoist request data sstabl sstabl iter cfs minimum compact threshold cfs compact disabl cfs compact strategi instanceof size tier compact strategi trace trace defrag request data row mutat row mutat cfs tabl row filter key return clone skip commitlog index updat fine sinc fragment exist data tabl open tabl appli fals fals caller respons final remov delet import cach row work correct return return final disk atom iter iter iter file util close quiet iter tabl reader releas refer view sstabl remov column param filter alreadi data param return newer param sstabl timestamp privat void reduc filter queri filter filter column famili return long sstabl timestamp abstract column filter path super column null return super column return column filter path super column don ani inform null sstabl timestamp long return iter byte buffer iter queri filter filter filter column iter iter byte buffer filter column iter column column column filter column column null column timestamp sstabl timestamp iter remov collect data brute forc iter filter question everi memtabl sstabl merg togeth privat column famili collect data logger trace collect data trace trace acquir sstabl refer column famili store view fragment view cfs mark referenc filter key list disk atom iter iter array list disk atom iter iter size view memtabl view sstabl size column famili return column famili creat cfs metadata factori filter filter revers tri trace trace merg memtabl content memtabl memtabl view memtabl disk atom iter iter filter memtabl column iter memtabl iter null return delet iter column famili iter add iter elimin full sstabl base timestamp alreadi read collect time order data elimin sstabl max timestamp tombston read reli sstabl order max timestamp sinc max timestamp max timestamp guarante row tombston timestamp tombston max timestamp sinc necessarili timestamp tombston max timestamp word iter max timestamp order tombston elimin pass minim number sstabl read row tombston collect sort view sstabl tabl max timestamp compar long row tombston long tabl reader sstabl view sstabl alreadi row tombston timestamp greater updat sstabl skip sstabl max timestamp row tombston break disk atom iter iter filter tabl column iter sstabl iter add iter iter column famili null column famili iter column famili mark delet row tombston delet info top level delet mark delet return delet sstabl iter distinguish data row rebuild effici data cach empti don rebuild slower iter empti return null trace trace merg data memtabl sstabl sstabl iter filter collat disk atom return iter befor caller respons final remov delet import cach row work correct return return final disk atom iter iter iter file util close quiet iter tabl reader releas refer view sstabl public int sstabl iter return sstabl iter 