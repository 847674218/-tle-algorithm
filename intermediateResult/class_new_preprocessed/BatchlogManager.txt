licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java import java lang manag manag factori import java net inet address import java nio byte buffer import java util import java util concurr execut import java util concurr time unit import java util concurr atom atom boolean import java util concurr atom atom long import javax manag bean server import javax manag object import googl common collect immut sort set import googl common collect iter import org slf logger import org slf logger factori import org apach cassandra config meta data import org apach cassandra config databas descriptor import org apach cassandra compact compact manag import org apach cassandra filter disk atom filter import org apach cassandra filter queri filter import org apach cassandra filter queri filter import org apach cassandra filter queri path import org apach cassandra marshal long type import org apach cassandra marshal type import org apach cassandra marshal type import org apach cassandra dht abstract bound import org apach cassandra dht partition import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra sstabl descriptor import org apach cassandra sstabl tabl reader import org apach cassandra util fast byte array output stream import org apach cassandra net messag servic import org apach cassandra servic storag proxi import org apach cassandra servic storag servic import org apach cassandra util byte buffer util import org apach cassandra util util import org apach cassandra util wrap runnabl public class batchlog manag implement batchlog manag bean privat static final string org apach cassandra type batchlog manag privat static final int messag servic privat static final long databas descriptor write rpc timeout privat static final byte buffer column written privat static final byte buffer column data privat static final logger logger logger factori logger batchlog manag class public static final batchlog manag instanc batchlog manag privat final atom long total batch replay atom long privat final atom boolean replay atom boolean public void start bean server mbs manag factori platform bean server tri mbs regist bean object catch throw runtim runnabl runnabl wrap runnabl public void run throw throw execut interrupt replay fail batch storag servic option task schedul fix delay runnabl storag servic time unit public int count batch int count row row rang slice queri filter immut sort set byte buffer row null row mark delet count return count public long total batch replay return total batch replay long valu public void forc batchlog replay runnabl runnabl wrap runnabl public void run throw throw execut interrupt replay fail batch storag servic option task execut runnabl public static row mutat batchlog mutat collect row mutat mutat uuid long timestamp util timestamp micro byte buffer written long type instanc decompos timestamp byte buffer data serial row mutat mutat column famili column famili creat meta data batchlog add column column written timestamp add column column data timestamp row mutat row mutat tabl type instanc decompos uuid add return privat static byte buffer serial row mutat collect row mutat mutat fast byte array output stream bos fast byte array output stream data output stream dos data output stream bos tri dos write int mutat size row mutat mutat row mutat serial serial dos catch throw assert error happen return byte buffer wrap bos byte array privat void replay fail batch throw execut interrupt replay compar set fals true return tri logger debug start replay fail batch row row rang slice queri filter row null row mark delet continu column written row column written null system current time milli long type instanc compos written valu replay batch row key cleanup final replay set fals logger debug finish replay fail batch privat void replay batch decor key key uuid type instanc compos key key logger debug replay batch uuid column famili store store tabl open tabl column famili store system tabl queri filter filter queri filter ident filter key queri path system tabl column famili batch store column famili filter batch null batch mark delet return column data column batch column tri data column null write hint serial mutat data column valu catch logger warn skip batch replay due uuid delet batch key total batch replay increment privat static void write hint serial mutat byte buffer data throw data input stream data input stream byte buffer util input stream data int size read int int size write hint mutat row mutat serial deseri privat static void write hint mutat row mutat mutat throw string tabl mutat tabl token storag servic partition token mutat key list inet address natur endpoint storag servic instanc natur endpoint tabl collect inet address pend endpoint storag servic instanc token metadata pend endpoint tabl inet address target iter concat natur endpoint pend endpoint target equal util broadcast address mutat appli els storag proxi write hint mutat mutat target privat static void delet batch decor key key row mutat row mutat tabl key key delet queri path system tabl util timestamp micro appli privat static byte buffer column string byte buffer raw type instanc decompos return meta data batchlog def column builder add raw build privat static list row rang slice disk atom filter column filter column famili store store tabl open tabl column famili store system tabl partition partition storag servic partition row posit min posit partition minimum token min key bound abstract bound row posit rang rang row posit min posit min posit partition return store rang slice null rang integ column filter null forc flush compact reclaim space replay batch privat void cleanup throw execut interrupt column famili store cfs tabl open tabl column famili store system tabl cfs forc block flush collect descriptor descriptor array list descriptor tabl reader sstr cfs tabl descriptor add sstr descriptor descriptor empti don pollut log noth compact compact manag instanc submit user defin cfs descriptor integ 