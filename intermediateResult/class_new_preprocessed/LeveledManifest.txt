licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra compact import java file import java import java util import googl common annot visibl test import googl common base predic import googl common base predic import googl common collect immut sort set import googl common collect iter import googl common collect set import googl common primit int import org codehaus jackson json encod import org codehaus jackson json factori import org codehaus jackson json generat import org codehaus jackson json node import org codehaus jackson map object mapper import org slf logger import org slf logger factori import org apach cassandra column famili store import org apach cassandra row posit import org apach cassandra dht bound import org apach cassandra dht token import org apach cassandra write error import org apach cassandra sstabl tabl import org apach cassandra sstabl tabl reader import org apach cassandra util file util public class level manifest privat static final logger logger logger factori logger level manifest class public static final string json limit number sstabl onc becaus compact bloom filter creation pessimist estim mani key overlap risk wast memori ming compact high overlap sstabl privat static final int privat final column famili store cfs privat final list tabl reader generat privat final map tabl reader integ sstabl generat privat final row posit compact key privat final int max tabl size byte privat level manifest column famili store cfs int max tabl size cfs cfs max tabl size byte max tabl size alloc generat data int int math log max tabl size generat list compact key row posit int generat length generat array list tabl reader compact key cfs partition minimum token min key bound sstabl generat hash map tabl reader integ static level manifest creat column famili store cfs int max tabl size return creat cfs max tabl size cfs tabl public static level manifest creat column famili store cfs int max tabl size iter tabl reader sstabl level manifest manifest level manifest cfs max tabl size load cfs manifest sstabl ensur tabl manifest tabl reader tabl reader sstabl manifest level tabl reader manifest add tabl reader return manifest privat static void load column famili store cfs level manifest manifest iter tabl reader sstabl file manifest file tri manifest cfs manifest file null return tri pars manifest manifest sstabl manifest file catch logger debug error pars manifest file file file manifest file path replac json file exist tri pars manifest manifest sstabl file return catch logger debug manifest present corrupt logger warn manifest present corrupt cassandra level scratch cfs column famili privat static void pars manifest level manifest manifest iter tabl reader sstabl file manifest file throw object mapper object mapper json node root node read valu manifest file json node class json node generat root node generat assert generat array json node generat generat int level generat generat int valu json node generat valu generat member json node generat valu generat valu tabl reader tabl reader sstabl tabl reader descriptor generat generat valu int valu logger debug load tabl reader level manifest add tabl reader level public synchron void add tabl reader reader log distribut logger debug ad reader add reader serial number tabl current compact set exceed target level level current content find empti level privat int skip level int level iter tabl reader ad max byte level level tabl reader total byte ad generat level empti level return level public synchron void promot iter tabl reader remov iter tabl reader ad assert iter empti remov add promot ad sstabl log distribut logger debug enabl logger debug replac string remov level ad sstabl max remov remov level int minimum level integ int maximum level tabl reader sstabl remov int level remov sstabl assert level maximum level math max maximum level level minimum level math min minimum level level valid remov add truncat ad iter return int level minimum level maximum level tabl total byte remov max tabl size byte special case tini sstabl level els level minimum level maximum level maximum level maximum level level skip level level ad assert level logger debug enabl logger debug ad string ad level compact key minimum level tabl sstabl order max ad tabl reader tabl reader ad add tabl reader level fix overlap sstabl level repair overlap tabl level serial public synchron void repair overlap tabl int level tabl reader previous null collect sort generat level tabl sstabl compar list tabl reader order tabl array list tabl reader tabl reader current generat level previous null current compar previous logger error string format level overlap caus bug cassandra send run scrub sinc row order sstabl level previous previous previous current current current order tabl add current els previous current order tabl empti tabl reader sstabl order tabl send sstabl serial public synchron void replac iter tabl reader remov iter tabl reader ad replac compact oper oper exact sstabl merg remov exact sstabl ad assert iter size remov iter size remov assert iter size ad iter size ad log distribut logger debug replac remov ad int level remov remov iter iter empti ad add ad iter level serial privat synchron void send tabl reader sstabl remov sstabl add sstabl privat string string iter tabl reader sstabl string builder builder string builder tabl reader sstabl sstabl builder append sstabl descriptor cfname append append sstabl descriptor generat append append level sstabl append return builder string visibl test long max byte level int level level return max tabl size byte doubl byte math pow level max tabl size byte byte long throw runtim long byte compact level max tabl size absurd high comput byte return long byte return highest prioriti sstabl compact compact necessari return empti list return null public synchron collect tabl reader compact candid level give level score data ideal amount compact level highest score fall spectacular onc consid set level ideal ideal ideal problem higher score compact batch sstabl sstabl put result sstabl compact batch spend rewrit data batch singl time ideal javadoc level simpli block write compact fall don luxuri forc compact higher level minim number read quick short term minim compact optimi give long term win int generat length list tabl reader sstabl generat sstabl empti continu avoid pollut debug log score calcul score exclud compact set tabl reader sstabl level set hash set sstabl set tabl reader remain set differ sstabl level cfs data tracker compact doubl score doubl tabl reader total byte remain doubl max byte level logger debug compact score level score special case don anyth import compact sstabl score sstabl size collect tabl reader candid candid logger debug enabl logger debug compact candid string candid candid empti return candid return collect empti list public int level size int return generat length generat size public synchron int level size int count int generat length int count length count generat size return count privat void log distribut logger debug enabl int generat length generat empti logger debug tabl byte object generat size tabl reader total byte generat int level tabl reader sstabl integ level sstabl generat sstabl level null return return level int valu privat int remov tabl reader reader int level level reader assert level reader present manifest generat level remov reader sstabl generat remov reader return level privat void add tabl reader sstabl int level assert level generat length invalid level level generat length generat level add sstabl sstabl generat put sstabl integ valu level privat static set tabl reader overlap collect tabl reader candid iter tabl reader assert candid empti pick sstabl overlap sstabl candid becaus follow situat candid case overlap compact result sstabl overlap return correct approach pick sstabl overlap anyth key candid sstabl iter tabl reader iter candid iter tabl reader sstabl iter token sstabl token token sstabl token iter sstabl iter compar sstabl token sstabl token compar sstabl token sstabl token return overlap visibl test static set tabl reader overlap tabl reader sstabl iter tabl reader return overlap sstabl token sstabl token return sstabl param sstabl key param start param inclus privat static set tabl reader overlap token start token iter tabl reader sstabl assert start compar set tabl reader overlap hash set tabl reader bound token promot bound bound token start tabl reader candid sstabl bound token candid bound bound token candid token candid token candid bound intersect promot bound overlap add candid return overlap privat static final predic tabl reader suspect predic tabl reader public boolean appli tabl reader candid return candid mark suspect return highest prioriti sstabl compact level compact possibl becaus concurr compact becaus sstabl blacklist prior failur return empti list return null privat collect tabl reader candid int level assert generat level empti logger debug choos candid level final set tabl reader compact cfs data tracker compact level dump ground sstabl overlap treat compact special add sstabl candid set max tabl size prefer choos older sstabl candid newer ani sstabl overlap candid becom candid sstabl compact onc total candid size max tabl size won bother compact result compact stay promot promot note ignor suspect ness sstabl sinc sstabl suspect basic screw sinc expect sstabl overlap sstabl sstabl suspect besid tri hope set tabl reader candid hash set tabl reader set tabl reader remain hash set tabl reader iter add remain iter filter generat predic suspect tabl reader sstabl age sort tabl remain candid sstabl continu tabl reader candid set union collect singleton sstabl overlap sstabl remain compact candid candid add candid remain remov candid candid size limit onli oldest candid candid hash set tabl reader age sort tabl candid list break leav everyth didn full sstabl worth data tabl total byte candid max tabl size byte add sstabl overlap candid overlap alreadi busi compact leav tri find set sstabl onli overlap busi sstabl candid set union candid overlap candid generat check overlap compact sstabl generat overlap iter tabl reader compact iter filter generat predic compact set intersect candid compact empti overlap candid compact empti return collect empti list return candid size candid collect tabl reader empti list compact pick left time collect sort generat level tabl sstabl compar int start handl case prior compact touch veri rang int generat level size tabl reader sstabl generat level sstabl compar compact key level start break suspect tabl compact start left time wrap generat necessari int generat level size tabl reader sstabl generat level start generat level size set tabl reader candid set union collect singleton sstabl overlap sstabl generat level iter ani candid suspect continu set intersect candid compact empti return candid sstabl suspect overlap someth suspect return collect empti list privat list tabl reader age sort tabl collect tabl reader candid list tabl reader age sort candid array list tabl reader candid collect sort age sort candid tabl max timestamp compar return age sort candid public static file tri manifest column famili store cfs return cfs directori tri level manifest public synchron void serial file manifest file cfs directori creat level manifest file file file manifest file path replac json file tmp file file manifest file path replac tmp json json factori json factori tri json generat creat json generat tmp file json encod default pretti printer write start object write array field start generat int level level generat length level write start object write number field generat level write array field start member tabl reader tabl reader generat level write number tabl reader descriptor generat write array member write object generat write array field generat write object write global object close catch throw write error tmp file file exist manifest file exist file util delet confirm file manifest file exist file util renam confirm manifest file file assert tmp file exist file util renam confirm tmp file manifest file logger debug save manifest manifest file overrid public string string return manifest hash code public int level count int generat length generat size return return public synchron sort set tabl reader level sort int level compar tabl reader compar return immut sort set copi compar generat level public list tabl reader level int return generat public synchron int estim task long task long estim long generat length int generat length list tabl reader sstabl generat estim math max tabl reader total byte sstabl max byte level max tabl size byte task estim logger debug estim compact object array string estim cfs tabl cfs column famili return int check cast task 