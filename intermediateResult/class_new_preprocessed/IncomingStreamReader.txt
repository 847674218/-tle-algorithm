licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra stream import java import java net inet address import java net inet socket address import java net socket import java util collect import googl common base throwabl import org slf logger import org slf logger factori import org apach cassandra config databas descriptor import org apach cassandra column famili import org apach cassandra column famili store import org apach cassandra decor key import org apach cassandra tabl import org apach cassandra compact compact control import org apach cassandra compact precompact row import org apach cassandra column serial import org apach cassandra sstabl import org apach cassandra util file util import org apach cassandra metric stream metric import org apach cassandra net messag servic import org apach cassandra net outbound tcp connect import org apach cassandra servic storag servic import org apach cassandra stream compress compress input stream import org apach cassandra util byte buffer util import org apach cassandra util byte read tracker import org apach cassandra util pair import ning compress lzf input stream public class incom stream reader privat static final logger logger logger factori logger incom stream reader class protect final pend file local file protect final pend file remot file protect final stream session session privat final input stream underlin stream privat final stream metric metric public incom stream reader stream header header socket socket throw socket set timeout databas descriptor stream socket timeout inet address host inet socket address socket remot socket address address header pend file empti header file null stream session creat alreadi receiv file stream session session header session stream repli repli stream repli header session stream repli status outbound tcp connect write repli creat messag header session string system current time milli data output stream socket output stream messag servic instanc version host throw session header session alreadi close session stream session host header session session set socket socket session add file header pend file set current file stream progress show jmx session set current file header file session set tabl header tabl pend file context local node remot file header file local file remot file null stream context map remot file null remot file null remot file compress info null underlin stream input stream socket input stream els underlin stream compress input stream socket input stream remot file compress info els underlin stream null metric stream metric host throw read remot sstabl fail throw local write fail public void read throw remot file null logger debug enabl logger debug receiv stream logger debug creat file estim key local file filenam remot file estim key assert remot file estim key data input dis data input stream underlin stream tri tabl reader reader stream dis local file remot file session finish remot file reader catch retri throw session close finish throw read remot sstabl fail throw local write fail privat tabl reader stream data input input pend file local file pend file remot file throw column famili store cfs tabl open local file desc ksname column famili store local file desc cfname decor key key tabl writer writer tabl writer local file filenam remot file estim key compact control control compact control cfs collect tabl reader empti list integ tri byte read tracker byte read tracker input long total byte read pair long long section local file section long length section section left skip section insid chunk remot file compress info null compress input stream underlin stream posit section left long byte read byte read length reset key tabl reader decod key storag servic partition local file desc byte buffer util read short length long data size tabl reader read row size local file desc cfs cach row key remot file type oper type data size databas descriptor memori compact limit updat row cach note becaus won echo column flag contrarili append stream doe tabl ident iter iter tabl ident iter cfs metadata local file filenam key data size column serial flag precompact row row precompact row control collect singleton list iter don expir anyth row shouldn empti assert row empti writer append row updat cach column famili row full column famili cfs mayb updat row cach key els writer append stream key cfs metadata data size cfs invalid cach row key byte read byte read compress report total byte compress chunk read sinc remot file size sum chunk transfer remot file compress info null remot file progress compress input stream underlin stream total compress byte read els remot file progress byte read total byte read byte read stream metric total incom byte total byte read metric incom byte total byte read return writer close open reader catch throwabl writer abort instanceof throw els throw throwabl propag final control close privat void retri sourc node stream file session retri remot file delet orphan file file local file filenam file file util delet confirm file local file filenam 