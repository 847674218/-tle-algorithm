licens apach softwar foundat contributor licens agreement file distribut work addit inform regard copyright ownership licens file apach licens version licens file complianc licens obtain copi licens http www apach org licens requir applic law agre write softwar distribut licens distribut express impli licens specif languag govern permiss limit licens packag org apach cassandra import java data input stream import java data output stream import java import java net inet address import java nio byte buffer import java nio charset charact code import java util import java util concurr execut import googl common collect hash multimap import googl common collect set multimap import googl common collect set import org slf logger import org slf logger factori import org apach avro ipc byte buffer input stream import org apach cassandra config meta data import org apach cassandra config schema import org apach cassandra commitlog replay posit import org apach cassandra marshal type import org apach cassandra configur import org apach cassandra config databas descriptor import org apach cassandra cql queri processor import org apach cassandra cql untyp result set import org apach cassandra columniter ident queri filter import org apach cassandra filter queri filter import org apach cassandra filter queri path import org apach cassandra marshal ascii type import org apach cassandra marshal byte type import org apach cassandra marshal type import org apach cassandra dht rang import org apach cassandra dht token import org apach cassandra util data output buffer import org apach cassandra util fast byte array output stream import org apach cassandra locat endpoint snitch import org apach cassandra servic storag servic import org apach cassandra thrift constant import org apach cassandra util byte buffer util import org apach cassandra util counter import org apach cassandra util util import org apach cassandra util pair import static org apach cassandra cql queri processor process intern public class system tabl privat static final logger logger logger factori logger system tabl class meta data schema definit public static final string peer public static final string local public static final string index info public static final string node info public static final string hint public static final string rang xfer public static final string batchlog layout descript def tabl class header public static final string schema keyspac public static final string schema columnfamili public static final string schema column deprec public static final string locat info deprec public static final string hint column famili privat static final string local privat static final byte buffer byte buffer util byte local public enum bootstrap state privat static decor key decor byte buffer key return storag servic partition decor key key public static void finish startup def tabl fix schema nano timestamp setup version tri upgrad system data catch execut throw runtim catch interrupt throw runtim add entri system schema columnfamili hardcod system definit string ksname schema system keyspac meta data ksmd schema instanc meta data ksname delet possibl obsolet entri schema columnfamili string cfname array list system tabl system tabl system tabl string req string format system keyspac cfname ksmd process intern req timestamp don shadow tombston ad ksmd schema util timestamp micro appli privat static void setup version string req system key releas version cql version thrift version data center rack partition endpoint snitch snitch databas descriptor endpoint snitch process intern string format req util releas version string queri processor string constant snitch datacent util broadcast address snitch rack util broadcast address databas descriptor partition class system data becom incompat version cassandra logic associ purg manag privat static void upgrad system data throw execut interrupt tabl tabl tabl open tabl column famili store status cfs tabl column famili store status cfs tabl size sort set byte buffer col tree set byte buffer byte type instanc col add byte buffer util byte cluster col add byte buffer util byte token queri filter filter queri filter filter decor byte buffer util byte queri path col column famili status cfs column famili filter iter column column column iter string cluster null tri cluster byte buffer util string column valu catch charact code throw runtim serial token collect token token token storag servic partition token factori byte array column valu string token byte token set collect singleton token assum ani node upgrad bootstrap sinc store separ row reason string req system key cluster token bootstrap process intern string format req cluster token byte bootstrap state status cfs truncat column famili store hint cfs tabl column famili store hint cfs tabl size logger info possibl format hint truncat hint cfs truncat public static void save truncat posit column famili store cfs replay posit posit string req system truncat truncat key process intern string format req posit map entri cfs posit forc block flush privat static string posit map entri column famili store cfs replay posit posit data output buffer data output buffer tri replay posit serial serial posit catch throw runtim return string format cfs metadata byte buffer util byte hex byte buffer wrap data length public static map replay posit truncat posit string req truncat system key untyp result set row process intern string format req row empti return collect empti map untyp result set row row row map byte buffer raw map row map truncat type instanc byte type instanc raw map null return collect empti map map replay posit posit hash map replay posit map entri byte buffer entri raw map entri set posit put entri key posit blob entri valu return posit privat static replay posit posit blob byte buffer byte tri return replay posit serial deseri data input stream byte buffer util input stream byte catch throw runtim record token anoth node public static synchron void updat token inet address collect token token equal util broadcast address remov endpoint return string req system peer token process intern string format req host address token set token forc block flush public static synchron void updat peer info inet address string column string valu equal util broadcast address return string req system peer process intern string format req column host address valu public static synchron void updat schema version version string req system key schema version process intern string format req version string privat static string token set collect token token token token factori factori storag servic partition token factori string builder string builder append iter token iter token iter iter append append factori string iter append iter append append return string privat static collect token deseri token collect string token string token token factori factori storag servic partition token factori list token token array list token token string size string token string token add factori string return token remov store token anoth node public static synchron void remov endpoint inet address string req system peer process intern string format req host address forc block flush method updat system tabl token node public static synchron void updat token collect token token assert token empti remov endpoint string req system key token process intern string format req token set token forc block flush conveni method updat list token local system tabl param add token token add param token token remov return collect persist token public static synchron collect token updat local token collect token add token collect token token collect token token save token token remov token token add add token updat token token return token privat static void forc block flush string cfname tri tabl open tabl column famili store cfname forc block flush catch execut throw runtim catch interrupt throw assert error return map store token address public static set multimap inet address token load token set multimap inet address token token map hash multimap creat untyp result set row row process intern peer token system inet address peer row inet address peer row token token map put peer deseri token row set token type instanc return token map return map store host id address public static map inet address load host id map inet address host map hash map inet address untyp result set row row process intern peer host system inet address peer row inet address peer row host host map put peer row host return host map return map address map rack info public static map inet address map string string load rack info map inet address map string string result hash map inet address map string string untyp result set row row process intern peer data center rack system inet address peer row inet address peer row data center map string string rack hash map string string rack put data center row string data center rack put rack row string rack result put peer rack return result happen tri read system tabl file present read great file great node assum file present read bad throw configur public static void check health throw configur tabl tabl tri tabl tabl open tabl catch assert error err happen user switch configur configur read system tabl init caus err throw column famili store cfs tabl column famili store string req cluster system key untyp result set result process intern string format req result empti result cluster brand node cfs tabl empti throw configur system tabl file couldn load system file node req system key cluster process intern string format req databas descriptor cluster return string save cluster result string cluster databas descriptor cluster equal save cluster throw configur save cluster save cluster configur databas descriptor cluster public static collect token save token string req token system key untyp result set result process intern string format req return result empti result token collect token empti list deseri token result string set token type instanc public static int increment generat string req gossip generat system key untyp result set result process intern string format req int generat result empti result gossip generat sinc epoch isn foolproof generat foolproof guarante larger address close sane possibl generat int system current time milli els node ignor gossip messag node generat previous final int store generat result int gossip generat final int int system current time milli store generat logger warn store gossip generat greater current system time experi problem store generat generat store generat els generat req system key gossip generat process intern string format req generat forc block flush return generat public static bootstrap state bootstrap state string req bootstrap system key untyp result set result process intern string format req result empti result bootstrap return bootstrap state return bootstrap state valu result string bootstrap public static boolean bootstrap complet return bootstrap state bootstrap state public static boolean bootstrap progress return bootstrap state bootstrap state public static void set bootstrap state bootstrap state state string req system key bootstrap process intern string format req state forc block flush public static boolean index built string tabl string index column famili store cfs tabl open tabl column famili store queri filter filter queri filter filter decor byte buffer util byte tabl queri path byte buffer util byte index return column famili store remov delet cfs column famili filter integ null public static void set index built string tabl string index column famili column famili creat tabl add column column byte buffer util byte index byte buffer util util timestamp micro row mutat row mutat tabl byte buffer util byte tabl add appli forc block flush public static void set index remov string tabl string index row mutat row mutat tabl byte buffer util byte tabl delet queri path null byte buffer util byte index util timestamp micro appli forc block flush read host system tabl creat store exist public static local host host null string req host system key untyp result set result process intern string format req host return result empti result host return result host generat persist return host random logger warn host creat note happen exact onc node host req system key host process intern string format req host return host read current local node system tabl null node record public static counter current local counter tabl tabl tabl open tabl counter sinc counter timeuuid order older newer queri filter filter queri filter slice filter decor queri path byte buffer util byte buffer util true column famili tabl column famili store column famili filter null column count return counter wrap iter els return null write current local node system tabl param counter previous local node code counter replac null node exist node remov system tabl param counter current local node record param microsecond time stamp public static void write current local counter counter counter counter counter long byte buffer byte buffer wrap util broadcast address address column famili column famili creat tabl add column column counter byte row mutat row mutat tabl add appli forc block flush public static list counter counter record local counter id list counter counter record array list counter counter record tabl tabl tabl open tabl queri filter filter queri filter ident filter decor queri path column famili tabl column famili store column famili filter counter previous null column previous null add counter counter record previous timestamp ignor column purpos sinc current local node previous counter wrap return param column famili respons part schema keyspac column famili column return respons hold level serial schema public static column famili store schema string return tabl open tabl column famili store public static list row serial schema list row schema array list row schema add serial schema schema add serial schema schema add serial schema return schema param schema column famili respons part schema keyspac column famili column return level schema represent row repres individu keyspac column famili public static list row serial schema string schema token min token storag servic partition minimum token return schema schema rang slice null rang row posit min token min key bound min token max key bound integ ident queri filter null public static collect row mutat serial schema map decor key row mutat mutat map hash map decor key row mutat serial schema mutat map serial schema mutat map serial schema mutat map return mutat map valu privat static void serial schema map decor key row mutat mutat map string schema row schema row serial schema schema schema ignor schema row schema row continu row mutat mutat mutat map schema row key mutat null mutat map put schema row key row mutat tabl schema row continu mutat add schema row public static map decor key column famili schema string map decor key column famili schema hash map decor key column famili row schema entiti system tabl serial schema schema put schema entiti key schema entiti return schema public static byte buffer schema key string return ascii type instanc string public static row read schema row string decor key key storag servic partition decor key schema key column famili store schema system tabl schema column famili result schema column famili queri filter ident filter key queri path return row key result public static row read schema row string string decor key key storag servic partition decor key schema key column famili store schema system tabl schema column famili result schema column famili key queri path def tabl search composit true def tabl search composit fals fals integ return row key result 