<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.sdml.info/srcML/src" language="Java" filename="C:\Users\mrahimi1\Desktop\FSE-2015-LinkEvolution\srcML-Win\srcML-Win\cassandra-cassandra-1.2.1\src\java\org\apache\cassandra\db\SystemTable.java"><comment type="block">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</comment>
<package>package <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name></name>;</package>

<import>import <name><name>java</name>.<name>io</name>.<name>DataInputStream</name></name>;</import>
<import>import <name><name>java</name>.<name>io</name>.<name>DataOutputStream</name></name>;</import>
<import>import <name><name>java</name>.<name>io</name>.<name>IOException</name></name>;</import>
<import>import <name><name>java</name>.<name>net</name>.<name>InetAddress</name></name>;</import>
<import>import <name><name>java</name>.<name>nio</name>.<name>ByteBuffer</name></name>;</import>
<import>import <name><name>java</name>.<name>nio</name>.<name>charset</name>.<name>CharacterCodingException</name></name>;</import>
<import>import <name><name>java</name>.<name>util</name></name>.*;</import>
<import>import <name><name>java</name>.<name>util</name>.<name>concurrent</name>.<name>ExecutionException</name></name>;</import>

<import>import <name><name>com</name>.<name>google</name>.<name>common</name>.<name>collect</name>.<name>HashMultimap</name></name>;</import>
<import>import <name><name>com</name>.<name>google</name>.<name>common</name>.<name>collect</name>.<name>SetMultimap</name></name>;</import>
<import>import <name><name>com</name>.<name>google</name>.<name>common</name>.<name>collect</name>.<name>Sets</name></name>;</import>
<import>import <name><name>org</name>.<name>slf4j</name>.<name>Logger</name></name>;</import>
<import>import <name><name>org</name>.<name>slf4j</name>.<name>LoggerFactory</name></name>;</import>

<import>import <name><name>org</name>.<name>apache</name>.<name>avro</name>.<name>ipc</name>.<name>ByteBufferInputStream</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>config</name>.<name>KSMetaData</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>config</name>.<name>Schema</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>commitlog</name>.<name>ReplayPosition</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>marshal</name>.<name>UUIDType</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>exceptions</name>.<name>ConfigurationException</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>config</name>.<name>DatabaseDescriptor</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>cql3</name>.<name>QueryProcessor</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>cql3</name>.<name>UntypedResultSet</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>columniterator</name>.<name>IdentityQueryFilter</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>filter</name>.<name>QueryFilter</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>filter</name>.<name>QueryPath</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>marshal</name>.<name>AsciiType</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>marshal</name>.<name>BytesType</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>db</name>.<name>marshal</name>.<name>UTF8Type</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>dht</name>.<name>Range</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>dht</name>.<name>Token</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>io</name>.<name>util</name>.<name>DataOutputBuffer</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>io</name>.<name>util</name>.<name>FastByteArrayOutputStream</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>locator</name>.<name>IEndpointSnitch</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>service</name>.<name>StorageService</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>thrift</name>.<name>Constants</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>utils</name>.<name>ByteBufferUtil</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>utils</name>.<name>CounterId</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>utils</name>.<name>FBUtilities</name></name>;</import>
<import>import <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>utils</name>.<name>Pair</name></name>;</import>

<import>import static <name><name>org</name>.<name>apache</name>.<name>cassandra</name>.<name>cql3</name>.<name>QueryProcessor</name>.<name>processInternal</name></name>;</import>

<class><specifier>public</specifier> class <name>SystemTable</name>
<block>{
    <decl_stmt><decl><type><specifier>private</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>Logger</name></type> <name>logger</name> <init>= <expr><call><name><name>LoggerFactory</name>.<name>getLogger</name></name><argument_list>(<argument><expr><name><name>SystemTable</name>.<name>class</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

    <comment type="line">// see CFMetaData for schema definitions</comment>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>PEERS_CF</name> <init>= <expr>"peers"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>LOCAL_CF</name> <init>= <expr>"local"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>INDEX_CF</name> <init>= <expr>"IndexInfo"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>COUNTER_ID_CF</name> <init>= <expr>"NodeIdInfo"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>HINTS_CF</name> <init>= <expr>"hints"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>RANGE_XFERS_CF</name> <init>= <expr>"range_xfers"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>BATCHLOG_CF</name> <init>= <expr>"batchlog"</expr></init></decl>;</decl_stmt>
    <comment type="line">// see layout description in the DefsTable class header</comment>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>SCHEMA_KEYSPACES_CF</name> <init>= <expr>"schema_keyspaces"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>SCHEMA_COLUMNFAMILIES_CF</name> <init>= <expr>"schema_columnfamilies"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>SCHEMA_COLUMNS_CF</name> <init>= <expr>"schema_columns"</expr></init></decl>;</decl_stmt>

    <decl_stmt><decl><type><annotation>@<name>Deprecated</name></annotation>
    <specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>OLD_STATUS_CF</name> <init>= <expr>"LocationInfo"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><annotation>@<name>Deprecated</name></annotation>
    <specifier>public</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>OLD_HINTS_CF</name> <init>= <expr>"HintsColumnFamily"</expr></init></decl>;</decl_stmt>

    <decl_stmt><decl><type><specifier>private</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>String</name></type> <name>LOCAL_KEY</name> <init>= <expr>"local"</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>private</specifier> <specifier>static</specifier> <specifier>final</specifier> <name>ByteBuffer</name></type> <name>ALL_LOCAL_NODE_ID_KEY</name> <init>= <expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr>"Local"</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

    <enum><specifier>public</specifier> enum <name>BootstrapState</name>
    <block>{
        <decl><name>NEEDS_BOOTSTRAP</name></decl>,
        <decl><name>COMPLETED</name></decl>,
        <decl><name>IN_PROGRESS</name></decl>
    }</block></enum>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>DecoratedKey</name></type> <name>decorate</name><parameter_list>(<param><decl><type><name>ByteBuffer</name></type> <name>key</name></decl></param>)</parameter_list>
    <block>{
        <return>return <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>decorateKey</name><argument_list>(<argument><expr><name>key</name></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>finishStartup</name><parameter_list>()</parameter_list>
    <block>{
        <expr_stmt><expr><call><name><name>DefsTable</name>.<name>fixSchemaNanoTimestamps</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>setupVersion</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <try>try
        <block>{
            <expr_stmt><expr><call><name>upgradeSystemData</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        }</block>
        <catch>catch <parameter_list>(<param><decl><type><name>ExecutionException</name></type> <name>e</name></decl></param>)</parameter_list>
        <block>{
            <throw>throw <expr>new <call><name>RuntimeException</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
        }</block></catch>
        <catch>catch <parameter_list>(<param><decl><type><name>InterruptedException</name></type> <name>e</name></decl></param>)</parameter_list>
        <block>{
            <throw>throw <expr>new <call><name>RuntimeException</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
        }</block></catch></try>

        <comment type="line">// add entries to system schema columnfamilies for the hardcoded system definitions</comment>
        <for>for (<init><decl><type><name>String</name></type> <name>ksname</name> <range>: <expr><name><name>Schema</name>.<name>systemKeyspaceNames</name></name></expr></range></decl></init>)
        <block>{
            <decl_stmt><decl><type><name>KSMetaData</name></type> <name>ksmd</name> <init>= <expr><call><name><name>Schema</name>.<name>instance</name>.<name>getKSMetaData</name></name><argument_list>(<argument><expr><name>ksname</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

            <comment type="line">// delete old, possibly obsolete entries in schema columnfamilies</comment>
            <for>for (<init><decl><type><name>String</name></type> <name>cfname</name> <range>: <expr><call><name><name>Arrays</name>.<name>asList</name></name><argument_list>(<argument><expr><name><name>SystemTable</name>.<name>SCHEMA_KEYSPACES_CF</name></name></expr></argument>, <argument><expr><name><name>SystemTable</name>.<name>SCHEMA_COLUMNFAMILIES_CF</name></name></expr></argument>, <argument><expr><name><name>SystemTable</name>.<name>SCHEMA_COLUMNS_CF</name></name></expr></argument>)</argument_list></call></expr></range></decl></init>)
            <block>{
                <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr>"DELETE FROM system.%s WHERE keyspace_name = '%s'"</expr></argument>, <argument><expr><name>cfname</name></expr></argument>, <argument><expr><name><name>ksmd</name>.<name>name</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
                <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><name>req</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            }</block></for>

            <comment type="line">// (+1 to timestamp to make sure we don't get shadowed by the tombstones we just added)</comment>
            <expr_stmt><expr><call><name><name>ksmd</name>.<name>toSchema</name></name><argument_list>(<argument><expr><call><name><name>FBUtilities</name>.<name>timestampMicros</name></name><argument_list>()</argument_list></call> + 1</expr></argument>)</argument_list></call>.<call><name>apply</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        }</block></for>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>void</name></type> <name>setupVersion</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (key, release_version, cql_version, thrift_version, data_center, rack, partitioner) VALUES ('%s', '%s', '%s', '%s', '%s', '%s', '%s')"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>IEndpointSnitch</name></type> <name>snitch</name> <init>= <expr><call><name><name>DatabaseDescriptor</name>.<name>getEndpointSnitch</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>,
                                         <argument><expr><name>LOCAL_KEY</name></expr></argument>,
                                         <argument><expr><call><name><name>FBUtilities</name>.<name>getReleaseVersionString</name></name><argument_list>()</argument_list></call></expr></argument>,
                                         <argument><expr><call><name><name>QueryProcessor</name>.<name>CQL_VERSION</name>.<name>toString</name></name><argument_list>()</argument_list></call></expr></argument>,
                                         <argument><expr><name><name>Constants</name>.<name>VERSION</name></name></expr></argument>,
                                         <argument><expr><call><name><name>snitch</name>.<name>getDatacenter</name></name><argument_list>(<argument><expr><call><name><name>FBUtilities</name>.<name>getBroadcastAddress</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>,
                                         <argument><expr><call><name><name>snitch</name>.<name>getRack</name></name><argument_list>(<argument><expr><call><name><name>FBUtilities</name>.<name>getBroadcastAddress</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>,
                                         <argument><expr><call><name><name>DatabaseDescriptor</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>getClass</name><argument_list>()</argument_list></call>.<call><name>getName</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <comment type="block" format="javadoc">/** if system data becomes incompatible across versions of cassandra, that logic (and associated purging) is managed here */</comment>
    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>void</name></type> <name>upgradeSystemData</name><parameter_list>()</parameter_list> <throws>throws <argument><expr><name>ExecutionException</name></expr></argument>, <argument><expr><name>InterruptedException</name></expr></argument></throws>
    <block>{
        <decl_stmt><decl><type><name>Table</name></type> <name>table</name> <init>= <expr><call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>ColumnFamilyStore</name></type> <name>oldStatusCfs</name> <init>= <expr><call><name><name>table</name>.<name>getColumnFamilyStore</name></name><argument_list>(<argument><expr><name>OLD_STATUS_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <if>if <condition>(<expr><call><name><name>oldStatusCfs</name>.<name>getSSTables</name></name><argument_list>()</argument_list></call>.<call><name>size</name><argument_list>()</argument_list></call> &gt; 0</expr>)</condition><then>
        <block>{
            <decl_stmt><decl><type><name><name>SortedSet</name><argument_list>&lt;<argument><name>ByteBuffer</name></argument>&gt;</argument_list></name></type> <name>cols</name> <init>= <expr>new <call><name><name>TreeSet</name><argument_list>&lt;<argument><name>ByteBuffer</name></argument>&gt;</argument_list></name><argument_list>(<argument><expr><name><name>BytesType</name>.<name>instance</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <expr_stmt><expr><call><name><name>cols</name>.<name>add</name></name><argument_list>(<argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr>"ClusterName"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name><name>cols</name>.<name>add</name></name><argument_list>(<argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr>"Token"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <decl_stmt><decl><type><name>QueryFilter</name></type> <name>filter</name> <init>= <expr><call><name><name>QueryFilter</name>.<name>getNamesFilter</name></name><argument_list>(<argument><expr><call><name>decorate</name><argument_list>(<argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr>"L"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>, <argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>OLD_STATUS_CF</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><name>cols</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>oldCf</name> <init>= <expr><call><name><name>oldStatusCfs</name>.<name>getColumnFamily</name></name><argument_list>(<argument><expr><name>filter</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <decl_stmt><decl><type><name><name>Iterator</name><argument_list>&lt;<argument><name>IColumn</name></argument>&gt;</argument_list></name></type> <name>oldColumns</name> <init>= <expr><call><name><name>oldCf</name>.<name>columns</name>.<name>iterator</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>

            <decl_stmt><decl><type><name>String</name></type> <name>clusterName</name> <init>= <expr>null</expr></init></decl>;</decl_stmt>
            <try>try
            <block>{
                <expr_stmt><expr><name>clusterName</name> = <call><name><name>ByteBufferUtil</name>.<name>string</name></name><argument_list>(<argument><expr><call><name><name>oldColumns</name>.<name>next</name></name><argument_list>()</argument_list></call>.<call><name>value</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            }</block>
            <catch>catch <parameter_list>(<param><decl><type><name>CharacterCodingException</name></type> <name>e</name></decl></param>)</parameter_list>
            <block>{
                <throw>throw <expr>new <call><name>RuntimeException</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
            }</block></catch></try>
            <comment type="line">// serialize the old token as a collection of (one )tokens.</comment>
            <decl_stmt><decl><type><name>Token</name></type> <name>token</name> <init>= <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>getTokenFactory</name><argument_list>()</argument_list></call>.<call><name>fromByteArray</name><argument_list>(<argument><expr><call><name><name>oldColumns</name>.<name>next</name></name><argument_list>()</argument_list></call>.<call><name>value</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <decl_stmt><decl><type><name>String</name></type> <name>tokenBytes</name> <init>= <expr><call><name>tokensAsSet</name><argument_list>(<argument><expr><call><name><name>Collections</name>.<name>singleton</name></name><argument_list>(<argument><expr><name>token</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <comment type="line">// (assume that any node getting upgraded was bootstrapped, since that was stored in a separate row for no particular reason)</comment>
            <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (key, cluster_name, tokens, bootstrapped) VALUES ('%s', '%s', %s, '%s')"</expr></init></decl>;</decl_stmt>
            <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><name>clusterName</name></expr></argument>, <argument><expr><name>tokenBytes</name></expr></argument>, <argument><expr><call><name><name>BootstrapState</name>.<name>COMPLETED</name>.<name>name</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>

            <expr_stmt><expr><call><name><name>oldStatusCfs</name>.<name>truncate</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        }</block></then></if>

        <decl_stmt><decl><type><name>ColumnFamilyStore</name></type> <name>oldHintsCfs</name> <init>= <expr><call><name><name>table</name>.<name>getColumnFamilyStore</name></name><argument_list>(<argument><expr><name>OLD_HINTS_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <if>if <condition>(<expr><call><name><name>oldHintsCfs</name>.<name>getSSTables</name></name><argument_list>()</argument_list></call>.<call><name>size</name><argument_list>()</argument_list></call> &gt; 0</expr>)</condition><then>
        <block>{
            <expr_stmt><expr><call><name><name>logger</name>.<name>info</name></name><argument_list>(<argument><expr>"Possible old-format hints found. Truncating"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name><name>oldHintsCfs</name>.<name>truncate</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        }</block></then></if>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>saveTruncationPosition</name><parameter_list>(<param><decl><type><name>ColumnFamilyStore</name></type> <name>cfs</name></decl></param>, <param><decl><type><name>ReplayPosition</name></type> <name>position</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"UPDATE system.%s SET truncated_at = truncated_at + %s WHERE key = '%s'"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><call><name>positionAsMapEntry</name><argument_list>(<argument><expr><name>cfs</name></expr></argument>, <argument><expr><name>position</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>LOCAL_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>String</name></type> <name>positionAsMapEntry</name><parameter_list>(<param><decl><type><name>ColumnFamilyStore</name></type> <name>cfs</name></decl></param>, <param><decl><type><name>ReplayPosition</name></type> <name>position</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>DataOutputBuffer</name></type> <name>out</name> <init>= <expr>new <call><name>DataOutputBuffer</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <try>try
        <block>{
            <expr_stmt><expr><call><name><name>ReplayPosition</name>.<name>serializer</name>.<name>serialize</name></name><argument_list>(<argument><expr><name>position</name></expr></argument>, <argument><expr><name>out</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block>
        <catch>catch <parameter_list>(<param><decl><type><name>IOException</name></type> <name>e</name></decl></param>)</parameter_list>
        <block>{
            <throw>throw <expr>new <call><name>RuntimeException</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
        }</block></catch></try>
        <return>return <expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr>"{'%s': '%s'}"</expr></argument>,
                             <argument><expr><name><name>cfs</name>.<name>metadata</name>.<name>cfId</name></name></expr></argument>,
                             <argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytesToHex</name></name><argument_list>(<argument><expr><call><name><name>ByteBuffer</name>.<name>wrap</name></name><argument_list>(<argument><expr><call><name><name>out</name>.<name>getData</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr><call><name><name>out</name>.<name>getLength</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>Map</name><argument_list>&lt;<argument><name>UUID</name></argument>, <argument><name>ReplayPosition</name></argument>&gt;</argument_list></name></type> <name>getTruncationPositions</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"SELECT truncated_at FROM system.%s WHERE key = '%s'"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>UntypedResultSet</name></type> <name>rows</name> <init>= <expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <if>if <condition>(<expr><call><name><name>rows</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call></expr>)</condition><then>
            <return>return <expr><call><name><name>Collections</name>.<name>emptyMap</name></name><argument_list>()</argument_list></call></expr>;</return></then></if>

        <decl_stmt><decl><type><name><name>UntypedResultSet</name>.<name>Row</name></name></type> <name>row</name> <init>= <expr><call><name><name>rows</name>.<name>one</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>UUID</name></argument>, <argument><name>ByteBuffer</name></argument>&gt;</argument_list></name></type> <name>rawMap</name> <init>= <expr><call><name><name>row</name>.<name>getMap</name></name><argument_list>(<argument><expr>"truncated_at"</expr></argument>, <argument><expr><name><name>UUIDType</name>.<name>instance</name></name></expr></argument>, <argument><expr><name><name>BytesType</name>.<name>instance</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <if>if <condition>(<expr><name>rawMap</name> == null</expr>)</condition><then>
            <return>return <expr><call><name><name>Collections</name>.<name>emptyMap</name></name><argument_list>()</argument_list></call></expr>;</return></then></if>

        <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>UUID</name></argument>, <argument><name>ReplayPosition</name></argument>&gt;</argument_list></name></type> <name>positions</name> <init>= <expr>new <call><name><name>HashMap</name><argument_list>&lt;<argument><name>UUID</name></argument>, <argument><name>ReplayPosition</name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <for>for (<init><decl><type><name><name>Map</name>.<name><name>Entry</name><argument_list>&lt;<argument><name>UUID</name></argument>, <argument><name>ByteBuffer</name></argument>&gt;</argument_list></name></name></type> <name>entry</name> <range>: <expr><call><name><name>rawMap</name>.<name>entrySet</name></name><argument_list>()</argument_list></call></expr></range></decl></init>)
        <block>{
            <expr_stmt><expr><call><name><name>positions</name>.<name>put</name></name><argument_list>(<argument><expr><call><name><name>entry</name>.<name>getKey</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><call><name>positionFromBlob</name><argument_list>(<argument><expr><call><name><name>entry</name>.<name>getValue</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></for>
        <return>return <expr><name>positions</name></expr>;</return>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>ReplayPosition</name></type> <name>positionFromBlob</name><parameter_list>(<param><decl><type><name>ByteBuffer</name></type> <name>bytes</name></decl></param>)</parameter_list>
    <block>{
        <try>try
        <block>{
            <return>return <expr><call><name><name>ReplayPosition</name>.<name>serializer</name>.<name>deserialize</name></name><argument_list>(<argument><expr>new <call><name>DataInputStream</name><argument_list>(<argument><expr><call><name><name>ByteBufferUtil</name>.<name>inputStream</name></name><argument_list>(<argument><expr><name>bytes</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</return>
        }</block>
        <catch>catch <parameter_list>(<param><decl><type><name>IOException</name></type> <name>e</name></decl></param>)</parameter_list>
        <block>{
            <throw>throw <expr>new <call><name>RuntimeException</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
        }</block></catch></try>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Record tokens being used by another node
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <specifier>synchronized</specifier> <name>void</name></type> <name>updateTokens</name><parameter_list>(<param><decl><type><name>InetAddress</name></type> <name>ep</name></decl></param>, <param><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>tokens</name></decl></param>)</parameter_list>
    <block>{
        <if>if <condition>(<expr><call><name><name>ep</name>.<name>equals</name></name><argument_list>(<argument><expr><call><name><name>FBUtilities</name>.<name>getBroadcastAddress</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>)</condition><then>
        <block>{
            <expr_stmt><expr><call><name>removeEndpoint</name><argument_list>(<argument><expr><name>ep</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return;</return>
        }</block></then></if>

        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (peer, tokens) VALUES ('%s', %s)"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>PEERS_CF</name></expr></argument>, <argument><expr><call><name><name>ep</name>.<name>getHostAddress</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><call><name>tokensAsSet</name><argument_list>(<argument><expr><name>tokens</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>PEERS_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <specifier>synchronized</specifier> <name>void</name></type> <name>updatePeerInfo</name><parameter_list>(<param><decl><type><name>InetAddress</name></type> <name>ep</name></decl></param>, <param><decl><type><name>String</name></type> <name>columnName</name></decl></param>, <param><decl><type><name>String</name></type> <name>value</name></decl></param>)</parameter_list>
    <block>{
        <if>if <condition>(<expr><call><name><name>ep</name>.<name>equals</name></name><argument_list>(<argument><expr><call><name><name>FBUtilities</name>.<name>getBroadcastAddress</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>)</condition><then>
            <return>return;</return></then></if>

        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (peer, %s) VALUES ('%s', '%s')"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>PEERS_CF</name></expr></argument>, <argument><expr><name>columnName</name></expr></argument>, <argument><expr><call><name><name>ep</name>.<name>getHostAddress</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><name>value</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <specifier>synchronized</specifier> <name>void</name></type> <name>updateSchemaVersion</name><parameter_list>(<param><decl><type><name>UUID</name></type> <name>version</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (key, schema_version) VALUES ('%s', %s)"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><call><name><name>version</name>.<name>toString</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>String</name></type> <name>tokensAsSet</name><parameter_list>(<param><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>tokens</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Token</name>.<name>TokenFactory</name></name></type> <name>factory</name> <init>= <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>getTokenFactory</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>StringBuilder</name></type> <name>sb</name> <init>= <expr>new <call><name>StringBuilder</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>sb</name>.<name>append</name></name><argument_list>(<argument><expr>"{"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <decl_stmt><decl><type><name><name>Iterator</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>iter</name> <init>= <expr><call><name><name>tokens</name>.<name>iterator</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <while>while <condition>(<expr><call><name><name>iter</name>.<name>hasNext</name></name><argument_list>()</argument_list></call></expr>)</condition>
        <block>{
            <expr_stmt><expr><call><name><name>sb</name>.<name>append</name></name><argument_list>(<argument><expr>"'"</expr></argument>)</argument_list></call>.<call><name>append</name><argument_list>(<argument><expr><call><name><name>factory</name>.<name>toString</name></name><argument_list>(<argument><expr><call><name><name>iter</name>.<name>next</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call>.<call><name>append</name><argument_list>(<argument><expr>"'"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if>if <condition>(<expr><call><name><name>iter</name>.<name>hasNext</name></name><argument_list>()</argument_list></call></expr>)</condition><then>
                <expr_stmt><expr><call><name><name>sb</name>.<name>append</name></name><argument_list>(<argument><expr>","</expr></argument>)</argument_list></call></expr>;</expr_stmt></then></if>
        }</block></while>
        <expr_stmt><expr><call><name><name>sb</name>.<name>append</name></name><argument_list>(<argument><expr>"}"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><call><name><name>sb</name>.<name>toString</name></name><argument_list>()</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>deserializeTokens</name><parameter_list>(<param><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>String</name></argument>&gt;</argument_list></name></type> <name>tokensStrings</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Token</name>.<name>TokenFactory</name></name></type> <name>factory</name> <init>= <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>getTokenFactory</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name><name>List</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>tokens</name> <init>= <expr>new <call><name><name>ArrayList</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name><argument_list>(<argument><expr><call><name><name>tokensStrings</name>.<name>size</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <for>for (<init><decl><type><name>String</name></type> <name>tk</name> <range>: <expr><name>tokensStrings</name></expr></range></decl></init>)
            <expr_stmt><expr><call><name><name>tokens</name>.<name>add</name></name><argument_list>(<argument><expr><call><name><name>factory</name>.<name>fromString</name></name><argument_list>(<argument><expr><name>tk</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt></for>
        <return>return <expr><name>tokens</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Remove stored tokens being used by another node
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <specifier>synchronized</specifier> <name>void</name></type> <name>removeEndpoint</name><parameter_list>(<param><decl><type><name>InetAddress</name></type> <name>ep</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"DELETE FROM system.%s WHERE peer = '%s'"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>PEERS_CF</name></expr></argument>, <argument><expr><call><name><name>ep</name>.<name>getHostAddress</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>PEERS_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * This method is used to update the System Table with the new tokens for this node
    */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <specifier>synchronized</specifier> <name>void</name></type> <name>updateTokens</name><parameter_list>(<param><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>tokens</name></decl></param>)</parameter_list>
    <block>{
        <assert>assert <expr>!<call><name><name>tokens</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call> : "removeEndpoint should be used instead"</expr>;</assert>
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (key, tokens) VALUES ('%s', %s)"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><call><name>tokensAsSet</name><argument_list>(<argument><expr><name>tokens</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>LOCAL_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Convenience method to update the list of tokens in the local system table.
     *
     * @param addTokens tokens to add
     * @param rmTokens tokens to remove
     * @return the collection of persisted tokens
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <specifier>synchronized</specifier> <name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>updateLocalTokens</name><parameter_list>(<param><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>addTokens</name></decl></param>, <param><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>rmTokens</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>tokens</name> <init>= <expr><call><name>getSavedTokens</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>tokens</name>.<name>removeAll</name></name><argument_list>(<argument><expr><name>rmTokens</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>tokens</name>.<name>addAll</name></name><argument_list>(<argument><expr><name>addTokens</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>updateTokens</name><argument_list>(<argument><expr><name>tokens</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>tokens</name></expr>;</return>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>void</name></type> <name>forceBlockingFlush</name><parameter_list>(<param><decl><type><name>String</name></type> <name>cfname</name></decl></param>)</parameter_list>
    <block>{
        <try>try
        <block>{
            <expr_stmt><expr><call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call>.<call><name>getColumnFamilyStore</name><argument_list>(<argument><expr><name>cfname</name></expr></argument>)</argument_list></call>.<call><name>forceBlockingFlush</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        }</block>
        <catch>catch <parameter_list>(<param><decl><type><name>ExecutionException</name></type> <name>e</name></decl></param>)</parameter_list>
        <block>{
            <throw>throw <expr>new <call><name>RuntimeException</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
        }</block></catch>
        <catch>catch <parameter_list>(<param><decl><type><name>InterruptedException</name></type> <name>e</name></decl></param>)</parameter_list>
        <block>{
            <throw>throw <expr>new <call><name>AssertionError</name><argument_list>(<argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
        }</block></catch></try>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Return a map of stored tokens to IP addresses
     *
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>SetMultimap</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>loadTokens</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>SetMultimap</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>tokenMap</name> <init>= <expr><call><name><name>HashMultimap</name>.<name>create</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <for>for (<init><decl><type><name><name>UntypedResultSet</name>.<name>Row</name></name></type> <name>row</name> <range>: <expr><call><name>processInternal</name><argument_list>(<argument><expr>"SELECT peer, tokens FROM system." + <name>PEERS_CF</name></expr></argument>)</argument_list></call></expr></range></decl></init>)
        <block>{
            <decl_stmt><decl><type><name>InetAddress</name></type> <name>peer</name> <init>= <expr><call><name><name>row</name>.<name>getInetAddress</name></name><argument_list>(<argument><expr>"peer"</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <if>if <condition>(<expr><call><name><name>row</name>.<name>has</name></name><argument_list>(<argument><expr>"tokens"</expr></argument>)</argument_list></call></expr>)</condition><then>
                <expr_stmt><expr><call><name><name>tokenMap</name>.<name>putAll</name></name><argument_list>(<argument><expr><name>peer</name></expr></argument>, <argument><expr><call><name>deserializeTokens</name><argument_list>(<argument><expr><call><name><name>row</name>.<name>getSet</name></name><argument_list>(<argument><expr>"tokens"</expr></argument>, <argument><expr><name><name>UTF8Type</name>.<name>instance</name></name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt></then></if>
        }</block></for>

        <return>return <expr><name>tokenMap</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Return a map of store host_ids to IP addresses
     *
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>Map</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name>UUID</name></argument>&gt;</argument_list></name></type> <name>loadHostIds</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name>UUID</name></argument>&gt;</argument_list></name></type> <name>hostIdMap</name> <init>= <expr>new <call><name><name>HashMap</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name>UUID</name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <for>for (<init><decl><type><name><name>UntypedResultSet</name>.<name>Row</name></name></type> <name>row</name> <range>: <expr><call><name>processInternal</name><argument_list>(<argument><expr>"SELECT peer, host_id FROM system." + <name>PEERS_CF</name></expr></argument>)</argument_list></call></expr></range></decl></init>)
        <block>{
            <decl_stmt><decl><type><name>InetAddress</name></type> <name>peer</name> <init>= <expr><call><name><name>row</name>.<name>getInetAddress</name></name><argument_list>(<argument><expr>"peer"</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <if>if <condition>(<expr><call><name><name>row</name>.<name>has</name></name><argument_list>(<argument><expr>"host_id"</expr></argument>)</argument_list></call></expr>)</condition><then>
            <block>{
                <expr_stmt><expr><call><name><name>hostIdMap</name>.<name>put</name></name><argument_list>(<argument><expr><name>peer</name></expr></argument>, <argument><expr><call><name><name>row</name>.<name>getUUID</name></name><argument_list>(<argument><expr>"host_id"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            }</block></then></if>
        }</block></for>
        <return>return <expr><name>hostIdMap</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Return a map of IP addresses containing a map of dc and rack info
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>Map</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name><name>Map</name><argument_list>&lt;<argument><name>String</name></argument>,<argument><name>String</name></argument>&gt;</argument_list></name></argument>&gt;</argument_list></name></type> <name>loadDcRackInfo</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name><name>Map</name><argument_list>&lt;<argument><name>String</name></argument>, <argument><name>String</name></argument>&gt;</argument_list></name></argument>&gt;</argument_list></name></type> <name>result</name> <init>= <expr>new <call><name><name>HashMap</name><argument_list>&lt;<argument><name>InetAddress</name></argument>, <argument><name><name>Map</name><argument_list>&lt;<argument><name>String</name></argument>, <argument><name>String</name></argument>&gt;</argument_list></name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
        <for>for (<init><decl><type><name><name>UntypedResultSet</name>.<name>Row</name></name></type> <name>row</name> <range>: <expr><call><name>processInternal</name><argument_list>(<argument><expr>"SELECT peer, data_center, rack from system." + <name>PEERS_CF</name></expr></argument>)</argument_list></call></expr></range></decl></init>)
        <block>{
            <decl_stmt><decl><type><name>InetAddress</name></type> <name>peer</name> <init>= <expr><call><name><name>row</name>.<name>getInetAddress</name></name><argument_list>(<argument><expr>"peer"</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <if>if <condition>(<expr><call><name><name>row</name>.<name>has</name></name><argument_list>(<argument><expr>"data_center"</expr></argument>)</argument_list></call></expr>)</condition><then>
            <block>{
                <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>String</name></argument>, <argument><name>String</name></argument>&gt;</argument_list></name></type> <name>dcRack</name> <init>= <expr>new <call><name><name>HashMap</name><argument_list>&lt;<argument><name>String</name></argument>, <argument><name>String</name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
                <expr_stmt><expr><call><name><name>dcRack</name>.<name>put</name></name><argument_list>(<argument><expr>"data_center"</expr></argument>, <argument><expr><call><name><name>row</name>.<name>getString</name></name><argument_list>(<argument><expr>"data_center"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><call><name><name>dcRack</name>.<name>put</name></name><argument_list>(<argument><expr>"rack"</expr></argument>, <argument><expr><call><name><name>row</name>.<name>getString</name></name><argument_list>(<argument><expr>"rack"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><call><name><name>result</name>.<name>put</name></name><argument_list>(<argument><expr><name>peer</name></expr></argument>, <argument><expr><name>dcRack</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            }</block></then></if>
        }</block></for>
        <return>return <expr><name>result</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * One of three things will happen if you try to read the system table:
     * 1. files are present and you can read them: great
     * 2. no files are there: great (new node is assumed)
     * 3. files are present but you can't read them: bad
     * @throws ConfigurationException
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>checkHealth</name><parameter_list>()</parameter_list> <throws>throws <argument><expr><name>ConfigurationException</name></expr></argument></throws>
    <block>{
        <decl_stmt><decl><type><name>Table</name></type> <name>table</name></decl>;</decl_stmt>
        <try>try
        <block>{
            <expr_stmt><expr><name>table</name> = <call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block>
        <catch>catch <parameter_list>(<param><decl><type><name>AssertionError</name></type> <name>err</name></decl></param>)</parameter_list>
        <block>{
            <comment type="line">// this happens when a user switches from OPP to RP.</comment>
            <decl_stmt><decl><type><name>ConfigurationException</name></type> <name>ex</name> <init>= <expr>new <call><name>ConfigurationException</name><argument_list>(<argument><expr>"Could not read system table!"</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <expr_stmt><expr><call><name><name>ex</name>.<name>initCause</name></name><argument_list>(<argument><expr><name>err</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <throw>throw <expr><name>ex</name></expr>;</throw>
        }</block></catch></try>
        <decl_stmt><decl><type><name>ColumnFamilyStore</name></type> <name>cfs</name> <init>= <expr><call><name><name>table</name>.<name>getColumnFamilyStore</name></name><argument_list>(<argument><expr><name>LOCAL_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"SELECT cluster_name FROM system.%s WHERE key='%s'"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>UntypedResultSet</name></type> <name>result</name> <init>= <expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <if>if <condition>(<expr><call><name><name>result</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call> || !<call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>has</name><argument_list>(<argument><expr>"cluster_name"</expr></argument>)</argument_list></call></expr>)</condition><then>
        <block>{
            <comment type="line">// this is a brand new node</comment>
            <if>if <condition>(<expr>!<call><name><name>cfs</name>.<name>getSSTables</name></name><argument_list>()</argument_list></call>.<call><name>isEmpty</name><argument_list>()</argument_list></call></expr>)</condition><then>
                <throw>throw <expr>new <call><name>ConfigurationException</name><argument_list>(<argument><expr>"Found system table files, but they couldn't be loaded!"</expr></argument>)</argument_list></call></expr>;</throw></then></if>

            <comment type="line">// no system files.  this is a new node.</comment>
            <expr_stmt><expr><name>req</name> = "INSERT INTO system.%s (key, cluster_name) VALUES ('%s', '%s')"</expr>;</expr_stmt>
            <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><call><name><name>DatabaseDescriptor</name>.<name>getClusterName</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return;</return>
        }</block></then></if>

        <decl_stmt><decl><type><name>String</name></type> <name>savedClusterName</name> <init>= <expr><call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>getString</name><argument_list>(<argument><expr>"cluster_name"</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <if>if <condition>(<expr>!<call><name><name>DatabaseDescriptor</name>.<name>getClusterName</name></name><argument_list>()</argument_list></call>.<call><name>equals</name><argument_list>(<argument><expr><name>savedClusterName</name></expr></argument>)</argument_list></call></expr>)</condition><then>
            <throw>throw <expr>new <call><name>ConfigurationException</name><argument_list>(<argument><expr>"Saved cluster name " + <name>savedClusterName</name> + " != configured name " + <call><name><name>DatabaseDescriptor</name>.<name>getClusterName</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</throw></then></if>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>Collection</name><argument_list>&lt;<argument><name>Token</name></argument>&gt;</argument_list></name></type> <name>getSavedTokens</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"SELECT tokens FROM system.%s WHERE key='%s'"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>UntypedResultSet</name></type> <name>result</name> <init>= <expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <return>return <expr><call><name><name>result</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call> || !<call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>has</name><argument_list>(<argument><expr>"tokens"</expr></argument>)</argument_list></call>
             ? <name><name>Collections</name>.</name>&lt;<name>Token</name>&gt;<call><name>emptyList</name><argument_list>()</argument_list></call>
             : <call><name>deserializeTokens</name><argument_list>(<argument><expr><call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.&lt;<name>String</name>&gt;<call><name>getSet</name><argument_list>(<argument><expr>"tokens"</expr></argument>, <argument><expr><name><name>UTF8Type</name>.<name>instance</name></name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>int</name></type> <name>incrementAndGetGeneration</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"SELECT gossip_generation FROM system.%s WHERE key='%s'"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>UntypedResultSet</name></type> <name>result</name> <init>= <expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>int</name></type> <name>generation</name></decl>;</decl_stmt>
        <if>if <condition>(<expr><call><name><name>result</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call> || !<call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>has</name><argument_list>(<argument><expr>"gossip_generation"</expr></argument>)</argument_list></call></expr>)</condition><then>
        <block>{
            <comment type="line">// seconds-since-epoch isn't a foolproof new generation</comment>
            <comment type="line">// (where foolproof is "guaranteed to be larger than the last one seen at this ip address"),</comment>
            <comment type="line">// but it's as close as sanely possible</comment>
            <expr_stmt><expr><name>generation</name> = <call>(<name>int</name>) <argument_list>(<argument><expr><call><name><name>System</name>.<name>currentTimeMillis</name></name><argument_list>()</argument_list></call> / 1000</expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></then>
        <else>else
        <block>{
            <comment type="line">// Other nodes will ignore gossip messages about a node that have a lower generation than previously seen.</comment>
            <decl_stmt><decl><type><specifier>final</specifier> <name>int</name></type> <name>storedGeneration</name> <init>= <expr><call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>getInt</name><argument_list>(<argument><expr>"gossip_generation"</expr></argument>)</argument_list></call> + 1</expr></init></decl>;</decl_stmt>
            <decl_stmt><decl><type><specifier>final</specifier> <name>int</name></type> <name>now</name> <init>= <expr><call>(<name>int</name>) <argument_list>(<argument><expr><call><name><name>System</name>.<name>currentTimeMillis</name></name><argument_list>()</argument_list></call> / 1000</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
            <if>if <condition>(<expr><name>storedGeneration</name> &gt;= <name>now</name></expr>)</condition><then>
            <block>{
                <expr_stmt><expr><call><name><name>logger</name>.<name>warn</name></name><argument_list>(<argument><expr>"Using stored Gossip Generation {} as it is greater than current system time {}.  See CASSANDRA-3654 if you experience problems"</expr></argument>,
                            <argument><expr><name>storedGeneration</name></expr></argument>, <argument><expr><name>now</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><name>generation</name> = <name>storedGeneration</name></expr>;</expr_stmt>
            }</block></then>
            <else>else
            <block>{
                <expr_stmt><expr><name>generation</name> = <name>now</name></expr>;</expr_stmt>
            }</block></else></if>
        }</block></else></if>

        <expr_stmt><expr><name>req</name> = "INSERT INTO system.%s (key, gossip_generation) VALUES ('%s', %d)"</expr>;</expr_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><name>generation</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>LOCAL_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <return>return <expr><name>generation</name></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>BootstrapState</name></type> <name>getBootstrapState</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"SELECT bootstrapped FROM system.%s WHERE key='%s'"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>UntypedResultSet</name></type> <name>result</name> <init>= <expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <if>if <condition>(<expr><call><name><name>result</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call> || !<call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>has</name><argument_list>(<argument><expr>"bootstrapped"</expr></argument>)</argument_list></call></expr>)</condition><then>
            <return>return <expr><name><name>BootstrapState</name>.<name>NEEDS_BOOTSTRAP</name></name></expr>;</return></then></if>

        <return>return <expr><call><name><name>BootstrapState</name>.<name>valueOf</name></name><argument_list>(<argument><expr><call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>getString</name><argument_list>(<argument><expr>"bootstrapped"</expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>boolean</name></type> <name>bootstrapComplete</name><parameter_list>()</parameter_list>
    <block>{
        <return>return <expr><call><name>getBootstrapState</name><argument_list>()</argument_list></call> == <name><name>BootstrapState</name>.<name>COMPLETED</name></name></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>boolean</name></type> <name>bootstrapInProgress</name><parameter_list>()</parameter_list>
    <block>{
        <return>return <expr><call><name>getBootstrapState</name><argument_list>()</argument_list></call> == <name><name>BootstrapState</name>.<name>IN_PROGRESS</name></name></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>setBootstrapState</name><parameter_list>(<param><decl><type><name>BootstrapState</name></type> <name>state</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"INSERT INTO system.%s (key, bootstrapped) VALUES ('%s', '%s')"</expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><call><name><name>state</name>.<name>name</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>LOCAL_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>boolean</name></type> <name>isIndexBuilt</name><parameter_list>(<param><decl><type><name>String</name></type> <name>table</name></decl></param>, <param><decl><type><name>String</name></type> <name>indexName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>ColumnFamilyStore</name></type> <name>cfs</name> <init>= <expr><call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call>.<call><name>getColumnFamilyStore</name><argument_list>(<argument><expr><name>INDEX_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>QueryFilter</name></type> <name>filter</name> <init>= <expr><call><name><name>QueryFilter</name>.<name>getNamesFilter</name></name><argument_list>(<argument><expr><call><name>decorate</name><argument_list>(<argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr><name>table</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>INDEX_CF</name></expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr><name>indexName</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <return>return <expr><call><name><name>ColumnFamilyStore</name>.<name>removeDeleted</name></name><argument_list>(<argument><expr><call><name><name>cfs</name>.<name>getColumnFamily</name></name><argument_list>(<argument><expr><name>filter</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><name><name>Integer</name>.<name>MAX_VALUE</name></name></expr></argument>)</argument_list></call> != null</expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>setIndexBuilt</name><parameter_list>(<param><decl><type><name>String</name></type> <name>table</name></decl></param>, <param><decl><type><name>String</name></type> <name>indexName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>cf</name> <init>= <expr><call><name><name>ColumnFamily</name>.<name>create</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>, <argument><expr><name>INDEX_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>cf</name>.<name>addColumn</name></name><argument_list>(<argument><expr>new <call><name>Column</name><argument_list>(<argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr><name>indexName</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><name><name>ByteBufferUtil</name>.<name>EMPTY_BYTE_BUFFER</name></name></expr></argument>, <argument><expr><call><name><name>FBUtilities</name>.<name>timestampMicros</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <decl_stmt><decl><type><name>RowMutation</name></type> <name>rm</name> <init>= <expr>new <call><name>RowMutation</name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>, <argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr><name>table</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>rm</name>.<name>add</name></name><argument_list>(<argument><expr><name>cf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>rm</name>.<name>apply</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>INDEX_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>setIndexRemoved</name><parameter_list>(<param><decl><type><name>String</name></type> <name>table</name></decl></param>, <param><decl><type><name>String</name></type> <name>indexName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>RowMutation</name></type> <name>rm</name> <init>= <expr>new <call><name>RowMutation</name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>, <argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr><name>table</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>rm</name>.<name>delete</name></name><argument_list>(<argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>INDEX_CF</name></expr></argument>, <argument><expr>null</expr></argument>, <argument><expr><call><name><name>ByteBufferUtil</name>.<name>bytes</name></name><argument_list>(<argument><expr><name>indexName</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><call><name><name>FBUtilities</name>.<name>timestampMicros</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>rm</name>.<name>apply</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>INDEX_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Read the host ID from the system table, creating (and storing) one if
     * none exists.
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>UUID</name></type> <name>getLocalHostId</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>UUID</name></type> <name>hostId</name> <init>= <expr>null</expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>String</name></type> <name>req</name> <init>= <expr>"SELECT host_id FROM system.%s WHERE key='%s'"</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>UntypedResultSet</name></type> <name>result</name> <init>= <expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <comment type="line">// Look up the Host UUID (return it if found)</comment>
        <if>if <condition>(<expr>!<call><name><name>result</name>.<name>isEmpty</name></name><argument_list>()</argument_list></call> &amp;&amp; <call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>has</name><argument_list>(<argument><expr>"host_id"</expr></argument>)</argument_list></call></expr>)</condition><then>
        <block>{
            <return>return <expr><call><name><name>result</name>.<name>one</name></name><argument_list>()</argument_list></call>.<call><name>getUUID</name><argument_list>(<argument><expr>"host_id"</expr></argument>)</argument_list></call></expr>;</return>
        }</block></then></if>

        <comment type="line">// ID not found, generate a new one, persist, and then return it.</comment>
        <expr_stmt><expr><name>hostId</name> = <call><name><name>UUID</name>.<name>randomUUID</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>logger</name>.<name>warn</name></name><argument_list>(<argument><expr>"No host ID found, created {} (Note: This should happen exactly once per node)."</expr></argument>, <argument><expr><name>hostId</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <expr_stmt><expr><name>req</name> = "INSERT INTO system.%s (key, host_id) VALUES ('%s', '%s')"</expr>;</expr_stmt>
        <expr_stmt><expr><call><name>processInternal</name><argument_list>(<argument><expr><call><name><name>String</name>.<name>format</name></name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>LOCAL_CF</name></expr></argument>, <argument><expr><name>LOCAL_KEY</name></expr></argument>, <argument><expr><name>hostId</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>hostId</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Read the current local node id from the system table or null if no
     * such node id is recorded.
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>CounterId</name></type> <name>getCurrentLocalCounterId</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>Table</name></type> <name>table</name> <init>= <expr><call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <comment type="line">// Get the last CounterId (since CounterId are timeuuid is thus ordered from the older to the newer one)</comment>
        <decl_stmt><decl><type><name>QueryFilter</name></type> <name>filter</name> <init>= <expr><call><name><name>QueryFilter</name>.<name>getSliceFilter</name></name><argument_list>(<argument><expr><call><name>decorate</name><argument_list>(<argument><expr><name>ALL_LOCAL_NODE_ID_KEY</name></expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>COUNTER_ID_CF</name></expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr><name><name>ByteBufferUtil</name>.<name>EMPTY_BYTE_BUFFER</name></name></expr></argument>,
                                                        <argument><expr><name><name>ByteBufferUtil</name>.<name>EMPTY_BYTE_BUFFER</name></name></expr></argument>,
                                                        <argument><expr>true</expr></argument>,
                                                        <argument><expr>1</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>cf</name> <init>= <expr><call><name><name>table</name>.<name>getColumnFamilyStore</name></name><argument_list>(<argument><expr><name>COUNTER_ID_CF</name></expr></argument>)</argument_list></call>.<call><name>getColumnFamily</name><argument_list>(<argument><expr><name>filter</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <if>if <condition>(<expr><name>cf</name> != null &amp;&amp; <call><name><name>cf</name>.<name>getColumnCount</name></name><argument_list>()</argument_list></call> != 0</expr>)</condition><then>
            <return>return <expr><call><name><name>CounterId</name>.<name>wrap</name></name><argument_list>(<argument><expr><call><name><name>cf</name>.<name>iterator</name></name><argument_list>()</argument_list></call>.<call><name>next</name><argument_list>()</argument_list></call>.<call><name>name</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</return></then>
        <else>else
            <return>return <expr>null</expr>;</return></else></if>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * Write a new current local node id to the system table.
     *
     * @param oldCounterId the previous local node id (that {@code newCounterId}
     * replace) or null if no such node id exists (new node or removed system
     * table)
     * @param newCounterId the new current local node id to record
     * @param now microsecond time stamp.
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>void</name></type> <name>writeCurrentLocalCounterId</name><parameter_list>(<param><decl><type><name>CounterId</name></type> <name>oldCounterId</name></decl></param>, <param><decl><type><name>CounterId</name></type> <name>newCounterId</name></decl></param>, <param><decl><type><name>long</name></type> <name>now</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>ByteBuffer</name></type> <name>ip</name> <init>= <expr><call><name><name>ByteBuffer</name>.<name>wrap</name></name><argument_list>(<argument><expr><call><name><name>FBUtilities</name>.<name>getBroadcastAddress</name></name><argument_list>()</argument_list></call>.<call><name>getAddress</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>cf</name> <init>= <expr><call><name><name>ColumnFamily</name>.<name>create</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>, <argument><expr><name>COUNTER_ID_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>cf</name>.<name>addColumn</name></name><argument_list>(<argument><expr>new <call><name>Column</name><argument_list>(<argument><expr><call><name><name>newCounterId</name>.<name>bytes</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><name>ip</name></expr></argument>, <argument><expr><name>now</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <decl_stmt><decl><type><name>RowMutation</name></type> <name>rm</name> <init>= <expr>new <call><name>RowMutation</name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>, <argument><expr><name>ALL_LOCAL_NODE_ID_KEY</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name><name>rm</name>.<name>add</name></name><argument_list>(<argument><expr><name>cf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>rm</name>.<name>apply</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>forceBlockingFlush</name><argument_list>(<argument><expr><name>COUNTER_ID_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>List</name><argument_list>&lt;<argument><name><name>CounterId</name>.<name>CounterIdRecord</name></name></argument>&gt;</argument_list></name></type> <name>getOldLocalCounterIds</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>List</name><argument_list>&lt;<argument><name><name>CounterId</name>.<name>CounterIdRecord</name></name></argument>&gt;</argument_list></name></type> <name>l</name> <init>= <expr>new <call><name><name>ArrayList</name><argument_list>&lt;<argument><name><name>CounterId</name>.<name>CounterIdRecord</name></name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>Table</name></type> <name>table</name> <init>= <expr><call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>QueryFilter</name></type> <name>filter</name> <init>= <expr><call><name><name>QueryFilter</name>.<name>getIdentityFilter</name></name><argument_list>(<argument><expr><call><name>decorate</name><argument_list>(<argument><expr><name>ALL_LOCAL_NODE_ID_KEY</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>COUNTER_ID_CF</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>cf</name> <init>= <expr><call><name><name>table</name>.<name>getColumnFamilyStore</name></name><argument_list>(<argument><expr><name>COUNTER_ID_CF</name></expr></argument>)</argument_list></call>.<call><name>getColumnFamily</name><argument_list>(<argument><expr><name>filter</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>CounterId</name></type> <name>previous</name> <init>= <expr>null</expr></init></decl>;</decl_stmt>
        <for>for (<init><decl><type><name>IColumn</name></type> <name>c</name> <range>: <expr><name>cf</name></expr></range></decl></init>)
        <block>{
            <if>if <condition>(<expr><name>previous</name> != null</expr>)</condition><then>
                <expr_stmt><expr><call><name><name>l</name>.<name>add</name></name><argument_list>(<argument><expr>new <call><name><name>CounterId</name>.<name>CounterIdRecord</name></name><argument_list>(<argument><expr><name>previous</name></expr></argument>, <argument><expr><call><name><name>c</name>.<name>timestamp</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt></then></if>

            <comment type="line">// this will ignore the last column on purpose since it is the</comment>
            <comment type="line">// current local node id</comment>
            <expr_stmt><expr><name>previous</name> = <call><name><name>CounterId</name>.<name>wrap</name></name><argument_list>(<argument><expr><call><name><name>c</name>.<name>name</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></for>
        <return>return <expr><name>l</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * @param cfName The name of the ColumnFamily responsible for part of the schema (keyspace, ColumnFamily, columns)
     * @return CFS responsible to hold low-level serialized schema
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>ColumnFamilyStore</name></type> <name>schemaCFS</name><parameter_list>(<param><decl><type><name>String</name></type> <name>cfName</name></decl></param>)</parameter_list>
    <block>{
        <return>return <expr><call><name><name>Table</name>.<name>open</name></name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>)</argument_list></call>.<call><name>getColumnFamilyStore</name><argument_list>(<argument><expr><name>cfName</name></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>List</name><argument_list>&lt;<argument><name>Row</name></argument>&gt;</argument_list></name></type> <name>serializedSchema</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>List</name><argument_list>&lt;<argument><name>Row</name></argument>&gt;</argument_list></name></type> <name>schema</name> <init>= <expr>new <call><name><name>ArrayList</name><argument_list>&lt;<argument><name>Row</name></argument>&gt;</argument_list></name><argument_list>(<argument><expr>3</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <expr_stmt><expr><call><name><name>schema</name>.<name>addAll</name></name><argument_list>(<argument><expr><call><name>serializedSchema</name><argument_list>(<argument><expr><name>SCHEMA_KEYSPACES_CF</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>schema</name>.<name>addAll</name></name><argument_list>(<argument><expr><call><name>serializedSchema</name><argument_list>(<argument><expr><name>SCHEMA_COLUMNFAMILIES_CF</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name><name>schema</name>.<name>addAll</name></name><argument_list>(<argument><expr><call><name>serializedSchema</name><argument_list>(<argument><expr><name>SCHEMA_COLUMNS_CF</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <return>return <expr><name>schema</name></expr>;</return>
    }</block></function>

    <comment type="block" format="javadoc">/**
     * @param schemaCfName The name of the ColumnFamily responsible for part of the schema (keyspace, ColumnFamily, columns)
     * @return low-level schema representation (each row represents individual Keyspace or ColumnFamily)
     */</comment>
    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>List</name><argument_list>&lt;<argument><name>Row</name></argument>&gt;</argument_list></name></type> <name>serializedSchema</name><parameter_list>(<param><decl><type><name>String</name></type> <name>schemaCfName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>Token</name></type> <name>minToken</name> <init>= <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>getMinimumToken</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>

        <return>return <expr><call><name>schemaCFS</name><argument_list>(<argument><expr><name>schemaCfName</name></expr></argument>)</argument_list></call>.<call><name>getRangeSlice</name><argument_list>(<argument><expr>null</expr></argument>,
                                                     <argument><expr>new <call><name><name>Range</name><argument_list>&lt;<argument><name>RowPosition</name></argument>&gt;</argument_list></name><argument_list>(<argument><expr><call><name><name>minToken</name>.<name>minKeyBound</name></name><argument_list>()</argument_list></call></expr></argument>,
                                                                            <argument><expr><call><name><name>minToken</name>.<name>maxKeyBound</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></argument>,
                                                     <argument><expr><name><name>Integer</name>.<name>MAX_VALUE</name></name></expr></argument>,
                                                     <argument><expr>new <call><name>IdentityQueryFilter</name><argument_list>()</argument_list></call></expr></argument>,
                                                     <argument><expr>null</expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>Collection</name><argument_list>&lt;<argument><name>RowMutation</name></argument>&gt;</argument_list></name></type> <name>serializeSchema</name><parameter_list>()</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>DecoratedKey</name></argument>, <argument><name>RowMutation</name></argument>&gt;</argument_list></name></type> <name>mutationMap</name> <init>= <expr>new <call><name><name>HashMap</name><argument_list>&lt;<argument><name>DecoratedKey</name></argument>, <argument><name>RowMutation</name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>

        <expr_stmt><expr><call><name>serializeSchema</name><argument_list>(<argument><expr><name>mutationMap</name></expr></argument>, <argument><expr><name>SCHEMA_KEYSPACES_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>serializeSchema</name><argument_list>(<argument><expr><name>mutationMap</name></expr></argument>, <argument><expr><name>SCHEMA_COLUMNFAMILIES_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>serializeSchema</name><argument_list>(<argument><expr><name>mutationMap</name></expr></argument>, <argument><expr><name>SCHEMA_COLUMNS_CF</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <return>return <expr><call><name><name>mutationMap</name>.<name>values</name></name><argument_list>()</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>private</specifier> <specifier>static</specifier> <name>void</name></type> <name>serializeSchema</name><parameter_list>(<param><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>DecoratedKey</name></argument>, <argument><name>RowMutation</name></argument>&gt;</argument_list></name></type> <name>mutationMap</name></decl></param>, <param><decl><type><name>String</name></type> <name>schemaCfName</name></decl></param>)</parameter_list>
    <block>{
        <for>for (<init><decl><type><name>Row</name></type> <name>schemaRow</name> <range>: <expr><call><name>serializedSchema</name><argument_list>(<argument><expr><name>schemaCfName</name></expr></argument>)</argument_list></call></expr></range></decl></init>)
        <block>{
            <if>if <condition>(<expr><call><name><name>Schema</name>.<name>ignoredSchemaRow</name></name><argument_list>(<argument><expr><name>schemaRow</name></expr></argument>)</argument_list></call></expr>)</condition><then>
                <continue>continue;</continue></then></if>

            <decl_stmt><decl><type><name>RowMutation</name></type> <name>mutation</name> <init>= <expr><call><name><name>mutationMap</name>.<name>get</name></name><argument_list>(<argument><expr><name><name>schemaRow</name>.<name>key</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

            <if>if <condition>(<expr><name>mutation</name> == null</expr>)</condition><then>
            <block>{
                <expr_stmt><expr><call><name><name>mutationMap</name>.<name>put</name></name><argument_list>(<argument><expr><name><name>schemaRow</name>.<name>key</name></name></expr></argument>, <argument><expr>new <call><name>RowMutation</name><argument_list>(<argument><expr><name><name>Table</name>.<name>SYSTEM_KS</name></name></expr></argument>, <argument><expr><name>schemaRow</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <continue>continue;</continue>
            }</block></then></if>

            <expr_stmt><expr><call><name><name>mutation</name>.<name>add</name></name><argument_list>(<argument><expr><name><name>schemaRow</name>.<name>cf</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></for>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name><name>Map</name><argument_list>&lt;<argument><name>DecoratedKey</name></argument>, <argument><name>ColumnFamily</name></argument>&gt;</argument_list></name></type> <name>getSchema</name><parameter_list>(<param><decl><type><name>String</name></type> <name>cfName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name><name>Map</name><argument_list>&lt;<argument><name>DecoratedKey</name></argument>, <argument><name>ColumnFamily</name></argument>&gt;</argument_list></name></type> <name>schema</name> <init>= <expr>new <call><name><name>HashMap</name><argument_list>&lt;<argument><name>DecoratedKey</name></argument>, <argument><name>ColumnFamily</name></argument>&gt;</argument_list></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>

        <for>for (<init><decl><type><name>Row</name></type> <name>schemaEntity</name> <range>: <expr><call><name><name>SystemTable</name>.<name>serializedSchema</name></name><argument_list>(<argument><expr><name>cfName</name></expr></argument>)</argument_list></call></expr></range></decl></init>)
            <expr_stmt><expr><call><name><name>schema</name>.<name>put</name></name><argument_list>(<argument><expr><name><name>schemaEntity</name>.<name>key</name></name></expr></argument>, <argument><expr><name><name>schemaEntity</name>.<name>cf</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></for>

        <return>return <expr><name>schema</name></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>ByteBuffer</name></type> <name>getSchemaKSKey</name><parameter_list>(<param><decl><type><name>String</name></type> <name>ksName</name></decl></param>)</parameter_list>
    <block>{
        <return>return <expr><call><name><name>AsciiType</name>.<name>instance</name>.<name>fromString</name></name><argument_list>(<argument><expr><name>ksName</name></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>Row</name></type> <name>readSchemaRow</name><parameter_list>(<param><decl><type><name>String</name></type> <name>ksName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>DecoratedKey</name></type> <name>key</name> <init>= <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>decorateKey</name><argument_list>(<argument><expr><call><name>getSchemaKSKey</name><argument_list>(<argument><expr><name>ksName</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>ColumnFamilyStore</name></type> <name>schemaCFS</name> <init>= <expr><call><name><name>SystemTable</name>.<name>schemaCFS</name></name><argument_list>(<argument><expr><name>SCHEMA_KEYSPACES_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>result</name> <init>= <expr><call><name><name>schemaCFS</name>.<name>getColumnFamily</name></name><argument_list>(<argument><expr><call><name><name>QueryFilter</name>.<name>getIdentityFilter</name></name><argument_list>(<argument><expr><name>key</name></expr></argument>, <argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>SCHEMA_KEYSPACES_CF</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <return>return <expr>new <call><name>Row</name><argument_list>(<argument><expr><name>key</name></expr></argument>, <argument><expr><name>result</name></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>

    <function><type><specifier>public</specifier> <specifier>static</specifier> <name>Row</name></type> <name>readSchemaRow</name><parameter_list>(<param><decl><type><name>String</name></type> <name>ksName</name></decl></param>, <param><decl><type><name>String</name></type> <name>cfName</name></decl></param>)</parameter_list>
    <block>{
        <decl_stmt><decl><type><name>DecoratedKey</name></type> <name>key</name> <init>= <expr><call><name><name>StorageService</name>.<name>getPartitioner</name></name><argument_list>()</argument_list></call>.<call><name>decorateKey</name><argument_list>(<argument><expr><call><name>getSchemaKSKey</name><argument_list>(<argument><expr><name>ksName</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <decl_stmt><decl><type><name>ColumnFamilyStore</name></type> <name>schemaCFS</name> <init>= <expr><call><name><name>SystemTable</name>.<name>schemaCFS</name></name><argument_list>(<argument><expr><name>SCHEMA_COLUMNFAMILIES_CF</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>ColumnFamily</name></type> <name>result</name> <init>= <expr><call><name><name>schemaCFS</name>.<name>getColumnFamily</name></name><argument_list>(<argument><expr><name>key</name></expr></argument>,
                                                        <argument><expr>new <call><name>QueryPath</name><argument_list>(<argument><expr><name>SCHEMA_COLUMNFAMILIES_CF</name></expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr><call><name><name>DefsTable</name>.<name>searchComposite</name></name><argument_list>(<argument><expr><name>cfName</name></expr></argument>, <argument><expr>true</expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr><call><name><name>DefsTable</name>.<name>searchComposite</name></name><argument_list>(<argument><expr><name>cfName</name></expr></argument>, <argument><expr>false</expr></argument>)</argument_list></call></expr></argument>,
                                                        <argument><expr>false</expr></argument>,
                                                        <argument><expr><name><name>Integer</name>.<name>MAX_VALUE</name></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

        <return>return <expr>new <call><name>Row</name><argument_list>(<argument><expr><name>key</name></expr></argument>, <argument><expr><name>result</name></expr></argument>)</argument_list></call></expr>;</return>
    }</block></function>
}</block></class>
</unit>
